{"data":{"root":{"post":{"body":"<p>In this post are the beginnings of riak-solr-client.</p>\n<p>First, we need to take a look at the response from Solr/Yokozuna/Riak-Search-2 for a single query. In this case, the database only holds two records and we are doing a query that matches all results (<code>*:*</code>).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{\n   <span class=\"highlight__hljs-string___1SffY\">\"responseHeader\"</span>:{\n      <span class=\"highlight__hljs-string___1SffY\">\"status\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"QTime\"</span>:<span class=\"highlight__hljs-number___2gmaH\">11</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"params\"</span>:{\n         <span class=\"highlight__hljs-string___1SffY\">\"shards\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"127.0.0.1:8093/solr/my_index\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"q\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"*:*\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"127.0.0.1:8093\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"_yz_pn:64 OR (_yz_pn:61 AND (_yz_fpn:61)) OR _yz_pn:60 OR _yz_pn:57 OR _yz_pn:54 OR _yz_pn:51 OR _yz_pn:48 OR _yz_pn:45 OR _yz_pn:42 OR _yz_pn:39 OR _yz_pn:36 OR _yz_pn:33 OR _yz_pn:30 OR _yz_pn:27 OR _yz_pn:24 OR _yz_pn:21 OR _yz_pn:18 OR _yz_pn:15 OR _yz_pn:12 OR _yz_pn:9 OR _yz_pn:6 OR _yz_pn:3\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"wt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"json\"</span>\n      }\n   },\n   <span class=\"highlight__hljs-string___1SffY\">\"response\"</span>:{\n      <span class=\"highlight__hljs-string___1SffY\">\"numFound\"</span>:<span class=\"highlight__hljs-number___2gmaH\">2</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"start\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"maxScore\"</span>:<span class=\"highlight__hljs-number___2gmaH\">1.0</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"docs\"</span>:[\n         {\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"data_my_bucket_name_12\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"name\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"data\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"my_bucket\"</span>\n         },\n         {\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"data_my_bucket_second_15\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"second\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"data\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"my_bucket\"</span>\n         }\n      ]\n   }\n}\n</code></pre>\n<p>As you can see, I’ve decided to retrieve JSON because of my familiarity with\nData.Aeson. There is no set schema for Solr responses, so we’re going to have to\ntest this fairly well to make a generic library that will be updated over time\nas Solr updates.</p>\n<p>With the sample response in mind, we can start to create the datatypes:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">newtype</span> <span class=\"highlight__hljs-type___11WfV\">Params</span> = <span class=\"highlight__hljs-type___11WfV\">Params</span> (<span class=\"highlight__hljs-type___11WfV\">Map</span> <span class=\"highlight__hljs-type___11WfV\">String</span> <span class=\"highlight__hljs-type___11WfV\">String</span>) <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> = <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">status</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">qTime</span>  :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">params</span> :: <span class=\"highlight__hljs-type___11WfV\">Params</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">Docs</span> = <span class=\"highlight__hljs-type___11WfV\">Docs</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_id</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rk</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rt</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rb</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">Results</span> = <span class=\"highlight__hljs-type___11WfV\">Results</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">numFound</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">start</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">maxScore</span> :: <span class=\"highlight__hljs-type___11WfV\">Float</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">docs</span> :: [<span class=\"highlight__hljs-type___11WfV\">Docs</span>]\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> = <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">responseHeader</span> :: <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">response</span> :: <span class=\"highlight__hljs-type___11WfV\">Results</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n</code></pre>\n<p>The most interesting part of this is <code>Params</code>. We’ve defined <code>Params</code> as a\n<code>newtype</code> for a <code>Data.Map</code> because, making an educated guess, the keys for\nparams won’t always be the same. We can reach this conclusion by seeing that one\nof the keys is an IP address (with a port number).</p>\n<p>Another interesting piece of the response is the <code>Docs</code>. Solr seems to return\nthe id in Solr (<code>_yz</code> is presumably for _yokozuna), the Riak Key (<code>_yz_rk</code>), the\nRiak Bucket Type <code>_yz_rt</code> and the Riak Bucket (<code>_yz_rb</code>). This is useful\ninformation because we will need to use riak-haskell-client (or more likely an\nupdated fork for Riak 2.0) to retrieve the actual data.</p>\n<p>We can now write some JSON instances and basic http code to test. Here is the\nfull file:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"hljs-meta\">{-# LANGUAGE OverloadedStrings #-}</span>\n<span class=\"highlight__hljs-keyword___som98\">import</span> Data.Aeson\n<span class=\"highlight__hljs-keyword___som98\">import</span> Data.Map\n<span class=\"highlight__hljs-keyword___som98\">import</span> Control.Applicative\n<span class=\"highlight__hljs-keyword___som98\">import</span> Control.Monad (<span class=\"highlight__hljs-title___1fl8Q\">mzero</span>)\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> Network.HTTP.Conduit <span class=\"highlight__hljs-comment___UYk12\">-- the main module</span>\n\n<span class=\"highlight__hljs-comment___UYk12\">-- The streaming interface uses conduits</span>\n<span class=\"highlight__hljs-keyword___som98\">import</span> Data.Conduit\n<span class=\"highlight__hljs-keyword___som98\">import</span> Data.Conduit.Binary (<span class=\"highlight__hljs-title___1fl8Q\">sinkFile</span>)\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> <span class=\"highlight__hljs-keyword___som98\">qualified</span> Data.ByteString.Lazy.Char8 <span class=\"highlight__hljs-keyword___som98\">as</span> L\n<span class=\"highlight__hljs-keyword___som98\">import</span> Control.Monad.IO.Class (<span class=\"highlight__hljs-title___1fl8Q\">liftIO</span>)\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">newtype</span> <span class=\"highlight__hljs-type___11WfV\">Params</span> = <span class=\"highlight__hljs-type___11WfV\">Params</span> (<span class=\"highlight__hljs-type___11WfV\">Map</span> <span class=\"highlight__hljs-type___11WfV\">String</span> <span class=\"highlight__hljs-type___11WfV\">String</span>) <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> <span class=\"highlight__hljs-type___11WfV\">Params</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseJSON val = <span class=\"highlight__hljs-type___11WfV\">Params</span>  parseJSON val\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> = <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">status</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">qTime</span>  :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">params</span> :: <span class=\"highlight__hljs-type___11WfV\">Params</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseJSON (<span class=\"highlight__hljs-type___11WfV\">Object</span> o) = <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span>  o .: <span class=\"highlight__hljs-string___1SffY\">\"status\"</span>\n                                         o .: <span class=\"highlight__hljs-string___1SffY\">\"QTime\"</span>\n                                         o .: <span class=\"highlight__hljs-string___1SffY\">\"params\"</span>\n  parseJSON _ = mzero\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">Docs</span> = <span class=\"highlight__hljs-type___11WfV\">Docs</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_id</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rk</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rt</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rb</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> <span class=\"highlight__hljs-type___11WfV\">Docs</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseJSON (<span class=\"highlight__hljs-type___11WfV\">Object</span> o) = <span class=\"highlight__hljs-type___11WfV\">Docs</span>  o .: <span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span>\n                               o .: <span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span>\n                               o .: <span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span>\n                               o .: <span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span>\n  parseJSON _ = mzero\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">Results</span> = <span class=\"highlight__hljs-type___11WfV\">Results</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">numFound</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">start</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">maxScore</span> :: <span class=\"highlight__hljs-type___11WfV\">Float</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">docs</span> :: [<span class=\"highlight__hljs-type___11WfV\">Docs</span>]\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> <span class=\"highlight__hljs-type___11WfV\">Results</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseJSON (<span class=\"highlight__hljs-type___11WfV\">Object</span> o) = <span class=\"highlight__hljs-type___11WfV\">Results</span>  o .: <span class=\"highlight__hljs-string___1SffY\">\"numFound\"</span>\n                                  o .: <span class=\"highlight__hljs-string___1SffY\">\"start\"</span>\n                                  o .: <span class=\"highlight__hljs-string___1SffY\">\"maxScore\"</span>\n                                  o .: <span class=\"highlight__hljs-string___1SffY\">\"docs\"</span>\n  parseJSON _ = mzero\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> = <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">responseHeader</span> :: <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">response</span> :: <span class=\"highlight__hljs-type___11WfV\">Results</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseJSON (<span class=\"highlight__hljs-type___11WfV\">Object</span> o) = <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span>  o .: <span class=\"highlight__hljs-string___1SffY\">\"responseHeader\"</span>\n                                       o .: <span class=\"highlight__hljs-string___1SffY\">\"response\"</span>\n  parseJSON _ = mzero\n\n<span class=\"highlight__hljs-title___1fl8Q\">main</span> :: <span class=\"highlight__hljs-type___11WfV\">IO</span> ()\n<span class=\"highlight__hljs-title___1fl8Q\">main</span> = <span class=\"highlight__hljs-keyword___som98\">do</span>\n</code></pre>\n<p>and running <code>main</code> in ghci gives us:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">Just</span> (<span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> {responseHeader = <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> {status = <span class=\"highlight__hljs-number___2gmaH\">0</span>, qTime = <span class=\"highlight__hljs-number___2gmaH\">8</span>, params = <span class=\"highlight__hljs-type___11WfV\">Params</span> (fromList [(<span class=\"highlight__hljs-string___1SffY\">\"127.0.0.1:8093\"</span>,<span class=\"highlight__hljs-string___1SffY\">\"_yz_pn:63 OR (_yz_pn:60 AND (_yz_fpn:60)) OR _yz_pn:59 OR _yz_pn:56 OR _yz_pn:53 OR _yz_pn:50 OR _yz_pn:47 OR _yz_pn:44 OR _yz_pn:41 OR _yz_pn:38 OR _yz_pn:35 OR _yz_pn:32 OR _yz_pn:29 OR _yz_pn:26 OR _yz_pn:23 OR _yz_pn:20 OR _yz_pn:17 OR _yz_pn:14 OR _yz_pn:11 OR _yz_pn:8 OR _yz_pn:5 OR _yz_pn:2\"</span>),(<span class=\"highlight__hljs-string___1SffY\">\"q\"</span>,<span class=\"highlight__hljs-string___1SffY\">\"*:*\"</span>),(<span class=\"highlight__hljs-string___1SffY\">\"shards\"</span>,<span class=\"highlight__hljs-string___1SffY\">\"127.0.0.1:8093/solr/my_index\"</span>),(<span class=\"highlight__hljs-string___1SffY\">\"wt\"</span>,<span class=\"highlight__hljs-string___1SffY\">\"json\"</span>)])}, response = <span class=\"highlight__hljs-type___11WfV\">Results</span> {numFound = <span class=\"highlight__hljs-number___2gmaH\">2</span>, start = <span class=\"highlight__hljs-number___2gmaH\">0</span>, maxScore = <span class=\"highlight__hljs-number___2gmaH\">1.0</span>, docs = [<span class=\"highlight__hljs-type___11WfV\">Docs</span> {_yz_id = <span class=\"highlight__hljs-string___1SffY\">\"data_my_bucket_name_11\"</span>, _yz_rk = <span class=\"highlight__hljs-string___1SffY\">\"name\"</span>, _yz_rt = <span class=\"highlight__hljs-string___1SffY\">\"data\"</span>, _yz_rb = <span class=\"highlight__hljs-string___1SffY\">\"my_bucket\"</span>},<span class=\"highlight__hljs-type___11WfV\">Docs</span> {_yz_id = <span class=\"highlight__hljs-string___1SffY\">\"data_my_bucket_second_14\"</span>, _yz_rk = <span class=\"highlight__hljs-string___1SffY\">\"second\"</span>, _yz_rt = <span class=\"highlight__hljs-string___1SffY\">\"data\"</span>, _yz_rb = <span class=\"highlight__hljs-string___1SffY\">\"my_bucket\"</span>}]}})\n</code></pre>\n<p>Success!</p>\n<p>This is just a small start. Hopefully I’ll be able to build this out a bit more\n(two changes of note will be usage of <code>http-streams</code> and <code>Lens</code>) and write a\nsnaplet that integrates well with <a href=\"https://github.com/ChristopherBiscardi/snaplet-riak-2\">this Riak\nSnaplet</a> in a more\ngeneric fashion.</p>\n","attributes":{"title":"In Search of a Riak Solr Client for Haskell","updatedAt":"Feb 1st, 2014","publishedAt":"Feb 1st, 2014","timeToRead":5,"headerImage":null,"url":"/2014/2/1/in-search-of-a-riak-solr-client-for-haskell/","canonicalURL":null,"excerpt":"In this post are the beginnings of riak-solr-client.","__typename":"BlogPostAttributes"},"__typename":"BlogPost"},"__typename":"Query"}}}