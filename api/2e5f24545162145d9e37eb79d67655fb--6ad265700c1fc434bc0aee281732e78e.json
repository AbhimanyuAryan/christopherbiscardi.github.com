{"data":{"root":{"post":{"body":"<p>In this post we will go over how to set up the sample project for Robolectric,\nrun, test and deploy to a device in a headless vagrant environment.</p>\n<h2 id=\"sample-app\">Sample App</h2>\n<p>Clone the sample app from the <a href=\"https://github.com/robolectric/RobolectricSample\">github\nrepo</a></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>git clone git@github.com:robolectric/RobolectricSample.git\n</code></pre>\n<h2 id=\"vagrantfile\">Vagrantfile</h2>\n<p>Here is our Vagrantfile. We’ll need to add the <code>precise64</code> base box to our\nsystem. also availible as a\n<a href=\"https://gist.github.com/ChristopherBiscardi/9383725\">Gist</a></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>vagrant box add precise64 http://files.vagrantup.com/precise64.box\n</code></pre>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\"># -*- mode: ruby -*-</span>\n<span class=\"highlight__hljs-comment___UYk12\"># vi: set ft=ruby :</span>\n\n<span class=\"highlight__hljs-comment___UYk12\"># Vagrantfile API/syntax version. Don't touch unless you know what you're doing!</span>\nVAGRANTFILE_API_VERSION = <span class=\"highlight__hljs-string___1SffY\">\"2\"</span>\n\nVagrant.configure(VAGRANTFILE_API_VERSION) <span class=\"highlight__hljs-keyword___som98\">do</span> <span class=\"hljs-params\">|config|</span>\n  config.vm.box = <span class=\"highlight__hljs-string___1SffY\">\"precise64\"</span>\n  config.vm.provision <span class=\"highlight__hljs-string___1SffY\">\"shell\"</span>, <span class=\"highlight__hljs-symbol___mdaTG\">path:</span> <span class=\"highlight__hljs-string___1SffY\">\"vagrant-android-build.sh\"</span>\n  config.vm.provider <span class=\"highlight__hljs-symbol___mdaTG\">:virtualbox</span> <span class=\"highlight__hljs-keyword___som98\">do</span> <span class=\"hljs-params\">|vb|</span>\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'modifyvm'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--usb'</span>, <span class=\"highlight__hljs-string___1SffY\">'on'</span>]\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'usbfilter'</span>, <span class=\"highlight__hljs-string___1SffY\">'add'</span>, <span class=\"highlight__hljs-string___1SffY\">'0'</span>, <span class=\"highlight__hljs-string___1SffY\">'--target'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--name'</span>, <span class=\"highlight__hljs-string___1SffY\">'1197123b'</span>, <span class=\"highlight__hljs-string___1SffY\">'--vendorid'</span>, <span class=\"highlight__hljs-string___1SffY\">'0x04e8'</span>]\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'usbfilter'</span>, <span class=\"highlight__hljs-string___1SffY\">'add'</span>, <span class=\"highlight__hljs-string___1SffY\">'0'</span>, <span class=\"highlight__hljs-string___1SffY\">'--target'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--name'</span>, <span class=\"highlight__hljs-string___1SffY\">'android'</span>, <span class=\"highlight__hljs-string___1SffY\">'--vendorid'</span>, <span class=\"highlight__hljs-string___1SffY\">'0x18d1'</span>]\n  <span class=\"highlight__hljs-keyword___som98\">end</span>\n<span class=\"highlight__hljs-keyword___som98\">end</span>\n</code></pre>\n<p>and the Vagrant build script. The build script downloads and installs ADT and\nMaven.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>apt-get update -y\napt-get install openjdk-7-jdk unzip -y\n<span class=\"highlight__hljs-comment___UYk12\"># For maven-plugin</span>\napt-get install lib32z1-dev bison flex lib32ncurses5-dev libx11-dev gperf g++-multilib -y\n<span class=\"highlight__hljs-comment___UYk12\"># Setup Android SDK</span>\nsudo -u vagrant wget http://dl.google.com/android/adt/adt-bundle-linux-x86_64-20131030.zip\nsudo -u vagrant unzip adt-bundle-linux-x86_64-20131030.zip\n<span class=\"highlight__hljs-comment___UYk12\"># Add Android SDK to PATH</span>\nsudo -u vagrant <span class=\"highlight__hljs-built_in___3uuyR\">echo</span> <span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/tools:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span> &gt;&gt; /home/vagrant/.bashrc\nsudo -u vagrant <span class=\"highlight__hljs-built_in___3uuyR\">echo</span> <span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/platform-tools:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span> &gt;&gt; /home/vagrant/.bashrc\n\n<span class=\"highlight__hljs-comment___UYk12\"># Maven</span>\nsudo -u vagrant wget http://download.nextag.com/apache/maven/maven-3/3.2.1/binaries/apache-maven-3.2.1-bin.tar.gz\nsudo -u vagrant tar -xvzf apache-maven-3.2.1-bin.tar.gz\n<span class=\"highlight__hljs-comment___UYk12\"># Add Maven to PATH</span>\nsudo -u vagrant <span class=\"highlight__hljs-built_in___3uuyR\">echo</span> <span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/apache-maven-3.2.1/bin:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span> &gt;&gt; /home/vagrant/.bashrc\n\n<span class=\"highlight__hljs-comment___UYk12\"># Install API 16 (sample project needs it)</span>\n<span class=\"highlight__hljs-comment___UYk12\"># echo \"y\" is a hack to accept the license</span>\nsudo -u vagrant <span class=\"highlight__hljs-built_in___3uuyR\">echo</span> <span class=\"highlight__hljs-string___1SffY\">\"y\"</span> | /home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/tools/android update sdk -t 6 --no-ui -y\n<span class=\"highlight__hljs-comment___UYk12\"># ANDROID_HOME is for Maven</span>\nsudo -u vagrant <span class=\"highlight__hljs-built_in___3uuyR\">echo</span> <span class=\"highlight__hljs-built_in___3uuyR\">export</span> ANDROID_HOME=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/ &gt;&gt; /home/vagrant/.bashrc\n</code></pre>\n<h2 id=\"path-and-android-home\">Path and ANDROID_HOME</h2>\n<p>We need a few thing on our path, all of which are included in our Vagrant build\nscript (Android tools, Android platform-tools, Maven and ANDROID_HOME)</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/tools:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span>\n<span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/platform-tools:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span>\n<span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/apache-maven-3.2.1/bin:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span>\n<span class=\"highlight__hljs-built_in___3uuyR\">export</span> ANDROID_HOME=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/\n</code></pre>\n<h2 id=\"vagrant-up\">Vagrant Up</h2>\n<p>Simply copy the <code>Vagrantfile</code> and <code>vagrant-android-build.sh</code> into the sample\nproject’s root folder. Then <code>cd</code> into that folder and run <code>vagrant up</code> to boot\nthe machine. If you don’t have Vagrant and VirtualBox,\n<a href=\"http://www.vagrantup.com/\">here</a> and <a href=\"https://www.virtualbox.org/\">here</a> are\nthe respective links.</p>\n<p>Note that it may be necessary to run the command to update the Android SDK\nmanually due to the licenses.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>vagrant ssh\nandroid update sdk -t 6 --no-ui -y\n</code></pre>\n<h2 id=\"running-the-tests\">Running the Tests</h2>\n<p>We can run the tests inside the vm using maven:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>vagrant ssh\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> /vagrant\nmvn clean <span class=\"highlight__hljs-built_in___3uuyR\">test</span>\n</code></pre>\n<p>Which will give us output that looks like this:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>Results :\n\nTests run: 87, Failures: 0, Errors: 0, Skipped: 0\n\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time: 28.917 s\n[INFO] Finished at: 2014-03-06T06:19:39+00:00\n[INFO] Final Memory: 23M/57M\n[INFO] ------------------------------------------------------------------------\n</code></pre>\n<p>Run <code>exit</code> to get out of the vm.</p>\n<h2 id=\"connecting-test-devices-to-the-vm\">Connecting Test Devices to the VM</h2>\n<p>With <code>VBoxManage</code> and devices connected, we can allow (all?) of them using the\nfollowing <code>usbfilter</code> in our <code>Vagrantfile</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>config.vm.provider <span class=\"highlight__hljs-symbol___mdaTG\">:virtualbox</span> <span class=\"highlight__hljs-keyword___som98\">do</span> <span class=\"hljs-params\">|vb|</span>\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'modifyvm'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--usb'</span>, <span class=\"highlight__hljs-string___1SffY\">'on'</span>]\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'usbfilter'</span>, <span class=\"highlight__hljs-string___1SffY\">'add'</span>, <span class=\"highlight__hljs-string___1SffY\">'0'</span>, <span class=\"highlight__hljs-string___1SffY\">'--target'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--name'</span>, <span class=\"highlight__hljs-string___1SffY\">'android'</span>, <span class=\"highlight__hljs-string___1SffY\">'--vendorid'</span>, <span class=\"highlight__hljs-string___1SffY\">'0x18d1'</span>]\n  <span class=\"highlight__hljs-keyword___som98\">end</span>\n</code></pre>\n<p>Alternatively, we can list all connected usbhosts and select a specific device\nas such:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>VBoxManage list usbhost\n</code></pre>\n<p>Which gives us a list of these:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>UUID:               6316e123-b702-4155-9703-c2015d014237\nVendorId:           0x18d1 (18D1)\nProductId:          0xd002 (D002)\nRevision:           2.40 (0240)\nPort:               6\nUSB version/speed:  0/2\nManufacturer:       asus\nProduct:            Nexus 7\nSerialNumber:       07d99c71\nAddress:            p=0xd002;v=0x18d1;s=0x000000006321cfbd;l=0x20260000\nCurrent State:      Busy\n</code></pre>\n<p>Find your Android device and use these parameters to change our Vagrantfile:</p>\n<p>SerialNumber -&gt; –name\nVendorId -&gt; –vendorid</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>config.vm.provider <span class=\"highlight__hljs-symbol___mdaTG\">:virtualbox</span> <span class=\"highlight__hljs-keyword___som98\">do</span> <span class=\"hljs-params\">|vb|</span>\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'modifyvm'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--usb'</span>, <span class=\"highlight__hljs-string___1SffY\">'on'</span>]\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'usbfilter'</span>, <span class=\"highlight__hljs-string___1SffY\">'add'</span>, <span class=\"highlight__hljs-string___1SffY\">'0'</span>, <span class=\"highlight__hljs-string___1SffY\">'--target'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--name'</span>, <span class=\"highlight__hljs-string___1SffY\">'1197123b'</span>, <span class=\"highlight__hljs-string___1SffY\">'--vendorid'</span>, <span class=\"highlight__hljs-string___1SffY\">'0x04e8'</span>]\n  <span class=\"highlight__hljs-keyword___som98\">end</span>\n</code></pre>\n<p>Remember to <code>vagrant reload</code> after changing network settings in the\n<code>Vagrantfile</code>. Some devices may also need to be unplugged and plugged back in\nfor the VM to see them.</p>\n<h2 id=\"deploying\">Deploying</h2>\n<p>Simply run adb inside the vm to see the connected devices:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>vagrant ssh\nsudo adb devices\n</code></pre>\n<p>If you see an unauthorized message like the one below, it is likely that you\ndidn’t start the adb server as root (which will prevent the RSA authorization\nfrom popping up).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>* daemon not running. starting it now on port 5037 *\n* daemon started successfully *\nList of devices attached\n????????????\tno permissions&lt;/pre&gt;&lt;p&gt;Otherwise we should see a list of devices as below after authorizing the devices when the RSA dialog pops up on each device.&lt;/p&gt;&lt;pre&gt;&lt;code class=<span class=\"highlight__hljs-string___1SffY\">\"&gt;List of devices attached\n07d99c71\tdevice\n2d605528\tdevice\n</span></code></pre>\n<p>We can now install the app on our devices from inside the vm using maven.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">cd</span> /vagrant\nmvn clean install &amp;&amp; mvn android:deploy\n</code></pre>\n<h2 id=\"fin\">Fin</h2>\n<p>That’s it. The app should be installed on your connected devices. It won’t start\nautomatically, but you can navigate to the newly installed <code>Robolectric Sample</code>\napp and start it up.</p>\n","attributes":{"title":"Getting Started with Robolectric: Headless Android Testing with Vagrant","updatedAt":"Mar 8th, 2014","publishedAt":"Mar 8th, 2014","timeToRead":3,"headerImage":null,"url":"/2014/3/8/getting-started-with-robolectric-headless-android-testing-with-vagrant/","canonicalURL":null,"excerpt":"In this post we will go over how to set up the sample project for Robolectric,\nrun, test and deploy to a device in a headless vagrant…","__typename":"BlogPostAttributes"},"__typename":"BlogPost"},"__typename":"Query"}}}