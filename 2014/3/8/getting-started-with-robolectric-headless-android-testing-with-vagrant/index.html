<html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" type="text/css" href="/styles.fb354817e9ba604f47bb6a23702bb15a.css"/></head><body class="landing-page"><div id="react-mount"><div data-reactid=".q7cev7ilwg" data-react-checksum="175415931"><div class="Nav__wrapper___u7BUA" data-reactid=".q7cev7ilwg.0"><nav class="Nav__nav___1e2Pp" data-reactid=".q7cev7ilwg.0.0"><a class="Nav__logoWrapper___35yvY" href="/" data-reactid=".q7cev7ilwg.0.0.0"><img class="Nav__logo___sw4O9" src="/69305db2985e926d498b513a21d28383.png" data-reactid=".q7cev7ilwg.0.0.0.0"/></a><ul class="Nav__items___1oDCD" data-reactid=".q7cev7ilwg.0.0.1"><li data-reactid=".q7cev7ilwg.0.0.1.0"><a class="Nav__itemLink___H6Isv" href="/posts" data-reactid=".q7cev7ilwg.0.0.1.0.0">Posts</a></li><li data-reactid=".q7cev7ilwg.0.0.1.1"><a href="https://github.com/ChristopherBiscardi/ama/issues?q=is%3Aissue+is%3Aclosed" class="Nav__itemLink___H6Isv" data-reactid=".q7cev7ilwg.0.0.1.1.0">AMA</a></li><li data-reactid=".q7cev7ilwg.0.0.1.2"><a class="Nav__itemLink___H6Isv" href="/books" data-reactid=".q7cev7ilwg.0.0.1.2.0">Books</a></li><li data-reactid=".q7cev7ilwg.0.0.1.3"><a class="Nav__itemLink___H6Isv" href="/projects" data-reactid=".q7cev7ilwg.0.0.1.3.0">Projects</a></li></ul></nav></div><div data-reactid=".q7cev7ilwg.1"><div class="Post__container___3xG6t" data-reactid=".q7cev7ilwg.1.0"><div class="Post__singleColumn___3RGaV" data-reactid=".q7cev7ilwg.1.0.0"><h1 class="Post__title___1k3xj" data-reactid=".q7cev7ilwg.1.0.0.0">Getting Started with Robolectric: Headless Android Testing with Vagrant</h1><div class="Post__meta___1jyEB" data-reactid=".q7cev7ilwg.1.0.0.1"><span data-reactid=".q7cev7ilwg.1.0.0.1.0">Mar 8th, 2014</span><span data-reactid=".q7cev7ilwg.1.0.0.1.1"> · </span><span data-reactid=".q7cev7ilwg.1.0.0.1.2">3</span><span data-reactid=".q7cev7ilwg.1.0.0.1.3"> minute read</span></div><div data-reactid=".q7cev7ilwg.1.0.0.2"><p>In this post we will go over how to set up the sample project for Robolectric,
run, test and deploy to a device in a headless vagrant environment.</p>
<h2 id="sample-app">Sample App</h2>
<p>Clone the sample app from the <a href="https://github.com/robolectric/RobolectricSample">github
repo</a></p>
<pre class="hljs"><code>git clone git@github.com:robolectric/RobolectricSample.git
</code></pre>
<h2 id="vagrantfile">Vagrantfile</h2>
<p>Here is our Vagrantfile. We’ll need to add the <code>precise64</code> base box to our
system. also availible as a
<a href="https://gist.github.com/ChristopherBiscardi/9383725">Gist</a></p>
<pre class="hljs"><code>vagrant box add precise64 http://files.vagrantup.com/precise64.box
</code></pre>
<pre class="hljs"><code><span class="hljs-comment"># -*- mode: ruby -*-</span>
<span class="hljs-comment"># vi: set ft=ruby :</span>

<span class="hljs-comment"># Vagrantfile API/syntax version. Don't touch unless you know what you're doing!</span>
VAGRANTFILE_API_VERSION = <span class="hljs-string">"2"</span>

Vagrant.configure(VAGRANTFILE_API_VERSION) <span class="hljs-keyword">do</span> <span class="hljs-params">|config|</span>
  config.vm.box = <span class="hljs-string">"precise64"</span>
  config.vm.provision <span class="hljs-string">"shell"</span>, <span class="hljs-symbol">path:</span> <span class="hljs-string">"vagrant-android-build.sh"</span>
  config.vm.provider <span class="hljs-symbol">:virtualbox</span> <span class="hljs-keyword">do</span> <span class="hljs-params">|vb|</span>
    vb.customize [<span class="hljs-string">'modifyvm'</span>, <span class="hljs-symbol">:id</span>, <span class="hljs-string">'--usb'</span>, <span class="hljs-string">'on'</span>]
    vb.customize [<span class="hljs-string">'usbfilter'</span>, <span class="hljs-string">'add'</span>, <span class="hljs-string">'0'</span>, <span class="hljs-string">'--target'</span>, <span class="hljs-symbol">:id</span>, <span class="hljs-string">'--name'</span>, <span class="hljs-string">'1197123b'</span>, <span class="hljs-string">'--vendorid'</span>, <span class="hljs-string">'0x04e8'</span>]
    vb.customize [<span class="hljs-string">'usbfilter'</span>, <span class="hljs-string">'add'</span>, <span class="hljs-string">'0'</span>, <span class="hljs-string">'--target'</span>, <span class="hljs-symbol">:id</span>, <span class="hljs-string">'--name'</span>, <span class="hljs-string">'android'</span>, <span class="hljs-string">'--vendorid'</span>, <span class="hljs-string">'0x18d1'</span>]
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>and the Vagrant build script. The build script downloads and installs ADT and
Maven.</p>
<pre class="hljs"><code>apt-get update -y
apt-get install openjdk-7-jdk unzip -y
<span class="hljs-comment"># For maven-plugin</span>
apt-get install lib32z1-dev bison flex lib32ncurses5-dev libx11-dev gperf g++-multilib -y
<span class="hljs-comment"># Setup Android SDK</span>
sudo -u vagrant wget http://dl.google.com/android/adt/adt-bundle-linux-x86_64-20131030.zip
sudo -u vagrant unzip adt-bundle-linux-x86_64-20131030.zip
<span class="hljs-comment"># Add Android SDK to PATH</span>
sudo -u vagrant <span class="hljs-built_in">echo</span> <span class="hljs-built_in">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/tools:\<span class="hljs-variable">$PATH</span> &gt;&gt; /home/vagrant/.bashrc
sudo -u vagrant <span class="hljs-built_in">echo</span> <span class="hljs-built_in">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/platform-tools:\<span class="hljs-variable">$PATH</span> &gt;&gt; /home/vagrant/.bashrc

<span class="hljs-comment"># Maven</span>
sudo -u vagrant wget http://download.nextag.com/apache/maven/maven-3/3.2.1/binaries/apache-maven-3.2.1-bin.tar.gz
sudo -u vagrant tar -xvzf apache-maven-3.2.1-bin.tar.gz
<span class="hljs-comment"># Add Maven to PATH</span>
sudo -u vagrant <span class="hljs-built_in">echo</span> <span class="hljs-built_in">export</span> PATH=/home/vagrant/apache-maven-3.2.1/bin:\<span class="hljs-variable">$PATH</span> &gt;&gt; /home/vagrant/.bashrc

<span class="hljs-comment"># Install API 16 (sample project needs it)</span>
<span class="hljs-comment"># echo "y" is a hack to accept the license</span>
sudo -u vagrant <span class="hljs-built_in">echo</span> <span class="hljs-string">"y"</span> | /home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/tools/android update sdk -t 6 --no-ui -y
<span class="hljs-comment"># ANDROID_HOME is for Maven</span>
sudo -u vagrant <span class="hljs-built_in">echo</span> <span class="hljs-built_in">export</span> ANDROID_HOME=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/ &gt;&gt; /home/vagrant/.bashrc
</code></pre>
<h2 id="path-and-android-home">Path and ANDROID_HOME</h2>
<p>We need a few thing on our path, all of which are included in our Vagrant build
script (Android tools, Android platform-tools, Maven and ANDROID_HOME)</p>
<pre class="hljs"><code><span class="hljs-built_in">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/tools:\<span class="hljs-variable">$PATH</span>
<span class="hljs-built_in">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/platform-tools:\<span class="hljs-variable">$PATH</span>
<span class="hljs-built_in">export</span> PATH=/home/vagrant/apache-maven-3.2.1/bin:\<span class="hljs-variable">$PATH</span>
<span class="hljs-built_in">export</span> ANDROID_HOME=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/
</code></pre>
<h2 id="vagrant-up">Vagrant Up</h2>
<p>Simply copy the <code>Vagrantfile</code> and <code>vagrant-android-build.sh</code> into the sample
project’s root folder. Then <code>cd</code> into that folder and run <code>vagrant up</code> to boot
the machine. If you don’t have Vagrant and VirtualBox,
<a href="http://www.vagrantup.com/">here</a> and <a href="https://www.virtualbox.org/">here</a> are
the respective links.</p>
<p>Note that it may be necessary to run the command to update the Android SDK
manually due to the licenses.</p>
<pre class="hljs"><code>vagrant ssh
android update sdk -t 6 --no-ui -y
</code></pre>
<h2 id="running-the-tests">Running the Tests</h2>
<p>We can run the tests inside the vm using maven:</p>
<pre class="hljs"><code>vagrant ssh
<span class="hljs-built_in">cd</span> /vagrant
mvn clean <span class="hljs-built_in">test</span>
</code></pre>
<p>Which will give us output that looks like this:</p>
<pre class="hljs"><code>Results :

Tests run: 87, Failures: 0, Errors: 0, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 28.917 s
[INFO] Finished at: 2014-03-06T06:19:39+00:00
[INFO] Final Memory: 23M/57M
[INFO] ------------------------------------------------------------------------
</code></pre>
<p>Run <code>exit</code> to get out of the vm.</p>
<h2 id="connecting-test-devices-to-the-vm">Connecting Test Devices to the VM</h2>
<p>With <code>VBoxManage</code> and devices connected, we can allow (all?) of them using the
following <code>usbfilter</code> in our <code>Vagrantfile</code></p>
<pre class="hljs"><code>config.vm.provider <span class="hljs-symbol">:virtualbox</span> <span class="hljs-keyword">do</span> <span class="hljs-params">|vb|</span>
    vb.customize [<span class="hljs-string">'modifyvm'</span>, <span class="hljs-symbol">:id</span>, <span class="hljs-string">'--usb'</span>, <span class="hljs-string">'on'</span>]
    vb.customize [<span class="hljs-string">'usbfilter'</span>, <span class="hljs-string">'add'</span>, <span class="hljs-string">'0'</span>, <span class="hljs-string">'--target'</span>, <span class="hljs-symbol">:id</span>, <span class="hljs-string">'--name'</span>, <span class="hljs-string">'android'</span>, <span class="hljs-string">'--vendorid'</span>, <span class="hljs-string">'0x18d1'</span>]
  <span class="hljs-keyword">end</span>
</code></pre>
<p>Alternatively, we can list all connected usbhosts and select a specific device
as such:</p>
<pre class="hljs"><code>VBoxManage list usbhost
</code></pre>
<p>Which gives us a list of these:</p>
<pre class="hljs"><code>UUID:               6316e123-b702-4155-9703-c2015d014237
VendorId:           0x18d1 (18D1)
ProductId:          0xd002 (D002)
Revision:           2.40 (0240)
Port:               6
USB version/speed:  0/2
Manufacturer:       asus
Product:            Nexus 7
SerialNumber:       07d99c71
Address:            p=0xd002;v=0x18d1;s=0x000000006321cfbd;l=0x20260000
Current State:      Busy
</code></pre>
<p>Find your Android device and use these parameters to change our Vagrantfile:</p>
<p>SerialNumber -&gt; –name
VendorId -&gt; –vendorid</p>
<pre class="hljs"><code>config.vm.provider <span class="hljs-symbol">:virtualbox</span> <span class="hljs-keyword">do</span> <span class="hljs-params">|vb|</span>
    vb.customize [<span class="hljs-string">'modifyvm'</span>, <span class="hljs-symbol">:id</span>, <span class="hljs-string">'--usb'</span>, <span class="hljs-string">'on'</span>]
    vb.customize [<span class="hljs-string">'usbfilter'</span>, <span class="hljs-string">'add'</span>, <span class="hljs-string">'0'</span>, <span class="hljs-string">'--target'</span>, <span class="hljs-symbol">:id</span>, <span class="hljs-string">'--name'</span>, <span class="hljs-string">'1197123b'</span>, <span class="hljs-string">'--vendorid'</span>, <span class="hljs-string">'0x04e8'</span>]
  <span class="hljs-keyword">end</span>
</code></pre>
<p>Remember to <code>vagrant reload</code> after changing network settings in the
<code>Vagrantfile</code>. Some devices may also need to be unplugged and plugged back in
for the VM to see them.</p>
<h2 id="deploying">Deploying</h2>
<p>Simply run adb inside the vm to see the connected devices:</p>
<pre class="hljs"><code>vagrant ssh
sudo adb devices
</code></pre>
<p>If you see an unauthorized message like the one below, it is likely that you
didn’t start the adb server as root (which will prevent the RSA authorization
from popping up).</p>
<pre class="hljs"><code>* daemon not running. starting it now on port 5037 *
* daemon started successfully *
List of devices attached
????????????	no permissions&lt;/pre&gt;&lt;p&gt;Otherwise we should see a list of devices as below after authorizing the devices when the RSA dialog pops up on each device.&lt;/p&gt;&lt;pre&gt;&lt;code class=<span class="hljs-string">"&gt;List of devices attached
07d99c71	device
2d605528	device
</span></code></pre>
<p>We can now install the app on our devices from inside the vm using maven.</p>
<pre class="hljs"><code><span class="hljs-built_in">cd</span> /vagrant
mvn clean install &amp;&amp; mvn android:deploy
</code></pre>
<h2 id="fin">Fin</h2>
<p>That’s it. The app should be installed on your connected devices. It won’t start
automatically, but you can navigate to the newly installed <code>Robolectric Sample</code>
app and start it up.</p>
</div></div></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-46878058-1', 'auto');
          ga('send', 'pageview');</script></body></html>