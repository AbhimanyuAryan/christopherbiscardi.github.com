<html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title data-react-helmet="true">Getting Started With Snap (and User Authentication): Part 2</title><meta data-react-helmet="true" property="description" content=""/><meta data-react-helmet="true" property="og:title" content="Getting Started With Snap (and User Authentication): Part 2"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:url" content="http://christopherbiscardi.com/2014/1/9/getting-started-with-snap-and-user-authentication-part-2/"/><meta data-react-helmet="true" property="og:description" content=""/><meta data-react-helmet="true" property="og:image" content="http://christopherbiscardi.comnull"/><meta data-react-helmet="true" property="twitter:card" content="summary"/><meta data-react-helmet="true" property="twitter:title" content="Getting Started With Snap (and User Authentication): Part 2"/><meta data-react-helmet="true" property="twitter:description" content=""/><meta data-react-helmet="true" property="twitter:url" content="http://christopherbiscardi.com/2014/1/9/getting-started-with-snap-and-user-authentication-part-2/"/><link rel="stylesheet" type="text/css" href="/styles.f25bf9e6682280946ba2e441a544b407.css"/></head><body class="landing-page"><div id="content"><div data-reactroot="" data-reactid="1" data-react-checksum="-243587509"><div class="Nav__wrapper___u7BUA" data-reactid="2"><nav class="Nav__nav___1e2Pp" data-reactid="3"><a class="Nav__logoWrapper___35yvY" href="/" data-reactid="4"><img class="Nav__logo___sw4O9" src="/69305db2985e926d498b513a21d28383.png" data-reactid="5"/></a><ul class="Nav__items___1oDCD" data-reactid="6"><li data-reactid="7"><a class="Nav__itemLink___H6Isv" href="/posts/" data-reactid="8">Posts</a></li><li data-reactid="9"><a href="https://github.com/ChristopherBiscardi/ama/issues?q=is%3Aissue+is%3Aclosed" class="Nav__itemLink___H6Isv" data-reactid="10">AMA</a></li><li data-reactid="11"><a class="Nav__itemLink___H6Isv" href="/books/" data-reactid="12">Books</a></li><li data-reactid="13"><a class="Nav__itemLink___H6Isv" href="/projects/" data-reactid="14">Projects</a></li><li data-reactid="15"><a class="Nav__itemLink___H6Isv" href="/about/" data-reactid="16">About</a></li></ul></nav></div><div data-reactid="17"><div class="Post__page___15ves" data-reactid="18"><!-- react-empty: 19 --><div class="Post__container___f_rKX" data-reactid="20"><div class="Post__singleColumn___tYK8R" data-reactid="21"><h1 class="Post__title___2I6DZ" data-reactid="22">Getting Started With Snap (and User Authentication): Part 2</h1><div class="Post__meta___1fVoc" data-reactid="23"><!-- react-text: 24 -->Jan 10th, 2014<!-- /react-text --><!-- react-text: 25 --> · <!-- /react-text --><!-- react-text: 26 -->3<!-- /react-text --><!-- react-text: 27 --> minute read<!-- /react-text --></div></div></div><div class="Post__container___f_rKX" data-reactid="28"><div class="Post__singleColumn___tYK8R" data-reactid="29"><div data-reactid="30"><p><a href="http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611521/CBLogo_2014_transparent_swcmig.png"><img src="http://res.cloudinary.com/diqzbm8lz/image/upload/h_300,w_300/v1428611521/CBLogo_2014_transparent_swcmig.png" alt="CBLogo_2014_transparent"></a></p>
<p><a href="https://github.com/ChristopherBiscardi/Getting-Started-with-Snap-and-User-Authentication">Git Repo</a>
<a href="http://www.christopherbiscardi.com/2014/01/07/getting-started-with-snap-and-user-authentication-part-1/">part 1</a></p>
<p>The file structure now looks like this:</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code>  - abc.cabal
  - log/
     - access.log
     - error.log
  - snaplets/
     - heist/
        - templates/
           - _login.tpl
           - _new_user.tpl
           - base.tpl
           - index.tpl
           - login.tpl
           - new_user.tpl
           - userform.tpl
  - src/
     - Application.hs
     - Main.hs
     - Site.hs
  - static/
     - screen.css
</code></pre>
<p><code>abc.cabal</code> includes our dependencies and build information. This file is read
when we run <code>cabal install</code></p>
<p><code>log</code> includes two files that log out what browsers <code>access</code> the site and what
<code>error</code>s occur.</p>
<p><code>snaplets</code> is where our snaplets store their files. In this case we only have
<code>heist</code> there, which contains a <code>templates</code> folder that includes the templates
we use to render the site.</p>
<p><code>static</code> includes a simple stylesheet that is served when we visit the site.</p>
<p><code>src</code> is the folder we’re currently concerned with. It includes three files:</p>
<h5 id="mainhs">Main.hs</h5>
<p>This file contains some boilerplate for dynamic recompilation of a snap site.
We’ll be leaving this file alone.</p>
<h5 id="applicationhs">Application.hs</h5>
<p>Here we define our App datatype with the snaplets we will be using.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-class___mOeOV"><span class="highlight__hljs-keyword___som98">data</span> <span class="highlight__hljs-type___11WfV">App</span> = <span class="highlight__hljs-type___11WfV">App</span></span>
    { _heist :: <span class="highlight__hljs-type___11WfV">Snaplet</span> (<span class="highlight__hljs-type___11WfV">Heist</span> <span class="highlight__hljs-type___11WfV">App</span>)
    , _sess :: <span class="highlight__hljs-type___11WfV">Snaplet</span> <span class="highlight__hljs-type___11WfV">SessionManager</span>
    , _auth :: <span class="highlight__hljs-type___11WfV">Snaplet</span> (<span class="highlight__hljs-type___11WfV">AuthManager</span> <span class="highlight__hljs-type___11WfV">App</span>)
    }
</code></pre>
<p>In this case we are using <code>heist</code>, <code>sessions</code> and <code>authentication</code>.</p>
<p>Then we make a call to <code>makeLenses</code></p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code>makeLenses ''App
</code></pre>
<p><code>makeLenses</code> does some things under the hood like creating getters/setters and
changing the names for the snaplets in our app to remove the underscore. This
means that <code>_auth</code> will be referred to as <code>auth</code> in the rest of our app,
including in <code>src/Site.hs</code>.</p>
<p>We then define an instance for the Heist Snaplet so we don’t have to use <code>with heist</code> every time we want to render a template (More about this later).</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-class___mOeOV"><span class="highlight__hljs-keyword___som98">instance</span> <span class="highlight__hljs-type___11WfV">HasHeist</span> <span class="highlight__hljs-type___11WfV">App</span> <span class="highlight__hljs-keyword___som98">where</span></span>
    heistLens = subSnaplet heist
</code></pre>
<p>and finally we declare a type alias so that we can use <code>AppHandler</code> instead of
the longer <code>Handler App App</code> in the type signatures for our routes.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code>type AppHandler = Handler App App
</code></pre>
<h5 id="sitehs">Site.hs</h5>
<p>This is where the meat of our site lives. The routing code, handlers and
initialization for the entire app.</p>
<p>The first route is <code>&quot;/login&quot;</code> which uses <code>handleLoginSubmit</code>.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code>(&quot;/login&quot;,    with auth handleLoginSubmit)
</code></pre>
<p><code>with auth</code> lets us work in the auth Snaplet for <code>handleLoginSubmit</code>.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-title___1fl8Q">handleLoginSubmit</span> :: <span class="highlight__hljs-type___11WfV">Handler</span> <span class="highlight__hljs-type___11WfV">App</span> (<span class="highlight__hljs-type___11WfV">AuthManager</span> <span class="highlight__hljs-type___11WfV">App</span>) ()
<span class="highlight__hljs-title___1fl8Q">handleLoginSubmit</span> =
    loginUser <span class="highlight__hljs-string___1SffY">"login"</span> <span class="highlight__hljs-string___1SffY">"password"</span> <span class="highlight__hljs-type___11WfV">Nothing</span>
              (_ -&gt; handleLogin err) (redirect <span class="highlight__hljs-string___1SffY">"/"</span>)
  <span class="highlight__hljs-keyword___som98">where</span>
    err = <span class="highlight__hljs-type___11WfV">Just</span> <span class="highlight__hljs-string___1SffY">"Unknown user or password"</span>
</code></pre>
<p>Since we’re working in the auth Snaplet our type signature for the handler has
the type <code>Handler App (AuthManager App) ()</code>, which is slightly different from
the type we aliased in <code>Application.hs</code>.</p>
<p><code>loginUser</code> is a function from the auth snaplet. It takes the <code>username</code> field
and the <code>password</code> field from a form submission, a “remember” field, a failure
function and a success function, in that order. The type signature looks like
this:</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-title___1fl8Q">loginUser</span>
  :: <span class="highlight__hljs-type___11WfV">ByteString</span> <span class="highlight__hljs-comment___UYk12">-- name of username field</span>
     -&gt; <span class="highlight__hljs-type___11WfV">ByteString</span> <span class="highlight__hljs-comment___UYk12">-- name of password field</span>
     -&gt; <span class="highlight__hljs-type___11WfV">Maybe</span> <span class="highlight__hljs-type___11WfV">ByteString</span> <span class="highlight__hljs-comment___UYk12">-- name of remember field (`Nothing` means there isn't one)</span>
     -&gt; (<span class="highlight__hljs-type___11WfV">AuthFailure</span> -&gt; <span class="highlight__hljs-type___11WfV">Handler</span> b (<span class="highlight__hljs-type___11WfV">AuthManager</span> b) ()) <span class="highlight__hljs-comment___UYk12">-- failure function</span>
     -&gt; <span class="highlight__hljs-type___11WfV">Handler</span> b (<span class="highlight__hljs-type___11WfV">AuthManager</span> b) () <span class="highlight__hljs-comment___UYk12">-- success function</span>
     -&gt; <span class="highlight__hljs-type___11WfV">Handler</span> b (<span class="highlight__hljs-type___11WfV">AuthManager</span> b) () <span class="highlight__hljs-comment___UYk12">-- return value is a handler</span>
</code></pre>
<p>So going back to <code>handleLoginSubmit</code> we use:
<code>&quot;login&quot;</code> as the username field
<code>&quot;password&quot;</code> as the password field
<code>Nothing</code> as the remember field
<code>_ -&gt; handleLogin err</code> as our error function
and <code>redirect &quot;/&quot;</code> as our success function.</p>
<p><code>err</code> is defined as <code>Just &quot;Unknown user or password&quot;</code> which matches up with the
type from <code>handleLogin</code>.</p>
<p>The <code>handleLogin</code> code will be covered in a Heist tutorial at another time, but
suffice it to say that <code>handleLogin</code> is rendering the login form with the error
that we’ve supplied it (which is “Unknown user or password”).</p>
<p>Our <code>&quot;/logout&quot;</code> route is pretty simple. Just call the snaplet-auth supplied
function <code>logout</code> and redirect to <code>&quot;/&quot;</code></p>
<p><code>&quot;/new_user&quot;</code> does a similar thing, except it displays the empty form on <code>GET</code>
request and handles a form submit on <code>POST</code>.</p>
<p>Next we’ll replace the backend, currently a json file, with postgres.</p>
</div></div></div></div></div></div></div><script charset="UTF-8">window.__APOLLO_STATE__={"apollo":{"data":{"$ROOT_QUERY.root.post({\"slug\":\"getting-started-with-snap-and-user-authentication-part-2\"})":{"body":"<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611521/CBLogo_2014_transparent_swcmig.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/h_300,w_300/v1428611521/CBLogo_2014_transparent_swcmig.png\" alt=\"CBLogo_2014_transparent\"></a></p>\n<p><a href=\"https://github.com/ChristopherBiscardi/Getting-Started-with-Snap-and-User-Authentication\">Git Repo</a>\n<a href=\"http://www.christopherbiscardi.com/2014/01/07/getting-started-with-snap-and-user-authentication-part-1/\">part 1</a></p>\n<p>The file structure now looks like this:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>  - abc.cabal\n  - log/\n     - access.log\n     - error.log\n  - snaplets/\n     - heist/\n        - templates/\n           - _login.tpl\n           - _new_user.tpl\n           - base.tpl\n           - index.tpl\n           - login.tpl\n           - new_user.tpl\n           - userform.tpl\n  - src/\n     - Application.hs\n     - Main.hs\n     - Site.hs\n  - static/\n     - screen.css\n</code></pre>\n<p><code>abc.cabal</code> includes our dependencies and build information. This file is read\nwhen we run <code>cabal install</code></p>\n<p><code>log</code> includes two files that log out what browsers <code>access</code> the site and what\n<code>error</code>s occur.</p>\n<p><code>snaplets</code> is where our snaplets store their files. In this case we only have\n<code>heist</code> there, which contains a <code>templates</code> folder that includes the templates\nwe use to render the site.</p>\n<p><code>static</code> includes a simple stylesheet that is served when we visit the site.</p>\n<p><code>src</code> is the folder we’re currently concerned with. It includes three files:</p>\n<h5 id=\"mainhs\">Main.hs</h5>\n<p>This file contains some boilerplate for dynamic recompilation of a snap site.\nWe’ll be leaving this file alone.</p>\n<h5 id=\"applicationhs\">Application.hs</h5>\n<p>Here we define our App datatype with the snaplets we will be using.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">App</span> = <span class=\"highlight__hljs-type___11WfV\">App</span></span>\n    { _heist :: <span class=\"highlight__hljs-type___11WfV\">Snaplet</span> (<span class=\"highlight__hljs-type___11WfV\">Heist</span> <span class=\"highlight__hljs-type___11WfV\">App</span>)\n    , _sess :: <span class=\"highlight__hljs-type___11WfV\">Snaplet</span> <span class=\"highlight__hljs-type___11WfV\">SessionManager</span>\n    , _auth :: <span class=\"highlight__hljs-type___11WfV\">Snaplet</span> (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> <span class=\"highlight__hljs-type___11WfV\">App</span>)\n    }\n</code></pre>\n<p>In this case we are using <code>heist</code>, <code>sessions</code> and <code>authentication</code>.</p>\n<p>Then we make a call to <code>makeLenses</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>makeLenses ''App\n</code></pre>\n<p><code>makeLenses</code> does some things under the hood like creating getters/setters and\nchanging the names for the snaplets in our app to remove the underscore. This\nmeans that <code>_auth</code> will be referred to as <code>auth</code> in the rest of our app,\nincluding in <code>src/Site.hs</code>.</p>\n<p>We then define an instance for the Heist Snaplet so we don’t have to use <code>with heist</code> every time we want to render a template (More about this later).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">HasHeist</span> <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n    heistLens = subSnaplet heist\n</code></pre>\n<p>and finally we declare a type alias so that we can use <code>AppHandler</code> instead of\nthe longer <code>Handler App App</code> in the type signatures for our routes.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>type AppHandler = Handler App App\n</code></pre>\n<h5 id=\"sitehs\">Site.hs</h5>\n<p>This is where the meat of our site lives. The routing code, handlers and\ninitialization for the entire app.</p>\n<p>The first route is <code>&quot;/login&quot;</code> which uses <code>handleLoginSubmit</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>(&quot;/login&quot;,    with auth handleLoginSubmit)\n</code></pre>\n<p><code>with auth</code> lets us work in the auth Snaplet for <code>handleLoginSubmit</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">handleLoginSubmit</span> :: <span class=\"highlight__hljs-type___11WfV\">Handler</span> <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> <span class=\"highlight__hljs-type___11WfV\">App</span>) ()\n<span class=\"highlight__hljs-title___1fl8Q\">handleLoginSubmit</span> =\n    loginUser <span class=\"highlight__hljs-string___1SffY\">\"login\"</span> <span class=\"highlight__hljs-string___1SffY\">\"password\"</span> <span class=\"highlight__hljs-type___11WfV\">Nothing</span>\n              (_ -&gt; handleLogin err) (redirect <span class=\"highlight__hljs-string___1SffY\">\"/\"</span>)\n  <span class=\"highlight__hljs-keyword___som98\">where</span>\n    err = <span class=\"highlight__hljs-type___11WfV\">Just</span> <span class=\"highlight__hljs-string___1SffY\">\"Unknown user or password\"</span>\n</code></pre>\n<p>Since we’re working in the auth Snaplet our type signature for the handler has\nthe type <code>Handler App (AuthManager App) ()</code>, which is slightly different from\nthe type we aliased in <code>Application.hs</code>.</p>\n<p><code>loginUser</code> is a function from the auth snaplet. It takes the <code>username</code> field\nand the <code>password</code> field from a form submission, a “remember” field, a failure\nfunction and a success function, in that order. The type signature looks like\nthis:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">loginUser</span>\n  :: <span class=\"highlight__hljs-type___11WfV\">ByteString</span> <span class=\"highlight__hljs-comment___UYk12\">-- name of username field</span>\n     -&gt; <span class=\"highlight__hljs-type___11WfV\">ByteString</span> <span class=\"highlight__hljs-comment___UYk12\">-- name of password field</span>\n     -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">ByteString</span> <span class=\"highlight__hljs-comment___UYk12\">-- name of remember field (`Nothing` means there isn't one)</span>\n     -&gt; (<span class=\"highlight__hljs-type___11WfV\">AuthFailure</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">Handler</span> b (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> b) ()) <span class=\"highlight__hljs-comment___UYk12\">-- failure function</span>\n     -&gt; <span class=\"highlight__hljs-type___11WfV\">Handler</span> b (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> b) () <span class=\"highlight__hljs-comment___UYk12\">-- success function</span>\n     -&gt; <span class=\"highlight__hljs-type___11WfV\">Handler</span> b (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> b) () <span class=\"highlight__hljs-comment___UYk12\">-- return value is a handler</span>\n</code></pre>\n<p>So going back to <code>handleLoginSubmit</code> we use:\n<code>&quot;login&quot;</code> as the username field\n<code>&quot;password&quot;</code> as the password field\n<code>Nothing</code> as the remember field\n<code>_ -&gt; handleLogin err</code> as our error function\nand <code>redirect &quot;/&quot;</code> as our success function.</p>\n<p><code>err</code> is defined as <code>Just &quot;Unknown user or password&quot;</code> which matches up with the\ntype from <code>handleLogin</code>.</p>\n<p>The <code>handleLogin</code> code will be covered in a Heist tutorial at another time, but\nsuffice it to say that <code>handleLogin</code> is rendering the login form with the error\nthat we’ve supplied it (which is “Unknown user or password”).</p>\n<p>Our <code>&quot;/logout&quot;</code> route is pretty simple. Just call the snaplet-auth supplied\nfunction <code>logout</code> and redirect to <code>&quot;/&quot;</code></p>\n<p><code>&quot;/new_user&quot;</code> does a similar thing, except it displays the empty form on <code>GET</code>\nrequest and handles a form submit on <code>POST</code>.</p>\n<p>Next we’ll replace the backend, currently a json file, with postgres.</p>\n","attributes":{"type":"id","id":"$ROOT_QUERY.root.post({\"slug\":\"getting-started-with-snap-and-user-authentication-part-2\"}).attributes","generated":true},"__typename":"BlogPost"},"$ROOT_QUERY.root.post({\"slug\":\"getting-started-with-snap-and-user-authentication-part-2\"}).attributes":{"title":"Getting Started With Snap (and User Authentication): Part 2","updatedAt":"Jan 10th, 2014","publishedAt":"Jan 10th, 2014","timeToRead":3,"headerImage":null,"url":"/2014/1/9/getting-started-with-snap-and-user-authentication-part-2/","canonicalURL":null,"excerpt":"","__typename":"BlogPostAttributes"},"$ROOT_QUERY.root":{"post({\"slug\":\"getting-started-with-snap-and-user-authentication-part-2\"})":{"type":"id","id":"$ROOT_QUERY.root.post({\"slug\":\"getting-started-with-snap-and-user-authentication-part-2\"})","generated":true},"__typename":"Query"},"ROOT_QUERY":{"root":{"type":"id","id":"$ROOT_QUERY.root","generated":true}}}}};</script><script src="/js/client.js" charset="UTF-8"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-46878058-1', 'auto');
          ga('send', 'pageview');</script></body></html>