<html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" type="text/css" href="/styles.fb354817e9ba604f47bb6a23702bb15a.css"/></head><body class="landing-page"><div id="react-mount"><div data-reactid=".1wjeb2fo3sw" data-react-checksum="-1469480032"><div class="Nav__wrapper___u7BUA" data-reactid=".1wjeb2fo3sw.0"><nav class="Nav__nav___1e2Pp" data-reactid=".1wjeb2fo3sw.0.0"><a class="Nav__logoWrapper___35yvY" href="/" data-reactid=".1wjeb2fo3sw.0.0.0"><img class="Nav__logo___sw4O9" src="/69305db2985e926d498b513a21d28383.png" data-reactid=".1wjeb2fo3sw.0.0.0.0"/></a><ul class="Nav__items___1oDCD" data-reactid=".1wjeb2fo3sw.0.0.1"><li data-reactid=".1wjeb2fo3sw.0.0.1.0"><a class="Nav__itemLink___H6Isv" href="/posts" data-reactid=".1wjeb2fo3sw.0.0.1.0.0">Posts</a></li><li data-reactid=".1wjeb2fo3sw.0.0.1.1"><a href="https://github.com/ChristopherBiscardi/ama/issues?q=is%3Aissue+is%3Aclosed" class="Nav__itemLink___H6Isv" data-reactid=".1wjeb2fo3sw.0.0.1.1.0">AMA</a></li><li data-reactid=".1wjeb2fo3sw.0.0.1.2"><a class="Nav__itemLink___H6Isv" href="/books" data-reactid=".1wjeb2fo3sw.0.0.1.2.0">Books</a></li><li data-reactid=".1wjeb2fo3sw.0.0.1.3"><a class="Nav__itemLink___H6Isv" href="/projects" data-reactid=".1wjeb2fo3sw.0.0.1.3.0">Projects</a></li></ul></nav></div><div data-reactid=".1wjeb2fo3sw.1"><div class="Post__container___3xG6t" data-reactid=".1wjeb2fo3sw.1.0"><div class="Post__singleColumn___3RGaV" data-reactid=".1wjeb2fo3sw.1.0.0"><h1 class="Post__title___1k3xj" data-reactid=".1wjeb2fo3sw.1.0.0.0">GeoSpatial Indexing with Riak Search 2.0 (Yokozuna/Solr)</h1><div class="Post__meta___1jyEB" data-reactid=".1wjeb2fo3sw.1.0.0.1"><span data-reactid=".1wjeb2fo3sw.1.0.0.1.0">Feb 7th, 2014</span><span data-reactid=".1wjeb2fo3sw.1.0.0.1.1"> · </span><span data-reactid=".1wjeb2fo3sw.1.0.0.1.2">7</span><span data-reactid=".1wjeb2fo3sw.1.0.0.1.3"> minute read</span></div><div data-reactid=".1wjeb2fo3sw.1.0.0.2"><p>In this post we will be using curl to construct a geospatial index using Riak
Search 2 (also known as Yokozuna) which is backed by Solr.</p>
<p>I’ll be using <a href="http://docs.basho.com/riak/2.0.0pre11/downloads/">Riak Pre11</a> for
this.</p>
<p>In <code>etc/riak.conf</code> change <code>search</code> to <code>on</code>:
(It was on line 411 for me)</p>
<pre class="hljs"><code>search = on
</code></pre>
<p>Make sure your <code>ulimit</code> is 4096 or greater:</p>
<pre class="hljs"><code><span class="hljs-built_in">ulimit</span> -n 4096
</code></pre>
<p>Then start Riak. I’m using <code>console</code> myself, but <code>start</code> would also work.</p>
<pre class="hljs"><code>./bin/riak console
</code></pre>
<h2 id="creating-a-schema">Creating a Schema</h2>
<p>Let’s create a schema so that Solr indexes our data correctly (file available
<a href="https://gist.github.com/ChristopherBiscardi/8876815">here</a>):</p>
<pre class="hljs"><code><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"geotest"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"1.5"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">uniqueKey</span>&gt;</span>_yz_id
  <span class="hljs-tag">&lt;<span class="hljs-name">fields</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"loc"</span>  <span class="hljs-attr">type</span>=<span class="hljs-string">"location_rpt"</span>  <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"true"</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- Begin Yokozuna Fields --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_id"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">required</span>=<span class="hljs-string">"true"</span> /&gt;</span>

   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text_ws"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">multiValued</span>=<span class="hljs-string">"true"</span>/&gt;</span>

   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_version_"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"long"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"true"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Entropy Data: Data related to anti-entropy --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_ed"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"false"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Partition Number: Used as a filter query param --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_pn"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"false"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- First Partition Number: The first partition in this doc's
        preflist, used for further filtering on overlapping partitions. --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_fpn"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"false"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- If there is a sibling, use vtag to differentiate them --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_vtag"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"false"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Node: The name of the node that this doc was created on. --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_node"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"false"</span>/&gt;</span>

   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_rt"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"true"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Riak Bucket: The bucket of the Riak object this doc corresponds to. --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_rb"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"true"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Riak Key: The key of the Riak object this doc corresponds to. --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_rk"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"true"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Node: Stores a flag if this doc is the product of a failed object extration --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_err"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"false"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">fields</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">types</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"location_rpt"</span>   <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.SpatialRecursivePrefixTreeFieldType"</span>
	               <span class="hljs-attr">spatialContextFactory</span>=<span class="hljs-string">"com.spatial4j.core.context.jts.JtsSpatialContextFactory"</span>
	               <span class="hljs-attr">distErrPct</span>=<span class="hljs-string">"0.025"</span>
	               <span class="hljs-attr">maxDistErr</span>=<span class="hljs-string">"0.000009"</span>
	               <span class="hljs-attr">units</span>=<span class="hljs-string">"degrees"</span>
	            /&gt;</span>
    <span class="hljs-comment">&lt;!-- since fields of this type are by default not stored or indexed,
         any data added to them will be ignored outright.  --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldtype</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ignored"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">multiValued</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.StrField"</span> /&gt;</span>

    <span class="hljs-comment">&lt;!-- YZ String: Used for non-analyzed fields --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_yz_str"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.StrField"</span> <span class="hljs-attr">sortMissingLast</span>=<span class="hljs-string">"true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"string"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.StrField"</span> <span class="hljs-attr">sortMissingLast</span>=<span class="hljs-string">"true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"boolean"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.BoolField"</span> <span class="hljs-attr">sortMissingLast</span>=<span class="hljs-string">"true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"int"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TrieIntField"</span> <span class="hljs-attr">precisionStep</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"float"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TrieFloatField"</span> <span class="hljs-attr">precisionStep</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"long"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TrieLongField"</span> <span class="hljs-attr">precisionStep</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"double"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TrieDoubleField"</span> <span class="hljs-attr">precisionStep</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"0"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!--
     Numeric field types that index each value at various levels of precision
     to accelerate range queries when the number of values between the range
     endpoints is large. See the javadoc for NumericRangeQuery for internal
     implementation details.

     Smaller precisionStep values (specified in bits) will lead to more tokens
     indexed per value, slightly larger index size, and faster range queries.
     A precisionStep of 0 disables indexing at different precision levels.
    --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"tint"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TrieIntField"</span> <span class="hljs-attr">precisionStep</span>=<span class="hljs-string">"8"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"tfloat"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TrieFloatField"</span> <span class="hljs-attr">precisionStep</span>=<span class="hljs-string">"8"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"tlong"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TrieLongField"</span> <span class="hljs-attr">precisionStep</span>=<span class="hljs-string">"8"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"tdouble"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TrieDoubleField"</span> <span class="hljs-attr">precisionStep</span>=<span class="hljs-string">"8"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"date"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TrieDateField"</span> <span class="hljs-attr">precisionStep</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"0"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!-- A Trie based date field for faster date range queries and date faceting. --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"tdate"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TrieDateField"</span> <span class="hljs-attr">precisionStep</span>=<span class="hljs-string">"6"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"0"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!--Binary data type. The data should be sent/retrieved in as Base64 encoded Strings --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldtype</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"binary"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.BinaryField"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"random"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.RandomSortField"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!-- A text field that only splits on whitespace for exact matching of words --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"text_ws"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TextField"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"100"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">analyzer</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tokenizer</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.WhitespaceTokenizerFactory"</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">analyzer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">fieldType</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- A general text field that has reasonable, generic
         cross-language defaults: it tokenizes with StandardTokenizer,
         removes stop words from case-insensitive "stopwords.txt"
         (empty by default), and down cases.  At query time only, it
         also applies synonyms. --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"text_general"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.TextField"</span> <span class="hljs-attr">positionIncrementGap</span>=<span class="hljs-string">"100"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">analyzer</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"index"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tokenizer</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.StandardTokenizerFactory"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.StopFilterFactory"</span> <span class="hljs-attr">ignoreCase</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">words</span>=<span class="hljs-string">"stopwords.txt"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.LowerCaseFilterFactory"</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">analyzer</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">analyzer</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"query"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tokenizer</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.StandardTokenizerFactory"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.StopFilterFactory"</span> <span class="hljs-attr">ignoreCase</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">words</span>=<span class="hljs-string">"stopwords.txt"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.SynonymFilterFactory"</span> <span class="hljs-attr">synonyms</span>=<span class="hljs-string">"synonyms.txt"</span> <span class="hljs-attr">ignoreCase</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">expand</span>=<span class="hljs-string">"true"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.LowerCaseFilterFactory"</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">analyzer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">fieldType</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">types</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">schema</span>&gt;</span>
</code></pre>
<p>The important parts here are the schema name being <code>geotest</code></p>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"geotest"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"1.5"</span>&gt;</span>
</code></pre>
<p>our two fields. <code>name</code> and <code>loc</code></p>
<pre class="hljs"><code>    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span> <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"loc"</span>  <span class="hljs-attr">type</span>=<span class="hljs-string">"location_rpt"</span>  <span class="hljs-attr">indexed</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">stored</span>=<span class="hljs-string">"true"</span>/&gt;</span>```

and our fieldType `location_rpt`

```xml
	<span class="hljs-tag">&lt;<span class="hljs-name">fieldType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"location_rpt"</span>   <span class="hljs-attr">class</span>=<span class="hljs-string">"solr.SpatialRecursivePrefixTreeFieldType"</span>
	               <span class="hljs-attr">distErrPct</span>=<span class="hljs-string">"0.025"</span>
	               <span class="hljs-attr">maxDistErr</span>=<span class="hljs-string">"0.000009"</span>
	               <span class="hljs-attr">units</span>=<span class="hljs-string">"degrees"</span>
	            /&gt;</span>
</code></pre>
<p>Pretty much everything else is boilerplate so that the Riak Solr integration
works.</p>
<h2 id="upload-schema">Upload Schema</h2>
<p>We can now upload this schema (I saved the schema above as schema.xml in my
current directory):</p>
<pre class="hljs"><code>curl -i -XPUT http://localhost:8098/search/schema/geotest \
  -H <span class="hljs-string">'content-type: application/xml'</span> \
  --data-binary @schema.xml
</code></pre>
<h2 id="create-index">Create Index</h2>
<p>…and we create an index named “my_geo_index” which uses the schema (name =
“geotest”) we just uploaded.</p>
<pre class="hljs"><code>curl -i -XPUT http://localhost:8098/search/index/my_geo_index \
  -H <span class="hljs-string">'content-type: application/json'</span> \
  <span class="hljs-_">-d</span> <span class="hljs-string">'{"schema":"geotest"}'</span>
</code></pre>
<p>They should both return 204 responses.</p>
<h2 id="create-bucket-type">Create Bucket Type</h2>
<p>Next we’ll create a bucket type named “geo_type” using the <code>riak-admin</code> command.
Our bucket type won’t have any special properties, it just needs to exist.</p>
<pre class="hljs"><code>./bin/riak-admin bucket-type create geo_<span class="hljs-built_in">type</span> <span class="hljs-string">'{"props":{}}'</span>
</code></pre>
<h2 id="activate-bucket-type">Activate Bucket Type</h2>
<p>We also need to activate our new bucket type:</p>
<pre class="hljs"><code>./bin/riak-admin bucket-type activate geo_<span class="hljs-built_in">type</span>
</code></pre>
<h2 id="create-bucket">Create Bucket</h2>
<p>We will now create a bucket named “stuff” under the <code>geo_type</code> bucket type. In
addition, this command associates the Solr index <code>my_geo_index</code> with the bucket
<code>stuff</code></p>
<pre class="hljs"><code>curl -XPUT <span class="hljs-string">'http://localhost:8098/types/geo_type/buckets/stuff/props'</span> \
  -H <span class="hljs-string">'content-type: application/json'</span> \
  <span class="hljs-_">-d</span> <span class="hljs-string">'{"props":{"search_index":"my_geo_index"}}'</span>
</code></pre>
<h2 id="indexing-data">Indexing Data</h2>
<p>That’s it. Let’s index some data!</p>
<pre class="hljs"><code>curl -i -H <span class="hljs-string">'content-type: application/json'</span> -X PUT <span class="hljs-string">'http://localhost:8098/types/geo_type/buckets/stuff/keys/sf'</span> <span class="hljs-_">-d</span> <span class="hljs-string">'{"name":"San Francisco", "loc":"37.774929,-122.419416"}'</span>
curl -i -H <span class="hljs-string">'content-type: application/json'</span> -X PUT <span class="hljs-string">'http://localhost:8098/types/geo_type/buckets/stuff/keys/sj'</span> <span class="hljs-_">-d</span> <span class="hljs-string">'{"name":"San Jose", "loc":"37.339386,-121.894955"}'</span>
curl -i -H <span class="hljs-string">'content-type: application/json'</span> -X PUT <span class="hljs-string">'http://localhost:8098/types/geo_type/buckets/stuff/keys/mv'</span> <span class="hljs-_">-d</span> <span class="hljs-string">'{"name":"Mountain View", "loc":"37.386052,-122.083851"}'</span>
</code></pre>
<h2 id="querying">Querying</h2>
<p>Now for the fun part. Let’s find all of our data, scored and sorted by distance.
The score will return a distance (in degrees). We are querying from a location
in Palo Alto, California, so we should see fairly small distances to Mountain
View, San Jose and San Francisco.</p>
<pre class="hljs"><code>curl <span class="hljs-string">'http://localhost:8098/search/my_geo_index?&amp;fl=*,score&amp;sort=score%20asc&amp;q={!geofilt%20score=distance%20filter=false%20sfield=loc%20pt=37.441883,-122.143019%20d=10}&amp;wt=json'</span>
</code></pre>
<p>The query returns the results:</p>
<pre class="hljs"><code>{
   <span class="hljs-string">"responseHeader"</span>:{
      <span class="hljs-string">"status"</span>:<span class="hljs-number">0</span>,
      <span class="hljs-string">"QTime"</span>:<span class="hljs-number">24</span>,
      <span class="hljs-string">"params"</span>:{
         <span class="hljs-string">"shards"</span>:<span class="hljs-string">"127.0.0.1:8093/solr/my_geo_index"</span>,
         <span class="hljs-string">"sort"</span>:<span class="hljs-string">"score asc"</span>,
         <span class="hljs-string">"fl"</span>:<span class="hljs-string">"*,score"</span>,
         <span class="hljs-string">"q"</span>:<span class="hljs-string">"{!geofilt score=distance filter=false sfield=loc pt=37.441883,-122.143019 d=10}"</span>,
         <span class="hljs-string">"127.0.0.1:8093"</span>:<span class="hljs-string">"_yz_pn:64 OR (_yz_pn:61 AND (_yz_fpn:61)) OR _yz_pn:60 OR _yz_pn:57 OR _yz_pn:54 OR _yz_pn:51 OR _yz_pn:48 OR _yz_pn:45 OR _yz_pn:42 OR _yz_pn:39 OR _yz_pn:36 OR _yz_pn:33 OR _yz_pn:30 OR _yz_pn:27 OR _yz_pn:24 OR _yz_pn:21 OR _yz_pn:18 OR _yz_pn:15 OR _yz_pn:12 OR _yz_pn:9 OR _yz_pn:6 OR _yz_pn:3"</span>,
         <span class="hljs-string">"wt"</span>:<span class="hljs-string">"json"</span>
      }
   },
   <span class="hljs-string">"response"</span>:{
      <span class="hljs-string">"numFound"</span>:<span class="hljs-number">4</span>,
      <span class="hljs-string">"start"</span>:<span class="hljs-number">0</span>,
      <span class="hljs-string">"maxScore"</span>:<span class="hljs-number">0.39857662</span>,
      <span class="hljs-string">"docs"</span>:[
         {
            <span class="hljs-string">"loc"</span>:<span class="hljs-string">"37.386052,-122.083851"</span>,
            <span class="hljs-string">"name"</span>:<span class="hljs-string">"Mountain View"</span>,
            <span class="hljs-string">"_yz_id"</span>:<span class="hljs-string">"geo_type_stuff_mv_42"</span>,
            <span class="hljs-string">"_yz_rk"</span>:<span class="hljs-string">"mv"</span>,
            <span class="hljs-string">"_yz_rt"</span>:<span class="hljs-string">"geo_type"</span>,
            <span class="hljs-string">"_yz_rb"</span>:<span class="hljs-string">"stuff"</span>,
            <span class="hljs-string">"score"</span>:<span class="hljs-number">0.072977245</span>
         },
         {
            <span class="hljs-string">"loc"</span>:<span class="hljs-string">"37.339386,-121.894955"</span>,
            <span class="hljs-string">"name"</span>:<span class="hljs-string">"San Jose"</span>,
            <span class="hljs-string">"_yz_id"</span>:<span class="hljs-string">"geo_type_stuff_sj_21"</span>,
            <span class="hljs-string">"_yz_rk"</span>:<span class="hljs-string">"sj"</span>,
            <span class="hljs-string">"_yz_rt"</span>:<span class="hljs-string">"geo_type"</span>,
            <span class="hljs-string">"_yz_rb"</span>:<span class="hljs-string">"stuff"</span>,
            <span class="hljs-string">"score"</span>:<span class="hljs-number">0.2221485</span>
         },
         {
            <span class="hljs-string">"loc"</span>:<span class="hljs-string">"37.774929,-122.419416"</span>,
            <span class="hljs-string">"name"</span>:<span class="hljs-string">"San Francisco"</span>,
            <span class="hljs-string">"_yz_id"</span>:<span class="hljs-string">"geo_type_stuff_sf_60_MeNonMcIRG8mmdJpk5KfM"</span>,
            <span class="hljs-string">"_yz_rk"</span>:<span class="hljs-string">"sf"</span>,
            <span class="hljs-string">"_yz_rt"</span>:<span class="hljs-string">"geo_type"</span>,
            <span class="hljs-string">"_yz_rb"</span>:<span class="hljs-string">"stuff"</span>,
            <span class="hljs-string">"score"</span>:<span class="hljs-number">0.39857662</span>
         },
         {
            <span class="hljs-string">"loc"</span>:<span class="hljs-string">"37.774929,-122.419416"</span>,
            <span class="hljs-string">"name"</span>:<span class="hljs-string">"San Francisco"</span>,
            <span class="hljs-string">"_yz_id"</span>:<span class="hljs-string">"geo_type_stuff_sf_60_5n4gT2r1Gt2qlHwfKCwypL"</span>,
            <span class="hljs-string">"_yz_rk"</span>:<span class="hljs-string">"sf"</span>,
            <span class="hljs-string">"_yz_rt"</span>:<span class="hljs-string">"geo_type"</span>,
            <span class="hljs-string">"_yz_rb"</span>:<span class="hljs-string">"stuff"</span>,
            <span class="hljs-string">"score"</span>:<span class="hljs-number">0.39857662</span>
         }
      ]
   }
}
</code></pre>
<p>You’ll notice that there are two San Franciscos. This is because I inserted data
twice into Riak without using a VClock the second time (While I was writing this
post), resulting in siblings. This issue is easily resolvable by resolving the
siblings as mentioned
<a href="http://docs.basho.com/riak/latest/theory/concepts/Vector-Clocks/">here</a>.</p>
<p>Now, we can convert to miles by multiplying the score (which is degrees) by
<code>69.09341</code>. If we do this for San Jose it would be <code>.2221485 * 69.09341</code>, or
about <code>15.34 mi</code>.</p>
<p>For Kilometers we use <code>111.1951</code>, which gives us about <code>24.7 km</code>.</p>
<p>Since our query location was from Palo Alto, California, we can see that San
Jose is indeed, approximately that 15 miles away. Our search was successful!</p>
</div></div></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-46878058-1', 'auto');
          ga('send', 'pageview');</script></body></html>