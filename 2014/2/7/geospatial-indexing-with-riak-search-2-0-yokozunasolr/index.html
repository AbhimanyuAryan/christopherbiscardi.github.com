<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="user-scalable=no width=device-width, initial-scale=1.0 maximum-scale=1.0"><title></title><link rel="shortcut icon"><link href="https://fonts.googleapis.com/css?family=Crimson+Text|Montserrat:700" rel="stylesheet" type="text/css"><link href="/style.css" rel="stylesheet" type="text/css"></head><body class="landing-page"><div id="react-mount"><div data-reactid=".1frs31jfri8" data-react-checksum="228246803"><nav data-reactid=".1frs31jfri8.1"><div data-reactid=".1frs31jfri8.1.0"><div data-reactid=".1frs31jfri8.1.0.0"><ul data-reactid=".1frs31jfri8.1.0.0.0"><li data-reactid=".1frs31jfri8.1.0.0.0.0"><a class="" href="/" data-reactid=".1frs31jfri8.1.0.0.0.0.0">chrisbiscardi</a></li><li data-reactid=".1frs31jfri8.1.0.0.0.1"><a class="" href="/talks" data-reactid=".1frs31jfri8.1.0.0.0.1.0">talks</a></li><li data-reactid=".1frs31jfri8.1.0.0.0.2"><a href="https://twitter.com/chrisbiscardi" data-reactid=".1frs31jfri8.1.0.0.0.2.0">twitter</a></li><li data-reactid=".1frs31jfri8.1.0.0.0.3"><a class="" href="/projects" data-reactid=".1frs31jfri8.1.0.0.0.3.0">projects</a></li><li data-reactid=".1frs31jfri8.1.0.0.0.4"><a class="" href="/books" data-reactid=".1frs31jfri8.1.0.0.0.4.0">books</a></li></ul></div></div></nav><div data-reactid=".1frs31jfri8.2"><div data-reactid=".1frs31jfri8.2.1"><div data-reactid=".1frs31jfri8.2.1.0"><div class="markdown" data-reactid=".1frs31jfri8.2.1.0.0"><div data-reactid=".1frs31jfri8.2.1.0.0.0"><p>In this post we will be using curl to construct a geospatial index using Riak Search 2 (also known as Yokozuna) which is backed by Solr.</p>
<p>I’ll be using <a href="http://docs.basho.com/riak/2.0.0pre11/downloads/">Riak Pre11</a> for this.</p>
<p>In <code>etc/riak.conf</code> change <code>search</code> to <code>on</code>:<br>
(It was on line 411 for me)</p>
<p><code>search = on</code></p>
<p>Make sure your <code>ulimit</code> is 4096 or greater:</p>
<p><code>&lt;code class=&quot;bash&quot;&gt;ulimit -n 4096</code></p>
<p>Then start Riak. I’m using <code>console</code> myself, but <code>start</code> would also work.</p>
<p><code>&lt;code class=&quot;bash&quot;&gt;./bin/riak console</code></p>
<h2>Creating a Schema</h2>
<p>Let’s create a schema so that Solr indexes our data correctly (file available <a href="https://gist.github.com/ChristopherBiscardi/8876815">here</a>):</p>
<pre><code><span class="hljs-tag">&lt;<span class="hljs-title">code</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"xml"</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"overflow-x:scroll"</span>&gt;</span><span class="hljs-pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">schema</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"geotest"</span> <span class="hljs-attribute">version</span>=<span class="hljs-value">"1.5"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">uniqueKey</span>&gt;</span>_yz_id
  <span class="hljs-tag">&lt;<span class="hljs-title">fields</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"name"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"string"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"loc"</span>  <span class="hljs-attribute">type</span>=<span class="hljs-value">"location_rpt"</span>  <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"true"</span>/&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Begin Yokozuna Fields --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_id"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">required</span>=<span class="hljs-value">"true"</span> /&gt;</span>

   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"text"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text_ws"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"false"</span> <span class="hljs-attribute">multiValued</span>=<span class="hljs-value">"true"</span>/&gt;</span>

   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_version_"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"long"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"true"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Entropy Data: Data related to anti-entropy --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_ed"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"false"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Partition Number: Used as a filter query param --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_pn"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"false"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- First Partition Number: The first partition in this doc's
        preflist, used for further filtering on overlapping partitions. --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_fpn"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"false"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- If there is a sibling, use vtag to differentiate them --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_vtag"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"false"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Node: The name of the node that this doc was created on. --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_node"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"false"</span>/&gt;</span>

   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_rt"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"true"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Riak Bucket: The bucket of the Riak object this doc corresponds to. --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_rb"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"true"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Riak Key: The key of the Riak object this doc corresponds to. --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_rk"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"true"</span>/&gt;</span>

   <span class="hljs-comment">&lt;!-- Node: Stores a flag if this doc is the product of a failed object extration --&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">field</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_err"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"false"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">fields</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">types</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"location_rpt"</span>   <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.SpatialRecursivePrefixTreeFieldType"</span>
                   <span class="hljs-attribute">spatialContextFactory</span>=<span class="hljs-value">"com.spatial4j.core.context.jts.JtsSpatialContextFactory"</span>
                   <span class="hljs-attribute">distErrPct</span>=<span class="hljs-value">"0.025"</span>
                   <span class="hljs-attribute">maxDistErr</span>=<span class="hljs-value">"0.000009"</span>
                   <span class="hljs-attribute">units</span>=<span class="hljs-value">"degrees"</span>
                /&gt;</span>
    <span class="hljs-comment">&lt;!-- since fields of this type are by default not stored or indexed,
         any data added to them will be ignored outright.  --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldtype</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"ignored"</span> <span class="hljs-attribute">stored</span>=<span class="hljs-value">"false"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"false"</span> <span class="hljs-attribute">multiValued</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.StrField"</span> /&gt;</span>

    <span class="hljs-comment">&lt;!-- YZ String: Used for non-analyzed fields --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"_yz_str"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.StrField"</span> <span class="hljs-attribute">sortMissingLast</span>=<span class="hljs-value">"true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"string"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.StrField"</span> <span class="hljs-attribute">sortMissingLast</span>=<span class="hljs-value">"true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"boolean"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.BoolField"</span> <span class="hljs-attribute">sortMissingLast</span>=<span class="hljs-value">"true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"int"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TrieIntField"</span> <span class="hljs-attribute">precisionStep</span>=<span class="hljs-value">"0"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"float"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TrieFloatField"</span> <span class="hljs-attribute">precisionStep</span>=<span class="hljs-value">"0"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"long"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TrieLongField"</span> <span class="hljs-attribute">precisionStep</span>=<span class="hljs-value">"0"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"double"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TrieDoubleField"</span> <span class="hljs-attribute">precisionStep</span>=<span class="hljs-value">"0"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"0"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!--
     Numeric field types that index each value at various levels of precision
     to accelerate range queries when the number of values between the range
     endpoints is large. See the javadoc for NumericRangeQuery for internal
     implementation details.

     Smaller precisionStep values (specified in bits) will lead to more tokens
     indexed per value, slightly larger index size, and faster range queries.
     A precisionStep of 0 disables indexing at different precision levels.
    --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"tint"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TrieIntField"</span> <span class="hljs-attribute">precisionStep</span>=<span class="hljs-value">"8"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"tfloat"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TrieFloatField"</span> <span class="hljs-attribute">precisionStep</span>=<span class="hljs-value">"8"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"tlong"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TrieLongField"</span> <span class="hljs-attribute">precisionStep</span>=<span class="hljs-value">"8"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"tdouble"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TrieDoubleField"</span> <span class="hljs-attribute">precisionStep</span>=<span class="hljs-value">"8"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"date"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TrieDateField"</span> <span class="hljs-attribute">precisionStep</span>=<span class="hljs-value">"0"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"0"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!-- A Trie based date field for faster date range queries and date faceting. --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"tdate"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TrieDateField"</span> <span class="hljs-attribute">precisionStep</span>=<span class="hljs-value">"6"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"0"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!--Binary data type. The data should be sent/retrieved in as Base64 encoded Strings --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldtype</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"binary"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.BinaryField"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"random"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.RandomSortField"</span> <span class="hljs-attribute">indexed</span>=<span class="hljs-value">"true"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!-- A text field that only splits on whitespace for exact matching of words --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"text_ws"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TextField"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"100"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">analyzer</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">tokenizer</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.WhitespaceTokenizerFactory"</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">analyzer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">fieldType</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- A general text field that has reasonable, generic
         cross-language defaults: it tokenizes with StandardTokenizer,
         removes stop words from case-insensitive "stopwords.txt"
         (empty by default), and down cases.  At query time only, it
         also applies synonyms. --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">fieldType</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"text_general"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.TextField"</span> <span class="hljs-attribute">positionIncrementGap</span>=<span class="hljs-value">"100"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">analyzer</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"index"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">tokenizer</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.StandardTokenizerFactory"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">filter</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.StopFilterFactory"</span> <span class="hljs-attribute">ignoreCase</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">words</span>=<span class="hljs-value">"stopwords.txt"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">filter</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.LowerCaseFilterFactory"</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">analyzer</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">analyzer</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"query"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">tokenizer</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.StandardTokenizerFactory"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">filter</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.StopFilterFactory"</span> <span class="hljs-attribute">ignoreCase</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">words</span>=<span class="hljs-value">"stopwords.txt"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">filter</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.SynonymFilterFactory"</span> <span class="hljs-attribute">synonyms</span>=<span class="hljs-value">"synonyms.txt"</span> <span class="hljs-attribute">ignoreCase</span>=<span class="hljs-value">"true"</span> <span class="hljs-attribute">expand</span>=<span class="hljs-value">"true"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">filter</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"solr.LowerCaseFilterFactory"</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">analyzer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">fieldType</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">types</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">schema</span>&gt;</span>```

The important parts here are the schema name being `geotest`

`<span class="hljs-tag">&lt;<span class="hljs-title">code</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"xml"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">schema</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"geotest"</span> <span class="hljs-attribute">version</span>=<span class="hljs-value">"1.5"</span>&gt;</span>`

our two fields. `name` and `loc`

</code></pre>
<p><code class="xml" style="overflow-x:scroll">    <field name="name" type="string" indexed="true" stored="true"/>
<field name="loc"  type="location_rpt"  indexed="true" stored="true"/>```</p>
<p>and our fieldType <code>location_rpt</code></p>
<pre><code>&lt;code <span class="hljs-type">class</span>=<span class="hljs-string">"xml"</span> style=<span class="hljs-string">"overflow-x:scroll"</span>&gt;    &lt;fieldType <span class="hljs-property">name</span>=<span class="hljs-string">"location_rpt"</span>   <span class="hljs-type">class</span>=<span class="hljs-string">"solr.SpatialRecursivePrefixTreeFieldType"</span>
                   distErrPct=<span class="hljs-string">"0.025"</span>
                   maxDistErr=<span class="hljs-string">"0.000009"</span>
                   units=<span class="hljs-string">"degrees"</span>
                /&gt;```

Pretty much everything <span class="hljs-keyword">else</span> <span class="hljs-keyword">is</span> boilerplate so <span class="hljs-keyword">that</span> <span class="hljs-keyword">the</span> Riak Solr integration works.


<span class="hljs-comment">## Upload Schema</span>

We can now upload this schema (I saved <span class="hljs-keyword">the</span> schema <span class="hljs-keyword">above</span> <span class="hljs-keyword">as</span> schema.xml <span class="hljs-keyword">in</span> <span class="hljs-keyword">my</span> current directory):

</code></pre>
<p><code class="bash">curl -i -XPUT <a href="http://localhost:8098/search/schema/geotest">http://localhost:8098/search/schema/geotest</a> <br>
-H ‘content-type: application/xml’ <br>
–data-binary @schema.xml```</p>
<h2>Create Index</h2>
<p>…and we create an index named “my_geo_index” which uses the schema (name = “geotest”) we just uploaded.</p>
<pre><code>&lt;code <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"bash"</span>&gt;curl -i -<span class="hljs-type">XPUT</span> http:<span class="hljs-comment">//localhost:8098/search/index/my_geo_index \</span>
  -<span class="hljs-type">H</span> <span class="hljs-symbol">'content</span>-<span class="hljs-class"><span class="hljs-keyword">type</span>:</span> application/json' \
  -d '{<span class="hljs-string">"schema"</span>:<span class="hljs-string">"geotest"</span>}'```

<span class="hljs-type">They</span> should both <span class="hljs-keyword">return</span> <span class="hljs-number">204</span> responses.


## <span class="hljs-type">Create</span> <span class="hljs-type">Bucket</span> <span class="hljs-type">Type</span>

<span class="hljs-type">Next</span> we’ll create a bucket <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">named</span> <span class="hljs-title">“geo_type”</span> <span class="hljs-title">using</span> <span class="hljs-title">the</span> `<span class="hljs-title">riak-admin</span>` <span class="hljs-title">command</span>. <span class="hljs-title">Our</span> <span class="hljs-title">bucket</span> <span class="hljs-title">type</span> <span class="hljs-title">won’t</span> <span class="hljs-title">have</span> <span class="hljs-title">any</span> <span class="hljs-title">special</span> <span class="hljs-title">properties</span>, <span class="hljs-title">it</span> <span class="hljs-title">just</span> <span class="hljs-title">needs</span> <span class="hljs-title">to</span> <span class="hljs-title">exist</span>.
</span>
`&lt;code <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"bash"</span>&gt;./bin/riak-admin bucket-<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">create</span> <span class="hljs-title">geo_type</span> '{</span><span class="hljs-string">"props"</span>:{}}'`


## <span class="hljs-type">Activate</span> <span class="hljs-type">Bucket</span> <span class="hljs-type">Type</span>

<span class="hljs-type">We</span> also need to activate our <span class="hljs-keyword">new</span> bucket <span class="hljs-class"><span class="hljs-keyword">type</span>:</span>

`&lt;code <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"bash"</span>&gt;./bin/riak-admin bucket-<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">activate</span> <span class="hljs-title">geo_type</span>`
</span>

## <span class="hljs-type">Create</span> <span class="hljs-type">Bucket</span>

<span class="hljs-type">We</span> will now create a bucket named “stuff” under the `geo_type` bucket <span class="hljs-class"><span class="hljs-keyword">type</span>. <span class="hljs-title">In</span> <span class="hljs-title">addition</span>, <span class="hljs-title">this</span> <span class="hljs-title">command</span> <span class="hljs-title">associates</span> <span class="hljs-title">the</span> <span class="hljs-title">Solr</span> <span class="hljs-title">index</span> `<span class="hljs-title">my_geo_index</span>` <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-title">the</span> <span class="hljs-title">bucket</span> `<span class="hljs-title">stuff</span>`
</span>
</code></pre>
<p><code class="bash">curl -XPUT ’<a href="http://localhost:8098/types/geo_type/buckets/stuff/props">http://localhost:8098/types/geo_type/buckets/stuff/props</a>’ <br>
-H ‘content-type: application/json’ <br>
-d ‘{“props”:{“search_index”:“my_geo_index”}}’```</p>
<h2>Indexing Data</h2>
<p>That’s it. Let’s index some data!</p>
<pre><code>&lt;code class=<span class="hljs-string">"bash"</span> style=<span class="hljs-string">"overflow-x:scroll"</span>&gt;curl -i -H <span class="hljs-string">'content-type: application/json'</span> -X PUT <span class="hljs-string">'http://localhost:8098/types/geo_type/buckets/stuff/keys/sf'</span> -d <span class="hljs-string">'{"name":"San Francisco", "loc":"37.774929,-122.419416"}'</span>
curl -i -H <span class="hljs-string">'content-type: application/json'</span> -X PUT <span class="hljs-string">'http://localhost:8098/types/geo_type/buckets/stuff/keys/sj'</span> -d <span class="hljs-string">'{"name":"San Jose", "loc":"37.339386,-121.894955"}'</span>
curl -i -H <span class="hljs-string">'content-type: application/json'</span> -X PUT <span class="hljs-string">'http://localhost:8098/types/geo_type/buckets/stuff/keys/mv'</span> -d <span class="hljs-string">'{"name":"Mountain View", "loc":"37.386052,-122.083851"}'</span>```


<span class="hljs-comment">## Querying</span>

Now <span class="hljs-keyword">for</span> <span class="hljs-operator">the</span> fun part. Let’s find all <span class="hljs-operator">of</span> our data, scored <span class="hljs-operator">and</span> sorted <span class="hljs-keyword">by</span> distance. The score will <span class="hljs-constant">return</span> <span class="hljs-operator">a</span> distance (<span class="hljs-operator">in</span> degrees). We are querying <span class="hljs-built_in">from</span> <span class="hljs-operator">a</span> location <span class="hljs-operator">in</span> Palo Alto, California, so we should see fairly small distances <span class="hljs-built_in">to</span> Mountain View, San Jose <span class="hljs-operator">and</span> San Francisco.

`&lt;code class=<span class="hljs-string">"bash"</span> style=<span class="hljs-string">"overflow-x:scroll"</span>&gt;curl <span class="hljs-string">'http://localhost:8098/search/my_geo_index?&amp;fl=*,score&amp;sort=score%20asc&amp;q={!geofilt%20score=distance%20filter=false%20sfield=loc%20pt=37.441883,-122.143019%20d=10}&amp;wt=json'</span>`

The query returns <span class="hljs-operator">the</span> results:

</code></pre>
<p><code class="Javascript" style="overflow-x:scroll">{
“responseHeader”:{
“status”:0,
“QTime”:24,
“params”:{
“shards”:“127.0.0.1:8093/solr/my_geo_index”,
“sort”:“score asc”,
“fl”:&quot;*,score&quot;,
“q”:&quot;{!geofilt score=distance filter=false sfield=loc pt=37.441883,-122.143019 d=10}&quot;,
“127.0.0.1:8093”:&quot;_yz_pn:64 OR (_yz_pn:61 AND (_yz_fpn:61)) OR _yz_pn:60 OR _yz_pn:57 OR _yz_pn:54 OR _yz_pn:51 OR _yz_pn:48 OR _yz_pn:45 OR _yz_pn:42 OR _yz_pn:39 OR _yz_pn:36 OR _yz_pn:33 OR _yz_pn:30 OR _yz_pn:27 OR _yz_pn:24 OR _yz_pn:21 OR _yz_pn:18 OR _yz_pn:15 OR _yz_pn:12 OR _yz_pn:9 OR _yz_pn:6 OR _yz_pn:3&quot;,
“wt”:“json”
}
},
“response”:{
“numFound”:4,
“start”:0,
“maxScore”:0.39857662,
“docs”:[
{
“loc”:“37.386052,-122.083851”,
“name”:“Mountain View”,
“_yz_id”:“geo_type_stuff_mv_42”,
“_yz_rk”:“mv”,
“_yz_rt”:“geo_type”,
“_yz_rb”:“stuff”,
“score”:0.072977245
},
{
“loc”:“37.339386,-121.894955”,
“name”:“San Jose”,
“_yz_id”:“geo_type_stuff_sj_21”,
“_yz_rk”:“sj”,
“_yz_rt”:“geo_type”,
“_yz_rb”:“stuff”,
“score”:0.2221485
},
{
“loc”:“37.774929,-122.419416”,
“name”:“San Francisco”,
“_yz_id”:“geo_type_stuff_sf_60_MeNonMcIRG8mmdJpk5KfM”,
“_yz_rk”:“sf”,
“_yz_rt”:“geo_type”,
“_yz_rb”:“stuff”,
“score”:0.39857662
},
{
“loc”:“37.774929,-122.419416”,
“name”:“San Francisco”,
“_yz_id”:“geo_type_stuff_sf_60_5n4gT2r1Gt2qlHwfKCwypL”,
“_yz_rk”:“sf”,
“_yz_rt”:“geo_type”,
“_yz_rb”:“stuff”,
“score”:0.39857662
}
]
}
}```</p>
<p>You’ll notice that there are two San Franciscos. This is because I inserted data twice into Riak without using a VClock the second time (While I was writing this post), resulting in siblings. This issue is easily resolvable by resolving the siblings as mentioned <a href="http://docs.basho.com/riak/latest/theory/concepts/Vector-Clocks/">here</a>.</p>
<p>Now, we can convert to miles by multiplying the score (which is degrees) by <code>69.09341</code>. If we do this for San Jose it would be <code>.2221485 * 69.09341</code>, or about <code>15.34 mi</code>.</p>
<p>For Kilometers we use <code>111.1951</code>, which gives us about <code>24.7 km</code>.</p>
<p>Since our query location was from Palo Alto, California, we can see that San Jose is indeed, approximately that 15 miles away. Our search was successful!</p>
</div><em data-reactid=".1frs31jfri8.2.1.0.0.1"><span data-reactid=".1frs31jfri8.2.1.0.0.1.0">Posted </span><span data-reactid=".1frs31jfri8.2.1.0.0.1.1">February 7, 2014</span></em><hr data-reactid=".1frs31jfri8.2.1.0.0.2"><noscript data-reactid=".1frs31jfri8.2.1.0.0.3"></noscript><p data-reactid=".1frs31jfri8.2.1.0.0.4"><img src="/headshot.png" data-reactid=".1frs31jfri8.2.1.0.0.4.0"><span data-reactid=".1frs31jfri8.2.1.0.0.4.1">Written by </span><strong data-reactid=".1frs31jfri8.2.1.0.0.4.2">Chris Biscardi</strong><span data-reactid=".1frs31jfri8.2.1.0.0.4.3"> who lives and works in San Francisco building useful things. </span><a href="https://twitter.com/chrisbiscardi" data-reactid=".1frs31jfri8.2.1.0.0.4.4">Follow on Twitter</a></p></div></div><div data-reactid=".1frs31jfri8.2.1.1"></div></div></div></div></div><script src="/bundle.js"></script></body></html>