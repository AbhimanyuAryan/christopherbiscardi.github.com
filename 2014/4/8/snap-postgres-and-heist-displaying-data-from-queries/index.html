<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="user-scalable=no width=device-width, initial-scale=1.0 maximum-scale=1.0"><title></title><link rel="shortcut icon"><link href="https://fonts.googleapis.com/css?family=Crimson+Text|Montserrat:700" rel="stylesheet" type="text/css"></head><body class="landing-page"><div id="react-mount"><div data-reactid=".1he6boygxkw" data-react-checksum="-553697448"><nav data-reactid=".1he6boygxkw.1"><div data-reactid=".1he6boygxkw.1.0"><div data-reactid=".1he6boygxkw.1.0.0"><ul data-reactid=".1he6boygxkw.1.0.0.0"><li data-reactid=".1he6boygxkw.1.0.0.0.0"><a class="" href="/" data-reactid=".1he6boygxkw.1.0.0.0.0.0">chrisbiscardi</a></li><li data-reactid=".1he6boygxkw.1.0.0.0.1"><a class="" href="/talks" data-reactid=".1he6boygxkw.1.0.0.0.1.0">talks</a></li><li data-reactid=".1he6boygxkw.1.0.0.0.2"><a href="https://twitter.com/chrisbiscardi" data-reactid=".1he6boygxkw.1.0.0.0.2.0">twitter</a></li><li data-reactid=".1he6boygxkw.1.0.0.0.3"><a class="" href="/projects" data-reactid=".1he6boygxkw.1.0.0.0.3.0">projects</a></li><li data-reactid=".1he6boygxkw.1.0.0.0.4"><a class="" href="/books" data-reactid=".1he6boygxkw.1.0.0.0.4.0">books</a></li></ul></div></div></nav><div data-reactid=".1he6boygxkw.2"><div data-reactid=".1he6boygxkw.2.0"><div class="markdown" data-reactid=".1he6boygxkw.2.0.0"><h1 data-reactid=".1he6boygxkw.2.0.0.0">Snap, Postgres and Heist: Displaying Data from Queries</h1><div data-reactid=".1he6boygxkw.2.0.0.1"><p>The github repo for this post is <a href="https://github.com/ChristopherBiscardi/snap-postgres-heist">here</a>.</p>
<h2>Single AuthUser Splice</h2>
<p>Assuming we have instances and initializations for the Postgres Auth backend and Postgresql-Simple Snaplet, we can do a few things. First, we need to write a Splice for the AuthUser data type. We will only use a couple fields to show how it works.</p>
<pre><code>&lt;code class=<span class="hljs-string">"haskell"</span> style=<span class="hljs-string">"overflow-x:auto"</span>&gt;authUserSplice <span class="hljs-symbol">:</span><span class="hljs-symbol">:</span> <span class="hljs-constant">Monad </span>m =&gt;
                  <span class="hljs-constant">AuthUser </span>-&gt;
                  <span class="hljs-constant">Splices </span>(<span class="hljs-constant">HeistT </span>n m <span class="hljs-constant">Template)</span>
authUserSplice authUser = <span class="hljs-keyword">do</span>
  <span class="hljs-string">"userLogin"</span> <span class="hljs-comment">## I.textSplice (userLogin authUser)</span>
  <span class="hljs-string">"userLoginCount"</span> <span class="hljs-comment">## I.textSplice (T.pack $ show $ userLoginCount authUser)</span>
</code></pre>
<p>Using <code>##</code>, we are binding the strings <code>&quot;userLogin&quot;</code> and <code>&quot;userLoginCount&quot;</code> to their respective values from the <code>authUser</code> object. <code>userLogin authUser</code> gives us a <code>Text</code> result, so <code>&quot;userLogin&quot;</code> is bound to a text splice. We also bind <code>&quot;userLoginCount&quot;</code> as a text splice by converting the <code>int</code> we get from using <code>userLoginCount</code> on <code>authUser</code>.</p>
<p>Now that we have our Splice written, letâ€™s write our template.</p>
<pre><code>&lt;code class=<span class="hljs-string">"html"</span>&gt;&lt;apply template=<span class="hljs-string">"base"</span>&gt;
&lt;h1&gt;&lt;userLogin/&gt;&lt;/h1&gt;
&lt;p&gt;Number <span class="hljs-operator">of</span> Times Logged In: &lt;userLoginCount/&gt;&lt;/p&gt;
&lt;/apply&gt;```

Nothing major here. We have used <span class="hljs-operator">the</span> strings we bound <span class="hljs-keyword">before</span> <span class="hljs-keyword">as</span> tags <span class="hljs-built_in">to</span> display <span class="hljs-operator">the</span> <span class="hljs-keyword">text</span> <span class="hljs-built_in">from</span> <span class="hljs-operator">the</span> `authUser` object.

Finally, we can <span class="hljs-built_in">write</span> <span class="hljs-operator">a</span> Handler <span class="hljs-built_in">to</span> make <span class="hljs-operator">the</span> database request <span class="hljs-operator">and</span> render <span class="hljs-operator">the</span> template <span class="hljs-keyword">using</span> our splice.

</code></pre>
<p><code class="haskell" style="overflow-x:auto">getFromPostgres :: Handler App (AuthManager App) ()
getFromPostgres = do
result ```</p>
<p>Using a simple query to store the data from Postgres in <code>result</code>, we then render using our template (<code>auth_user_splice.tpl</code>) and apply the splice to the data in our result.</p>
<h2>List of AuthUsers</h2>
<p>To display a list of data, the process is very similar.</p>
<p>We can reuse the <code>authUserSplice</code> we just wrote and map it across the list of data we plan on passing in using <code>mapSplices</code> and <code>runChildrenWith</code>.</p>
<pre><code>&lt;<span class="hljs-tag">code</span> class=<span class="hljs-string">"haskell"</span> style=<span class="hljs-string">"overflow-x:auto"</span>&gt;authUsersSplice  :: [AuthUser] -&gt; I<span class="hljs-class">.Splice</span> AppHandler
authUsersSplice = I<span class="hljs-class">.mapSplices</span> (I<span class="hljs-class">.runChildrenWith</span> . authUserSplice)```

We will also write <span class="hljs-tag">a</span> new template to <span class="hljs-attribute">display</span> the information. Included <span class="hljs-keyword">in</span> this is the `authUsers` tag, which we are going to bind <span class="hljs-keyword">in</span> our Handler.

</code></pre>
<p><code class="html"><apply template="base"></p>
<dl>
<authUsers>
<dt><userLogin/></dt>
<dd>Number of Times Logged In: <userLoginCount/></dd>
</authUsers>
</dl>
</apply>```
<p>We can then write our handler as such:</p>
<pre><code>&lt;code class=<span class="hljs-string">"haskell"</span> style=<span class="hljs-string">"overflow-x:auto"</span>&gt;getManyFromPostgres :: <span class="hljs-type">Handler</span> <span class="hljs-type">App</span> (<span class="hljs-type">AuthManager</span> <span class="hljs-type">App</span>) ()
getManyFromPostgres = <span class="hljs-keyword">do</span>
        results ```

<span class="hljs-type">We</span> are rendering our new <span class="hljs-keyword">template</span> `auth_users_splice.tpl` <span class="hljs-keyword">with</span> our mapped splices bound to `<span class="hljs-string">"authUsers"</span>`. <span class="hljs-type">The</span> code inside <span class="hljs-keyword">of</span> `&lt;authUsers&gt;` will be run <span class="hljs-keyword">for</span> each <span class="hljs-literal">result</span> <span class="hljs-keyword">in</span> our list.


<span class="hljs-comment">## End</span>

<span class="hljs-type">That</span>'s it. <span class="hljs-type">Feel</span> free to pull the code <span class="hljs-keyword">from</span> [github](https://github.com/<span class="hljs-type">ChristopherBiscardi</span>/snap-postgres-heist) <span class="hljs-keyword">and</span> leave <span class="hljs-type">any</span> questions you have below.


</code></pre>
</div><em data-reactid=".1he6boygxkw.2.0.0.2"><span data-reactid=".1he6boygxkw.2.0.0.2.0">Posted </span><span data-reactid=".1he6boygxkw.2.0.0.2.1">April 8, 2014</span></em><hr data-reactid=".1he6boygxkw.2.0.0.3"><noscript data-reactid=".1he6boygxkw.2.0.0.4"></noscript><p data-reactid=".1he6boygxkw.2.0.0.5"><img src="/headshot.png" data-reactid=".1he6boygxkw.2.0.0.5.0"><span data-reactid=".1he6boygxkw.2.0.0.5.1">Written by </span><strong data-reactid=".1he6boygxkw.2.0.0.5.2">Chris Biscardi</strong><span data-reactid=".1he6boygxkw.2.0.0.5.3"> who lives and works in San Francisco building useful things. </span><a href="https://twitter.com/chrisbiscardi" data-reactid=".1he6boygxkw.2.0.0.5.4">Follow on Twitter</a></p></div></div><div data-reactid=".1he6boygxkw.2.1"></div></div></div></div><script src="/bundle.js"></script></body></html>