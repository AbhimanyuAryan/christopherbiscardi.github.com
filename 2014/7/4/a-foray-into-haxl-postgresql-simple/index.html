<html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title data-react-helmet="true">A Foray Into Haxl: PostgreSQL Simple</title><meta data-react-helmet="true" property="description" content="I wrote a simple Haxl DataSource and I thought it would be good to share. If you
don’t know what Haxl is you can find out more
here."/><meta data-react-helmet="true" property="og:title" content="A Foray Into Haxl: PostgreSQL Simple"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:url" content="http://christopherbiscardi.com/2014/7/4/a-foray-into-haxl-postgresql-simple/"/><meta data-react-helmet="true" property="og:description" content="I wrote a simple Haxl DataSource and I thought it would be good to share. If you
don’t know what Haxl is you can find out more
here."/><meta data-react-helmet="true" property="og:image" content="http://christopherbiscardi.comnull"/><meta data-react-helmet="true" property="twitter:card" content="summary"/><meta data-react-helmet="true" property="twitter:title" content="A Foray Into Haxl: PostgreSQL Simple"/><meta data-react-helmet="true" property="twitter:description" content="I wrote a simple Haxl DataSource and I thought it would be good to share. If you
don’t know what Haxl is you can find out more
here."/><meta data-react-helmet="true" property="twitter:url" content="http://christopherbiscardi.com/2014/7/4/a-foray-into-haxl-postgresql-simple/"/><link rel="stylesheet" type="text/css" href="/styles.f25bf9e6682280946ba2e441a544b407.css"/></head><body class="landing-page"><div id="content"><div data-reactroot="" data-reactid="1" data-react-checksum="1309753112"><div class="Nav__wrapper___u7BUA" data-reactid="2"><nav class="Nav__nav___1e2Pp" data-reactid="3"><a class="Nav__logoWrapper___35yvY" href="/" data-reactid="4"><img class="Nav__logo___sw4O9" src="/69305db2985e926d498b513a21d28383.png" data-reactid="5"/></a><ul class="Nav__items___1oDCD" data-reactid="6"><li data-reactid="7"><a class="Nav__itemLink___H6Isv" href="/posts/" data-reactid="8">Posts</a></li><li data-reactid="9"><a href="https://github.com/ChristopherBiscardi/ama/issues?q=is%3Aissue+is%3Aclosed" class="Nav__itemLink___H6Isv" data-reactid="10">AMA</a></li><li data-reactid="11"><a class="Nav__itemLink___H6Isv" href="/books/" data-reactid="12">Books</a></li><li data-reactid="13"><a class="Nav__itemLink___H6Isv" href="/projects/" data-reactid="14">Projects</a></li><li data-reactid="15"><a class="Nav__itemLink___H6Isv" href="/about/" data-reactid="16">About</a></li></ul></nav></div><div data-reactid="17"><div class="Post__page___15ves" data-reactid="18"><!-- react-empty: 19 --><div class="Post__container___f_rKX" data-reactid="20"><div class="Post__singleColumn___tYK8R" data-reactid="21"><h1 class="Post__title___2I6DZ" data-reactid="22">A Foray Into Haxl: PostgreSQL Simple</h1><div class="Post__meta___1fVoc" data-reactid="23"><!-- react-text: 24 -->Jul 4th, 2014<!-- /react-text --><!-- react-text: 25 --> · <!-- /react-text --><!-- react-text: 26 -->3<!-- /react-text --><!-- react-text: 27 --> minute read<!-- /react-text --></div></div></div><div class="Post__container___f_rKX" data-reactid="28"><div class="Post__singleColumn___tYK8R" data-reactid="29"><div data-reactid="30"><p>I wrote a simple Haxl DataSource and I thought it would be good to share. If you
don’t know what Haxl is you can find out more
<a href="https://github.com/facebook/Haxl">here</a>.</p>
<p>The gist with the relevant .cabal and DataSource is
<a href="https://gist.github.com/ChristopherBiscardi/45c765eb292d96ab4549">here</a></p>
<h2 id="table">Table</h2>
<p>We will need a people table to store our people:</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-keyword___som98">CREATE</span> <span class="highlight__hljs-keyword___som98">TABLE</span> people (
    _id bigserial primary <span class="highlight__hljs-keyword___som98">key</span>,
    first_name <span class="highlight__hljs-built_in___3uuyR">text</span> <span class="highlight__hljs-keyword___som98">NOT</span> <span class="highlight__hljs-literal___1V6TY">NULL</span>,
    last_name <span class="highlight__hljs-built_in___3uuyR">text</span> <span class="highlight__hljs-keyword___som98">NOT</span> <span class="highlight__hljs-literal___1V6TY">NULL</span>,
    age <span class="highlight__hljs-built_in___3uuyR">int</span> <span class="highlight__hljs-keyword___som98">NOT</span> <span class="highlight__hljs-literal___1V6TY">NULL</span>
);
</code></pre>
<p>And some data to query:</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-keyword___som98">INSERT</span> <span class="highlight__hljs-keyword___som98">INTO</span> people (<span class="highlight__hljs-string___1SffY">"first_name"</span>, <span class="highlight__hljs-string___1SffY">"last_name"</span>, <span class="highlight__hljs-string___1SffY">"age"</span>) <span class="highlight__hljs-keyword___som98">VALUES</span> (<span class="highlight__hljs-string___1SffY">'Bob'</span>,<span class="highlight__hljs-string___1SffY">'Seger'</span>,<span class="highlight__hljs-number___2gmaH">69</span>);
<span class="highlight__hljs-keyword___som98">INSERT</span> <span class="highlight__hljs-keyword___som98">INTO</span> people (<span class="highlight__hljs-string___1SffY">"first_name"</span>, <span class="highlight__hljs-string___1SffY">"last_name"</span>, <span class="highlight__hljs-string___1SffY">"age"</span>) <span class="highlight__hljs-keyword___som98">VALUES</span> (<span class="highlight__hljs-string___1SffY">'Billy'</span>,<span class="highlight__hljs-string___1SffY">'Idol'</span>,<span class="highlight__hljs-number___2gmaH">58</span>);
</code></pre>
<p>which gives us a table that looks like:</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code>peopledb=# select * from people;
 _id | first_name | last_name | age
-----+------------+-----------+-----
   1 | Bob        | Seger     |  69
   2 | Billy      | Idol      |  58
(2 rows)
</code></pre>
<p>We can then head into ghci and check out the Haxl DataSource.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-title___1fl8Q">ghci</span> <span class="highlight__hljs-type___11WfV">DataSource</span>.hs
<span class="highlight__hljs-title___1fl8Q">let</span> cinfo = defaultConnectInfo {
    connectUser = <span class="highlight__hljs-string___1SffY">"pgsuper"</span>
  , connectPassword = <span class="highlight__hljs-string___1SffY">"password"</span>
  , connectDatabase = <span class="highlight__hljs-string___1SffY">"peopledb"</span>
  }
<span class="highlight__hljs-title___1fl8Q">pgstate</span>
</code></pre>
<p>If we check out the value of <code>r</code> we see a <code>Just Person</code>.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-type___11WfV">Just</span> (<span class="highlight__hljs-type___11WfV">Person</span> {_id = <span class="highlight__hljs-type___11WfV">PersonId</span> <span class="highlight__hljs-number___2gmaH">1</span>, first_name = <span class="highlight__hljs-string___1SffY">"Bob"</span>, last_name = <span class="highlight__hljs-string___1SffY">"Seger"</span>, age = <span class="highlight__hljs-number___2gmaH">69</span>})
</code></pre>
<h2 id="the-code">The Code</h2>
<p>First, we need a datatype to be querying. Of note is that we’ve <code>newtype</code>'d
<code>PersonId</code>, so we’ll use <code>GeneralizedNewtypeDeriving</code> to get the <code>FromField</code>
instance from <code>Int</code></p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-class___mOeOV"><span class="highlight__hljs-keyword___som98">newtype</span> <span class="highlight__hljs-type___11WfV">PersonId</span> = <span class="highlight__hljs-type___11WfV">PersonId</span> <span class="highlight__hljs-type___11WfV">Int</span> <span class="highlight__hljs-keyword___som98">deriving</span> (<span class="highlight__hljs-type___11WfV">Show</span>, <span class="highlight__hljs-type___11WfV">Eq</span>, <span class="highlight__hljs-type___11WfV">FromField</span>)</span>

<span class="highlight__hljs-class___mOeOV"><span class="highlight__hljs-keyword___som98">data</span> <span class="highlight__hljs-type___11WfV">Person</span> = <span class="highlight__hljs-type___11WfV">Person</span> { <span class="highlight__hljs-title___1fl8Q">_id</span>        :: <span class="highlight__hljs-type___11WfV">PersonId</span>
                     , <span class="highlight__hljs-title___1fl8Q">first_name</span> :: <span class="highlight__hljs-type___11WfV">Text</span>
                     , <span class="highlight__hljs-title___1fl8Q">last_name</span>  :: <span class="highlight__hljs-type___11WfV">Text</span>
                     , <span class="highlight__hljs-title___1fl8Q">age</span>        :: <span class="highlight__hljs-type___11WfV">Int</span> } <span class="highlight__hljs-keyword___som98">deriving</span> (<span class="highlight__hljs-type___11WfV">Show</span>, <span class="highlight__hljs-type___11WfV">Typeable</span>)</span>
</code></pre>
<p>Next we’ll define our requests as a GADT. In this case we only have a single
request type: “GetPerson”, which takes a <code>PersonId</code> and looks up that user.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-class___mOeOV"><span class="highlight__hljs-keyword___som98">data</span> <span class="highlight__hljs-type___11WfV">PGReq</span> a where</span>
  <span class="highlight__hljs-type___11WfV">GetPerson</span> :: <span class="highlight__hljs-type___11WfV">PersonId</span> -&gt; <span class="highlight__hljs-type___11WfV">PGReq</span> (<span class="highlight__hljs-type___11WfV">Maybe</span> <span class="highlight__hljs-type___11WfV">Person</span>)
  <span class="highlight__hljs-keyword___som98">deriving</span> <span class="highlight__hljs-type___11WfV">Typeable</span>
</code></pre>
<p>Now we need some simple boilerplate. The Hashable instance defines the hash of our request types for the cache. In this case a <code>GetPerson</code> request is as a tuple of <code>(0,PersonId)</code>.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-title___1fl8Q">deriving</span> <span class="highlight__hljs-keyword___som98">instance</span> <span class="highlight__hljs-type___11WfV">Eq</span> (<span class="highlight__hljs-type___11WfV">PGReq</span> a)
<span class="highlight__hljs-title___1fl8Q">deriving</span> <span class="highlight__hljs-keyword___som98">instance</span> <span class="highlight__hljs-type___11WfV">Show</span> (<span class="highlight__hljs-type___11WfV">PGReq</span> a)
<span class="highlight__hljs-class___mOeOV">
<span class="highlight__hljs-keyword___som98">instance</span> <span class="highlight__hljs-type___11WfV">Show1</span> <span class="highlight__hljs-type___11WfV">PGReq</span> <span class="highlight__hljs-keyword___som98">where</span></span> show1 = show
<span class="highlight__hljs-class___mOeOV">
<span class="highlight__hljs-keyword___som98">instance</span> <span class="highlight__hljs-type___11WfV">Hashable</span> (<span class="highlight__hljs-type___11WfV">PGReq</span> <span class="highlight__hljs-title___1fl8Q">a</span>) <span class="highlight__hljs-keyword___som98">where</span></span>
  hashWithSalt s (<span class="highlight__hljs-type___11WfV">GetPerson</span> (<span class="highlight__hljs-type___11WfV">PersonId</span> pid)) = hashWithSalt s (<span class="highlight__hljs-number___2gmaH">0</span>::<span class="highlight__hljs-type___11WfV">Int</span>, pid)
</code></pre>
<p>Following the boilerplate we’ll create a <code>StateKey</code> instance. Since this is a simple implementation, we’ll put the connection information in our state so we can create connections later. We’ll also define a function to initialize said state.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-class___mOeOV"><span class="highlight__hljs-keyword___som98">instance</span> <span class="highlight__hljs-type___11WfV">StateKey</span> <span class="highlight__hljs-type___11WfV">PGReq</span> <span class="highlight__hljs-keyword___som98">where</span></span>
  <span class="highlight__hljs-class___mOeOV"><span class="highlight__hljs-keyword___som98">data</span> <span class="highlight__hljs-type___11WfV">State</span> <span class="highlight__hljs-type___11WfV">PGReq</span> =</span>
    <span class="highlight__hljs-type___11WfV">PGState</span>
      { connInfo :: <span class="highlight__hljs-type___11WfV">ConnectInfo</span> }

<span class="highlight__hljs-title___1fl8Q">initHaxlState</span>
  :: <span class="highlight__hljs-type___11WfV">ConnectInfo</span>
  -&gt; <span class="highlight__hljs-type___11WfV">IO</span> (<span class="highlight__hljs-type___11WfV">State</span> <span class="highlight__hljs-type___11WfV">PGReq</span>)
<span class="highlight__hljs-title___1fl8Q">initHaxlState</span> cInfo = <span class="highlight__hljs-keyword___som98">do</span>
  return <span class="highlight__hljs-type___11WfV">PGState</span>
    { connInfo = cInfo }
</code></pre>
<p>Haxl needs us to name our DataSource and tell it which function to use for
fetching data.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-class___mOeOV"><span class="highlight__hljs-keyword___som98">instance</span> <span class="highlight__hljs-type___11WfV">DataSourceName</span> <span class="highlight__hljs-type___11WfV">PGReq</span> <span class="highlight__hljs-keyword___som98">where</span></span>
  dataSourceName _ = <span class="highlight__hljs-string___1SffY">"Postgres"</span>
<span class="highlight__hljs-class___mOeOV">
<span class="highlight__hljs-keyword___som98">instance</span> <span class="highlight__hljs-type___11WfV">DataSource</span> u <span class="highlight__hljs-type___11WfV">PGReq</span> <span class="highlight__hljs-keyword___som98">where</span></span>
  fetch = pgFetch
</code></pre>
<p>Then we can define our asynchronous fetch functions which will process our
<code>BlockedFetch</code>es. We put a failure on exceptions and pass the data through on a
success.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-title___1fl8Q">pgFetch</span>
 :: <span class="highlight__hljs-type___11WfV">State</span> <span class="highlight__hljs-type___11WfV">PGReq</span>
 -&gt; <span class="highlight__hljs-type___11WfV">Flags</span>
 -&gt; u
 -&gt; [<span class="highlight__hljs-type___11WfV">BlockedFetch</span> <span class="highlight__hljs-type___11WfV">PGReq</span>]
 -&gt; <span class="highlight__hljs-type___11WfV">PerformFetch</span>
<span class="highlight__hljs-title___1fl8Q">pgFetch</span> <span class="highlight__hljs-type___11WfV">PGState</span> {..} _flags _user bfs =
  <span class="highlight__hljs-type___11WfV">AsyncFetch</span> $ \inner -&gt; <span class="highlight__hljs-keyword___som98">do</span>
    asyncs  <span class="highlight__hljs-type___11WfV">BlockedFetch</span> <span class="highlight__hljs-type___11WfV">PGReq</span>
  -&gt; <span class="highlight__hljs-type___11WfV">IO</span> (<span class="highlight__hljs-type___11WfV">Async</span> ())
<span class="highlight__hljs-title___1fl8Q">fetchAsync</span> creds (<span class="highlight__hljs-type___11WfV">BlockedFetch</span> req rvar) =
  async $ <span class="highlight__hljs-keyword___som98">do</span>
    bracket (connect creds) (close) $ \conn -&gt; <span class="highlight__hljs-keyword___som98">do</span>
      e  putFailure rvar (ex :: <span class="highlight__hljs-type___11WfV">SomeException</span>)
        <span class="highlight__hljs-type___11WfV">Right</span> val -&gt; putSuccess rvar val
</code></pre>
<p>Finally, we can define our application logic. In this case our only request type
is <code>GetPerson</code>, so we need to get a single <code>Person</code> by <code>PersonId</code>. We could also
write more <code>fetchReq</code> patterns if we had more request types.</p>
<p><code>getPerson</code> is the function we’ll actually call to get a person by id; As seen
in the intro to this post.</p>
<pre class="highlight__hljs___FzKxy index__p2___65FBl"><code><span class="highlight__hljs-title___1fl8Q">fetchReq</span>
  :: <span class="highlight__hljs-type___11WfV">Connection</span>
  -&gt; <span class="highlight__hljs-type___11WfV">PGReq</span> a
  -&gt; <span class="highlight__hljs-type___11WfV">IO</span> a
<span class="highlight__hljs-title___1fl8Q">fetchReq</span> conn (<span class="highlight__hljs-type___11WfV">GetPerson</span> (<span class="highlight__hljs-type___11WfV">PersonId</span> pid)) = <span class="highlight__hljs-keyword___som98">do</span>
  people  <span class="highlight__hljs-type___11WfV">GenHaxl</span> u (<span class="highlight__hljs-type___11WfV">Maybe</span> <span class="highlight__hljs-type___11WfV">Person</span>)
<span class="highlight__hljs-title___1fl8Q">getPerson</span> pid = dataFetch (<span class="highlight__hljs-type___11WfV">GetPerson</span> pid)
</code></pre>
</div></div></div></div></div></div></div><script charset="UTF-8">window.__APOLLO_STATE__={"apollo":{"data":{"$ROOT_QUERY.root.post({\"slug\":\"a-foray-into-haxl-postgresql-simple\"})":{"body":"<p>I wrote a simple Haxl DataSource and I thought it would be good to share. If you\ndon’t know what Haxl is you can find out more\n<a href=\"https://github.com/facebook/Haxl\">here</a>.</p>\n<p>The gist with the relevant .cabal and DataSource is\n<a href=\"https://gist.github.com/ChristopherBiscardi/45c765eb292d96ab4549\">here</a></p>\n<h2 id=\"table\">Table</h2>\n<p>We will need a people table to store our people:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">TABLE</span> people (\n    _id bigserial primary <span class=\"highlight__hljs-keyword___som98\">key</span>,\n    first_name <span class=\"highlight__hljs-built_in___3uuyR\">text</span> <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n    last_name <span class=\"highlight__hljs-built_in___3uuyR\">text</span> <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n    age <span class=\"highlight__hljs-built_in___3uuyR\">int</span> <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>\n);\n</code></pre>\n<p>And some data to query:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">INSERT</span> <span class=\"highlight__hljs-keyword___som98\">INTO</span> people (<span class=\"highlight__hljs-string___1SffY\">\"first_name\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"last_name\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"age\"</span>) <span class=\"highlight__hljs-keyword___som98\">VALUES</span> (<span class=\"highlight__hljs-string___1SffY\">'Bob'</span>,<span class=\"highlight__hljs-string___1SffY\">'Seger'</span>,<span class=\"highlight__hljs-number___2gmaH\">69</span>);\n<span class=\"highlight__hljs-keyword___som98\">INSERT</span> <span class=\"highlight__hljs-keyword___som98\">INTO</span> people (<span class=\"highlight__hljs-string___1SffY\">\"first_name\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"last_name\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"age\"</span>) <span class=\"highlight__hljs-keyword___som98\">VALUES</span> (<span class=\"highlight__hljs-string___1SffY\">'Billy'</span>,<span class=\"highlight__hljs-string___1SffY\">'Idol'</span>,<span class=\"highlight__hljs-number___2gmaH\">58</span>);\n</code></pre>\n<p>which gives us a table that looks like:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>peopledb=# select * from people;\n _id | first_name | last_name | age\n-----+------------+-----------+-----\n   1 | Bob        | Seger     |  69\n   2 | Billy      | Idol      |  58\n(2 rows)\n</code></pre>\n<p>We can then head into ghci and check out the Haxl DataSource.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">ghci</span> <span class=\"highlight__hljs-type___11WfV\">DataSource</span>.hs\n<span class=\"highlight__hljs-title___1fl8Q\">let</span> cinfo = defaultConnectInfo {\n    connectUser = <span class=\"highlight__hljs-string___1SffY\">\"pgsuper\"</span>\n  , connectPassword = <span class=\"highlight__hljs-string___1SffY\">\"password\"</span>\n  , connectDatabase = <span class=\"highlight__hljs-string___1SffY\">\"peopledb\"</span>\n  }\n<span class=\"highlight__hljs-title___1fl8Q\">pgstate</span>\n</code></pre>\n<p>If we check out the value of <code>r</code> we see a <code>Just Person</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">Just</span> (<span class=\"highlight__hljs-type___11WfV\">Person</span> {_id = <span class=\"highlight__hljs-type___11WfV\">PersonId</span> <span class=\"highlight__hljs-number___2gmaH\">1</span>, first_name = <span class=\"highlight__hljs-string___1SffY\">\"Bob\"</span>, last_name = <span class=\"highlight__hljs-string___1SffY\">\"Seger\"</span>, age = <span class=\"highlight__hljs-number___2gmaH\">69</span>})\n</code></pre>\n<h2 id=\"the-code\">The Code</h2>\n<p>First, we need a datatype to be querying. Of note is that we’ve <code>newtype</code>'d\n<code>PersonId</code>, so we’ll use <code>GeneralizedNewtypeDeriving</code> to get the <code>FromField</code>\ninstance from <code>Int</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">newtype</span> <span class=\"highlight__hljs-type___11WfV\">PersonId</span> = <span class=\"highlight__hljs-type___11WfV\">PersonId</span> <span class=\"highlight__hljs-type___11WfV\">Int</span> <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>, <span class=\"highlight__hljs-type___11WfV\">Eq</span>, <span class=\"highlight__hljs-type___11WfV\">FromField</span>)</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">Person</span> = <span class=\"highlight__hljs-type___11WfV\">Person</span> { <span class=\"highlight__hljs-title___1fl8Q\">_id</span>        :: <span class=\"highlight__hljs-type___11WfV\">PersonId</span>\n                     , <span class=\"highlight__hljs-title___1fl8Q\">first_name</span> :: <span class=\"highlight__hljs-type___11WfV\">Text</span>\n                     , <span class=\"highlight__hljs-title___1fl8Q\">last_name</span>  :: <span class=\"highlight__hljs-type___11WfV\">Text</span>\n                     , <span class=\"highlight__hljs-title___1fl8Q\">age</span>        :: <span class=\"highlight__hljs-type___11WfV\">Int</span> } <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>, <span class=\"highlight__hljs-type___11WfV\">Typeable</span>)</span>\n</code></pre>\n<p>Next we’ll define our requests as a GADT. In this case we only have a single\nrequest type: “GetPerson”, which takes a <code>PersonId</code> and looks up that user.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span> a where</span>\n  <span class=\"highlight__hljs-type___11WfV\">GetPerson</span> :: <span class=\"highlight__hljs-type___11WfV\">PersonId</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">PGReq</span> (<span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Person</span>)\n  <span class=\"highlight__hljs-keyword___som98\">deriving</span> <span class=\"highlight__hljs-type___11WfV\">Typeable</span>\n</code></pre>\n<p>Now we need some simple boilerplate. The Hashable instance defines the hash of our request types for the cache. In this case a <code>GetPerson</code> request is as a tuple of <code>(0,PersonId)</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">deriving</span> <span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Eq</span> (<span class=\"highlight__hljs-type___11WfV\">PGReq</span> a)\n<span class=\"highlight__hljs-title___1fl8Q\">deriving</span> <span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Show</span> (<span class=\"highlight__hljs-type___11WfV\">PGReq</span> a)\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Show1</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span> show1 = show\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Hashable</span> (<span class=\"highlight__hljs-type___11WfV\">PGReq</span> <span class=\"highlight__hljs-title___1fl8Q\">a</span>) <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  hashWithSalt s (<span class=\"highlight__hljs-type___11WfV\">GetPerson</span> (<span class=\"highlight__hljs-type___11WfV\">PersonId</span> pid)) = hashWithSalt s (<span class=\"highlight__hljs-number___2gmaH\">0</span>::<span class=\"highlight__hljs-type___11WfV\">Int</span>, pid)\n</code></pre>\n<p>Following the boilerplate we’ll create a <code>StateKey</code> instance. Since this is a simple implementation, we’ll put the connection information in our state so we can create connections later. We’ll also define a function to initialize said state.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">StateKey</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">State</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span> =</span>\n    <span class=\"highlight__hljs-type___11WfV\">PGState</span>\n      { connInfo :: <span class=\"highlight__hljs-type___11WfV\">ConnectInfo</span> }\n\n<span class=\"highlight__hljs-title___1fl8Q\">initHaxlState</span>\n  :: <span class=\"highlight__hljs-type___11WfV\">ConnectInfo</span>\n  -&gt; <span class=\"highlight__hljs-type___11WfV\">IO</span> (<span class=\"highlight__hljs-type___11WfV\">State</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">initHaxlState</span> cInfo = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  return <span class=\"highlight__hljs-type___11WfV\">PGState</span>\n    { connInfo = cInfo }\n</code></pre>\n<p>Haxl needs us to name our DataSource and tell it which function to use for\nfetching data.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">DataSourceName</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  dataSourceName _ = <span class=\"highlight__hljs-string___1SffY\">\"Postgres\"</span>\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">DataSource</span> u <span class=\"highlight__hljs-type___11WfV\">PGReq</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  fetch = pgFetch\n</code></pre>\n<p>Then we can define our asynchronous fetch functions which will process our\n<code>BlockedFetch</code>es. We put a failure on exceptions and pass the data through on a\nsuccess.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">pgFetch</span>\n :: <span class=\"highlight__hljs-type___11WfV\">State</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span>\n -&gt; <span class=\"highlight__hljs-type___11WfV\">Flags</span>\n -&gt; u\n -&gt; [<span class=\"highlight__hljs-type___11WfV\">BlockedFetch</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span>]\n -&gt; <span class=\"highlight__hljs-type___11WfV\">PerformFetch</span>\n<span class=\"highlight__hljs-title___1fl8Q\">pgFetch</span> <span class=\"highlight__hljs-type___11WfV\">PGState</span> {..} _flags _user bfs =\n  <span class=\"highlight__hljs-type___11WfV\">AsyncFetch</span> $ \\inner -&gt; <span class=\"highlight__hljs-keyword___som98\">do</span>\n    asyncs  <span class=\"highlight__hljs-type___11WfV\">BlockedFetch</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span>\n  -&gt; <span class=\"highlight__hljs-type___11WfV\">IO</span> (<span class=\"highlight__hljs-type___11WfV\">Async</span> ())\n<span class=\"highlight__hljs-title___1fl8Q\">fetchAsync</span> creds (<span class=\"highlight__hljs-type___11WfV\">BlockedFetch</span> req rvar) =\n  async $ <span class=\"highlight__hljs-keyword___som98\">do</span>\n    bracket (connect creds) (close) $ \\conn -&gt; <span class=\"highlight__hljs-keyword___som98\">do</span>\n      e  putFailure rvar (ex :: <span class=\"highlight__hljs-type___11WfV\">SomeException</span>)\n        <span class=\"highlight__hljs-type___11WfV\">Right</span> val -&gt; putSuccess rvar val\n</code></pre>\n<p>Finally, we can define our application logic. In this case our only request type\nis <code>GetPerson</code>, so we need to get a single <code>Person</code> by <code>PersonId</code>. We could also\nwrite more <code>fetchReq</code> patterns if we had more request types.</p>\n<p><code>getPerson</code> is the function we’ll actually call to get a person by id; As seen\nin the intro to this post.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">fetchReq</span>\n  :: <span class=\"highlight__hljs-type___11WfV\">Connection</span>\n  -&gt; <span class=\"highlight__hljs-type___11WfV\">PGReq</span> a\n  -&gt; <span class=\"highlight__hljs-type___11WfV\">IO</span> a\n<span class=\"highlight__hljs-title___1fl8Q\">fetchReq</span> conn (<span class=\"highlight__hljs-type___11WfV\">GetPerson</span> (<span class=\"highlight__hljs-type___11WfV\">PersonId</span> pid)) = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  people  <span class=\"highlight__hljs-type___11WfV\">GenHaxl</span> u (<span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Person</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">getPerson</span> pid = dataFetch (<span class=\"highlight__hljs-type___11WfV\">GetPerson</span> pid)\n</code></pre>\n","attributes":{"type":"id","id":"$ROOT_QUERY.root.post({\"slug\":\"a-foray-into-haxl-postgresql-simple\"}).attributes","generated":true},"__typename":"BlogPost"},"$ROOT_QUERY.root.post({\"slug\":\"a-foray-into-haxl-postgresql-simple\"}).attributes":{"title":"A Foray Into Haxl: PostgreSQL Simple","updatedAt":"Jul 4th, 2014","publishedAt":"Jul 4th, 2014","timeToRead":3,"headerImage":null,"url":"/2014/7/4/a-foray-into-haxl-postgresql-simple/","canonicalURL":null,"excerpt":"I wrote a simple Haxl DataSource and I thought it would be good to share. If you\ndon’t know what Haxl is you can find out more\nhere.","__typename":"BlogPostAttributes"},"$ROOT_QUERY.root":{"post({\"slug\":\"a-foray-into-haxl-postgresql-simple\"})":{"type":"id","id":"$ROOT_QUERY.root.post({\"slug\":\"a-foray-into-haxl-postgresql-simple\"})","generated":true},"__typename":"Query"},"ROOT_QUERY":{"root":{"type":"id","id":"$ROOT_QUERY.root","generated":true}}}}};</script><script src="/js/client.js" charset="UTF-8"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-46878058-1', 'auto');
          ga('send', 'pageview');</script></body></html>