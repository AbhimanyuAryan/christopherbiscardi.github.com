<html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" type="text/css" href="/styles.9d56a516f70356a9b04feaf105275e9d.css"/></head><body class="landing-page"><div id="react-mount"><div data-reactid=".l4cols2i2o" data-react-checksum="-1479086055"><div class="Nav__wrapper___u7BUA" data-reactid=".l4cols2i2o.0"><nav class="Nav__nav___1e2Pp" data-reactid=".l4cols2i2o.0.0"><a class="Nav__logoWrapper___35yvY" href="/" data-reactid=".l4cols2i2o.0.0.0"><img class="Nav__logo___sw4O9" src="/69305db2985e926d498b513a21d28383.png" data-reactid=".l4cols2i2o.0.0.0.0"/></a><ul class="Nav__items___1oDCD" data-reactid=".l4cols2i2o.0.0.1"><li data-reactid=".l4cols2i2o.0.0.1.0"><a class="Nav__itemLink___H6Isv" href="/posts" data-reactid=".l4cols2i2o.0.0.1.0.0">Posts</a></li><li data-reactid=".l4cols2i2o.0.0.1.1"><a href="https://github.com/ChristopherBiscardi/ama" class="Nav__itemLink___H6Isv" data-reactid=".l4cols2i2o.0.0.1.1.0">AMA</a></li><li data-reactid=".l4cols2i2o.0.0.1.2"><a class="Nav__itemLink___H6Isv" href="/books" data-reactid=".l4cols2i2o.0.0.1.2.0">Books</a></li><li data-reactid=".l4cols2i2o.0.0.1.3"><a class="Nav__itemLink___H6Isv" href="/projects" data-reactid=".l4cols2i2o.0.0.1.3.0">Projects</a></li></ul></nav></div><div data-reactid=".l4cols2i2o.1"><div class="Post__container___3xG6t" data-reactid=".l4cols2i2o.1.0"><div class="Post__singleColumn___3RGaV" data-reactid=".l4cols2i2o.1.0.0"><h1 class="Post__title___1k3xj" data-reactid=".l4cols2i2o.1.0.0.0">A Foray Into Haxl: PostgreSQL Simple</h1><div class="Post__meta___1jyEB" data-reactid=".l4cols2i2o.1.0.0.1"><span data-reactid=".l4cols2i2o.1.0.0.1.0">Jul 4th, 2014</span><span data-reactid=".l4cols2i2o.1.0.0.1.1"> · </span><span data-reactid=".l4cols2i2o.1.0.0.1.2">3</span><span data-reactid=".l4cols2i2o.1.0.0.1.3"> minute read</span></div><div data-reactid=".l4cols2i2o.1.0.0.2"><p>I wrote a simple Haxl DataSource and I thought it would be good to share. If you
don’t know what Haxl is you can find out more
<a href="https://github.com/facebook/Haxl">here</a>.</p>
<p>The gist with the relevant .cabal and DataSource is
<a href="https://gist.github.com/ChristopherBiscardi/45c765eb292d96ab4549">here</a></p>
<h2 id="table">Table</h2>
<p>We will need a people table to store our people:</p>
<pre class="hljs"><code><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> people (
    _id bigserial primary <span class="hljs-keyword">key</span>,
    first_name <span class="hljs-built_in">text</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    last_name <span class="hljs-built_in">text</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    age <span class="hljs-built_in">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);
</code></pre>
<p>And some data to query:</p>
<pre class="hljs"><code><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> people (<span class="hljs-string">"first_name"</span>, <span class="hljs-string">"last_name"</span>, <span class="hljs-string">"age"</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'Bob'</span>,<span class="hljs-string">'Seger'</span>,<span class="hljs-number">69</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> people (<span class="hljs-string">"first_name"</span>, <span class="hljs-string">"last_name"</span>, <span class="hljs-string">"age"</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'Billy'</span>,<span class="hljs-string">'Idol'</span>,<span class="hljs-number">58</span>);
</code></pre>
<p>which gives us a table that looks like:</p>
<pre class="hljs"><code>peopledb=# select * from people;
 _id | first_name | last_name | age
-----+------------+-----------+-----
   1 | Bob        | Seger     |  69
   2 | Billy      | Idol      |  58
(2 rows)
</code></pre>
<p>We can then head into ghci and check out the Haxl DataSource.</p>
<pre class="hljs"><code><span class="hljs-title">ghci</span> <span class="hljs-type">DataSource</span>.hs
<span class="hljs-title">let</span> cinfo = defaultConnectInfo {
    connectUser = <span class="hljs-string">"pgsuper"</span>
  , connectPassword = <span class="hljs-string">"password"</span>
  , connectDatabase = <span class="hljs-string">"peopledb"</span>
  }
<span class="hljs-title">pgstate</span>
</code></pre>
<p>If we check out the value of <code>r</code> we see a <code>Just Person</code>.</p>
<pre class="hljs"><code><span class="hljs-type">Just</span> (<span class="hljs-type">Person</span> {_id = <span class="hljs-type">PersonId</span> <span class="hljs-number">1</span>, first_name = <span class="hljs-string">"Bob"</span>, last_name = <span class="hljs-string">"Seger"</span>, age = <span class="hljs-number">69</span>})
</code></pre>
<h2 id="the-code">The Code</h2>
<p>First, we need a datatype to be querying. Of note is that we’ve <code>newtype</code>'d
<code>PersonId</code>, so we’ll use <code>GeneralizedNewtypeDeriving</code> to get the <code>FromField</code>
instance from <code>Int</code></p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">newtype</span> <span class="hljs-type">PersonId</span> = <span class="hljs-type">PersonId</span> <span class="hljs-type">Int</span> <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Show</span>, <span class="hljs-type">Eq</span>, <span class="hljs-type">FromField</span>)</span>

<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">Person</span> = <span class="hljs-type">Person</span> { <span class="hljs-title">_id</span>        :: <span class="hljs-type">PersonId</span>
                     , <span class="hljs-title">first_name</span> :: <span class="hljs-type">Text</span>
                     , <span class="hljs-title">last_name</span>  :: <span class="hljs-type">Text</span>
                     , <span class="hljs-title">age</span>        :: <span class="hljs-type">Int</span> } <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Show</span>, <span class="hljs-type">Typeable</span>)</span>
</code></pre>
<p>Next we’ll define our requests as a GADT. In this case we only have a single
request type: “GetPerson”, which takes a <code>PersonId</code> and looks up that user.</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">PGReq</span> a where</span>
  <span class="hljs-type">GetPerson</span> :: <span class="hljs-type">PersonId</span> -&gt; <span class="hljs-type">PGReq</span> (<span class="hljs-type">Maybe</span> <span class="hljs-type">Person</span>)
  <span class="hljs-keyword">deriving</span> <span class="hljs-type">Typeable</span>
</code></pre>
<p>Now we need some simple boilerplate. The Hashable instance defines the hash of our request types for the cache. In this case a <code>GetPerson</code> request is as a tuple of <code>(0,PersonId)</code>.</p>
<pre class="hljs"><code><span class="hljs-title">deriving</span> <span class="hljs-keyword">instance</span> <span class="hljs-type">Eq</span> (<span class="hljs-type">PGReq</span> a)
<span class="hljs-title">deriving</span> <span class="hljs-keyword">instance</span> <span class="hljs-type">Show</span> (<span class="hljs-type">PGReq</span> a)
<span class="hljs-class">
<span class="hljs-keyword">instance</span> <span class="hljs-type">Show1</span> <span class="hljs-type">PGReq</span> <span class="hljs-keyword">where</span></span> show1 = show
<span class="hljs-class">
<span class="hljs-keyword">instance</span> <span class="hljs-type">Hashable</span> (<span class="hljs-type">PGReq</span> <span class="hljs-title">a</span>) <span class="hljs-keyword">where</span></span>
  hashWithSalt s (<span class="hljs-type">GetPerson</span> (<span class="hljs-type">PersonId</span> pid)) = hashWithSalt s (<span class="hljs-number">0</span>::<span class="hljs-type">Int</span>, pid)
</code></pre>
<p>Following the boilerplate we’ll create a <code>StateKey</code> instance. Since this is a simple implementation, we’ll put the connection information in our state so we can create connections later. We’ll also define a function to initialize said state.</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">StateKey</span> <span class="hljs-type">PGReq</span> <span class="hljs-keyword">where</span></span>
  <span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">State</span> <span class="hljs-type">PGReq</span> =</span>
    <span class="hljs-type">PGState</span>
      { connInfo :: <span class="hljs-type">ConnectInfo</span> }

<span class="hljs-title">initHaxlState</span>
  :: <span class="hljs-type">ConnectInfo</span>
  -&gt; <span class="hljs-type">IO</span> (<span class="hljs-type">State</span> <span class="hljs-type">PGReq</span>)
<span class="hljs-title">initHaxlState</span> cInfo = <span class="hljs-keyword">do</span>
  return <span class="hljs-type">PGState</span>
    { connInfo = cInfo }
</code></pre>
<p>Haxl needs us to name our DataSource and tell it which function to use for
fetching data.</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">DataSourceName</span> <span class="hljs-type">PGReq</span> <span class="hljs-keyword">where</span></span>
  dataSourceName _ = <span class="hljs-string">"Postgres"</span>
<span class="hljs-class">
<span class="hljs-keyword">instance</span> <span class="hljs-type">DataSource</span> u <span class="hljs-type">PGReq</span> <span class="hljs-keyword">where</span></span>
  fetch = pgFetch
</code></pre>
<p>Then we can define our asynchronous fetch functions which will process our
<code>BlockedFetch</code>es. We put a failure on exceptions and pass the data through on a
success.</p>
<pre class="hljs"><code><span class="hljs-title">pgFetch</span>
 :: <span class="hljs-type">State</span> <span class="hljs-type">PGReq</span>
 -&gt; <span class="hljs-type">Flags</span>
 -&gt; u
 -&gt; [<span class="hljs-type">BlockedFetch</span> <span class="hljs-type">PGReq</span>]
 -&gt; <span class="hljs-type">PerformFetch</span>
<span class="hljs-title">pgFetch</span> <span class="hljs-type">PGState</span> {..} _flags _user bfs =
  <span class="hljs-type">AsyncFetch</span> $ \inner -&gt; <span class="hljs-keyword">do</span>
    asyncs  <span class="hljs-type">BlockedFetch</span> <span class="hljs-type">PGReq</span>
  -&gt; <span class="hljs-type">IO</span> (<span class="hljs-type">Async</span> ())
<span class="hljs-title">fetchAsync</span> creds (<span class="hljs-type">BlockedFetch</span> req rvar) =
  async $ <span class="hljs-keyword">do</span>
    bracket (connect creds) (close) $ \conn -&gt; <span class="hljs-keyword">do</span>
      e  putFailure rvar (ex :: <span class="hljs-type">SomeException</span>)
        <span class="hljs-type">Right</span> val -&gt; putSuccess rvar val
</code></pre>
<p>Finally, we can define our application logic. In this case our only request type
is <code>GetPerson</code>, so we need to get a single <code>Person</code> by <code>PersonId</code>. We could also
write more <code>fetchReq</code> patterns if we had more request types.</p>
<p><code>getPerson</code> is the function we’ll actually call to get a person by id; As seen
in the intro to this post.</p>
<pre class="hljs"><code><span class="hljs-title">fetchReq</span>
  :: <span class="hljs-type">Connection</span>
  -&gt; <span class="hljs-type">PGReq</span> a
  -&gt; <span class="hljs-type">IO</span> a
<span class="hljs-title">fetchReq</span> conn (<span class="hljs-type">GetPerson</span> (<span class="hljs-type">PersonId</span> pid)) = <span class="hljs-keyword">do</span>
  people  <span class="hljs-type">GenHaxl</span> u (<span class="hljs-type">Maybe</span> <span class="hljs-type">Person</span>)
<span class="hljs-title">getPerson</span> pid = dataFetch (<span class="hljs-type">GetPerson</span> pid)
</code></pre>
</div></div></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-46878058-1', 'auto');
          ga('send', 'pageview');</script></body></html>