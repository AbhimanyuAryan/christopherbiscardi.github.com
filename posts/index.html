<html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title data-react-helmet="true"></title><link rel="stylesheet" type="text/css" href="/styles.f25bf9e6682280946ba2e441a544b407.css"/></head><body class="landing-page"><div id="content"><div data-reactroot="" data-reactid="1" data-react-checksum="1979219996"><div class="Nav__wrapper___u7BUA" data-reactid="2"><nav class="Nav__nav___1e2Pp" data-reactid="3"><a class="Nav__logoWrapper___35yvY" href="/" data-reactid="4"><img class="Nav__logo___sw4O9" src="/69305db2985e926d498b513a21d28383.png" data-reactid="5"/></a><ul class="Nav__items___1oDCD" data-reactid="6"><li data-reactid="7"><a class="Nav__itemLink___H6Isv Nav__active___2bCne" href="/posts/" data-reactid="8">Posts</a></li><li data-reactid="9"><a href="https://github.com/ChristopherBiscardi/ama/issues?q=is%3Aissue+is%3Aclosed" class="Nav__itemLink___H6Isv" data-reactid="10">AMA</a></li><li data-reactid="11"><a class="Nav__itemLink___H6Isv" href="/books/" data-reactid="12">Books</a></li><li data-reactid="13"><a class="Nav__itemLink___H6Isv" href="/projects/" data-reactid="14">Projects</a></li><li data-reactid="15"><a class="Nav__itemLink___H6Isv" href="/about/" data-reactid="16">About</a></li></ul></nav></div><div data-reactid="17"><ul class="Posts__container___2PlzX" data-reactid="18"><li class="Posts__li___4nwhp" data-reactid="19"><div class="PostCard__post___3wcGe" data-reactid="20"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="21"></div><div data-reactid="22"><a href="/react-communicating-with-children/" data-reactid="23"><h4 class="PostCard__heading___g30g2" data-reactid="24">React: Communicating With Children</h4></a><span class="PostCard__meta___1oEBN" data-reactid="25"><!-- react-text: 26 -->Nov 22nd, 2016<!-- /react-text --><!-- react-text: 27 --> • <!-- /react-text --><!-- react-text: 28 -->2<!-- /react-text --><!-- react-text: 29 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="30">How do custom React Components communicate with their children?</p><a class="PostCard__readMore___1LtB_" href="/react-communicating-with-children/" data-reactid="31">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="32"><div class="PostCard__post___3wcGe" data-reactid="33"><div class="PostCard__imageHeader___2PVNg PostCard__postHeader___1KtIc" style="background-image:url(/4697ea4ccbcd2ba2f293936baed59b9d.png);" data-reactid="34"></div><div data-reactid="35"><a href="/servant-custom-content-types/" data-reactid="36"><h4 class="PostCard__heading___g30g2" data-reactid="37">Servant Custom Content Types</h4></a><span class="PostCard__meta___1oEBN" data-reactid="38"><!-- react-text: 39 -->Oct 3rd, 2016<!-- /react-text --><!-- react-text: 40 --> • <!-- /react-text --><!-- react-text: 41 -->2<!-- /react-text --><!-- react-text: 42 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="43">Recently when implementing a Docker Registry I came across the need to
hash the incoming request body in a way that matches the…</p><a class="PostCard__readMore___1LtB_" href="/servant-custom-content-types/" data-reactid="44">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="45"><div class="PostCard__post___3wcGe" data-reactid="46"><div class="PostCard__imageHeader___2PVNg PostCard__postHeader___1KtIc" style="background-image:url(/da49167186a7e54073552e04d715a80f.png);" data-reactid="47"></div><div data-reactid="48"><a href="/building-a-docker-registry/" data-reactid="49"><h4 class="PostCard__heading___g30g2" data-reactid="50">Building a Docker Registry</h4></a><span class="PostCard__meta___1oEBN" data-reactid="51"><!-- react-text: 52 -->Oct 3rd, 2016<!-- /react-text --><!-- react-text: 53 --> • <!-- /react-text --><!-- react-text: 54 -->20<!-- /react-text --><!-- react-text: 55 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="56">Containers are surging right now. This series of blog posts will
explore a small corner of that universe by building a Docker Registry
that…</p><a class="PostCard__readMore___1LtB_" href="/building-a-docker-registry/" data-reactid="57">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="58"><div class="PostCard__post___3wcGe" data-reactid="59"><div class="PostCard__imageHeader___2PVNg PostCard__postHeader___1KtIc" style="background-image:url(/0e564987f79346b0e81685c304af3912.png);" data-reactid="60"></div><div data-reactid="61"><a href="/response-headers-with-servant/" data-reactid="62"><h4 class="PostCard__heading___g30g2" data-reactid="63">Response Headers with Servant</h4></a><span class="PostCard__meta___1oEBN" data-reactid="64"><!-- react-text: 65 -->Aug 8th, 2016<!-- /react-text --><!-- react-text: 66 --> • <!-- /react-text --><!-- react-text: 67 -->1<!-- /react-text --><!-- react-text: 68 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="69">It can be hard to figure out how to deal with all of the type
machinery in Servant. This post details adding headers to the response
of a…</p><a class="PostCard__readMore___1LtB_" href="/response-headers-with-servant/" data-reactid="70">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="71"><div class="PostCard__post___3wcGe" data-reactid="72"><div class="PostCard__imageHeader___2PVNg PostCard__postHeader___1KtIc" style="background-image:url(/4697ea4ccbcd2ba2f293936baed59b9d.png);" data-reactid="73"></div><div data-reactid="74"><a href="/instrumenting-servant-with-prometheus/" data-reactid="75"><h4 class="PostCard__heading___g30g2" data-reactid="76">Instrumenting Servant with Prometheus</h4></a><span class="PostCard__meta___1oEBN" data-reactid="77"><!-- react-text: 78 -->May 21st, 2016<!-- /react-text --><!-- react-text: 79 --> • <!-- /react-text --><!-- react-text: 80 -->2<!-- /react-text --><!-- react-text: 81 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="82">To set up a Servant/WAI application with monitoring, we will first
scaffold a servant application using stack.</p><a class="PostCard__readMore___1LtB_" href="/instrumenting-servant-with-prometheus/" data-reactid="83">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="84"><div class="PostCard__post___3wcGe" data-reactid="85"><div class="PostCard__imageHeader___2PVNg PostCard__postHeader___1KtIc" style="background-image:url(/0e564987f79346b0e81685c304af3912.png);" data-reactid="86"></div><div data-reactid="87"><a href="/reproducible-tutorials-with-stack/" data-reactid="88"><h4 class="PostCard__heading___g30g2" data-reactid="89">Reproducible Tutorials with Stack</h4></a><span class="PostCard__meta___1oEBN" data-reactid="90"><!-- react-text: 91 -->Apr 9th, 2016<!-- /react-text --><!-- react-text: 92 --> • <!-- /react-text --><!-- react-text: 93 -->1<!-- /react-text --><!-- react-text: 94 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="95">Stack yields some nice benefits for blogging, tutorials, and more. The
main benefit I want to talk about today is reproducibility when…</p><a class="PostCard__readMore___1LtB_" href="/reproducible-tutorials-with-stack/" data-reactid="96">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="97"><div class="PostCard__post___3wcGe" data-reactid="98"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="99"></div><div data-reactid="100"><a href="/episode-1-a-new-blog/" data-reactid="101"><h4 class="PostCard__heading___g30g2" data-reactid="102">Episode 1: A New Blog</h4></a><span class="PostCard__meta___1oEBN" data-reactid="103"><!-- react-text: 104 -->Mar 27th, 2016<!-- /react-text --><!-- react-text: 105 --> • <!-- /react-text --><!-- react-text: 106 -->1<!-- /react-text --><!-- react-text: 107 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="108">Hooray! A new published version of my blog (which also happens to
include everything on this domain and thus is not just a blog).</p><a class="PostCard__readMore___1LtB_" href="/episode-1-a-new-blog/" data-reactid="109">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="110"><div class="PostCard__post___3wcGe" data-reactid="111"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="112"></div><div data-reactid="113"><a href="/2014/12/27/deploying-a-minecraft-server-with-docker-machine/" data-reactid="114"><h4 class="PostCard__heading___g30g2" data-reactid="115">Deploying a Minecraft Server with Docker Machine</h4></a><span class="PostCard__meta___1oEBN" data-reactid="116"><!-- react-text: 117 -->Dec 27th, 2014<!-- /react-text --><!-- react-text: 118 --> • <!-- /react-text --><!-- react-text: 119 -->5<!-- /react-text --><!-- react-text: 120 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="121">The
previous post
explains how to get up and running with Docker machine. This one will
be a quick tutorial on setting up a Minecraft…</p><a class="PostCard__readMore___1LtB_" href="/2014/12/27/deploying-a-minecraft-server-with-docker-machine/" data-reactid="122">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="123"><div class="PostCard__post___3wcGe" data-reactid="124"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="125"></div><div data-reactid="126"><a href="/2014/12/21/docker-machine/" data-reactid="127"><h4 class="PostCard__heading___g30g2" data-reactid="128">Docker Machine</h4></a><span class="PostCard__meta___1oEBN" data-reactid="129"><!-- react-text: 130 -->Dec 21st, 2014<!-- /react-text --><!-- react-text: 131 --> • <!-- /react-text --><!-- react-text: 132 -->2<!-- /react-text --><!-- react-text: 133 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="134">In this post, I will record the process through which I attempt to use
Docker Machine to deploy a simple Haskell application on…</p><a class="PostCard__readMore___1LtB_" href="/2014/12/21/docker-machine/" data-reactid="135">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="136"><div class="PostCard__post___3wcGe" data-reactid="137"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="138"></div><div data-reactid="139"><a href="/2014/11/23/using-the-docker-haskell-official-image/" data-reactid="140"><h4 class="PostCard__heading___g30g2" data-reactid="141">Using the Docker-Haskell Official Image</h4></a><span class="PostCard__meta___1oEBN" data-reactid="142"><!-- react-text: 143 -->Nov 23rd, 2014<!-- /react-text --><!-- react-text: 144 --> • <!-- /react-text --><!-- react-text: 145 -->1<!-- /react-text --><!-- react-text: 146 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="147">Prerequisites: an install of Docker (If you don’t want an install, Digital Ocean also has a Docker Droplet).</p><a class="PostCard__readMore___1LtB_" href="/2014/11/23/using-the-docker-haskell-official-image/" data-reactid="148">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="149"><div class="PostCard__post___3wcGe" data-reactid="150"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="151"></div><div data-reactid="152"><a href="/2014/10/17/emacs-in-docker/" data-reactid="153"><h4 class="PostCard__heading___g30g2" data-reactid="154">Emacs in Docker</h4></a><span class="PostCard__meta___1oEBN" data-reactid="155"><!-- react-text: 156 -->Oct 17th, 2014<!-- /react-text --><!-- react-text: 157 --> • <!-- /react-text --><!-- react-text: 158 -->1<!-- /react-text --><!-- react-text: 159 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="160"></p><a class="PostCard__readMore___1LtB_" href="/2014/10/17/emacs-in-docker/" data-reactid="161">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="162"><div class="PostCard__post___3wcGe" data-reactid="163"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="164"></div><div data-reactid="165"><a href="/2014/10/15/deploying-snap-with-docker/" data-reactid="166"><h4 class="PostCard__heading___g30g2" data-reactid="167">Deploying Snap with Docker</h4></a><span class="PostCard__meta___1oEBN" data-reactid="168"><!-- react-text: 169 -->Oct 15th, 2014<!-- /react-text --><!-- react-text: 170 --> • <!-- /react-text --><!-- react-text: 171 -->2<!-- /react-text --><!-- react-text: 172 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="173"></p><a class="PostCard__readMore___1LtB_" href="/2014/10/15/deploying-snap-with-docker/" data-reactid="174">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="175"><div class="PostCard__post___3wcGe" data-reactid="176"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="177"></div><div data-reactid="178"><a href="/2014/10/5/working-with-snap-1-0/" data-reactid="179"><h4 class="PostCard__heading___g30g2" data-reactid="180">Working with Snap 1.0</h4></a><span class="PostCard__meta___1oEBN" data-reactid="181"><!-- react-text: 182 -->Oct 5th, 2014<!-- /react-text --><!-- react-text: 183 --> • <!-- /react-text --><!-- react-text: 184 -->1<!-- /react-text --><!-- react-text: 185 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="186"></p><a class="PostCard__readMore___1LtB_" href="/2014/10/5/working-with-snap-1-0/" data-reactid="187">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="188"><div class="PostCard__post___3wcGe" data-reactid="189"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="190"></div><div data-reactid="191"><a href="/2014/7/4/a-foray-into-haxl-postgresql-simple/" data-reactid="192"><h4 class="PostCard__heading___g30g2" data-reactid="193">A Foray Into Haxl: PostgreSQL Simple</h4></a><span class="PostCard__meta___1oEBN" data-reactid="194"><!-- react-text: 195 -->Jul 4th, 2014<!-- /react-text --><!-- react-text: 196 --> • <!-- /react-text --><!-- react-text: 197 -->3<!-- /react-text --><!-- react-text: 198 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="199">I wrote a simple Haxl DataSource and I thought it would be good to share. If you
don’t know what Haxl is you can find out more
here.</p><a class="PostCard__readMore___1LtB_" href="/2014/7/4/a-foray-into-haxl-postgresql-simple/" data-reactid="200">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="201"><div class="PostCard__post___3wcGe" data-reactid="202"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="203"></div><div data-reactid="204"><a href="/2014/6/29/stm-containers-benchmarks/" data-reactid="205"><h4 class="PostCard__heading___g30g2" data-reactid="206">STM-Containers Benchmarks</h4></a><span class="PostCard__meta___1oEBN" data-reactid="207"><!-- react-text: 208 -->Jun 29th, 2014<!-- /react-text --><!-- react-text: 209 --> • <!-- /react-text --><!-- react-text: 210 -->1<!-- /react-text --><!-- react-text: 211 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="212">Benchmarks available on GitHub and as Github pages.</p><a class="PostCard__readMore___1LtB_" href="/2014/6/29/stm-containers-benchmarks/" data-reactid="213">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="214"><div class="PostCard__post___3wcGe" data-reactid="215"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="216"></div><div data-reactid="217"><a href="/2014/6/22/getting-started-with-purescript/" data-reactid="218"><h4 class="PostCard__heading___g30g2" data-reactid="219">Getting Started with PureScript</h4></a><span class="PostCard__meta___1oEBN" data-reactid="220"><!-- react-text: 221 -->Jun 22nd, 2014<!-- /react-text --><!-- react-text: 222 --> • <!-- /react-text --><!-- react-text: 223 -->2<!-- /react-text --><!-- react-text: 224 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="225">According to PureScript.org</p><a class="PostCard__readMore___1LtB_" href="/2014/6/22/getting-started-with-purescript/" data-reactid="226">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="227"><div class="PostCard__post___3wcGe" data-reactid="228"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="229"></div><div data-reactid="230"><a href="/2014/4/9/handling-taps-on-listgrid-items-with-viewpagers-gesture/" data-reactid="231"><h4 class="PostCard__heading___g30g2" data-reactid="232">Handling Taps on List/Grid Items with ViewPagers (GestureDetector)</h4></a><span class="PostCard__meta___1oEBN" data-reactid="233"><!-- react-text: 234 -->Apr 9th, 2014<!-- /react-text --><!-- react-text: 235 --> • <!-- /react-text --><!-- react-text: 236 -->1<!-- /react-text --><!-- react-text: 237 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="238">When placing a ViewPager inside of a GridView recently I ran into the issue of
the ViewPager stealing the GridView Items’ click event. I…</p><a class="PostCard__readMore___1LtB_" href="/2014/4/9/handling-taps-on-listgrid-items-with-viewpagers-gesture/" data-reactid="239">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="240"><div class="PostCard__post___3wcGe" data-reactid="241"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="242"></div><div data-reactid="243"><a href="/2014/4/8/snap-postgres-and-heist-displaying-data-from-queries/" data-reactid="244"><h4 class="PostCard__heading___g30g2" data-reactid="245">Snap, Postgres and Heist: Displaying Data from Queries</h4></a><span class="PostCard__meta___1oEBN" data-reactid="246"><!-- react-text: 247 -->Apr 8th, 2014<!-- /react-text --><!-- react-text: 248 --> • <!-- /react-text --><!-- react-text: 249 -->2<!-- /react-text --><!-- react-text: 250 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="251">The github repo for this post is here.</p><a class="PostCard__readMore___1LtB_" href="/2014/4/8/snap-postgres-and-heist-displaying-data-from-queries/" data-reactid="252">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="253"><div class="PostCard__post___3wcGe" data-reactid="254"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="255"></div><div data-reactid="256"><a href="/2014/3/8/getting-started-with-robolectric-headless-android-testing-with-vagrant/" data-reactid="257"><h4 class="PostCard__heading___g30g2" data-reactid="258">Getting Started with Robolectric: Headless Android Testing with Vagrant</h4></a><span class="PostCard__meta___1oEBN" data-reactid="259"><!-- react-text: 260 -->Mar 8th, 2014<!-- /react-text --><!-- react-text: 261 --> • <!-- /react-text --><!-- react-text: 262 -->3<!-- /react-text --><!-- react-text: 263 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="264">In this post we will go over how to set up the sample project for Robolectric,
run, test and deploy to a device in a headless vagrant…</p><a class="PostCard__readMore___1LtB_" href="/2014/3/8/getting-started-with-robolectric-headless-android-testing-with-vagrant/" data-reactid="265">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="266"><div class="PostCard__post___3wcGe" data-reactid="267"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="268"></div><div data-reactid="269"><a href="/2014/3/5/ghc-ddump-minimal-imports-and-cpp-error-missing-binary-operator-before-token/" data-reactid="270"><h4 class="PostCard__heading___g30g2" data-reactid="271">GHC -ddump-minimal-imports and CPP error: missing binary operator before token &quot;(&quot;</h4></a><span class="PostCard__meta___1oEBN" data-reactid="272"><!-- react-text: 273 -->Mar 5th, 2014<!-- /react-text --><!-- react-text: 274 --> • <!-- /react-text --><!-- react-text: 275 -->1<!-- /react-text --><!-- react-text: 276 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="277">Today I was trying to extract the minimal imports for a module using ghc -ddump-minimal-imports but I was getting this error on some files:</p><a class="PostCard__readMore___1LtB_" href="/2014/3/5/ghc-ddump-minimal-imports-and-cpp-error-missing-binary-operator-before-token/" data-reactid="278">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="279"><div class="PostCard__post___3wcGe" data-reactid="280"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="281"></div><div data-reactid="282"><a href="/2014/2/12/riak-haproxy-and-haskell-multimachine-vagrant-on-osx/" data-reactid="283"><h4 class="PostCard__heading___g30g2" data-reactid="284">Riak, HAProxy and Haskell: MultiMachine Vagrant on OSX</h4></a><span class="PostCard__meta___1oEBN" data-reactid="285"><!-- react-text: 286 -->Feb 12th, 2014<!-- /react-text --><!-- react-text: 287 --> • <!-- /react-text --><!-- react-text: 288 -->5<!-- /react-text --><!-- react-text: 289 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="290"></p><a class="PostCard__readMore___1LtB_" href="/2014/2/12/riak-haproxy-and-haskell-multimachine-vagrant-on-osx/" data-reactid="291">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="292"><div class="PostCard__post___3wcGe" data-reactid="293"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="294"></div><div data-reactid="295"><a href="/2014/2/7/geospatial-indexing-with-riak-search-2-0-yokozunasolr/" data-reactid="296"><h4 class="PostCard__heading___g30g2" data-reactid="297">GeoSpatial Indexing with Riak Search 2.0 (Yokozuna/Solr)</h4></a><span class="PostCard__meta___1oEBN" data-reactid="298"><!-- react-text: 299 -->Feb 7th, 2014<!-- /react-text --><!-- react-text: 300 --> • <!-- /react-text --><!-- react-text: 301 -->7<!-- /react-text --><!-- react-text: 302 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="303">In this post we will be using curl to construct a geospatial index using Riak
Search 2 (also known as Yokozuna) which is backed by Solr.</p><a class="PostCard__readMore___1LtB_" href="/2014/2/7/geospatial-indexing-with-riak-search-2-0-yokozunasolr/" data-reactid="304">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="305"><div class="PostCard__post___3wcGe" data-reactid="306"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="307"></div><div data-reactid="308"><a href="/2014/2/6/environment-variables-in-haskell/" data-reactid="309"><h4 class="PostCard__heading___g30g2" data-reactid="310">Environment Variables in Haskell</h4></a><span class="PostCard__meta___1oEBN" data-reactid="311"><!-- react-text: 312 -->Feb 6th, 2014<!-- /react-text --><!-- react-text: 313 --> • <!-- /react-text --><!-- react-text: 314 -->1<!-- /react-text --><!-- react-text: 315 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="316">In this post we will go over how to accept environmental variables in Haskell.</p><a class="PostCard__readMore___1LtB_" href="/2014/2/6/environment-variables-in-haskell/" data-reactid="317">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="318"><div class="PostCard__post___3wcGe" data-reactid="319"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="320"></div><div data-reactid="321"><a href="/2014/2/4/writing-a-first-emacs-elisp-function/" data-reactid="322"><h4 class="PostCard__heading___g30g2" data-reactid="323">Writing A First Emacs Elisp Function</h4></a><span class="PostCard__meta___1oEBN" data-reactid="324"><!-- react-text: 325 -->Feb 4th, 2014<!-- /react-text --><!-- react-text: 326 --> • <!-- /react-text --><!-- react-text: 327 -->2<!-- /react-text --><!-- react-text: 328 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="329">So today I tried to write my first fully custom Emacs Lisp code. Here are some things I learned (along with the code for a region-to-gist…</p><a class="PostCard__readMore___1LtB_" href="/2014/2/4/writing-a-first-emacs-elisp-function/" data-reactid="330">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="331"><div class="PostCard__post___3wcGe" data-reactid="332"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="333"></div><div data-reactid="334"><a href="/2014/2/2/deploy-haskells-snap-on-heroku/" data-reactid="335"><h4 class="PostCard__heading___g30g2" data-reactid="336">Deploy Haskell&#x27;s Snap on Heroku</h4></a><span class="PostCard__meta___1oEBN" data-reactid="337"><!-- react-text: 338 -->Feb 2nd, 2014<!-- /react-text --><!-- react-text: 339 --> • <!-- /react-text --><!-- react-text: 340 -->1<!-- /react-text --><!-- react-text: 341 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="342">In this post we will deploy our Snap app to Heroku.</p><a class="PostCard__readMore___1LtB_" href="/2014/2/2/deploy-haskells-snap-on-heroku/" data-reactid="343">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="344"><div class="PostCard__post___3wcGe" data-reactid="345"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="346"></div><div data-reactid="347"><a href="/2014/2/1/in-search-of-a-riak-solr-client-for-haskell/" data-reactid="348"><h4 class="PostCard__heading___g30g2" data-reactid="349">In Search of a Riak Solr Client for Haskell</h4></a><span class="PostCard__meta___1oEBN" data-reactid="350"><!-- react-text: 351 -->Feb 1st, 2014<!-- /react-text --><!-- react-text: 352 --> • <!-- /react-text --><!-- react-text: 353 -->5<!-- /react-text --><!-- react-text: 354 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="355">In this post are the beginnings of riak-solr-client.</p><a class="PostCard__readMore___1LtB_" href="/2014/2/1/in-search-of-a-riak-solr-client-for-haskell/" data-reactid="356">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="357"><div class="PostCard__post___3wcGe" data-reactid="358"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="359"></div><div data-reactid="360"><a href="/2014/1/28/android-listfragment-populated-by-robospice/" data-reactid="361"><h4 class="PostCard__heading___g30g2" data-reactid="362">Android ListFragment Populated by RoboSpice</h4></a><span class="PostCard__meta___1oEBN" data-reactid="363"><!-- react-text: 364 -->Jan 28th, 2014<!-- /react-text --><!-- react-text: 365 --> • <!-- /react-text --><!-- react-text: 366 -->4<!-- /react-text --><!-- react-text: 367 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="368">In this post we are going to add a ListFragment backed by the RoboSpice data
from the first
post</p><a class="PostCard__readMore___1LtB_" href="/2014/1/28/android-listfragment-populated-by-robospice/" data-reactid="369">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="370"><div class="PostCard__post___3wcGe" data-reactid="371"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="372"></div><div data-reactid="373"><a href="/2014/1/27/android-robospice-with-googlehttpclient/" data-reactid="374"><h4 class="PostCard__heading___g30g2" data-reactid="375">Android RoboSpice with GoogleHttpClient</h4></a><span class="PostCard__meta___1oEBN" data-reactid="376"><!-- react-text: 377 -->Jan 27th, 2014<!-- /react-text --><!-- react-text: 378 --> • <!-- /react-text --><!-- react-text: 379 -->7<!-- /react-text --><!-- react-text: 380 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="381">In this post we will examine an example app in which we make a RoboSpice request
using GoogleHttpClient.</p><a class="PostCard__readMore___1LtB_" href="/2014/1/27/android-robospice-with-googlehttpclient/" data-reactid="382">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="383"><div class="PostCard__post___3wcGe" data-reactid="384"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="385"></div><div data-reactid="386"><a href="/2014/1/16/mocl-for-android-part-2-drakma/" data-reactid="387"><h4 class="PostCard__heading___g30g2" data-reactid="388">MOCL for Android Part 2: Drakma</h4></a><span class="PostCard__meta___1oEBN" data-reactid="389"><!-- react-text: 390 -->Jan 16th, 2014<!-- /react-text --><!-- react-text: 391 --> • <!-- /react-text --><!-- react-text: 392 -->1<!-- /react-text --><!-- react-text: 393 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="394">In this post we will enable Drakma HTTP support in the Android/MOCL example
code. I have forked the repo on
Github
for posterity. The first…</p><a class="PostCard__readMore___1LtB_" href="/2014/1/16/mocl-for-android-part-2-drakma/" data-reactid="395">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="396"><div class="PostCard__post___3wcGe" data-reactid="397"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="398"></div><div data-reactid="399"><a href="/2014/1/15/scaffolding-a-clojurecompojure-webapp-for-heroku/" data-reactid="400"><h4 class="PostCard__heading___g30g2" data-reactid="401">Scaffolding a Clojure/Compojure Webapp for Heroku</h4></a><span class="PostCard__meta___1oEBN" data-reactid="402"><!-- react-text: 403 -->Jan 15th, 2014<!-- /react-text --><!-- react-text: 404 --> • <!-- /react-text --><!-- react-text: 405 -->1<!-- /react-text --><!-- react-text: 406 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="407">In this post we’ll go through the process to create a basic Clojure/Compojure/libnoir scaffolding project and deploying it to Heroku.</p><a class="PostCard__readMore___1LtB_" href="/2014/1/15/scaffolding-a-clojurecompojure-webapp-for-heroku/" data-reactid="408">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="409"><div class="PostCard__post___3wcGe" data-reactid="410"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="411"></div><div data-reactid="412"><a href="/2014/1/11/getting-started-with-snap-and-user-authentication-part-3/" data-reactid="413"><h4 class="PostCard__heading___g30g2" data-reactid="414">Getting Started With Snap (and User Authentication): Part 3</h4></a><span class="PostCard__meta___1oEBN" data-reactid="415"><!-- react-text: 416 -->Jan 11th, 2014<!-- /react-text --><!-- react-text: 417 --> • <!-- /react-text --><!-- react-text: 418 -->1<!-- /react-text --><!-- react-text: 419 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="420">In this post we will be replacing the JSON file (for user authentication) with a
Postgres database.</p><a class="PostCard__readMore___1LtB_" href="/2014/1/11/getting-started-with-snap-and-user-authentication-part-3/" data-reactid="421">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="422"><div class="PostCard__post___3wcGe" data-reactid="423"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="424"></div><div data-reactid="425"><a href="/2014/1/10/common-lisp-on-android-running-the-mocl-android-example/" data-reactid="426"><h4 class="PostCard__heading___g30g2" data-reactid="427">Common Lisp on Android: Running the MOCL Android Example</h4></a><span class="PostCard__meta___1oEBN" data-reactid="428"><!-- react-text: 429 -->Jan 10th, 2014<!-- /react-text --><!-- react-text: 430 --> • <!-- /react-text --><!-- react-text: 431 -->1<!-- /react-text --><!-- react-text: 432 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="433">Prereqs: Install ADK, Android NDK, and mocl.</p><a class="PostCard__readMore___1LtB_" href="/2014/1/10/common-lisp-on-android-running-the-mocl-android-example/" data-reactid="434">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="435"><div class="PostCard__post___3wcGe" data-reactid="436"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="437"></div><div data-reactid="438"><a href="/2014/1/9/getting-started-with-snap-and-user-authentication-part-2/" data-reactid="439"><h4 class="PostCard__heading___g30g2" data-reactid="440">Getting Started With Snap (and User Authentication): Part 2</h4></a><span class="PostCard__meta___1oEBN" data-reactid="441"><!-- react-text: 442 -->Jan 10th, 2014<!-- /react-text --><!-- react-text: 443 --> • <!-- /react-text --><!-- react-text: 444 -->3<!-- /react-text --><!-- react-text: 445 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="446"></p><a class="PostCard__readMore___1LtB_" href="/2014/1/9/getting-started-with-snap-and-user-authentication-part-2/" data-reactid="447">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="448"><div class="PostCard__post___3wcGe" data-reactid="449"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="450"></div><div data-reactid="451"><a href="/2014/1/9/using-databases-inside-of-snaplet-auth-restricted-routes/" data-reactid="452"><h4 class="PostCard__heading___g30g2" data-reactid="453">Using Databases inside of Snaplet Auth Restricted Routes</h4></a><span class="PostCard__meta___1oEBN" data-reactid="454"><!-- react-text: 455 -->Jan 9th, 2014<!-- /react-text --><!-- react-text: 456 --> • <!-- /react-text --><!-- react-text: 457 -->1<!-- /react-text --><!-- react-text: 458 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="459">The github repo for this code is at here.</p><a class="PostCard__readMore___1LtB_" href="/2014/1/9/using-databases-inside-of-snaplet-auth-restricted-routes/" data-reactid="460">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="461"><div class="PostCard__post___3wcGe" data-reactid="462"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="463"></div><div data-reactid="464"><a href="/2014/1/7/books-on-my-bookshelf-for-2014/" data-reactid="465"><h4 class="PostCard__heading___g30g2" data-reactid="466">Books on My Bookshelf for 2014</h4></a><span class="PostCard__meta___1oEBN" data-reactid="467"><!-- react-text: 468 -->Jan 8th, 2014<!-- /react-text --><!-- react-text: 469 --> • <!-- /react-text --><!-- react-text: 470 -->3<!-- /react-text --><!-- react-text: 471 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="472">I decided to take stock of the books that are sitting on my bookshelf for 2014.
Here is that list.</p><a class="PostCard__readMore___1LtB_" href="/2014/1/7/books-on-my-bookshelf-for-2014/" data-reactid="473">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="474"><div class="PostCard__post___3wcGe" data-reactid="475"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="476"></div><div data-reactid="477"><a href="/2014/1/6/getting-started-with-snap-and-user-authentication-part-1/" data-reactid="478"><h4 class="PostCard__heading___g30g2" data-reactid="479">Getting Started With Snap (and User Authentication): Part 1</h4></a><span class="PostCard__meta___1oEBN" data-reactid="480"><!-- react-text: 481 -->Jan 7th, 2014<!-- /react-text --><!-- react-text: 482 --> • <!-- /react-text --><!-- react-text: 483 -->1<!-- /react-text --><!-- react-text: 484 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="485">Part 2</p><a class="PostCard__readMore___1LtB_" href="/2014/1/6/getting-started-with-snap-and-user-authentication-part-1/" data-reactid="486">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="487"><div class="PostCard__post___3wcGe" data-reactid="488"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="489"></div><div data-reactid="490"><a href="/2014/1/5/flattening-nested-arrays-in-javascript/" data-reactid="491"><h4 class="PostCard__heading___g30g2" data-reactid="492">Flattening Nested Arrays in JavaScript</h4></a><span class="PostCard__meta___1oEBN" data-reactid="493"><!-- react-text: 494 -->Jan 6th, 2014<!-- /react-text --><!-- react-text: 495 --> • <!-- /react-text --><!-- react-text: 496 -->1<!-- /react-text --><!-- react-text: 497 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="498">I was writing a quick script today and came across a nice use case for .apply to
merge nested arrays into a single array. So I figured I’d…</p><a class="PostCard__readMore___1LtB_" href="/2014/1/5/flattening-nested-arrays-in-javascript/" data-reactid="499">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="500"><div class="PostCard__post___3wcGe" data-reactid="501"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="502"></div><div data-reactid="503"><a href="/2013/7/25/installing-montage-a-riak-sibling-resolution-library-written-in-haskell-on-osx/" data-reactid="504"><h4 class="PostCard__heading___g30g2" data-reactid="505">Installing Montage: A Riak sibling resolution library written in Haskell, on OSX</h4></a><span class="PostCard__meta___1oEBN" data-reactid="506"><!-- react-text: 507 -->Jul 26th, 2013<!-- /react-text --><!-- react-text: 508 --> • <!-- /react-text --><!-- react-text: 509 -->1<!-- /react-text --><!-- react-text: 510 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="511">Here is a description of how I installed Montage (https://github.com/bumptech/montage) with GHC 7.6.1</p><a class="PostCard__readMore___1LtB_" href="/2013/7/25/installing-montage-a-riak-sibling-resolution-library-written-in-haskell-on-osx/" data-reactid="512">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="513"><div class="PostCard__post___3wcGe" data-reactid="514"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="515"></div><div data-reactid="516"><a href="/2013/7/12/vagrant-can-not-ssh-into-the-box/" data-reactid="517"><h4 class="PostCard__heading___g30g2" data-reactid="518">Vagrant Can Not SSH Into the Box</h4></a><span class="PostCard__meta___1oEBN" data-reactid="519"><!-- react-text: 520 -->Jul 12th, 2013<!-- /react-text --><!-- react-text: 521 --> • <!-- /react-text --><!-- react-text: 522 -->1<!-- /react-text --><!-- react-text: 523 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="524">For Vagrant, if you see this error after vagrant up-ing the box.</p><a class="PostCard__readMore___1LtB_" href="/2013/7/12/vagrant-can-not-ssh-into-the-box/" data-reactid="525">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="526"><div class="PostCard__post___3wcGe" data-reactid="527"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="528"></div><div data-reactid="529"><a href="/2013/2/26/installing-yokozuna-on-osx-lion-with-homebrew/" data-reactid="530"><h4 class="PostCard__heading___g30g2" data-reactid="531">Installing Yokozuna on OSX Lion with Homebrew</h4></a><span class="PostCard__meta___1oEBN" data-reactid="532"><!-- react-text: 533 -->Feb 26th, 2013<!-- /react-text --><!-- react-text: 534 --> • <!-- /react-text --><!-- react-text: 535 -->1<!-- /react-text --><!-- react-text: 536 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="537">It’s important to have Ivy installed before make yz-setup or the priv/solr.jar
won’t be built. The build script only checks for the…</p><a class="PostCard__readMore___1LtB_" href="/2013/2/26/installing-yokozuna-on-osx-lion-with-homebrew/" data-reactid="538">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="539"><div class="PostCard__post___3wcGe" data-reactid="540"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="541"></div><div data-reactid="542"><a href="/2013/2/17/clojure-compojure-jetty-integration/" data-reactid="543"><h4 class="PostCard__heading___g30g2" data-reactid="544">Clojure Compojure Jetty Integration</h4></a><span class="PostCard__meta___1oEBN" data-reactid="545"><!-- react-text: 546 -->Feb 18th, 2013<!-- /react-text --><!-- react-text: 547 --> • <!-- /react-text --><!-- react-text: 548 -->1<!-- /react-text --><!-- react-text: 549 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="550">If you want to deploy a Clojure/Compojure application you’re going to need a couple hints.</p><a class="PostCard__readMore___1LtB_" href="/2013/2/17/clojure-compojure-jetty-integration/" data-reactid="551">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="552"><div class="PostCard__post___3wcGe" data-reactid="553"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="554"></div><div data-reactid="555"><a href="/2013/2/8/quick-tip-haskell-list-comprehensions/" data-reactid="556"><h4 class="PostCard__heading___g30g2" data-reactid="557">Quick Tip: Haskell List Comprehensions</h4></a><span class="PostCard__meta___1oEBN" data-reactid="558"><!-- react-text: 559 -->Feb 8th, 2013<!-- /react-text --><!-- react-text: 560 --> • <!-- /react-text --><!-- react-text: 561 -->1<!-- /react-text --><!-- react-text: 562 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="563">I think list
comprehensions
are my favorite reason to pull out Haskell.</p><a class="PostCard__readMore___1LtB_" href="/2013/2/8/quick-tip-haskell-list-comprehensions/" data-reactid="564">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="565"><div class="PostCard__post___3wcGe" data-reactid="566"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="567"></div><div data-reactid="568"><a href="/2013/2/8/quick-tip-javascript-partially-applied-functions/" data-reactid="569"><h4 class="PostCard__heading___g30g2" data-reactid="570">Quick Tip: JavaScript Partially Applied Functions</h4></a><span class="PostCard__meta___1oEBN" data-reactid="571"><!-- react-text: 572 -->Feb 8th, 2013<!-- /react-text --><!-- react-text: 573 --> • <!-- /react-text --><!-- react-text: 574 -->1<!-- /react-text --><!-- react-text: 575 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="576">Say we have the following function:</p><a class="PostCard__readMore___1LtB_" href="/2013/2/8/quick-tip-javascript-partially-applied-functions/" data-reactid="577">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="578"><div class="PostCard__post___3wcGe" data-reactid="579"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="580"></div><div data-reactid="581"><a href="/2013/1/16/consistant-hash-routing-in-riak-core/" data-reactid="582"><h4 class="PostCard__heading___g30g2" data-reactid="583">Consistant Hash Routing in Riak Core</h4></a><span class="PostCard__meta___1oEBN" data-reactid="584"><!-- react-text: 585 -->Jan 16th, 2013<!-- /react-text --><!-- react-text: 586 --> • <!-- /react-text --><!-- react-text: 587 -->1<!-- /react-text --><!-- react-text: 588 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="589">The first function, shown above, pings a random (random enough for our purposes)
vnode and returns the partition identifier. The code we’re…</p><a class="PostCard__readMore___1LtB_" href="/2013/1/16/consistant-hash-routing-in-riak-core/" data-reactid="590">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="591"><div class="PostCard__post___3wcGe" data-reactid="592"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="593"></div><div data-reactid="594"><a href="/2013/1/13/riak-core-myappping/" data-reactid="595"><h4 class="PostCard__heading___g30g2" data-reactid="596">Riak Core: myapp:ping().</h4></a><span class="PostCard__meta___1oEBN" data-reactid="597"><!-- react-text: 598 -->Jan 13th, 2013<!-- /react-text --><!-- react-text: 599 --> • <!-- /react-text --><!-- react-text: 600 -->1<!-- /react-text --><!-- react-text: 601 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="602">As seen in the quickstart post; the default Riak Core template gives you a myapp:ping(). method.
I named my application spades, so my files…</p><a class="PostCard__readMore___1LtB_" href="/2013/1/13/riak-core-myappping/" data-reactid="603">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="604"><div class="PostCard__post___3wcGe" data-reactid="605"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="606"></div><div data-reactid="607"><a href="/2013/1/13/riak-core-quickstart/" data-reactid="608"><h4 class="PostCard__heading___g30g2" data-reactid="609">Riak Core: Quickstart</h4></a><span class="PostCard__meta___1oEBN" data-reactid="610"><!-- react-text: 611 -->Jan 13th, 2013<!-- /react-text --><!-- react-text: 612 --> • <!-- /react-text --><!-- react-text: 613 -->1<!-- /react-text --><!-- react-text: 614 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="615">First Retrieve the Rebar Templates and put them in ~/.rebar/templates</p><a class="PostCard__readMore___1LtB_" href="/2013/1/13/riak-core-quickstart/" data-reactid="616">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="617"><div class="PostCard__post___3wcGe" data-reactid="618"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="619"></div><div data-reactid="620"><a href="/2013/1/12/riak-core-up-and-running/" data-reactid="621"><h4 class="PostCard__heading___g30g2" data-reactid="622">Riak Core: Up and Running</h4></a><span class="PostCard__meta___1oEBN" data-reactid="623"><!-- react-text: 624 -->Jan 13th, 2013<!-- /react-text --><!-- react-text: 625 --> • <!-- /react-text --><!-- react-text: 626 -->1<!-- /react-text --><!-- react-text: 627 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="628">Some of the current Riak Core resources available are:</p><a class="PostCard__readMore___1LtB_" href="/2013/1/12/riak-core-up-and-running/" data-reactid="629">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="630"><div class="PostCard__post___3wcGe" data-reactid="631"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="632"></div><div data-reactid="633"><a href="/2013/1/12/riak-core-unique-identifiers/" data-reactid="634"><h4 class="PostCard__heading___g30g2" data-reactid="635">Riak Core: Unique Identifiers</h4></a><span class="PostCard__meta___1oEBN" data-reactid="636"><!-- react-text: 637 -->Jan 12th, 2013<!-- /react-text --><!-- react-text: 638 --> • <!-- /react-text --><!-- react-text: 639 -->1<!-- /react-text --><!-- react-text: 640 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="641">To generate a unique identifier, Riak Core exposes:</p><a class="PostCard__readMore___1LtB_" href="/2013/1/12/riak-core-unique-identifiers/" data-reactid="642">Read more...</a></div></li><li class="Posts__li___4nwhp" data-reactid="643"><div class="PostCard__post___3wcGe" data-reactid="644"><div class="PostCard__blueprintHeader___26g0W PostCard__postHeader___1KtIc globals__blueprintBg___25EbT" data-reactid="645"></div><div data-reactid="646"><a href="/2012/12/6/a-python-flask-crud/" data-reactid="647"><h4 class="PostCard__heading___g30g2" data-reactid="648">A Python Flask CRUD</h4></a><span class="PostCard__meta___1oEBN" data-reactid="649"><!-- react-text: 650 -->Dec 6th, 2012<!-- /react-text --><!-- react-text: 651 --> • <!-- /react-text --><!-- react-text: 652 -->2<!-- /react-text --><!-- react-text: 653 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="654">Recently I was asked to build a CRUD app.</p><a class="PostCard__readMore___1LtB_" href="/2012/12/6/a-python-flask-crud/" data-reactid="655">Read more...</a></div></li></ul></div></div></div><script charset="UTF-8">window.__APOLLO_STATE__={"apollo":{"data":{"$ROOT_QUERY.root.posts({\"first\":50}).pageInfo":{"hasNextPage":false,"__typename":"PageInfo"},"$ROOT_QUERY.root.posts({\"first\":50})":{"pageInfo":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).pageInfo","generated":true},"edges":[{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.0","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.1","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.2","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.3","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.4","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.5","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.6","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.7","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.8","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.9","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.10","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.11","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.12","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.13","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.14","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.15","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.16","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.17","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.18","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.19","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.20","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.21","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.22","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.23","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.24","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.25","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.26","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.27","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.28","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.29","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.30","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.31","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.32","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.33","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.34","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.35","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.36","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.37","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.38","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.39","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.40","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.41","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.42","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.43","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.44","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.45","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.46","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.47","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.48","generated":true}],"__typename":"BlogPostConnection"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.0.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.0.node.attributes","generated":true},"body":"<p>How do custom React Components communicate with their children?</p>\n<h1 id=\"a-simple-case\">A Simple Case</h1>\n<p>Given two components, <code>A</code> and <code>B</code>, where <code>A</code> renders arbitrary\nchildren and <code>B</code> renders a <code>display</code> prop.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">import</span> React, { Component } <span class=\"highlight__hljs-keyword___som98\">from</span> <span class=\"highlight__hljs-string___1SffY\">'react'</span>;\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">A</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">Component</span> </span>{\n  render() {\n    <span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"xml\"><span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">div</span>&gt;</span>\n      { this.props.children }\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span>\n  }\n}\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">B</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">Component</span> </span>{\n  render() {\n    <span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"xml\"><span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">span</span>&gt;</span>{this.props.display}<span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span></span>\n  }\n}\n</code></pre>\n<p>They can be rendered with React DOM as such:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>ReactDOM.render(&lt;A&gt;\n  &lt;B display='thing-one'/&gt;\n  &lt;B display='thing-two'/&gt;\n  &lt;/A&gt;,\n  document.body)\n</code></pre>\n<p>which yields a simple <code>thing-onething-two</code> result.</p>\n<h1 id=\"controlling-props\">Controlling Props</h1>\n<p>So far, nothing special. Let’s say we want A to control the display\nproperty of all <code>B</code>s or wrap every child in an element with a specific\nCSS class. We can simply alter the <code>A</code> component to map over any\nchildren, replacing the display prop using <code>cloneElement</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">A</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">Component</span> </span>{\n  render() {\n    <span class=\"highlight__hljs-keyword___som98\">const</span> { children } = <span class=\"highlight__hljs-keyword___som98\">this</span>.props;\n    <span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"xml\"><span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">div</span>&gt;</span>\n      {\n        children &amp;&amp; React.Children.map(children, (child, i) =&gt; React.cloneElement(child, {\n          display: `thing-${i}`\n        }))\n      }\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span>\n  }\n}\n</code></pre>\n<p>Note that the same render:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>ReactDOM.render(&lt;A&gt;\n  &lt;B display='thing-one'/&gt;\n  &lt;B display='thing-two'/&gt;\n  &lt;/A&gt;,\n  document.body)\n</code></pre>\n<p>returns a new result <code>thing-0thing-1</code>. This is because we have\nsuccessfully overridden the <code>display</code> prop of all children rendered by\n<code>A</code>.</p>\n<h1 id=\"handlers-and-state\">Handlers and State</h1>\n<p>Let’s say that every time the user clicks on <code>B</code>, we want to update\nthe state of <code>A</code> with a counter. We can simply add some inital state\nto <code>A</code> and pass in an additional handler prop which is defined on\n<code>A</code>. We use fat-arrow autobinding shorthand syntax so that <code>this</code> int\nhe <code>onChildClick</code> handler refers to <code>A</code>'s <code>this</code>. Then we make sure\nthat <code>B</code> can accept an <code>onClick</code> handler.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">A</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">Component</span> </span>{\n  state = {\n    counter: <span class=\"highlight__hljs-number___2gmaH\">0</span>\n  };\n  onChildClick = e =&gt; {\n    <span class=\"highlight__hljs-keyword___som98\">this</span>.setState({\n      counter: <span class=\"highlight__hljs-keyword___som98\">this</span>.state.counter + <span class=\"highlight__hljs-number___2gmaH\">1</span>\n    })\n  };\n  render() {\n    <span class=\"highlight__hljs-keyword___som98\">const</span> { children } = <span class=\"highlight__hljs-keyword___som98\">this</span>.props;\n    <span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"xml\"><span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">div</span>&gt;</span>\n      <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">h1</span>&gt;</span>{this.state.counter}<span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span>\n      {\n        children &amp;&amp; React.Children.map(children, (child, i) =&gt; React.cloneElement(child, {\n          display: `thing-${i}`,\n          onClick: this.onChildClick\n        }))\n      }\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span>\n  }\n}\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">B</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">Component</span> </span>{\n  render() {\n    <span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"xml\"><span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">span</span> <span class=\"hljs-attr\">onClick</span>=<span class=\"highlight__hljs-string___1SffY\">{this.props.onClick}</span>&gt;</span>{this.props.display}<span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span></span>\n  }\n}\n</code></pre>\n<p>Now, rendering the same way as before, we get a new output:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>0\n\nthing-0thing-1\n</code></pre>\n<p>and every time <code>thing-0</code> or <code>thing-1</code> is clicked, the counter in <code>A</code>\nis updated.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.0.node.attributes":{"slug":"react-communicating-with-children","__typename":"BlogPostAttributes","title":"React: Communicating With Children","url":"/react-communicating-with-children/","excerpt":"How do custom React Components communicate with their children?","updatedAt":"Nov 22nd, 2016","timeToRead":2,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.0":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.0.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.1.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.1.node.attributes","generated":true},"body":"<p>Recently when implementing a Docker Registry I came across the need to\nhash the incoming request body in a way that matches the clients\nhash. Since the Docker engine is an existing client that speaks a\ncouple of different <code>Content-Type</code>s (such as\n<code>application/vnd.docker.distribution.manifest.v2+json</code>, we cannot use\nServant’s alternate content types to get a ByteString to hash. This\nleads us to one possible implementation, which is to create a new\ncontent type that uses\n<code>application/vnd.docker.distribution.manifest.v2+json</code> as the <code>Accept</code>\nheader, but also hashes the content body with <code>SHA256</code>. Our content\ntype will behave very similarly to <code>application/json</code>.</p>\n<p>We will use <a href=\"https://hackage.haskell.org/package/cryptonite\">cryptonite</a> for hashing and <a href=\"https://hackage.haskell.org/package/aeson\">Aeson</a>\nfor JSON decoding. The full code follows.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"hljs-meta\">{-# LANGUAGE FlexibleInstances     #-}</span>\n<span class=\"hljs-meta\">{-# LANGUAGE MultiParamTypeClasses #-}</span>\n<span class=\"hljs-meta\">{-# LANGUAGE OverloadedStrings     #-}</span>\n<span class=\"highlight__hljs-keyword___som98\">module</span> SR.HashedJSONContentType <span class=\"highlight__hljs-keyword___som98\">where</span>\n\n<span class=\"highlight__hljs-keyword___som98\">import</span>           Crypto.Hash                (<span class=\"highlight__hljs-type___11WfV\">Digest</span>, <span class=\"highlight__hljs-type___11WfV\">SHA256</span>)\n<span class=\"highlight__hljs-keyword___som98\">import</span>           Data.Aeson\n<span class=\"highlight__hljs-keyword___som98\">import</span> <span class=\"highlight__hljs-keyword___som98\">qualified</span> Data.ByteString.Lazy.Char8 <span class=\"highlight__hljs-keyword___som98\">as</span> BSC\n<span class=\"highlight__hljs-keyword___som98\">import</span>           Network.HTTP.Media         <span class=\"highlight__hljs-keyword___som98\">hiding</span> (<span class=\"highlight__hljs-type___11WfV\">Accept</span>)\n<span class=\"highlight__hljs-keyword___som98\">import</span>           Servant.API.ContentTypes\n\n<span class=\"highlight__hljs-keyword___som98\">import</span>           Utils                      (<span class=\"highlight__hljs-title___1fl8Q\">mkDigest</span>)\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> = <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> <span class=\"highlight__hljs-type___11WfV\">String</span></span>\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Accept</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  contentType _ = <span class=\"highlight__hljs-string___1SffY\">\"application\"</span> // <span class=\"highlight__hljs-string___1SffY\">\"vnd.docker.distribution.manifest.v2+json\"</span>\n\n<span class=\"highlight__hljs-comment___UYk12\">-- | We don't need MimeRender for this since we are only using </span>\n<span class=\"highlight__hljs-comment___UYk12\">--   the content-type for receiving data.</span>\n<span class=\"highlight__hljs-comment___UYk12\">-- instance Show a =&gt; MimeRender HashedJSON a where</span>\n<span class=\"highlight__hljs-comment___UYk12\">--    mimeRender _ val = pack (\"This is MINE! \" ++ show val)</span>\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> a =&gt; <span class=\"highlight__hljs-type___11WfV\">MimeUnrender</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> (<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-title___1fl8Q\">a</span>) <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n   mimeUnrender _ bs = <span class=\"highlight__hljs-keyword___som98\">case</span> eitherDecodeLenient bs <span class=\"highlight__hljs-keyword___som98\">of</span>\n     <span class=\"highlight__hljs-type___11WfV\">Left</span> err -&gt; <span class=\"highlight__hljs-type___11WfV\">Left</span> err\n     <span class=\"highlight__hljs-type___11WfV\">Right</span> val -&gt; <span class=\"highlight__hljs-type___11WfV\">Right</span> (mkDigest $ <span class=\"highlight__hljs-type___11WfV\">BSC</span>.toStrict bs, val)\n</code></pre>\n<p>The most interesting part is the <code>MimeUnrender</code> instance for our\ncustom content type <code>HashedJSON</code>. Servant provides a more lenient\nversion of Aeson’s <code>decode</code> called <code>eitherDecodeLenient</code>. We use this\nfor compatibility with the normal <code>'JSON</code> content type in Servant.</p>\n<p>The instance uses a tuple <code>(Digest SHA256, a)</code> so any route types we\nwrite in the future will look similar to the following code which uses\na fake type <code>OurType</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">ReqBody</span> '[<span class=\"highlight__hljs-type___11WfV\">HashedJSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-type___11WfV\">OurType</span>) \n</code></pre>\n<p>An example handler using the above <code>ReqBody</code> declaration follows.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">putManifest</span> :: (<span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-type___11WfV\">Manifest</span>) -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">putManifest</span> (digest, manifest) = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  <span class=\"highlight__hljs-comment___UYk12\">-- do stuff with digests and manifests</span>\n  return <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>One can envision how changing the type of the hash in the type might\nallow us to specify which algorithm we want to use in the same way\nthat we specify <code>Manifest</code>.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.1.node.attributes":{"slug":"servant-custom-content-types","__typename":"BlogPostAttributes","title":"Servant Custom Content Types","url":"/servant-custom-content-types/","excerpt":"Recently when implementing a Docker Registry I came across the need to\nhash the incoming request body in a way that matches the…","updatedAt":"Oct 3rd, 2016","timeToRead":2,"headerImage":"/4697ea4ccbcd2ba2f293936baed59b9d.png"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.1":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.1.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.2.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.2.node.attributes","generated":true},"body":"<p>Containers are surging right now. This series of blog posts will\nexplore a small corner of that universe by building a Docker Registry\nthat adheres to the <a href=\"https://github.com/docker/distribution/blob/bfa0a9c0973b5026d2e942dec29115c120e7f731/docs/spec/api.md\">Docker Registry HTTP V2 API</a>. The\ninformation contained in these posts will take a conceptual approach\nrather than a step-by-step approach. The code will be available in\nfull on GitHub, as the <a href=\"https://github.com/ChristopherBiscardi/superhuman-registry\">Superhuman Registry</a>.</p>\n<h1 id=\"intro\">Intro</h1>\n<p>For this project we’ll use Haskell as the implementation language so\nthat we can use Servant.</p>\n<blockquote>\n<p>Servant is a set of packages for declaring web APIs at the\ntype-level and then using those API specifications to:</p>\n</blockquote>\n<ul>\n<li>write servers (this part of servant can be considered a web\nframework),</li>\n<li>obtain client functions (in Haskell),</li>\n<li>generate client functions for other programming languages,</li>\n<li>generate documentation</li>\n</ul>\n<p>Servant allows us to specify everything from request bodies to Headers\nat the type level, which will help us be explicit as we explore\nManifests, Tags and Digests. Since the purpose of this set of articles\nis informative, the types will help ground our conversations.</p>\n<h1 id=\"getting-started\">Getting Started</h1>\n<p>Firstly, we’ll need a new Haskell project. <a href=\"https://www.haskellstack.org/\">Stack</a> provides\nnice templating functionality, so we’ll use that to scaffold a new\nproject.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">stack</span> new servant sr <span class=\"highlight__hljs-comment___UYk12\">--resolver nightly-2016-07-31</span>\n</code></pre>\n<p>Since we aren’t focusing on Servant itself for this series, we’ll\nskip a bunch of the boilerplate and backing code to focus in on the\nhandlers and business logic. The code for this section <em>is</em>\n<a href=\"https://github.com/ChristopherBiscardi/superhuman-registry/blob/861b20d317132d3ea43dc05cc03d507ca325d3e0/src/Lib.hs\">on GitHub</a> for those that want to investigate further.</p>\n<h2 id=\"routes\">Routes</h2>\n<p>One of the benefits of working from a spec is that there are a full\nset of routes already penned out for us to implement so we can achieve\ncompatibility with the wider ecosystem of tools, such as the Docker\nEngine.</p>\n<p>To start, we’ll translate the routes pretty loosely. Then we’ll go\nback and fill in the return types as we write each of the route\nhandlers. Translating the <a href=\"https://github.com/docker/distribution/blob/bfa0a9c0973b5026d2e942dec29115c120e7f731/docs/spec/api.md\">V2 API</a> into types looks like the\nfollowing.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Head</span> = <span class=\"highlight__hljs-type___11WfV\">Verb</span> '<span class=\"highlight__hljs-type___11WfV\">HEAD</span> 200</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2Base</span> = \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> \"<span class=\"highlight__hljs-type___11WfV\">Docker</span>-<span class=\"highlight__hljs-type___11WfV\">Distribution</span>-<span class=\"highlight__hljs-type___11WfV\">API</span>-<span class=\"highlight__hljs-type___11WfV\">Version</span>\" <span class=\"highlight__hljs-type___11WfV\">String</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)</span>\n\n<span class=\"highlight__hljs-comment___UYk12\">-- | Main API Type</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">API</span> = <span class=\"highlight__hljs-type___11WfV\">V2Base</span> :&lt;|&gt; \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">V2API</span></span>\n\n<span class=\"highlight__hljs-comment___UYk12\">-- | V2 API Definition</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2API</span> = <span class=\"highlight__hljs-type___11WfV\">Metadata</span></span>\n  :&lt;|&gt; <span class=\"highlight__hljs-string___1SffY\">\"_catalog\"</span> :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Tags</span> = \"tags\" :&gt; \"list\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> </span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Metadata</span> = <span class=\"highlight__hljs-type___11WfV\">Capture</span> \"name\" <span class=\"highlight__hljs-type___11WfV\">Name</span> :&gt; (\n  <span class=\"highlight__hljs-type___11WfV\">Tags</span> :&lt;|&gt;\n  \"<span class=\"highlight__hljs-title___1fl8Q\">manifests</span>\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Manifests</span> :&lt;|&gt;\n  \"<span class=\"highlight__hljs-title___1fl8Q\">blobs</span>\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Blobs</span>\n  )</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Blobs</span> = <span class=\"highlight__hljs-type___11WfV\">Digests</span> :&lt;|&gt; <span class=\"highlight__hljs-type___11WfV\">Upload</span></span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Manifests</span> = <span class=\"highlight__hljs-type___11WfV\">Capture</span> \"reference\" <span class=\"highlight__hljs-type___11WfV\">Ref</span> :&gt; (\n  <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Put</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Delete</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Head</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n  ) </span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Digests</span> = <span class=\"highlight__hljs-type___11WfV\">Capture</span> \"digest\" <span class=\"highlight__hljs-type___11WfV\">Digest</span> :&gt; (\n  <span class=\"highlight__hljs-type___11WfV\">Head</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Delete</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n  )</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Upload</span> = \"uploads\" :&gt; (\n  <span class=\"highlight__hljs-type___11WfV\">Post</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Capture</span> \"<span class=\"highlight__hljs-title___1fl8Q\">uuid</span>\" <span class=\"highlight__hljs-type___11WfV\">UUID</span> :&gt; (\n    <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n    <span class=\"highlight__hljs-type___11WfV\">Patch</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n    <span class=\"highlight__hljs-type___11WfV\">Put</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n    <span class=\"highlight__hljs-type___11WfV\">Delete</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n    )</span>\n  )\n</code></pre>\n<p>This produces a set of routes that lay out as follows:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>/\n└─ v2/\n   ├─•\n   ┆\n   ┆\n   ├─ &lt;capture&gt;/\n   │  ├─ blobs/\n   │  │  ├─ &lt;capture&gt;/\n   │  │  │  ├─•\n   │  │  │  ┆\n   │  │  │  ├─•\n   │  │  │  ┆\n   │  │  │  └─•\n   │  │  ┆\n   │  │  └─ uploads/\n   │  │     ├─•\n   │  │     ┆\n   │  │     ┆\n   │  │     └─ &lt;capture&gt;/\n   │  │        ├─•\n   │  │        ┆\n   │  │        ├─•\n   │  │        ┆\n   │  │        ├─•\n   │  │        ┆\n   │  │        └─•\n   │  ├─ manifests/\n   │  │  └─ &lt;capture&gt;/\n   │  │     ├─•\n   │  │     ┆\n   │  │     ├─•\n   │  │     ┆\n   │  │     ├─•\n   │  │     ┆\n   │  │     └─•\n   │  └─ tags/\n   │     └─ list/\n   │        └─•\n   ┆\n   └─ _catalog/\n      └─•\n</code></pre>\n<p>This matches up with the spec quite well and gives us a nice base to\nstart writing more specific code without worrying about whether we’ll\nmiss a route.</p>\n<h2 id=\"the-types\">The Types</h2>\n<p>If we take a closer look at the types we just wrote out we see a bunch\nof concepts including <code>Name</code>, <code>Tags</code>, <code>Manifests</code>, <code>Blobs</code>, and\n<code>Digests</code>. Interestingly, we don’t see an <code>Image</code> or <code>Container</code>\nanywhere.</p>\n<h3 id=\"name\">Name</h3>\n<p>We use <code>Name</code> to represent an repository name. <code>Name</code>s must adhere to\na specific regex (<code>[a-z0-9]+(?:[._-][a-z0-9]+)*</code>) and be less than 256\ncharacters. In plain english from the spec:</p>\n<blockquote>\n<p>A repository name is broken up into path components. A component of\na repository name must be at least one lowercase, alpha-numeric\ncharacters, optionally separated by periods, dashes or\nunderscores.</p>\n</blockquote>\n<h3 id=\"tags\">Tags</h3>\n<p><code>Tags</code> are strings that reference images. For example, if we were\nusing <code>debian</code> and wanted to only use the tag <code>jessie</code>, we could pull\nusing the format <code>debian:jessie</code>.</p>\n<h3 id=\"manifests\">Manifests</h3>\n<p>An image manifest provides a configuration and a set of\nlayers for a container image. It looks like the following JSON:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{\n    <span class=\"highlight__hljs-string___1SffY\">\"schemaVersion\"</span>: <span class=\"highlight__hljs-number___2gmaH\">2</span>,\n    <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,\n    <span class=\"highlight__hljs-string___1SffY\">\"config\"</span>: {\n        <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.container.image.v1+json\"</span>,\n        <span class=\"highlight__hljs-string___1SffY\">\"size\"</span>: <span class=\"highlight__hljs-number___2gmaH\">7023</span>,\n        <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\"</span>\n    },\n    <span class=\"highlight__hljs-string___1SffY\">\"layers\"</span>: [\n        {\n            <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"size\"</span>: <span class=\"highlight__hljs-number___2gmaH\">32654</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f\"</span>\n        },\n        {\n            <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"size\"</span>: <span class=\"highlight__hljs-number___2gmaH\">16724</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:3c3a4604a545cdc127456d94e421cd355bca5b528f4a9c1905b15da2eb4a4c6b\"</span>\n        },\n        {\n            <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"size\"</span>: <span class=\"highlight__hljs-number___2gmaH\">73109</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:ec4b8955958665577945c89419d1af06b5f7636b4ac3da7f12184802ad867736\"</span>\n        }\n    ],\n}\n</code></pre>\n<h3 id=\"blobs-digests\">Blobs &amp; Digests</h3>\n<p>Layers are stored in the blob portion of the registry, keyed by\ndigest.</p>\n<h2 id=\"our-first-handler\">Our First Handler</h2>\n<p>The first route we’ll look at implementing is also the most\nsimple. It’s the route that lets clients know that this registry\nimplements the V2 APIs.</p>\n<p>The type of the <code>/v2</code> route is</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2Base</span> = \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> \"<span class=\"highlight__hljs-type___11WfV\">Docker</span>-<span class=\"highlight__hljs-type___11WfV\">Distribution</span>-<span class=\"highlight__hljs-type___11WfV\">API</span>-<span class=\"highlight__hljs-type___11WfV\">Version</span>\" <span class=\"highlight__hljs-type___11WfV\">String</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)</span>\n</code></pre>\n<p>Which breaks down to a <code>GET</code> request with an <code>application/json</code>\ncontent type. The response has a single header,\n<code>Docker-Distribution-API-Version</code>, which is what lets a client know\nwhich API version our registry implements. We also send back no body\ncontent. Finally, we can dig a bit deeper into <code>Get</code>, which is a type\nalias for <code>Verb 'GET 200</code>. This tells us that a successful response\nwill have a 200 code.</p>\n<p>The only other valid codes for this route <code>401 Unauthorized</code> and <code>429 Too Many Requests</code> but since we haven’t implemented authorization or\nrate-limiting, we’ll skip that for now.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">v2</span> :: <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[<span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Distribution-API-Version\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">v2</span> = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  $(logTM) <span class=\"highlight__hljs-type___11WfV\">InfoS</span> <span class=\"highlight__hljs-string___1SffY\">\"registry/2.0\"</span>\n  return $ addHeader <span class=\"highlight__hljs-string___1SffY\">\"registry/2.0\"</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>Our logging is pretty basic right now. We’ll worry about bulking it up\nlater. For now, we’re going to leave the default Katip stdout which\nleaves us with time, loglevel, hostname (container id), thread id and\nsource location:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>[2016-08-08 21:47:50][superhuman-registry][Info][85f79bec070f][33][ThreadId 11][sr-0.1.0.0-61fGnb6tOFbKD5fzBNSxKr:Lib src/Lib.hs:63:5] registry/2.0\n</code></pre>\n<h1 id=\"dealing-with-layers\">Dealing with Layers</h1>\n<p>The primary purpose of a Registry is to store layers and manifests so\na client (such as a Docker Engine) can pull images. We’ll avoid\nsupporting legacy versions of the registry for security and simplicity\nreasons, which means our registry will only work for docker 1.10 and\nabove. Benefits of this include not having to rewrite v2 manifests\ninto the v1 format.</p>\n<h2 id=\"docker-client\">Docker Client</h2>\n<p>We need to figure out what the docker is doing on a push. Since I’m\nrunning Docker for Mac, booting a server to act as a registry is\npretty simple. We’ll use <code>nc</code> for a first attempt.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker run -itp 9000:9000 alpine nc -l 9000\n</code></pre>\n<p>Now that we have a server acting as a “registry”, we need to tag and\npush an image to it.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; docker tag hello-world localhost:9000/hello-world\n&gt; docker push localhost:9000/hello-world\nThe push refers to a repository [localhost:9000/hello-world]\nPut http://localhost:9000/v1/repositories/hello-world/: EOF\n</code></pre>\n<p>Great! Our server is listening and the engine is pushing to the right\nplace. If it wasn’t, we could’ve seen something like this:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>Put http://localhost:9000/v1/repositories/hello-world/: read tcp\n[::1]:56492-&gt;[::1]:9000: read: connection reset by peer\n</code></pre>\n<p>There’s a problem though, <code>nc</code> doesn’t implement the <code>/v2/</code> endpoint,\nso the docker client falls back to v1 of the api. Luckily, we’ve\nimplemented the v2 endpoint already so we’ll skip netcat and jump back\ninto Haskell.</p>\n<p>We can use <code>Wai.Middleware.RequestLogger</code> to log out everything docker\ntries to do to our registry. Using docker-compose to boot up our\nregistry and re-attempting the push yields:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>api_1  | GET /v2/\napi_1  |   Accept:\napi_1  |   Status: 200 OK 0.000190373s\napi_1  | Prelude.undefined\napi_1  | CallStack (from HasCallStack):\napi_1  |   error, called at libraries/base/GHC/Err.hs:79:14 in base:GHC.Err\napi_1  |   undefined, called at src/SR/Blobs.hs:26:14 in sr-0.1.0.0-5isXdkrmBvbJTFdJY734op:SR.Blobs\napi_1  | Prelude.undefined\napi_1  | CallStack (from HasCallStack):\napi_1  |   error, called at libraries/base/GHC/Err.hs:79:14 in base:GHC.Err\napi_1  |   undefined, called at src/SR/Blobs.hs:26:14 in sr-0.1.0.0-5isXdkrmBvbJTFdJY734op:SR.Blobs\n</code></pre>\n<p>From the information, we see that the <code>/v2/</code> route is working as\nexpected, but we hit <code>undefined</code> at <code>src/SR/Blobs.hs:26:14</code>, which is\ntotally expected because we haven’t implemented <code>uploadBlob</code>\nyet. Notice that the engine retries the upload request.</p>\n<p>If the route didn’t exist, we would have seen a 404 in the logs.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>api_1  | GET /v2/\napi_1  |   Accept:\napi_1  |   Status: 200 OK 0.011277359s\napi_1  | POST /v2/hello-world/blobs/uploads/\napi_1  |   Accept:\napi_1  |   Status: 404 Not Found 0.000028066s\n</code></pre>\n<p>This matches with what we know about the\n<a href=\"https://github.com/docker/distribution/blob/dea554fc7cce2f2e7af5b1e1d38e28c5e96e1d9e/docs/spec/api.md#starting-an-upload\">upload process</a>.</p>\n<h2 id=\"uploadblob\">uploadBlob</h2>\n<p>We can throw a couple print statements in to replace the undefined as\nsuch:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">uploadBlob</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n<span class=\"highlight__hljs-title___1fl8Q\">uploadBlob</span> namespace' name' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  liftIO $ print namespace'\n  liftIO $ print name'\n  return <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>Which will yield us some progress when trying to push.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>api_1  | GET /v2/\napi_1  |   Accept:\napi_1  |   Status: 200 OK 0.004299263s\napi_1  | Namespace &quot;lib&quot;\napi_1  | Name &quot;hello-world&quot;\napi_1  | POST /v2/lib/hello-world/blobs/uploads/\napi_1  |   Accept:\napi_1  |   Status: 200 OK 0.000105174s\n</code></pre>\n<p>This is good progress, but we clearly have some issues since the\ndocker engine is still retrying the endpoint.</p>\n<p>There are two approaches to blob upload\n<a href=\"https://github.com/docker/distribution/blob/b1b100cf011b037b8821e8d0ae4f5ab3e2222c48/docs/spec/api.md#initiate-monolithic-blob-upload\">monolithic</a> and\n<a href=\"https://github.com/docker/distribution/blob/b1b100cf011b037b8821e8d0ae4f5ab3e2222c48/docs/spec/api.md#initiate-resumable-blob-upload\">resumeable</a>. The docs for\n<code>/v2/&lt;name&gt;/blobs/uploads</code> detail that the digest query param is the\ndifferentiator between monolithic and resumable upload.</p>\n<blockquote>\n<p>Initiate a resumable blob upload. If successful, an upload location\nwill be provided to complete the upload. Optionally, if the digest\nparameter is present, the request body will be used to complete the\nupload in a single request.</p>\n</blockquote>\n<p>Let’s take a look at an implementation for the <code>uploadBlob</code>\n(<code>&lt;&gt;/blobs/uploads</code>) route. We modifiy the type to reflect the various\nheaders and response codes (docker engine is a picky client). All of\nthe relevant information is communicated through headers, so we return\n<code>NoContent</code> as well. <code>PostAccepted</code> is a shortcut for <code>202</code> responses.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">PostAccepted</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Location\"</span> <span class=\"highlight__hljs-type___11WfV\">URI</span>,\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Range\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Upload-UUID\"</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n</code></pre>\n<p>Now the handler code. We generate a new uuid to send back in the\nresponse. Our first go is just trying to get the docker client to\ncontinue to the next request but in the future we should do something\nwith the uuid so we can respond to status requests. <code>uploadAPI</code> might\nlook scary, but it’s just specifying the route we want to generate for\nthe <code>Location</code> header. We do this so that Servant will automatically\ncheck that the route is valid for the <code>api</code> we are serving and we get\na compile error if it doesn’t typecheck.</p>\n<p>We add 3 headers, setting the Range to <code>&quot;0-0&quot;</code> because we are only\nresponding to resumable upload requests for now. (Otherwise we’d have\nto handle the case of an extra query string parameter). Once we\ngenerate the <code>Location</code> and the <code>Docker-Upload-UUID</code>, we send them\nback so the docker engine can start uploading blobs at the specified\n<code>Location</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">uploadBlob</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Location\"</span> <span class=\"highlight__hljs-type___11WfV\">URI</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Range\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Upload-UUID\"</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">uploadBlob</span> namespace' name' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  uuid &lt;- liftIO $ nextRandom\n  <span class=\"highlight__hljs-keyword___som98\">let</span> uploadAPI = <span class=\"highlight__hljs-type___11WfV\">Proxy</span> :: <span class=\"highlight__hljs-type___11WfV\">Proxy</span> (<span class=\"highlight__hljs-string___1SffY\">\"v2\"</span> :&gt; <span class=\"highlight__hljs-type___11WfV\">Capture</span> <span class=\"highlight__hljs-string___1SffY\">\"namespace\"</span> <span class=\"highlight__hljs-type___11WfV\">Namespace</span> :&gt; <span class=\"highlight__hljs-type___11WfV\">Capture</span> <span class=\"highlight__hljs-string___1SffY\">\"name\"</span> <span class=\"highlight__hljs-type___11WfV\">Name</span> :&gt; <span class=\"highlight__hljs-string___1SffY\">\"blobs\"</span> :&gt; <span class=\"highlight__hljs-string___1SffY\">\"uploads\"</span> :&gt; <span class=\"highlight__hljs-type___11WfV\">Capture</span> <span class=\"highlight__hljs-string___1SffY\">\"uuid\"</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span> :&gt; <span class=\"highlight__hljs-type___11WfV\">Put</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n      mkURI = safeLink api uploadAPI\n      uri = mkURI namespace' name' uuid\n      response = addHeader uri\n        $ addHeader <span class=\"highlight__hljs-string___1SffY\">\"0-0\"</span>\n        $ addHeader uuid <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n  $(logTM) <span class=\"highlight__hljs-type___11WfV\">InfoS</span> (logStr $ show $ getHeaders response)\n  return response\n</code></pre>\n<p>We also need a couple instances which allow us to render types like\n<code>UUID</code> into path components and headers. (note: these are orphan\ninstances, but we could fix that by using a newtype and declaring the\ninstances for the newtypes instead).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromHttpApiData</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseUrlPiece text = <span class=\"highlight__hljs-keyword___som98\">case</span> (fromText text) <span class=\"highlight__hljs-keyword___som98\">of</span>\n    <span class=\"highlight__hljs-type___11WfV\">Nothing</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">Left</span> $ <span class=\"highlight__hljs-type___11WfV\">T</span>.append <span class=\"highlight__hljs-string___1SffY\">\"Invalid UUID\"</span> text\n    <span class=\"highlight__hljs-type___11WfV\">Just</span> uuid -&gt; <span class=\"highlight__hljs-type___11WfV\">Right</span> uuid\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">ToByteString</span> <span class=\"highlight__hljs-type___11WfV\">URI</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  builder = lazyByteString . pack . show\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">ToHttpApiData</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  toUrlPiece = toText\n  toHeader = toASCIIBytes\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">ToByteString</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  builder = lazyByteString . toLazyASCIIBytes\n</code></pre>\n<p>We push again to test the route</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker push localhost:9000/lib/hello-world\n</code></pre>\n<p>And voilà, we get the desired effect. The docker engine accepts the\nUUID and tries to upload blobs to <code>PATCH /v2/lib/hello-world/blobs/uploads/v2/lib/hello-world/blobs/uploads/aeab6f5e-4b80-4c7b-9027-616b1cbe6a55</code>. That’s\ntotally not the right URI though. We’ve accidentally used a relative\nURI in our <code>Location</code> header. We’ll fix that though 😃</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>GET /v2/\n  Accept:\n  Status: 200 OK 0.000458567s\n[2016-08-30 18:12:49][superhuman-registry][Info][b4fa86e02706][6258][ThreadId 15][sr-0.1.0.0-4uXdy03mbpG98AEB4xHfiO:SR.Blobs src/SR/Blobs.hs:47:5] [(&quot;Location&quot;,&quot;v2/lib/hello-world/blobs/uploads/aeab6f5e-4b80-4c7b-9027-616b1cbe6a55&quot;),(&quot;Range&quot;,&quot;0-0&quot;),(&quot;Docker-Upload-UUID&quot;,&quot;aeab6f5e-4b80-4c7b-9027-616b1cbe6a55&quot;)]\nPOST /v2/lib/hello-world/blobs/uploads/\n  Accept:\n  Status: 202 Accepted 0.000303745s\nPATCH /v2/lib/hello-world/blobs/uploads/v2/lib/hello-world/blobs/uploads/aeab6f5e-4b80-4c7b-9027-616b1cbe6a55\n  Accept:\n  Status: 404 Not Found 0.000041239s\n</code></pre>\n<h2 id=\"patchblob\">patchBlob</h2>\n<p>The <a href=\"https://github.com/docker/distribution/blob/41f383fb9a3b4e3ff428a92db4f7836f8053058b/docs/spec/api.md#patch-blob-upload\">next route</a>, as shown in the logs above, is\nthe <code>PATCH</code> to the <code>Location</code> header we sent back down. The type for\nthe <code>PATCH</code> route changes to:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">ReqBody</span> '[<span class=\"highlight__hljs-type___11WfV\">OctetStream</span>] <span class=\"highlight__hljs-type___11WfV\">ByteString</span> :&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"range\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span> :&gt;\n  <span class=\"highlight__hljs-type___11WfV\">PatchNoContent</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Location\"</span> <span class=\"highlight__hljs-type___11WfV\">URI</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Range\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Upload-UUID\"</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n</code></pre>\n<p>We need to accept and echo back the <code>Range</code> header, while the request\nbody comes in as an <code>OctetStream</code>. We take this information and just\nwrite out the <code>OctetStream</code> to a file for now.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">patchBlob</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n          -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n          -&gt; <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n          -&gt; <span class=\"highlight__hljs-type___11WfV\">ByteString</span>\n          -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">String</span>\n          -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Location\"</span> <span class=\"highlight__hljs-type___11WfV\">URI</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Range\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Upload-UUID\"</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">patchBlob</span> namespace' name' uuid' blob range' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  liftIO $ <span class=\"highlight__hljs-type___11WfV\">Data</span>.<span class=\"highlight__hljs-type___11WfV\">ByteString</span>.writeFile (<span class=\"highlight__hljs-string___1SffY\">\"./tmp/\"</span> ++ toString uuid') blob\n  response &lt;- mkHeaders range' uuid' namespace' name'\n  return response\n</code></pre>\n<p>With this code (and another upload attempt from the engine), we can\nsee that the next request is a <code>PUT</code>, which indicates the last request\nfor this layer.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>GET /v2/\n  Accept:\n  Status: 200 OK 0.005978465s\n[2016-09-03 20:21:39][superhuman-registry][Info][b4fa86e02706][130][ThreadId 14][sr-0.1.0.0-7Q5s7SCyVcbA5o0UAD7J0W:SR.Blobs src/SR/Blobs.hs:74:5] [(&quot;Location&quot;,&quot;http://localhost:9000/v2/lib/hello-world/blobs/uploads/f525cc29-b588-417b-aac2-85c5752ce07b&quot;),(&quot;Range&quot;,&quot;0-0&quot;),(&quot;Docker-Upload-UUID&quot;,&quot;f525cc29-b588-417b-aac2-85c5752ce07b&quot;)]\nPOST /v2/lib/hello-world/blobs/uploads/\n  Accept:\n  Status: 202 Accepted 0.000442272s\nPATCH /v2/lib/hello-world/blobs/uploads/f525cc29-b588-417b-aac2-85c5752ce07b\n  Accept:\n  Status: 204 No Content 0.012519558s\nPUT /v2/lib/hello-world/blobs/uploads/f525cc29-b588-417b-aac2-85c5752ce07b\n  Params: [(&quot;digest&quot;,&quot;sha256:a9d36faac0fe2a855f798346f33bd48917bf3af9b6e4b77870ef8862fee8a8a3&quot;)]\n  Accept:\n  Status: 200 OK 0.000077408s\n</code></pre>\n<h2 id=\"putblob\">putBlob</h2>\n<p>After <code>PATCH</code>s finish flowing in, the client sends a <code>PUT</code> request\nwith the digest and potentially any final layer content. Note that at\nthis point, we have not implemented any append functionality so our\n<code>PATCH</code> endpoint will only work for small layers. Likewise, our <code>PUT</code>\nand the <code>HEAD</code> that comes after it will be very minimal, omitting\ncritical functionality. This is so that we can get through all of the\nrequests and confirm a full upload flow.</p>\n<p>The <code>Digest</code> for a layer is a sha256 hash as such:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>sha256:6c3c624b58dbbcd3c0dd82b4c53f04194d1247c6eebdaab7c610cf7d66709b3b\n</code></pre>\n<p>Our handler will just emit <code>NoContent</code> so we can skip the validation\ncode and get on with groking the entire request flow.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">putBlob</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n<span class=\"highlight__hljs-title___1fl8Q\">putBlob</span> namespace' name' uuid' digest' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  <span class=\"highlight__hljs-keyword___som98\">case</span> digest' <span class=\"highlight__hljs-keyword___som98\">of</span>\n    <span class=\"highlight__hljs-type___11WfV\">Nothing</span> -&gt; return <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n    <span class=\"highlight__hljs-type___11WfV\">Just</span> a -&gt; return <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<h2 id=\"headdigest\">headDigest</h2>\n<p>This is getting familiar, so we will move on to a minimal <code>HEAD</code> which\nis a request to check to see if a particular layer (identified by\n<code>Digest</code>) has been uploaded. Our version responds “yes” to every\nsingle <code>HEAD</code> request, indicating that the layer exists in the\nregistry already. Luckily for us the Docker client doesn’t seem to\nvalidate the <code>Content-Length</code> header which means we can just echo the\n<code>Digest</code> back in a header and call it done.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">headDigest</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Content-Length\"</span> <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Content-Digest\"</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n    ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">headDigest</span> namespace' name' digest' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  return $ addHeader <span class=\"highlight__hljs-number___2gmaH\">0</span>\n         $ addHeader digest' <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<h2 id=\"putmanifest\">putManifest</h2>\n<p>With the rest of the pieces in place, we receive a <code>PUT</code> to upload the\n<code>Manifest</code> for an image. When uploading the <code>Manifest</code> for an image,\nit is interesting to note that this is the first reference to a <code>Tag</code>\nthat we have seen so far. In this case, it is <code>latest</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>PUT /v2/lib/hello-world/manifests/latest\n</code></pre>\n<p>It is also interesting to remind ourselves that <code>docker pull</code> works if\nwe use the sha256 hash of the <code>Manifest</code>. To see this in action let’s\ngrab the sha for <code>hello-world</code>, which we’ve been using to test our\nregistry.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; docker inspect <span class=\"hljs-_\">-f</span> <span class=\"highlight__hljs-string___1SffY\">\"{{ .RepoDigests}}\"</span> hello-world\n[hello-world@sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9]\n&gt; docker pull hello-world@sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9\nsha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9: Pulling from library/hello-world\nDigest: sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9\nStatus: Image is up to date <span class=\"highlight__hljs-keyword___som98\">for</span> hello-world@sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9\n</code></pre>\n<p>This is useful because a <code>Reference</code>, which is the final path segment\nin the <code>PUT</code> URL, can be a <code>Digest</code> OR a <code>Tag</code>. We need to know this\nbecause the response headers need the <code>Digest</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>201 Created\nLocation: &lt;url&gt;\nContent-Length: 0\nDocker-Content-Digest: &lt;digest&gt;\n</code></pre>\n<h3 id=\"manifests\">Manifests</h3>\n<p>The <code>Manifest</code> for <code>hello-world</code> is a\n<a href=\"https://github.com/docker/distribution/blob/master/docs/spec/manifest-v2-2.md#image-manifest-field-descriptions\">v2+json</a>\nstyle manifest. The other major option for us is going to be a\nManifest List, aka a Fat Manifest. Our <code>Manifest</code> looks as the\nfollowing, with a single layer.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{\n   <span class=\"highlight__hljs-string___1SffY\">\"schemaVersion\"</span>: <span class=\"highlight__hljs-number___2gmaH\">2</span>,\n   <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,\n   <span class=\"highlight__hljs-string___1SffY\">\"config\"</span>: {\n      <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.container.image.v1+json\"</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:c54a2cc56cbb2f04003c1cd4507e118af7c0d340fe7e2720f70976c4b75237dc\"</span>\n   },\n   <span class=\"highlight__hljs-string___1SffY\">\"layers\"</span>: [\n      {\n         <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"size\"</span>: <span class=\"highlight__hljs-number___2gmaH\">1</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:c04b14da8d1441880ed3fe6106fb2cc6fa1c9661846ac0266b8a5ec8edf37b7c\"</span>\n      }\n   ]\n}\n</code></pre>\n<p>We can parse the above <code>Manifest</code> JSON into the following Haskell\ndatatype. In the future we can also do digest validation for each\ndigest in the manifest.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">V2_2</span> {\n  schemaVersion = <span class=\"highlight__hljs-number___2gmaH\">2</span>,\n  mediaType = <span class=\"highlight__hljs-type___11WfV\">Manifest_V2_JSON</span>,\n  config = <span class=\"highlight__hljs-type___11WfV\">Config</span> {\n      cMediaType = <span class=\"highlight__hljs-type___11WfV\">V1_JSON</span>,\n      cSize = <span class=\"highlight__hljs-number___2gmaH\">7023</span>,\n      cDigest = <span class=\"highlight__hljs-string___1SffY\">\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\"</span>\n      },\n  layers = [\n      <span class=\"highlight__hljs-type___11WfV\">Layer</span> {\n          lMediaType = <span class=\"highlight__hljs-type___11WfV\">Diff</span>,\n          lSize = <span class=\"highlight__hljs-number___2gmaH\">32654</span>,\n          lDigest = <span class=\"highlight__hljs-string___1SffY\">\"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f\"</span>,\n          lUrls = <span class=\"highlight__hljs-type___11WfV\">Nothing</span>\n          },\n      <span class=\"highlight__hljs-type___11WfV\">Layer</span> {\n          lMediaType = <span class=\"highlight__hljs-type___11WfV\">Diff</span>,\n          lSize = <span class=\"highlight__hljs-number___2gmaH\">16724</span>,\n          lDigest = <span class=\"highlight__hljs-string___1SffY\">\"sha256:3c3a4604a545cdc127456d94e421cd355bca5b528f4a9c1905b15da2eb4a4c6b\"</span>,\n          lUrls = <span class=\"highlight__hljs-type___11WfV\">Nothing</span>\n          },\n      <span class=\"highlight__hljs-type___11WfV\">Layer</span> {\n          lMediaType = <span class=\"highlight__hljs-type___11WfV\">Diff</span>,\n          lSize = <span class=\"highlight__hljs-number___2gmaH\">73109</span>,\n          lDigest = <span class=\"highlight__hljs-string___1SffY\">\"sha256:ec4b8955958665577945c89419d1af06b5f7636b4ac3da7f12184802ad867736\"</span>,\n          lUrls = <span class=\"highlight__hljs-type___11WfV\">Nothing</span>\n          }\n      ]\n  }\n</code></pre>\n<p>For us, it is important to note how the mechanics behind backward\ncompatibility work.</p>\n<blockquote>\n<p>When pushing images, clients which support the new manifest format\nshould first construct a manifest in the new format.</p>\n</blockquote>\n<p>Which is great for us because that means we only have to code support\nfor v2 manifests and compatible clients will behave appropriately.</p>\n<h3 id=\"implementing-the-handler\">Implementing the Handler</h3>\n<p>At this point, it’s useful to set up a proxy. After doing that, we can\nlog out arbitrary parts of the requests/responses to find the\nfollowing headers coming from the docker engine request to <code>putManifest</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{\n  <span class=\"highlight__hljs-string___1SffY\">\"connection\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"close\"</span>,\n  <span class=\"highlight__hljs-string___1SffY\">\"accept-encoding\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"gzip\"</span>,\n  <span class=\"highlight__hljs-string___1SffY\">\"content-type\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,\n  <span class=\"highlight__hljs-string___1SffY\">\"content-length\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"482\"</span>,\n  <span class=\"highlight__hljs-string___1SffY\">\"user-agent\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"docker/1.12.1 go/go1.6.3 git-commit/23cf638 kernel/4.4.20-moby os/linux arch/amd64 UpstreamClient(Docker-Client/1.12.1 \\\\(darwin\\\\))\"</span>,\n  <span class=\"highlight__hljs-string___1SffY\">\"host\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"localhost:8000\"</span>\n}\n</code></pre>\n<p>The one we <em>really</em> care about is the <code>Content-Type</code> header. The\nrequest identifies the type of <code>Manifest</code> based on the <code>Content-Type</code>,\nso we can easily handle different <code>Manifest</code> content. To add support\nfor the <code>vnd.docker.distribution.manifest.v2+json</code> <code>Content-Type</code>, we\ncan write the implementation for a new Servant <code>Content-Type</code>.</p>\n<p><a href=\"/servant-custom-content-types/\">Read More on Custom Content-Types</a></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> = <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> <span class=\"highlight__hljs-type___11WfV\">String</span></span>\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Accept</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  contentType _ = <span class=\"highlight__hljs-string___1SffY\">\"application\"</span> // <span class=\"highlight__hljs-string___1SffY\">\"vnd.docker.distribution.manifest.v2+json\"</span>\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> a =&gt; <span class=\"highlight__hljs-type___11WfV\">MimeUnrender</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> (<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-title___1fl8Q\">a</span>) <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n   mimeUnrender _ bs = <span class=\"highlight__hljs-keyword___som98\">case</span> eitherDecodeLenient bs <span class=\"highlight__hljs-keyword___som98\">of</span>\n     <span class=\"highlight__hljs-type___11WfV\">Left</span> err -&gt; <span class=\"highlight__hljs-type___11WfV\">Left</span> err\n     <span class=\"highlight__hljs-type___11WfV\">Right</span> val -&gt; <span class=\"highlight__hljs-type___11WfV\">Right</span> (mkLazyDigest bs, val)\n</code></pre>\n<p>Note that we have also included the ability to hash the incoming\ncontent with this <code>Content-Type</code>. This means our handlers don’t have\nto worry about dealing with hashing.</p>\n<p>Our route with the new <code>Content-Type</code> looks like the following, where\n<code>CH</code> comes from the <a href=\"https://hackage.haskell.org/package/cryptonite\">cryptonite</a> package. The request body\nis specified as a tuple of <code>(Digest, Manfiest)</code> which comes from the\n<code>HashedJSON</code> <code>Content-Type</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>  <span class=\"highlight__hljs-type___11WfV\">ReqBody</span> '[<span class=\"highlight__hljs-type___11WfV\">HashedJSON</span>] (<span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-type___11WfV\">Manifest</span>) :&gt;\n    <span class=\"highlight__hljs-type___11WfV\">PutCreated</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n      <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Content-Length\"</span> <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n      <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Content-Digest\"</span> <span class=\"highlight__hljs-type___11WfV\">CDigest</span>\n      ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n</code></pre>\n<p>We are still doing as little work as possible in the handler.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">putManifest</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n            -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n            -&gt; <span class=\"highlight__hljs-type___11WfV\">Ref</span>\n            -&gt; (<span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-type___11WfV\">Manifest</span>)\n            -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Content-Length\"</span> <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Content-Digest\"</span> <span class=\"highlight__hljs-type___11WfV\">CDigest</span>\n    ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">putManifest</span> namespace' name ref' (digest, manifest) = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  liftIO $ print <span class=\"highlight__hljs-string___1SffY\">\"putManifest\"</span>\n  liftIO $ print digest\n  return $ addHeader <span class=\"highlight__hljs-number___2gmaH\">0</span>\n         $ addHeader (<span class=\"highlight__hljs-type___11WfV\">CDigest</span> digest) <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>Success!</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&quot;putManifest&quot;\n6741f4d4187d8b5bcdf338c6a8dbbef12604e31211b3f57e4873f623f64dba80\nPUT /v2/biscarch/hello-world/manifests/latest\n  Request Body: {\n   &quot;schemaVersion&quot;: 2,\n   &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n   &quot;config&quot;: {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.container.image.v1+json&quot;,\n      &quot;digest&quot;: &quot;sha256:c54a2cc56cbb2f04003c1cd4507e118af7c0d340fe7e2720f70976c4b75237dc&quot;\n   },\n   &quot;layers&quot;: [\n      {\n         &quot;mediaType&quot;: &quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;,\n         &quot;digest&quot;: &quot;sha256:c04b14da8d1441880ed3fe6106fb2cc6fa1c9661846ac0266b8a5ec8edf37b7c&quot;\n      }\n   ]\n}\n  Accept:\n  Status: 201 Created 0.000758785s\n</code></pre>\n<hr>\n<h1 id=\"a-gadt-rises\">A GADT Rises</h1>\n<p>Now that we have a fully “working” image upload (at least, the docker\nengine is convinced we handled everything correctly), we have two ways\nforward.</p>\n<ol>\n<li>Truly implement <code>push</code> compatibility complete with resumable\nupload, etc.</li>\n<li>Execute the same “as little as possible” process to complete a\n<code>docker pull</code>.</li>\n</ol>\n<p>Since we eventually we want to support multiple backends, Option 1\nwill have to happen in the future. To do this, we would start off with\na GADT that defines the various operations that need to be implemented\nfor a new backend.</p>\n<p>To refresh, here is the list of handlers we need to implement for\n<code>push</code> compatibility.</p>\n<ul>\n<li>uploadBlob</li>\n<li>patchBlob</li>\n<li>putBlob</li>\n<li>headDigest</li>\n<li>putManifest</li>\n</ul>\n<p>What we want in the end is a Generalized Algebraic Data Type that\ndefines what it means to be a <code>RegistryBackend</code>. An example\ndeclaration for the <code>uploadBlob</code> functionality shows that a compliant\nbackend would need to declare a function which too a <code>RepoName</code>,\n<code>UUID</code>, <code>Maybe Digest</code> and returned an <code>Either UploadError NoContent</code>. We would use <code>UploadError</code> to restrict the types of errors\nwhich come back so we can communicate with exists clients such as the\nDocker engine.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-type___11WfV\">RegistryBackend</span> b <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  uploadBlob :: b\n             -&gt; <span class=\"highlight__hljs-type___11WfV\">RepoName</span>\n             -&gt; <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n             -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n             -&gt; <span class=\"highlight__hljs-type___11WfV\">Either</span> <span class=\"highlight__hljs-type___11WfV\">UploadError</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n  ...\n</code></pre>\n<p>This involves a couple of pieces including changing our handler types\nfrom the following (which uses <code>App</code> directly).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">putBlob</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>to something more general. Possibly just a <code>HasRegistryBackend</code>\nconstraint on the monad (<code>App</code> is also a monad).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">putBlob</span> :: ( <span class=\"highlight__hljs-type___11WfV\">KatipContext</span> m, <span class=\"highlight__hljs-type___11WfV\">RegistryBackend</span> m )\n        =&gt; <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n        -&gt; m <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>This would allow us to move configuration of the server into the\nexecutables while still allowing the library to provide guarentees\nabout what it needs to be able to function. In effect, allowing us to\nbuild binaries that target Postgres, File Systems, and other\ninteresting data stores.</p>\n<p>We will keep this in mind as we move forward with a concrete\nimplementation based on Postgres. This concrete implementation will\ninform us as to which abstractions make sense. An interesting choice\nfor the second store implementation would be something without\ntransactions and different consistency guarentees such as S3 or a KV\nstore.</p>\n<h1 id=\"postgres-uploadblob\">Postgres uploadBlob</h1>\n<p>Since we now need a “real” backend, we’ll spin up Postgres using\n<a href=\"http://sqitch.org/\">sqitch</a> for migrations. The official Postgres image allows us\nto use a shell script to initialize the db so all we need to do in\naddition is install sqitch:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>FROM postgres\n\nRUN apt-get update &amp;&amp; apt-get install sqitch -y\n\nCOPY . /opt/sqitch\nWORKDIR /opt/sqitch\n\nCOPY ./initdb.sh /docker-entrypoint-initdb.d/initdb.sh\n</code></pre>\n<p><a href=\"https://github.com/ChristopherBiscardi/superhuman-registry/blob/9508e1b1b6887c8d4e412fad0ddd8f89676f8192/sqitch/initdb.sh\">initdb.sh</a>\nis the following script to execute sqitch:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>#!/bin/bash\nset -e\n\ncd /opt/sqitch &amp;&amp; sqitch -u &quot;$POSTGRES_USER&quot; deploy --verify\n</code></pre>\n<p>The migrations (in order) are the following three. The first sets up\nour SR schema.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">-- Deploy sr:appschema to pg</span>\n\n<span class=\"highlight__hljs-keyword___som98\">BEGIN</span>;\n\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">SCHEMA</span> sr;\n\n<span class=\"highlight__hljs-keyword___som98\">COMMIT</span>;\n</code></pre>\n<p>The second registers uuid-ossp, which we will use when tracking upload\nrequests.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">-- Deploy sr:uuid-ossp to pg</span>\n<span class=\"highlight__hljs-comment___UYk12\">-- requires: appschema</span>\n\n<span class=\"highlight__hljs-keyword___som98\">BEGIN</span>;\n\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> EXTENSION <span class=\"highlight__hljs-string___1SffY\">\"uuid-ossp\"</span>;\n\n<span class=\"highlight__hljs-keyword___som98\">COMMIT</span>;\n</code></pre>\n<p>Finally, we implement a table with automatic <code>created_at</code> and\n<code>modified_at</code> timestamps. These timestamps will help us implement\ngarbage collection for abandoned uploads. We let Postgres handle\ngeneration of unique UUIDs on <code>INSERT</code> and leave the creation of a\nLarge Object for the future.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">-- Deploy sr:blob-uploads to pg</span>\n<span class=\"highlight__hljs-comment___UYk12\">-- requires: uuid-ossp</span>\n\n<span class=\"highlight__hljs-keyword___som98\">BEGIN</span>;\n\n<span class=\"highlight__hljs-comment___UYk12\">-- Table</span>\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">TABLE</span> sr.blob_uploads (\n  <span class=\"highlight__hljs-keyword___som98\">id</span> <span class=\"highlight__hljs-keyword___som98\">UUID</span> PRIMARY <span class=\"highlight__hljs-keyword___som98\">KEY</span> <span class=\"highlight__hljs-keyword___som98\">DEFAULT</span> uuid_generate_v4(),\n  lo_id <span class=\"highlight__hljs-keyword___som98\">OID</span>,\n  repo_name <span class=\"highlight__hljs-built_in___3uuyR\">VARCHAR</span>(<span class=\"highlight__hljs-number___2gmaH\">256</span>) <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n  created_at <span class=\"highlight__hljs-keyword___som98\">TIMESTAMP</span> <span class=\"highlight__hljs-keyword___som98\">WITH</span> <span class=\"highlight__hljs-keyword___som98\">TIME</span> ZONE <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n  modified_at <span class=\"highlight__hljs-keyword___som98\">TIMESTAMP</span> <span class=\"highlight__hljs-keyword___som98\">WITH</span> <span class=\"highlight__hljs-keyword___som98\">TIME</span> ZONE <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>\n);\n\n<span class=\"highlight__hljs-comment___UYk12\">-- Automatically update modified_at</span>\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">OR</span> <span class=\"highlight__hljs-keyword___som98\">REPLACE</span> <span class=\"highlight__hljs-keyword___som98\">FUNCTION</span> update_modified_column()\n<span class=\"highlight__hljs-keyword___som98\">RETURNS</span> <span class=\"highlight__hljs-keyword___som98\">TRIGGER</span> <span class=\"highlight__hljs-keyword___som98\">AS</span> $$\n<span class=\"highlight__hljs-keyword___som98\">BEGIN</span>\n    NEW.modified_at = <span class=\"highlight__hljs-keyword___som98\">now</span>();\n    <span class=\"highlight__hljs-comment___UYk12\">-- Force created_at to never change</span>\n    NEW.created_at = OLD.created_at;\n    RETURN NEW;\n<span class=\"highlight__hljs-keyword___som98\">END</span>;\n$$ language 'plpgsql';\n\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">TRIGGER</span> update_blob_upload_modtime\n<span class=\"highlight__hljs-keyword___som98\">BEFORE</span> <span class=\"highlight__hljs-keyword___som98\">UPDATE</span> <span class=\"highlight__hljs-keyword___som98\">ON</span> sr.blob_uploads\n<span class=\"highlight__hljs-keyword___som98\">FOR</span> <span class=\"highlight__hljs-keyword___som98\">EACH</span> <span class=\"highlight__hljs-keyword___som98\">ROW</span> <span class=\"highlight__hljs-keyword___som98\">EXECUTE</span> <span class=\"highlight__hljs-keyword___som98\">PROCEDURE</span> update_modified_column();\n\n<span class=\"highlight__hljs-comment___UYk12\">-- | Automatically populate created_at</span>\n<span class=\"highlight__hljs-comment___UYk12\">-- Use a trigger so it's impossible to override on insert</span>\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">OR</span> <span class=\"highlight__hljs-keyword___som98\">REPLACE</span> <span class=\"highlight__hljs-keyword___som98\">FUNCTION</span> populate_create_column()\n<span class=\"highlight__hljs-keyword___som98\">RETURNS</span> <span class=\"highlight__hljs-keyword___som98\">TRIGGER</span> <span class=\"highlight__hljs-keyword___som98\">AS</span> $$\n<span class=\"highlight__hljs-keyword___som98\">BEGIN</span>\n    NEW.created_at = <span class=\"highlight__hljs-keyword___som98\">now</span>();\n    NEW.modified_at = now();\n    RETURN NEW;\t\n<span class=\"highlight__hljs-keyword___som98\">END</span>;\n$$ language 'plpgsql';\n\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">TRIGGER</span> insert_blob_upload_createtime\n<span class=\"highlight__hljs-keyword___som98\">BEFORE</span> <span class=\"highlight__hljs-keyword___som98\">INSERT</span> <span class=\"highlight__hljs-keyword___som98\">ON</span> sr.blob_uploads\n<span class=\"highlight__hljs-keyword___som98\">FOR</span> <span class=\"highlight__hljs-keyword___som98\">EACH</span> <span class=\"highlight__hljs-keyword___som98\">ROW</span> <span class=\"highlight__hljs-keyword___som98\">EXECUTE</span> <span class=\"highlight__hljs-keyword___som98\">PROCEDURE</span> populate_create_column();\n\n<span class=\"highlight__hljs-keyword___som98\">COMMIT</span>;\n</code></pre>\n<p>To handle the initialization of new uploads, we use the following\nquery which grabs a connection from the pool, executes the statement\nand returns the UUID of the new upload.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">-- | Insert a new upload for a Repos</span>\n<span class=\"highlight__hljs-title___1fl8Q\">startNewUpload</span> :: <span class=\"highlight__hljs-type___11WfV\">Reponame</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n<span class=\"highlight__hljs-title___1fl8Q\">startNewUpload</span> repo = runPG (query repo insertNewUpload)\n\n<span class=\"highlight__hljs-comment___UYk12\">-- | PG automatically creates uuid, created_at and modified_at</span>\n<span class=\"highlight__hljs-title___1fl8Q\">insertNewUpload</span> :: <span class=\"highlight__hljs-type___11WfV\">Query</span> <span class=\"highlight__hljs-type___11WfV\">Text</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n<span class=\"highlight__hljs-title___1fl8Q\">insertNewUpload</span> =\n  statement sql encoder decoder <span class=\"highlight__hljs-type___11WfV\">True</span>\n  <span class=\"highlight__hljs-keyword___som98\">where</span>\n    sql =\n      <span class=\"highlight__hljs-string___1SffY\">\"INSERT INTO sr.blob_uploads (repo_name) VALUES ($1) RETURNING id\"</span>\n    encoder =\n      <span class=\"highlight__hljs-type___11WfV\">E</span>.value <span class=\"highlight__hljs-type___11WfV\">E</span>.text\n    decoder =\n      <span class=\"highlight__hljs-type___11WfV\">D</span>.singleRow (<span class=\"highlight__hljs-type___11WfV\">D</span>.value <span class=\"highlight__hljs-type___11WfV\">D</span>.uuid)\n</code></pre>\n<p><code>runPG</code> is a utility function which handles any connection\nerrors.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">runPG</span> :: <span class=\"highlight__hljs-type___11WfV\">Session</span> a -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> a\n<span class=\"highlight__hljs-title___1fl8Q\">runPG</span> action = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  pool &lt;- asks acPGPool\n  res &lt;- liftIO $ <span class=\"highlight__hljs-type___11WfV\">P</span>.use pool action\n  <span class=\"highlight__hljs-keyword___som98\">case</span> res <span class=\"highlight__hljs-keyword___som98\">of</span>\n    <span class=\"highlight__hljs-type___11WfV\">Left</span> usageError -&gt; <span class=\"highlight__hljs-keyword___som98\">do</span>\n    ...\n</code></pre>\n<h1 id=\"postgres-headblob\">Postgres headBlob</h1>\n<p>At this point I figured out that Docker will ask to mount if you push\nan image, then retag it and push the retagged image.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker tag hello-world localhost:9000/biscarch/hello-worlds\ndocker push localhost:9000/biscarch/hello-worlds\ndocker tag hello-world localhost:9000/biscarch/hello-world-2\ndocker push localhost:9000/biscarch/hello-world-2\n</code></pre>\n<p>The last push produces the following request to blob upload:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>GET /v2/\n  Accept:\n  Status: 200 OK 0.002441185s\nPOST /v2/biscarch/hello-world-2/blobs/uploads/\n  Params: [(&quot;from&quot;,&quot;biscarch/hello-worlds&quot;),(&quot;mount&quot;,&quot;sha256:c04b14da8d1441880ed3fe6106fb2cc6fa1c9661846ac0266b8a5ec8edf37b7c&quot;)]\n  Accept:\n</code></pre>\n<p>To implement <code>putBlob</code> we’ll need to make our hacky <code>headBlob</code> return\n404s. This gives us a nice spot to implement a <code>blobs</code> table which\nwill form the basis of our <code>catalog</code>.</p>\n<p>TODO: implement CREATE TABLE <code>blobs</code> here.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">-- Table</span>\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">TABLE</span> sr.blobs (\n  <span class=\"highlight__hljs-comment___UYk12\">-- id is a sha256 hash</span>\n  <span class=\"highlight__hljs-comment___UYk12\">-- <span class=\"hljs-doctag\">TODO:</span> limit this to sha256 length?</span>\n  <span class=\"highlight__hljs-keyword___som98\">id</span> <span class=\"highlight__hljs-built_in___3uuyR\">TEXT</span> PRIMARY <span class=\"highlight__hljs-keyword___som98\">KEY</span>,\n  <span class=\"highlight__hljs-comment___UYk12\">-- id of the hashed blob</span>\n  lo_id <span class=\"highlight__hljs-keyword___som98\">OID</span>,\n  <span class=\"highlight__hljs-comment___UYk12\">-- maybe remove repo_name?</span>\n  repo_name <span class=\"highlight__hljs-built_in___3uuyR\">VARCHAR</span>(<span class=\"highlight__hljs-number___2gmaH\">256</span>) <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n  created_at <span class=\"highlight__hljs-keyword___som98\">TIMESTAMP</span> <span class=\"highlight__hljs-keyword___som98\">WITH</span> <span class=\"highlight__hljs-keyword___som98\">TIME</span> ZONE <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n  modified_at <span class=\"highlight__hljs-keyword___som98\">TIMESTAMP</span> <span class=\"highlight__hljs-keyword___som98\">WITH</span> <span class=\"highlight__hljs-keyword___som98\">TIME</span> ZONE <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>\n);\n</code></pre>\n<p>Our <code>HEAD</code> handler will check to see if the blob exists in our\n<code>catalog</code>. If it does, we need to get the <code>Content-Length</code> of the blob\nto return. If it does not exist we just 404.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">headDigest</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Content-Length\"</span> <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Content-Digest\"</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n    ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">headDigest</span> namespace' name' digest' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  blobExists &lt;- headBlob digest'\n  <span class=\"highlight__hljs-keyword___som98\">case</span> blobExists <span class=\"highlight__hljs-keyword___som98\">of</span>\n    <span class=\"highlight__hljs-type___11WfV\">BLOB_EXISTS</span> d' -&gt; return addHeader <span class=\"highlight__hljs-number___2gmaH\">0</span>\n                    $ addHeader digest' <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n    <span class=\"highlight__hljs-type___11WfV\">UNKNOWN_BLOB</span> -&gt; throwError err404\n</code></pre>\n<h1 id=\"fixing-patchblob\">Fixing patchBlob</h1>\n<h1 id=\"postgres-putblob\">Postgres putBlob</h1>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.2.node.attributes":{"slug":"building-a-docker-registry","__typename":"BlogPostAttributes","title":"Building a Docker Registry","url":"/building-a-docker-registry/","excerpt":"Containers are surging right now. This series of blog posts will\nexplore a small corner of that universe by building a Docker Registry\nthat…","updatedAt":"Oct 3rd, 2016","timeToRead":20,"headerImage":"/da49167186a7e54073552e04d715a80f.png"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.2":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.2.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.3.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.3.node.attributes","generated":true},"body":"<p>It can be hard to figure out how to deal with all of the type\nmachinery in Servant. This post details adding headers to the response\nof a Servant API.</p>\n<p>Given the following API, which returns NoContent for a GET request.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2</span> = \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span></span>\n</code></pre>\n<p>and the following handler, which assumes we’ve set up a custom Monad\nstack called <code>App</code> (note that we’ve skipped the “server” boilerplate\nfor brevity, since it is covered in the Servant docs).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">v2</span> :: <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n<span class=\"highlight__hljs-title___1fl8Q\">v2</span> = return <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>We can add a response header using <a href=\"http://hackage.haskell.org/package/servant-0.8/docs/Servant-API-ResponseHeaders.html#v:addHeader\">addHeader</a>, which is\ndetailed in the docs on Hackage. What may be less obvious is that\naddHeader changes the response type of the route. Our simple API\nchanges it’s type to represent the new return value:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2Base</span> = \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[<span class=\"highlight__hljs-type___11WfV\">Header</span> \"<span class=\"highlight__hljs-type___11WfV\">X</span>-<span class=\"highlight__hljs-type___11WfV\">Awesome</span>\" <span class=\"highlight__hljs-type___11WfV\">String</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)</span>\n</code></pre>\n<p>and our handler now can return the appropriate type as well:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">v2</span> :: <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[<span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"X-Awesome\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">v2</span> = return $ addHeader <span class=\"highlight__hljs-string___1SffY\">\"very/awesome\"</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<h2 id=\"multiple-headers\">Multiple Headers</h2>\n<p>If we inspect the type we added to be able to return our first header,\nwe can notice that it is a list of <code>Header</code>s. We can use this to add\nmultiple new headers to our route as follows:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2Base</span> = \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> \"<span class=\"highlight__hljs-type___11WfV\">X</span>-<span class=\"highlight__hljs-type___11WfV\">Awesome</span>\" <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> \"<span class=\"highlight__hljs-type___11WfV\">Content</span>-<span class=\"highlight__hljs-type___11WfV\">Type</span>\" <span class=\"highlight__hljs-type___11WfV\">String</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)</span>\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.3.node.attributes":{"slug":"response-headers-with-servant","__typename":"BlogPostAttributes","title":"Response Headers with Servant","url":"/response-headers-with-servant/","excerpt":"It can be hard to figure out how to deal with all of the type\nmachinery in Servant. This post details adding headers to the response\nof a…","updatedAt":"Aug 8th, 2016","timeToRead":1,"headerImage":"/0e564987f79346b0e81685c304af3912.png"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.3":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.3.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.4.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.4.node.attributes","generated":true},"body":"<p>To set up a Servant/WAI application with monitoring, we will first\nscaffold a servant application using stack.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; stack new servant-prometheus \\\nhttps://raw.githubusercontent.com/commercialhaskell/stack-templates/8cb4889fb7c502c18f6f9ecf9<span class=\"highlight__hljs-built_in___3uuyR\">cd</span>62aef58589c21/servant.hsfiles \\\n--resolver nightly-2016-05-21\n</code></pre>\n<p>To instrument our servant application, add the following three\ndependencies to <code>servant-prometheus.cabal</code> under the <code>build-depends</code>\nof the <code>library</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>, wai-middleware-prometheus &gt;= <span class=\"highlight__hljs-number___2gmaH\">0.1</span><span class=\"highlight__hljs-number___2gmaH\">.0</span><span class=\"highlight__hljs-number___2gmaH\">.1</span>\n, prometheus-client &gt;= <span class=\"highlight__hljs-number___2gmaH\">0.1</span><span class=\"highlight__hljs-number___2gmaH\">.0</span><span class=\"highlight__hljs-number___2gmaH\">.1</span>\n, prometheus-metrics-ghc &gt;= <span class=\"highlight__hljs-number___2gmaH\">0.1</span><span class=\"highlight__hljs-number___2gmaH\">.0</span><span class=\"highlight__hljs-number___2gmaH\">.1</span>\n</code></pre>\n<p>In <code>src/Lib.hs</code> we need the following 3 imports. They are fully\nqualified for clarity.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">import</span> Network.Wai.Middleware.Prometheus (<span class=\"highlight__hljs-title___1fl8Q\">prometheus</span>, <span class=\"highlight__hljs-type___11WfV\">PrometheusSettings(..)</span>)\n<span class=\"highlight__hljs-keyword___som98\">import</span> Prometheus (<span class=\"highlight__hljs-title___1fl8Q\">register</span>)\n<span class=\"highlight__hljs-keyword___som98\">import</span> Prometheus.Metric.GHC (<span class=\"highlight__hljs-title___1fl8Q\">ghcMetrics</span>)\n</code></pre>\n<p>All of our work will be in the <code>startApp</code> function defined in the same\nfile. Currently, <code>startApp</code> is defined as <code>run 8080 app</code>. We are going\nto change that to the following.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">startApp</span> = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  register ghcMetrics\n  <span class=\"highlight__hljs-keyword___som98\">let</span> promMiddleware = prometheus $ <span class=\"highlight__hljs-type___11WfV\">PrometheusSettings</span> [<span class=\"highlight__hljs-string___1SffY\">\"metrics\"</span>] <span class=\"highlight__hljs-type___11WfV\">True</span> <span class=\"highlight__hljs-type___11WfV\">True</span>\n  run <span class=\"highlight__hljs-number___2gmaH\">8080</span> $ promMiddleware $ app\n</code></pre>\n<p>We also need <code>{-# LANGUAGE OverloadedStrings #-}</code> for the\n<code>[&quot;metrics&quot;]</code> literal.</p>\n<p>Finally, to actually enable consumption of GHC metrics, we need to\ninclude the <code>-T</code> flag in our executable. The <code>executable</code>'s\n<code>ghc-options</code> becomes:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>ghc-options: -threaded -rtsopts -with-rtsopts=-TN\n</code></pre>\n<p>After building and running, the servant server should be providing\nprometheus metrics at /metrics.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>stack install --only-dependencies\nstack build\nstack <span class=\"highlight__hljs-built_in___3uuyR\">exec</span> servant-prometheus-exe\n</code></pre>\n<h1 id=\"details\">Details</h1>\n<p>All three of the packages we added as dependencies come from\n<a href=\"https://github.com/fimad/prometheus-haskell\">fimad/prometheus-haskell</a>.</p>\n<ul>\n<li>Prometheus Client\n<ul>\n<li>Defines the core data types and metrics. The other two packages\nbuild on client to provide their metrics.</li>\n<li>This is the package to use to set up custom metrics.</li>\n</ul>\n</li>\n<li>Prometheus Metrics GHC\n<ul>\n<li>Provides a set of custom metrics for Prometheus Client that are\nexposed from GHC’s runtime system.</li>\n</ul>\n</li>\n<li>WAI Middleware Prometheus\n<ul>\n<li>Instruments a WAI application, exposing common HTTP metrics. Also\nexposes those metrics on /metrics (or the url of the user’s\nchoice)</li>\n</ul>\n</li>\n</ul>\n<p><a href=\"http://localhost:8080/metrics\">localhost:8080/metrics</a> should now\nhave the following output, which can be scraped by Prometheus.</p>\n<ul>\n<li><code>http_</code> prefixed metrics come from the WAI middleware</li>\n<li><code>ghc_</code> prefixed metrics come from <code>ghcMetrics</code></li>\n</ul>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code># HELP http_request_duration_microseconds The HTTP request latencies in microseconds.\n# TYPE http_request_duration_microseconds summary\nhttp_request_duration_microseconds{handler=&quot;app&quot;,quantile=&quot;0.5&quot;} 258.0\nhttp_request_duration_microseconds{handler=&quot;app&quot;,quantile=&quot;0.9&quot;} 258.0\nhttp_request_duration_microseconds{handler=&quot;app&quot;,quantile=&quot;0.99&quot;} 258.0\nhttp_request_duration_microseconds_sum{handler=&quot;app&quot;} 258.0\nhttp_request_duration_microseconds_count{handler=&quot;app&quot;} 1\n# HELP ghc_sparks The number of sparks in the local spark pool.\n# TYPE ghc_sparks gauge\nghc_sparks 0\n# HELP ghc_capabilities The number of threads that can run truly simultaneously.\n# TYPE ghc_capabilities gauge\nghc_capabilities 1\n# HELP ghc_bytes_allocated Total number of bytes allocated.\n# TYPE ghc_bytes_allocated gauge\nghc_bytes_allocated 249136\n# HELP ghc_num_gcs The number of garbage collections performed.\n# TYPE ghc_num_gcs gauge\nghc_num_gcs 3\n# HELP ghc_max_bytes_used The maximum number of live bytes seen so far.\n# TYPE ghc_max_bytes_used gauge\nghc_max_bytes_used 65576\n# HELP ghc_cumulative_bytes_used The cumulative total bytes used.\n# TYPE ghc_cumulative_bytes_used gauge\nghc_cumulative_bytes_used 149136\n# HELP ghc_bytes_copied The number of bytes copied during garbage collection.\n# TYPE ghc_bytes_copied gauge\nghc_bytes_copied 76344\n# HELP ghc_current_bytes_used The number of current live bytes.\n# TYPE ghc_current_bytes_used gauge\nghc_current_bytes_used 65504\n# HELP ghc_current_bytes_slop The current number of bytes lost to slop.\n# TYPE ghc_current_bytes_slop gauge\nghc_current_bytes_slop 0\n# HELP ghc_max_bytes_slop The maximum number of bytes lost to slop so far.\n# TYPE ghc_max_bytes_slop gauge\nghc_max_bytes_slop 8152\n# HELP ghc_peak_megabytes_allocated The maximum number of megabytes allocated.\n# TYPE ghc_peak_megabytes_allocated gauge\nghc_peak_megabytes_allocated 1\n# HELP ghc_mutator_cpu_seconds The CPU time spent running mutator threads.\n# TYPE ghc_mutator_cpu_seconds gauge\nghc_mutator_cpu_seconds 1.471e-3\n# HELP ghc_mutator_wall_seconds The wall clock time spent running mutator threads.\n# TYPE ghc_mutator_wall_seconds gauge\nghc_mutator_wall_seconds 1.48e-3\n# HELP ghc_gc_cpu_seconds The CPU time spent running GC.\n# TYPE ghc_gc_cpu_seconds gauge\nghc_gc_cpu_seconds 1.428e-3\n# HELP ghc_gc_wall_seconds The wall clock time spent running GC.\n# TYPE ghc_gc_wall_seconds gauge\nghc_gc_wall_seconds 1.781416e-3\n# HELP ghc_cpu_seconds Total CPU time elapsed since program start.\n# TYPE ghc_cpu_seconds gauge\nghc_cpu_seconds 0.352497\n# HELP ghc_wall_seconds Total wall clock time elapsed since start.\n# TYPE ghc_wall_seconds gauge\nghc_wall_seconds 28.681236189\n# HELP ghc_parallel_total_bytes_copied Number of bytes copied during GC, minus space held by mutable lists held by the capabilities.\n# TYPE ghc_parallel_total_bytes_copied gauge\nghc_parallel_total_bytes_copied 0\n# HELP ghc_parallel_max_bytes_copied Sum of number of bytes copied\neach GC by the most active GC thread each GC.\n# TYPE ghc_parallel_max_bytes_copied gauge\nghc_parallel_max_bytes_copied 0\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.4.node.attributes":{"slug":"instrumenting-servant-with-prometheus","__typename":"BlogPostAttributes","title":"Instrumenting Servant with Prometheus","url":"/instrumenting-servant-with-prometheus/","excerpt":"To set up a Servant/WAI application with monitoring, we will first\nscaffold a servant application using stack.","updatedAt":"May 21st, 2016","timeToRead":2,"headerImage":"/4697ea4ccbcd2ba2f293936baed59b9d.png"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.4":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.4.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.5.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.5.node.attributes","generated":true},"body":"<p>Stack yields some nice benefits for blogging, tutorials, and more. The\nmain benefit I want to talk about today is reproducibility when using\nstack to start a new project (in a tutorial).</p>\n<h2 id=\"resolvers\">Resolvers</h2>\n<p>To ensure repeatable resolutions, choose a specific\n<a href=\"https://www.stackage.org/nightly-2016-04-10\">resolver</a>. Since even the nightlies get unique identifiers,\nwe can ensure that any future attempt at reproducing a given tutorial\nis more likely to be successful.</p>\n<h2 id=\"templates\">Templates</h2>\n<p>Stack can use templates from github. Pointing to a specific template,\nwhether custom or from the <a href=\"https://github.com/commercialhaskell/stack-templates\">stack-templates</a> repo, is good\nas well. Cloning git repos could be used as an alternative here, but\none advantage of using Stack’s support is that you can now have a\nsingle repo of templates and point to a specific git commit/file.</p>\n<h2 id=\"code\">Code</h2>\n<p>A fully qualified reproducible template commmand could look like:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>stack new servant-users \\\nhttps://raw.githubusercontent.com/commercialhaskell/stack-templates/9a18e8762b8f048d403dabe5c19552ceb5292318/servant.hsfiles \\\n--resolver nightly-2016-04-10\n</code></pre>\n<p>– note</p>\n<p>Effectively, doing this is trying to freeze the (Hackage) world at a\nspecific point in time for a specific .cabal setup. I’d argue that\ndoing this is more useful (for tutorials) than trying to make sure a\ntutorial compiles with any arbitrary future set of packages.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.5.node.attributes":{"slug":"reproducible-tutorials-with-stack","__typename":"BlogPostAttributes","title":"Reproducible Tutorials with Stack","url":"/reproducible-tutorials-with-stack/","excerpt":"Stack yields some nice benefits for blogging, tutorials, and more. The\nmain benefit I want to talk about today is reproducibility when…","updatedAt":"Apr 9th, 2016","timeToRead":1,"headerImage":"/0e564987f79346b0e81685c304af3912.png"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.5":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.5.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.6.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.6.node.attributes","generated":true},"body":"<p>Hooray! A new published version of my blog (which also happens to\ninclude everything on this domain and thus is not just a blog).</p>\n<h1 id=\"a-new-blog-engine\">A New Blog Engine</h1>\n<p>I did what everyone tells you not to and wrote a whole new engine to\nbuild the new version of this blog. I dubbed it Leo and you can check\nit out <a href=\"https://github.com/superawesomelabs/leo\">on GitHub</a> if you are so inclined. It, for example,\nsupports conditionally including drafts in the output with env vars:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>BLOGPOST_RENDER_DRAFTS=<span class=\"highlight__hljs-literal___1V6TY\">true</span> npm start\n</code></pre>\n<p>I’ll do a more in-depth discussion of the static-site engine beneath\nthis site in a different post. The technical architecture is fairly\ninteresting itself since it uses Relay, GraphQL and React.</p>\n<h2 id=\"authoring\">Authoring</h2>\n<p>The markdown implementation is <a href=\"https://github.com/markdown-it/markdown-it\">markdown-it</a>, which\nsupports commonmark in it’s default configuration and has a plugin\nsystem. Hopefully I won’t abuse the plugin system too much… or I may\njust end up with a custom markdown syntax  ¯\\_(ツ)_/¯</p>\n<h3 id=\"emoji-shortcode-support\">Emoji Shortcode Support</h3>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>:poop: :) :fire: :joy: :sunglasses: :dizzy_face: :athletic_shoe:\n:tongue:\n</code></pre>\n<p>yields</p>\n<p>💩 😃 🔥 😂 😎 😵 👟 👅</p>\n<p>Unfortunately, for some reason they only work in <code>&lt;p&gt;</code>\ntags. Experimentally they use the correct utf-8 code in headers, but\nrender with an effect similar to <code>visibility: hidden</code>.</p>\n<h3 id=\"youtubevimeo\">Youtube/Vimeo</h3>\n<p>YouTube support is enabled via “shortcodes” from\n<a href=\"https://www.npmjs.com/package/markdown-it-video\">markdown-it-video</a></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>@[youtube](https://youtu.be/rO7oDZZb7K0)\n</code></pre>\n<p>turns into</p>\n<p><div class=\"embed-responsive embed-responsive-16by9\"><iframe class=\"embed-responsive-item\" id=\"ytplayer\" type=\"text/html\" width=\"640\" height=\"390\" src=\"//www.youtube.com/embed/rO7oDZZb7K0\" frameborder=\"0\"></iframe></div></p>\n<h2 id=\"headers\">Headers</h2>\n<ul>\n<li><a href=\"https://www.npmjs.com/package/markdown-it-named-headers\">markdown-it-named-headers</a></li>\n</ul>\n<p>headers have <code>name</code> attributes automatically associated with them, but\nthey aren’t “auto-linked”. This means that you have to either guess at\nthe <code>#slugified</code> representation or inspect element. I’d like to change\nthis to have a clickable link in the future.</p>\n<h2 id=\"footnotes\">Footnotes</h2>\n<p>Pandoc-style footnotes are enabled.<sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup></p>\n<h2 id=\"postcss\">PostCSS</h2>\n<ul>\n<li>More on <a href=\"https://github.com/postcss/postcss#plugins\">PostCSS</a></li>\n</ul>\n<p>I have a component library system<sup class=\"footnote-ref\"><a href=\"#fn2\" id=\"fnref2\">[2]</a></sup> in development that’s also\nbeing used in places on this site. It uses PostCSS for the CSS\ngeneration. <a href=\"https://github.com/seaneking/postcss-responsive-type\">postcss-responsive-type</a> is\nresponsible for the font-size changing depending on viewport size (try\nit, it’s cool!). This yields a nice effect where the entire site\nscales a bit, based on typography size, between phones and 4k screens.</p>\n<h1 id=\"design\">Design</h1>\n<p>Ok, so I spent 0 time designing this thing. It’s mainly an exploration\nof the functionality of <a href=\"https://github.com/superawesomelabs/leo\">Leo</a> (which was used to build the\nsite). That means there are significant areas to improve in terms of\ndesign. You may notice, for example, that there are some blueprint-ish\nplaceholders for featured post images, etc.</p>\n<h2 id=\"fonts\">Fonts</h2>\n<p>Roboto is <em>ok</em>, but a stack based on <a href=\"https://typekit.com/fonts/proxima-nova\">Proxima Nova</a> is\nprobably where I’ll end up long term.</p>\n<h1 id=\"open-source\">Open Source</h1>\n<p>The source for this site is on <a href=\"website\">GitHub</a> and the source for\nthe static site generation tool <a href=\"https://github.com/superawesomelabs/leo\">is there too</a>.</p>\n<hr class=\"footnotes-sep\">\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\"  class=\"footnote-item\"><p>Enabled by <a href=\"https://github.com/markdown-it/markdown-it-footnote\">markdown-it-footnote</a> <a href=\"#fnref1\" class=\"footnote-backref\">↩</a></p>\n</li>\n<li id=\"fn2\"  class=\"footnote-item\"><p>Not open source yet, but will live at <a href=\"https://github.com/superawesomelabs/fate\">superawesomelabs/fate</a> <a href=\"#fnref2\" class=\"footnote-backref\">↩</a></p>\n</li>\n</ol>\n</section>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.6.node.attributes":{"slug":"episode-1-a-new-blog","__typename":"BlogPostAttributes","title":"Episode 1: A New Blog","url":"/episode-1-a-new-blog/","excerpt":"Hooray! A new published version of my blog (which also happens to\ninclude everything on this domain and thus is not just a blog).","updatedAt":"Mar 27th, 2016","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.6":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.6.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.7.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.7.node.attributes","generated":true},"body":"<p>The\n<a href=\"http://www.christopherbiscardi.com/2014/12/21/docker-machine/\">previous post</a>\nexplains how to get up and running with Docker machine. This one will\nbe a quick tutorial on setting up a Minecraft server using Machine.</p>\n<h2 id=\"digital-ocean\">Digital Ocean</h2>\n<p>Create a new Digital Ocean Machine. We need a <code>1gb</code> server due to\nJava’s requirements, so we’ll specify the 1gb DO variant:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; machine-docker create -d digitalocean --digitalocean-access-token=$DO_TOKEN --digitalocean-size=1gb\nbiscarch-minecraft INFO[0000] Creating SSH key...  INFO[0000] Creating\nDigital Ocean droplet...  INFO[0003] Waiting for SSH...  INFO[0155]\n&quot;biscarch-minecraft&quot; has been created and is now the active\nmachine. To point Docker at this machine, run: export\nDOCKER_HOST=$(machine url) DOCKER_AUTH=identity \n</code></pre>\n<h2 id=\"activate\">Activate</h2>\n<p>Run the command suggested to activate the Digital Ocean\nmachine. Remember that we re-named our binaries, so our command will\nlook slightly different:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>export DOCKER_HOST=$(machine-docker url) DOCKER_AUTH=identity\n</code></pre>\n<h2 id=\"run-the-server\">Run the Server</h2>\n<p>After creating the machine, we can run a Minecraft server. Notice\nthat we’ve accepted the EULA using an environment variable.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; machine-docker-1.3.1-dev-identity-auth run -itp 25565:25565 -e EULA=true itzg/minecraft-server\nThe authenticity of host &quot;$ip:2376&quot; can't be established.\nRemote key ID XXXX\nAre you sure you want to continue connecting (yes/no)? yes\nUnable to find image 'itzg/minecraft-server:latest' locally\nPulling repository itzg/minecraft-server\ncf3280236048: Download complete\n511136ea3c5a: Download complete\n97fd97495e49: Download complete\n2dcbbf65536c: Download complete\n6a459d727ebb: Download complete\n8f321fc43180: Download complete\n03db2b23cf03: Download complete\n9cbaf023786c: Download complete\nc40e36cb3ec9: Download complete\n894f65ff66bd: Download complete\ne82301eb9615: Download complete\n1dbf91539513: Download complete\ne545342bf796: Download complete\n59bc57df4d1e: Download complete\n553afa5133d9: Download complete\n75c3ad818b79: Download complete\n0b0acc66bc64: Download complete\n978ce1e3b993: Download complete\n54fead2b8d41: Download complete\n2bb3b9314ae2: Download complete\naf46a2317b29: Download complete\n0b1b3214a72a: Download complete\nc68e5b97cc3f: Download complete\nf08ca66bb473: Download complete\n36a596d541f4: Download complete\n5c1156fb886b: Download complete\n59349c103e38: Download complete\n1d5073dd8949: Download complete\n250469004d09: Download complete\n78a77d27bdfa: Download complete\nStatus: Downloaded newer image for itzg/minecraft-server:latest\n--2014-12-27 06:06:21--  https://s3.amazonaws.com/Minecraft.Download/versions/versions.json\nResolving s3.amazonaws.com (s3.amazonaws.com)... 54.231.244.4\nConnecting to s3.amazonaws.com (s3.amazonaws.com)|54.231.244.4|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 20681 (20K) [application/octet-stream]\nSaving to: 'STDOUT'\n\n100%[====================================================================================&gt;] 20,681      --.-K/s   in 0.1s\n\n2014-12-27 06:06:22 (149 KB/s) - written to stdout [20681/20681]\n\nDownloading minecraft_server.1.8.1.jar ...\n[06:06:33] [Server thread/INFO]: Starting minecraft server version 1.8.1\n[06:06:33] [Server thread/INFO]: Loading properties\n[06:06:33] [Server thread/INFO]: Default game type: SURVIVAL\n[06:06:33] [Server thread/INFO]: Generating keypair\n[06:06:33] [Server thread/INFO]: Starting Minecraft server on *:25565\n[06:06:33] [Server thread/INFO]: Using epoll channel type\n[06:06:34] [Server thread/WARN]: Failed to load user banlist:\njava.io.FileNotFoundException: banned-players.json (No such file or directory)\n    at java.io.FileInputStream.open(Native Method) ~[?:1.7.0_65]\n    at java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:146) ~[?:1.7.0_65]\n    at com.google.common.io.Files.newReader(Files.java:86) ~[minecraft_server.1.8.1.jar:?]\n    at su.g(SourceFile:124) ~[minecraft_server.1.8.1.jar:?]\n    at po.z(SourceFile:99) [minecraft_server.1.8.1.jar:?]\n    at po.&lt;init&gt;(SourceFile:25) [minecraft_server.1.8.1.jar:?]\n    at pp.i(SourceFile:172) [minecraft_server.1.8.1.jar:?]\n    at net.minecraft.server.MinecraftServer.run(SourceFile:418) [minecraft_server.1.8.1.jar:?]\n    at java.lang.Thread.run(Thread.java:745) [?:1.7.0_65]\n[06:06:34] [Server thread/WARN]: Failed to load ip banlist:\njava.io.FileNotFoundException: banned-ips.json (No such file or directory)\n    at java.io.FileInputStream.open(Native Method) ~[?:1.7.0_65]\n    at java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:146) ~[?:1.7.0_65]\n    at com.google.common.io.Files.newReader(Files.java:86) ~[minecraft_server.1.8.1.jar:?]\n    at su.g(SourceFile:124) ~[minecraft_server.1.8.1.jar:?]\n    at po.y(SourceFile:91) [minecraft_server.1.8.1.jar:?]\n    at po.&lt;init&gt;(SourceFile:27) [minecraft_server.1.8.1.jar:?]\n    at pp.i(SourceFile:172) [minecraft_server.1.8.1.jar:?]\n    at net.minecraft.server.MinecraftServer.run(SourceFile:418) [minecraft_server.1.8.1.jar:?]\n    at java.lang.Thread.run(Thread.java:745) [?:1.7.0_65]\n[06:06:34] [Server thread/WARN]: Failed to load operators list:\njava.io.FileNotFoundException: ops.json (No such file or directory)\n    at java.io.FileInputStream.open(Native Method) ~[?:1.7.0_65]\n    at java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:146) ~[?:1.7.0_65]\n    at com.google.common.io.Files.newReader(Files.java:86) ~[minecraft_server.1.8.1.jar:?]\n    at su.g(SourceFile:124) ~[minecraft_server.1.8.1.jar:?]\n    at po.A(SourceFile:107) [minecraft_server.1.8.1.jar:?]\n    at po.&lt;init&gt;(SourceFile:29) [minecraft_server.1.8.1.jar:?]\n    at pp.i(SourceFile:172) [minecraft_server.1.8.1.jar:?]\n    at net.minecraft.server.MinecraftServer.run(SourceFile:418) [minecraft_server.1.8.1.jar:?]\n    at java.lang.Thread.run(Thread.java:745) [?:1.7.0_65]\n[06:06:34] [Server thread/WARN]: Failed to load white-list:\njava.io.FileNotFoundException: whitelist.json (No such file or directory)\n    at java.io.FileInputStream.open(Native Method) ~[?:1.7.0_65]\n    at java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:146) ~[?:1.7.0_65]\n    at com.google.common.io.Files.newReader(Files.java:86) ~[minecraft_server.1.8.1.jar:?]\n    at su.g(SourceFile:124) ~[minecraft_server.1.8.1.jar:?]\n    at po.C(SourceFile:123) [minecraft_server.1.8.1.jar:?]\n    at po.&lt;init&gt;(SourceFile:30) [minecraft_server.1.8.1.jar:?]\n    at pp.i(SourceFile:172) [minecraft_server.1.8.1.jar:?]\n    at net.minecraft.server.MinecraftServer.run(SourceFile:418) [minecraft_server.1.8.1.jar:?]\n    at java.lang.Thread.run(Thread.java:745) [?:1.7.0_65]\n[06:06:34] [Server thread/INFO]: Preparing level &quot;world&quot;\n[06:06:34] [Server thread/INFO]: Preparing start region for level 0\n[06:06:35] [Server thread/INFO]: Preparing spawn area: 4%\n[06:06:36] [Server thread/INFO]: Preparing spawn area: 7%\n[06:06:37] [Server thread/INFO]: Preparing spawn area: 9%\n[06:06:38] [Server thread/INFO]: Preparing spawn area: 11%\n[06:06:39] [Server thread/INFO]: Preparing spawn area: 15%\n[06:06:40] [Server thread/INFO]: Preparing spawn area: 17%\n[06:06:41] [Server thread/INFO]: Preparing spawn area: 20%\n[06:06:42] [Server thread/INFO]: Preparing spawn area: 29%\n[06:06:43] [Server thread/INFO]: Preparing spawn area: 40%\n[06:06:44] [Server thread/INFO]: Preparing spawn area: 55%\n[06:06:46] [Server thread/INFO]: Preparing spawn area: 70%\n[06:06:47] [Server thread/INFO]: Preparing spawn area: 82%\n[06:06:48] [Server thread/INFO]: Preparing spawn area: 95%\n[06:06:48] [Server thread/INFO]: Done (14.248s)! For help, type &quot;help&quot; or &quot;?&quot;\n</code></pre>\n<h2 id=\"launch-minecraft\">Launch Minecraft</h2>\n<p>If we ignore the files that we didn’t create for things like the\nbanned players list, that’s all we have to do to run the server!\nLaunch Minecraft and select Multiplayer:\n<a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611476/Screenshot-2014-12-27-00.41.05_xnigfr.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611476/Screenshot-2014-12-27-00.41.05_xnigfr.png\" alt=\"Minecraft Multiplayer\"></a></p>\n<p>Select “Add Server”\n<a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611474/Screenshot-2014-12-27-00.43.07_mje3vg.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611474/Screenshot-2014-12-27-00.43.07_mje3vg.png\" alt=\"Minecraft Add Server\"></a></p>\n<h2 id=\"get-the-url\">Get the URL</h2>\n<p>To get the server address, run <code>machine-docker url</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; machine-docker url\ntcp://nnn.nnn.nn.nn:2376\n</code></pre>\n<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611474/Screenshot-2014-12-27-00.46.13_dna5kf.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611474/Screenshot-2014-12-27-00.46.13_dna5kf.png\" alt=\"Mining and Crafting!\"></a></p>\n<p>After clicking <code>done</code>, we should see our server:</p>\n<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611473/Screenshot-2014-12-27-00.48.40_oxnmuv.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611473/Screenshot-2014-12-27-00.48.40_oxnmuv.png\" alt=\"Available Server!\"></a></p>\n<p>After clicking play the server, we get a nice new world!\n<a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611472/Screenshot-2014-12-27-00.50.45_xcr7h9.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611472/Screenshot-2014-12-27-00.50.45_xcr7h9.png\" alt=\"A New World!\"></a></p>\n<h2 id=\"whats-next\">What’s next?</h2>\n<h3 id=\"keeping-the-data-around\">Keeping the data around</h3>\n<p>Spawning servers is cool, but how do we keep the data around after the\ncontainer is killed?</p>\n<p>Let’s take a look inside a running Minecraft container.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; machine-docker-1.3.1-dev-identity-auth ps\nCONTAINER ID        IMAGE                          COMMAND              CREATED              STATUS              PORTS                      NAMES\n94cf3f854fd8        itzg/minecraft-server:latest   &quot;/start-minecraft&quot;   About a minute ago   Up About a minute   0.0.0.0:25565-&gt;25565/tcp   sad_pare\n&gt; machine-docker-1.3.1-dev-identity-auth exec -it 94c bash\n&gt;&gt; minecraft@94cf3f854fd8:/data$ ls\nbanned-ips.json  banned-players.json  eula.txt  logs  minecraft_server.1.8.1.jar  ops.json  server.properties  usercache.json  whitelist.json  world\n</code></pre>\n<p><code>kill</code> the old server (we ran it using <code>-it</code> so <code>Control-C</code> should\nkill it. If you chose to run it with <code>-d</code>, just use\n<code>machine-docker-1.3.1-dev-identity-auth ps</code> and\n<code>machine-docker-1.3.1-dev-identity-auth kill $container_id</code></p>\n<p>After killing the server, we will get kicked from the game:\n<a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611471/Screenshot-2014-12-27-00.55.45_hsjzmu.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611471/Screenshot-2014-12-27-00.55.45_hsjzmu.png\" alt=\"Screenshot 2014-12-27 00.55.45\"></a></p>\n<p>We can see that there were quite a few files in the <code>/data</code>\ndirectory. We’re going to mount a volume there using <code>/opt/craft</code> on\nthe host.</p>\n<p>Notice that we’ve also set the Message of the Day (MOTD).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>machine-docker-1.3.1-dev-identity-auth run -dp 25565:25565 -e EULA=true -e 'MOTD=Crafty Crafting!' -v /opt/craft:/data itzg/minecraft-server\n</code></pre>\n<p>Let’s ssh in to the Digital Ocean host and see if we have any files:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; machine-docker ssh\nroot@docker:~# ls /opt/craft/\nbanned-ips.json  banned-players.json  eula.txt  logs  minecraft_server.1.8.1.jar  ops.json  server.properties  usercache.json  whitelist.json  world\n</code></pre>\n<p>Voila! We have a bunch of files. Now we reconnect to the server (using\nthe Minecraft app) and spend some time doing something (say, chopping\ndown a tree). After that, kill the server as before. The files will\nstay on the Digital Ocean machine, so we can just restart the server\nusing the same volume mount:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>machine-docker-1.3.1-dev-identity-auth run -dp 25565:25565 -e EULA=true -e 'MOTD=Crafty Crafting!' -v /opt/craft:/data itzg/minecraft-server\n</code></pre>\n<p>And look at that, we’ve still cutting down our tree! The server was\nsaved!\n<a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611468/Screenshot-2014-12-27-01.21.57_ldyqeq.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611468/Screenshot-2014-12-27-01.21.57_ldyqeq.png\" alt=\"Chopping Wood\"></a></p>\n<h3 id=\"a-new-seed\">A new Seed:</h3>\n<p>Now we’ll re-run our server with a level seed. It should be added to <code>/opt/craft/server.properties</code> and we can do that through ssh and vi:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; machine-docker ssh biscarch/minecraft\nroot@docker:~# vi /opt/craft/server.properties\n</code></pre>\n<p>server.properties looks something like this (we’ve just changed the <code>level-seed</code>)</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>root@docker:~# cat /opt/craft/server.properties\n#Minecraft server properties\n#Sat Dec 27 10:00:14 UTC 2014\nspawn-protection=16\nmax-tick-time=60000\ngenerator-settings=\nforce-gamemode=false\nallow-nether=true\ngamemode=0\nenable-query=false\nplayer-idle-timeout=0\ndifficulty=1\nspawn-monsters=true\nop-permission-level=4\nresource-pack-hash=\nannounce-player-achievements=true\npvp=true\nsnooper-enabled=true\nlevel-type=DEFAULT\nhardcore=false\nenable-command-block=false\nmax-players=20\nnetwork-compression-threshold=256\nmax-world-size=29999984\nserver-port=25565\ntexture-pack=\nserver-ip=\nspawn-npcs=true\nallow-flight=false\nlevel-name=world\nview-distance=10\nresource-pack=\nspawn-animals=true\nwhite-list=false\ngenerate-structures=true\nonline-mode=true\nmax-build-height=256\nlevel-seed=1785852800490497919\nuse-native-transport=true\nenable-rcon=false\nmotd=Crafty Crafting!\n</code></pre>\n<p>Now we should be able to blow away <code>/opt/craft/world</code> (if it exists in\nthe container) and our world will get rebuilt:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>rm -rf /opt/craft/world\n</code></pre>\n<p>run the server with the volume attached:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>machine-docker-1.3.1-dev-identity-auth run -dp 25565:25565 -e EULA=true -e 'MOTD=Crafty Crafting!' -v /opt/craft:/data itzg/minecraft-server\n</code></pre>\n<p>After starting the server with the new seed, just play the server as\nbefore (it should still be listed).\n<a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611470/Screenshot-2014-12-27-01.01.20_moh5jl.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611470/Screenshot-2014-12-27-01.01.20_moh5jl.png\" alt=\"Screenshot 2014-12-27 01.01.20\"></a>\nTurn around and you should see:\n<a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611466/Screenshot-2014-12-27-02.00.51_disq4c.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611466/Screenshot-2014-12-27-02.00.51_disq4c.png\" alt=\"Screenshot 2014-12-27 02.00.51\"></a></p>\n<h1 id=\"fin\">Fin</h1>\n<p>We can use docker machine to ssh into the server and edit\n<code>/opt/craft/server.properties</code>, which holds <a href=\"http://minecraft.gamepedia.com/Server.properties\">a bunch of\ndata</a> we may want to edit.\nThen just restart the container 😃</p>\n<p>Happy Crafting!</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.7.node.attributes":{"slug":"deploying-a-minecraft-server-with-docker-machine","__typename":"BlogPostAttributes","title":"Deploying a Minecraft Server with Docker Machine","url":"/2014/12/27/deploying-a-minecraft-server-with-docker-machine/","excerpt":"The\nprevious post\nexplains how to get up and running with Docker machine. This one will\nbe a quick tutorial on setting up a Minecraft…","updatedAt":"Dec 27th, 2014","timeToRead":5,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.7":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.7.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.8.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.8.node.attributes","generated":true},"body":"<p>In this post, I will record the process through which I attempt to use\nDocker Machine to deploy a simple Haskell application on Digital\nOcean.</p>\n<h2 id=\"zero-to-docker\">Zero to Docker</h2>\n<p>To get an OSX docker machine running, I had to download\n<a href=\"https://github.com/docker/machine#try-it-out\">two binaries</a>:\n<code>machine</code> and a version of docker with Identity Authentication. I will\nrefer to these as <code>machine-docker</code> and\n<code>machine-docker-1.3.1-dev-identity-auth</code>\nrespectively. <code>machine-docker</code> is a new binary while\n<code>machine-docker-1.3.1-dev-identity-auth</code> is the usual <code>docker</code> binary\nwith some additional commits.</p>\n<ol>\n<li>Create an OSX machine using virtualbox. Name it <code>test-machine</code>:</li>\n</ol>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; machine-docker create <span class=\"hljs-_\">-d</span> virtualbox <span class=\"highlight__hljs-built_in___3uuyR\">test</span>-machine\nINFO[0000] Downloading boot2docker...\nINFO[0021] Creating SSH key...\nINFO[0021] Creating VirtualBox VM...\nINFO[0029] Starting VirtualBox VM...\nINFO[0029] Waiting <span class=\"highlight__hljs-keyword___som98\">for</span> VM to start...\nINFO[0061] <span class=\"highlight__hljs-string___1SffY\">\"test-machine\"</span> has been created and is now the active\n           machine. To point Docker at this machine, run: <span class=\"highlight__hljs-built_in___3uuyR\">export</span>\n           DOCKER_HOST=$(machine url) DOCKER_AUTH=identity\n</code></pre>\n<ol start=\"2\">\n<li>Create a function to export the desired env vars. I put this in my <code>~/.zshrc</code></li>\n</ol>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>to-<span class=\"hljs-function\"><span class=\"highlight__hljs-title___1fl8Q\">machine</span></span>(){\n    <span class=\"highlight__hljs-built_in___3uuyR\">export</span> DOCKER_HOST=$(machine-docker url) DOCKER_AUTH=identity\n}\n</code></pre>\n<ol start=\"3\">\n<li>Test with <code>docker ps</code> in a new shell:</li>\n</ol>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; to-machine\n&gt; machine-docker-1.3.1-dev-identity-auth ps\nCONTAINER ID  IMAGE  COMMAND  CREATED  STATUS  PORTS  NAMES\n</code></pre>\n<h2 id=\"docker-to-digital-ocean\">Docker to Digital Ocean</h2>\n<ol>\n<li>Create a <a href=\"https://cloud.digitalocean.com/settings/applications\">Personal Access Token</a></li>\n</ol>\n<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611477/Screenshot-2014-12-20-14.58.25_hvbvt6.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/h_181,w_660/v1428611477/Screenshot-2014-12-20-14.58.25_hvbvt6.png\" alt=\"digital ocean application settings\"></a></p>\n<ol start=\"2\">\n<li>Name and Generate the token</li>\n</ol>\n<p><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611476/Screenshot-2014-12-20-14.58.47_kcvvzv.png\" alt=\"Screenshot 2014-12-20 14.58.47\"></p>\n<ol start=\"3\">\n<li>After getting a token, I set it to <code>DO_TOKEN</code>:</li>\n</ol>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">export</span> DO_TOKEN=mytokenhere235bhn2b23j5k\n</code></pre>\n<ol start=\"4\">\n<li>Create a machine on Digital Ocean</li>\n</ol>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; machine-docker create <span class=\"hljs-_\">-d</span> digitalocean --digitalocean-access-token=<span class=\"highlight__hljs-variable___1-KRy\">$DO_TOKEN</span> biscarch/bot\nINFO[0000] Creating SSH key...\nINFO[0000] Creating Digital Ocean droplet...\nINFO[0002] Waiting <span class=\"highlight__hljs-keyword___som98\">for</span> SSH...\nINFO[0103] <span class=\"highlight__hljs-string___1SffY\">\"biscarch/bot\"</span> has been created and is now the active\n           machine. To point Docker at this machine, run: <span class=\"highlight__hljs-built_in___3uuyR\">export</span>\n           DOCKER_HOST=$(machine url) DOCKER_AUTH=identity\n</code></pre>\n<ol start=\"5\">\n<li>Point Docker at the Digital Ocean Machine <code>biscarch/bot</code></li>\n</ol>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; to-machine\n</code></pre>\n<ol start=\"6\">\n<li><code>docker ps</code> on Digital Ocean</li>\n</ol>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; machine-docker-1.3.1-dev-identity-auth ps\nThe authenticity of host <span class=\"highlight__hljs-string___1SffY\">\"<span class=\"highlight__hljs-variable___1-KRy\">$ip</span>:<span class=\"highlight__hljs-variable___1-KRy\">$port</span>\"</span> can<span class=\"highlight__hljs-string___1SffY\">'t be established.\nRemote key ID XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX\nAre you sure you want to continue connecting (yes/no)? yes\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n</span></code></pre>\n<h2 id=\"docker-run-on-digital-ocean\"><code>docker run</code> on Digital Ocean</h2>\n<ol>\n<li>We can run an image using the\n<a href=\"https://github.com/snapforbeginners/barebones\">barebones image</a>\nfrom <a href=\"http://snapforbeginners.com/\">Snap for Beginners</a>\ninteractively with a pseduo-tty:</li>\n</ol>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; machine-docker-1.3.1-dev-identity-auth run -itp 8000:8000 snapforbeginners/barebones\nno port specified, defaulting to port 8000\nListening on http://0.0.0.0:8000/\n</code></pre>\n<ol start=\"2\">\n<li>We can curl our Digital Ocean machine’s IP to see if the container\nis running:</li>\n</ol>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; curl <span class=\"highlight__hljs-variable___1-KRy\">$DO_IP</span>:8000\nhello world\n</code></pre>\n<h2 id=\"fin\">Fin</h2>\n<p>That’s it. We have a Docker Engine and a container running on Digital\nOcean. We can also run multiple containers as Daemons and all of the\nnormal goodness of the Docker CLI.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.8.node.attributes":{"slug":"docker-machine","__typename":"BlogPostAttributes","title":"Docker Machine","url":"/2014/12/21/docker-machine/","excerpt":"In this post, I will record the process through which I attempt to use\nDocker Machine to deploy a simple Haskell application on…","updatedAt":"Dec 21st, 2014","timeToRead":2,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.8":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.8.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.9.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.9.node.attributes","generated":true},"body":"<p>Prerequisites: an <a href=\"https://docs.docker.com/installation/#installation\">install of Docker</a> (If you don’t want an install, Digital Ocean also has a Docker Droplet).</p>\n<p>The Docker-Haskell “Official Images” container is available for download. You can find the source over on <a href=\"https://github.com/darinmorrison/docker-haskell\">GitHub</a> and the versions currently being built in the <a href=\"https://github.com/docker-library/official-images/blob/master/library/haskell\">official-images</a> repo.</p>\n<p>To start a ghci we can pull and run the image tagged as <code>7.8</code>, which contains alex, happy, cabal and ghc-7.8.3:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker pull haskell:7.8\ndocker run -it haskell:7.8\n</code></pre>\n<p>quitting the repl (<code>:q</code>) will also kill the container.</p>\n<h1 id=\"building-a-dockerfile\">Building a Dockerfile</h1>\n<p>We can base a new project’s Dockerfile off of the <code>haskell:7.8</code> base. As it happens, there is an example Snap project in the <a href=\"https://github.com/darinmorrison/docker-haskell\">docker-haskell</a> project, in the <code>/examples/7.8.3/</code> directory.</p>\n<p>If we clone the repo and cd into the example project’s folder we can build the Dockerfile:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>git clone git@github.com:darinmorrison/docker-haskell.git\ncd docker-haskell/examples/7.8.3/snap\ndocker build -t my-new-project .\n</code></pre>\n<p>and run it:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker run -itp 8000:8000 my-new-project\n</code></pre>\n<p>We can now see a Snap application running on port 8000 of either <code>localhost</code> or our <code>boot2docker ip</code>.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.9.node.attributes":{"slug":"using-the-docker-haskell-official-image","__typename":"BlogPostAttributes","title":"Using the Docker-Haskell Official Image","url":"/2014/11/23/using-the-docker-haskell-official-image/","excerpt":"Prerequisites: an install of Docker (If you don’t want an install, Digital Ocean also has a Docker Droplet).","updatedAt":"Nov 23rd, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.9":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.9.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.10.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.10.node.attributes","generated":true},"body":"<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611480/docker-emacs_rscg2o.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611480/docker-emacs_rscg2o.png\" alt=\"docker-emacs\"></a></p>\n<p>Assuming a docker installation (either boot2docker or just docker) and a version\nof <code>1.3</code> or higher, we can use Volumes to enable a portable emacs installation.</p>\n<h1 id=\"using-my-image\">Using My Image</h1>\n<p>To use mine, pull the image:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker pull biscarch/emacs\n</code></pre>\n<p>set up a function to mount the <code>pwd</code> at <code>/files</code> inside the container and open\nan emacs at <code>/files</code>:</p>\n<p>NOTE: This is what I have in my <code>.zshrc</code>; YMMV.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>de(){\n    docker run -itv `pwd`:/files biscarch/emacs emacs /files\n}\n</code></pre>\n<p>Now, in the root of a project run:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>cd my_project_root\nde\n</code></pre>\n<p>and you’ll be in an emacs. All edits in <code>/files</code> will persist to the host:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code> 1  /files:\n 2  total used in directory 52 available 21162304\n 3  drwxr-xr-x  1 1000 staff  680 Feb  8  2014 .\n 4  drwxr-xr-x 44 root root  4096 Oct 18 03:44 ..\n 8  -rw-r--r--  1 1000 staff  101 Aug 16  2013 .ghci\n 9  drwxr-xr-x  1 1000 staff  442 Oct 18  2014 .git\n10  -rw-r--r--  1 1000 staff   23 Nov  2  2013 .gitignore\n13  -rw-r--r--  1 1000 staff  125 Nov  2  2013 README.md\n14  drwxr-xr-x  1 1000 staff   68 Sep 15  2013 custom-deps\n15  drwxr-xr-x  1 1000 staff  170 Feb  8  2014 dist\n16  drwxr-xr-x  1 1000 staff  136 Feb  8  2014 log\n17  -rw-r--r--  1 1000 staff   96 Aug 31  2013 site_key.txt\n18  drwxr-xr-x  1 1000 staff  136 Feb  8  2014 snaplets\n19  drwxr-xr-x  1 1000 staff  646 Feb  8  2014 src\n20  drwxr-xr-x  1 1000 staff  204 Feb  8  2014 static\n21  -rw-r--r--  1 1000 staff 2542 Dec 25  2013 tracker.cabal\n22  -rw-r--r--  1 1000 staff  602 Dec 30  2013 users.json\n</code></pre>\n<h3 id=\"build-yours\">Build Yours</h3>\n<p>To build your own <code>docker-emacs</code>, check out my <a href=\"https://registry.hub.docker.com/u/biscarch/emacs/\">Automated\nBuild</a> and the <a href=\"https://github.com/ChristopherBiscardi/docker-emacs\">GitHub\nRepo</a> for <code>biscarch/emacs</code></p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.10.node.attributes":{"slug":"emacs-in-docker","__typename":"BlogPostAttributes","title":"Emacs in Docker","url":"/2014/10/17/emacs-in-docker/","excerpt":"","updatedAt":"Oct 17th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.10":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.10.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.11.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.11.node.attributes","generated":true},"body":"<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611482/snap_sks60m.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611482/snap_sks60m.png\" alt=\"snap-framework\"></a></p>\n<p><a href=\"http://www.christopherbiscardi.com/2014/10/05/working-with-snap-1-0/\">Previous Post – Working With Snap 1.0</a></p>\n<p>In our previous post we built out a scaffold project with Snap 1.0. In this post\nwe’ll go over building a simple Dockerfile to deploy the project.</p>\n<p>Make sure you’ve <a href=\"https://docs.docker.com/installation/#installation\">installed docker</a></p>\n<h2 id=\"building-the-haskell-base\">Building the Haskell Base</h2>\n<p>There is an effort to make a <a href=\"https://github.com/darinmorrison/docker-haskell/tree/docker-library\">docker official haskell\nimage</a> so\nwe’ll use that. Once it’s merged into <code>docker-library</code>, we can simply skip\nbuilding the <code>docker-haskell</code> from scratch.</p>\n<p>Clone docker-haskell and switch to the docker-library branch. (It doesn’t matter\nwhere on the computer we do this)</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>git clone git@github.com:darinmorrison/docker-haskell.git\ncd docker-haskell\ngit checkout docker-library\n</code></pre>\n<p>Once in the appropriate directory, we can build the image with <a href=\"https://docs.docker.com/reference/commandline/cli/#build\"><code>docker build</code></a>. <code>-t</code> is short\nfor <code>--tag</code>, which lets us tag an image. We’ll use <code>haskell</code> for the base name\nand tag it as <code>7.8</code>. Finally, the <code>.</code> tells docker where to find the dockerfile\nwe’re building.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>cd 7.8\ndocker build -t haskell:7.8 .\n</code></pre>\n<p>We can test that it worked by using <a href=\"https://docs.docker.com/reference/commandline/cli/#run\"><code>docker run</code></a> to spawn <code>ghci</code> as\nan interactive pseudo-tty.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker run -i -t haskell:7.8 ghci\n</code></pre>\n<p>Use <code>:q</code> to quit <code>ghci</code> as usual.</p>\n<h1 id=\"building-our-project\">Building our Project</h1>\n<p>We’ll base our project on the docker image we just built.</p>\n<blockquote>\n<p>NOTE: We can push this base image <a href=\"https://docs.docker.com/userguide/dockerrepos/#pushing-a-repository-to-docker-hub\">to the docker\nhub</a>\nbut interestingly enough, we don’t have to (if we’re using “normal” repos;\nAutomated Builds are a different story). We can push the final image without\npushing the base image.</p>\n</blockquote>\n<h3 id=\"dockerfile\">Dockerfile</h3>\n<p>Our <code>Dockerfile</code> goes in the root of the <code>auth-server/</code> folder. If you’ve built\na haskell project before and are familiar with cabal sandboxes, this will be\nsimilar:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code># https://github.com/darinmorrison/docker-haskell/tree/docker-library\nFROM haskell:7.8\n\nRUN cabal update\n\n# Add Cabal File and deps/ folder\nADD ./auth-server.cabal /opt/auth-server/auth-server.cabal\nADD ./deps /opt/auth-server/deps\n\n# Create Sandbox and Add Source Deps\nRUN cd /opt/auth-server &amp;&amp;\n        cabal sandbox init &amp;&amp;\n        cabal sandbox add-source deps/io-streams-haproxy &amp;&amp;\n        cabal sandbox add-source deps/snap &amp;&amp;\n        cabal sandbox add-source deps/snap-core &amp;&amp;\n        cabal sandbox add-source deps/snap-server &amp;&amp;\n        cabal sandbox add-source deps/snap-loader-static &amp;&amp;\n        cabal sandbox add-source deps/heist\n\nRUN cd /opt/auth-server &amp;&amp; cabal install --only-dependencies\n\n# Explicitly add relevant folders\nADD ./src /opt/auth-server/src\nADD ./snaplets /opt/auth-server/snaplets\nADD ./static /opt/auth-server/static\n\n# Init logging directories\nRUN mkdir /opt/auth-server/log\n\n# Build the Project\nRUN cd /opt/auth-server &amp;&amp; cabal build\n\n# The directory CMD works from\nWORKDIR /opt/auth-server\nCMD [&quot;./dist/build/auth-server/auth-server&quot;]\n</code></pre>\n<p>With the above dockerfile in the root of <code>auth-server/</code> we can build with:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>cd auth-server\ndocker build -t auth-server .\n</code></pre>\n<blockquote>\n<p>NOTE: <code>-t auth-server</code> could be any name, such as <code>-t myawesomething</code> but if\nyou plan to push it to the docker hub do <code>username/image-name:tag-name</code></p>\n</blockquote>\n<p>After building, run it with:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker run -i -t -p 8000:8000 auth-server\n</code></pre>\n<p>and we should have a running instance of our application on port <code>8000</code> (or at\n<code>boot2docker ip</code> on port <code>8000</code>).</p>\n<h3 id=\"to-the-hub\">To The Hub!</h3>\n<p>We can push the image we just built to a registry (such as the docker hub) by\nbuilding it with our username (so it gets filed under our user on the hub):</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker build -t biscarch/auth-server\ndocker push biscarch/auth-server\n</code></pre>\n<p>and on some other computer (such as AWS, a Digital Ocean instance or another dev\ncomputer) pull and run the image:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker pull biscarch/auth-server\ndocker run -d -p 8000:8000 biscarch/auth-server\n</code></pre>\n<p>after running, we can check that it’s up with <code>docker ps</code>:</p>\n<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611480/Screenshot-2014-10-14-20.26.19_ms5prn.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611480/Screenshot-2014-10-14-20.26.19_ms5prn.png\" alt=\"Screenshot 2014-10-14 20.26.19\"></a></p>\n<h1 id=\"fin\">FIN</h1>\n<p>The completed docker image is on the hub as\n<a href=\"https://registry.hub.docker.com/u/biscarch/auth-server/\">biscarch/auth-server:0.0.0.2</a>,\nso you can run a <code>pull</code>, then a <code>run</code> anywhere you like:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker pull biscarch/auth-server:0.0.0.2\ndocker run -i -t -p 8000:8000 biscarch/auth-server:0.0.0.2\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.11.node.attributes":{"slug":"deploying-snap-with-docker","__typename":"BlogPostAttributes","title":"Deploying Snap with Docker","url":"/2014/10/15/deploying-snap-with-docker/","excerpt":"","updatedAt":"Oct 15th, 2014","timeToRead":2,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.11":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.11.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.12.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.12.node.attributes","generated":true},"body":"<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611482/snap_sks60m.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611482/snap_sks60m.png\" alt=\"snap-framework\"></a></p>\n<p>Snap 1.0 isn’t on Hackage yet, but here’s how you can play with it now.</p>\n<p>NOTE: This was written using ghc-7.8.3. The repo is <a href=\"https://github.com/ChristopherBiscardi/snap-micro-services\">on GitHub</a></p>\n<p>First we’ll make a new directory for the project and one for the dependencies, then clone the dependencies for 1.0 that aren’t on Hackage:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;bash&quot; style=&quot;overflow-x:auto&quot;&gt;mkdir auth_server\ncd auth_server\nmkdir deps\ngit clone git@github.com:snapframework/io-streams-haproxy.git deps/io-streams-haproxy\ngit clone git@github.com:snapframework/snap.git deps/snap\ngit clone git@github.com:snapframework/snap-core.git deps/snap-core\ngit clone git@github.com:snapframework/snap-server.git deps/snap-server\ngit clone git@github.com:snapframework/snap-loader-static.git deps/snap-loader-static\ngit clone git@github.com:snapframework/heist.git deps/heist\ngit clone git@github.com:snapframework/snap-templates.git deps/snap-templates\n</code></pre>\n<p>We should have a file structure that looks like this:</p>\n<ul>\n<li>auth_server/ - deps/ - io-streams-haproxy/</li>\n<li>snap/</li>\n<li>snap-core/</li>\n<li>snap-server/</li>\n<li>snap-loader-static/</li>\n<li>heist/</li>\n</ul>\n<p>We can now get a scaffolded app using <code>snap-templates</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;bash&quot;&gt;cd auth_server/deps/snap-templates\ncabal build\n</code></pre>\n<p>Building <code>snap-templates</code> gives us the <code>snap</code> executable that we used to use from the <code>snap</code> project. In the project root, let’s init a new scaffold:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;bash&quot;&gt;cd auth_server\n./deps/snap-templates/dist/build/snap/snap init\n</code></pre>\n<p>Which leaves us with this structure at the top level:</p>\n<ul>\n<li>auth_server/ - auth-server.cabal</li>\n<li>deps/</li>\n<li>snaplets/</li>\n<li>src/</li>\n<li>static/</li>\n</ul>\n<p>If you haven’t created a new sandbox for this project, do that now and install the dependencies for the scaffold into the sandbox.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;bash&quot;&gt;cd auth_server\ncabal sandbox init\ncabal install --only-dependencies\n</code></pre>\n<p>We can’t build the app yet, since the scaffold is missing two things. We need to add <code>map-syntax</code> as a dependency to <code>auth-server.cabal</code> and we need to replace <code>noSplices</code> with <code>mempty</code> in <code>Site.hs</code> since <code>noSplices</code> has been deprecated.</p>\n<p>First, in <code>auth-server.cabal</code>, under <code>Build-depends</code> add <code>map-syntax</code>:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>    xmlhtml                   &gt;= 0.1,\n    map-syntax                &gt;= 0.1\n</code></pre>\n<p>Next, we need to add two imports to <code>src/Site.hs</code>:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;haskell&quot;&gt;import           Data.Map.Syntax\nimport           Data.Monoid        (mempty)\n</code></pre>\n<p>as well as replace <code>noSplices</code> with <code>mempty</code>:</p>\n<p>Before:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>errs = maybe noSplices splice authError\n</code></pre>\n<p>After:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code> errs = maybe mempty splice authError\n</code></pre>\n<p>We can now build and run the project:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>cd auth_server\ncabal build\n./dist/build/auth-server/auth-server\n</code></pre>\n<p>We now have a working Snap 1.0 app to play with. In a future blog post, we’ll explore the creation of a Users service.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.12.node.attributes":{"slug":"working-with-snap-1-0","__typename":"BlogPostAttributes","title":"Working with Snap 1.0","url":"/2014/10/5/working-with-snap-1-0/","excerpt":"","updatedAt":"Oct 5th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.12":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.12.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.13.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.13.node.attributes","generated":true},"body":"<p>I wrote a simple Haxl DataSource and I thought it would be good to share. If you\ndon’t know what Haxl is you can find out more\n<a href=\"https://github.com/facebook/Haxl\">here</a>.</p>\n<p>The gist with the relevant .cabal and DataSource is\n<a href=\"https://gist.github.com/ChristopherBiscardi/45c765eb292d96ab4549\">here</a></p>\n<h2 id=\"table\">Table</h2>\n<p>We will need a people table to store our people:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">TABLE</span> people (\n    _id bigserial primary <span class=\"highlight__hljs-keyword___som98\">key</span>,\n    first_name <span class=\"highlight__hljs-built_in___3uuyR\">text</span> <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n    last_name <span class=\"highlight__hljs-built_in___3uuyR\">text</span> <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n    age <span class=\"highlight__hljs-built_in___3uuyR\">int</span> <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>\n);\n</code></pre>\n<p>And some data to query:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">INSERT</span> <span class=\"highlight__hljs-keyword___som98\">INTO</span> people (<span class=\"highlight__hljs-string___1SffY\">\"first_name\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"last_name\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"age\"</span>) <span class=\"highlight__hljs-keyword___som98\">VALUES</span> (<span class=\"highlight__hljs-string___1SffY\">'Bob'</span>,<span class=\"highlight__hljs-string___1SffY\">'Seger'</span>,<span class=\"highlight__hljs-number___2gmaH\">69</span>);\n<span class=\"highlight__hljs-keyword___som98\">INSERT</span> <span class=\"highlight__hljs-keyword___som98\">INTO</span> people (<span class=\"highlight__hljs-string___1SffY\">\"first_name\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"last_name\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"age\"</span>) <span class=\"highlight__hljs-keyword___som98\">VALUES</span> (<span class=\"highlight__hljs-string___1SffY\">'Billy'</span>,<span class=\"highlight__hljs-string___1SffY\">'Idol'</span>,<span class=\"highlight__hljs-number___2gmaH\">58</span>);\n</code></pre>\n<p>which gives us a table that looks like:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>peopledb=# select * from people;\n _id | first_name | last_name | age\n-----+------------+-----------+-----\n   1 | Bob        | Seger     |  69\n   2 | Billy      | Idol      |  58\n(2 rows)\n</code></pre>\n<p>We can then head into ghci and check out the Haxl DataSource.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">ghci</span> <span class=\"highlight__hljs-type___11WfV\">DataSource</span>.hs\n<span class=\"highlight__hljs-title___1fl8Q\">let</span> cinfo = defaultConnectInfo {\n    connectUser = <span class=\"highlight__hljs-string___1SffY\">\"pgsuper\"</span>\n  , connectPassword = <span class=\"highlight__hljs-string___1SffY\">\"password\"</span>\n  , connectDatabase = <span class=\"highlight__hljs-string___1SffY\">\"peopledb\"</span>\n  }\n<span class=\"highlight__hljs-title___1fl8Q\">pgstate</span>\n</code></pre>\n<p>If we check out the value of <code>r</code> we see a <code>Just Person</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">Just</span> (<span class=\"highlight__hljs-type___11WfV\">Person</span> {_id = <span class=\"highlight__hljs-type___11WfV\">PersonId</span> <span class=\"highlight__hljs-number___2gmaH\">1</span>, first_name = <span class=\"highlight__hljs-string___1SffY\">\"Bob\"</span>, last_name = <span class=\"highlight__hljs-string___1SffY\">\"Seger\"</span>, age = <span class=\"highlight__hljs-number___2gmaH\">69</span>})\n</code></pre>\n<h2 id=\"the-code\">The Code</h2>\n<p>First, we need a datatype to be querying. Of note is that we’ve <code>newtype</code>'d\n<code>PersonId</code>, so we’ll use <code>GeneralizedNewtypeDeriving</code> to get the <code>FromField</code>\ninstance from <code>Int</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">newtype</span> <span class=\"highlight__hljs-type___11WfV\">PersonId</span> = <span class=\"highlight__hljs-type___11WfV\">PersonId</span> <span class=\"highlight__hljs-type___11WfV\">Int</span> <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>, <span class=\"highlight__hljs-type___11WfV\">Eq</span>, <span class=\"highlight__hljs-type___11WfV\">FromField</span>)</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">Person</span> = <span class=\"highlight__hljs-type___11WfV\">Person</span> { <span class=\"highlight__hljs-title___1fl8Q\">_id</span>        :: <span class=\"highlight__hljs-type___11WfV\">PersonId</span>\n                     , <span class=\"highlight__hljs-title___1fl8Q\">first_name</span> :: <span class=\"highlight__hljs-type___11WfV\">Text</span>\n                     , <span class=\"highlight__hljs-title___1fl8Q\">last_name</span>  :: <span class=\"highlight__hljs-type___11WfV\">Text</span>\n                     , <span class=\"highlight__hljs-title___1fl8Q\">age</span>        :: <span class=\"highlight__hljs-type___11WfV\">Int</span> } <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>, <span class=\"highlight__hljs-type___11WfV\">Typeable</span>)</span>\n</code></pre>\n<p>Next we’ll define our requests as a GADT. In this case we only have a single\nrequest type: “GetPerson”, which takes a <code>PersonId</code> and looks up that user.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span> a where</span>\n  <span class=\"highlight__hljs-type___11WfV\">GetPerson</span> :: <span class=\"highlight__hljs-type___11WfV\">PersonId</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">PGReq</span> (<span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Person</span>)\n  <span class=\"highlight__hljs-keyword___som98\">deriving</span> <span class=\"highlight__hljs-type___11WfV\">Typeable</span>\n</code></pre>\n<p>Now we need some simple boilerplate. The Hashable instance defines the hash of our request types for the cache. In this case a <code>GetPerson</code> request is as a tuple of <code>(0,PersonId)</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">deriving</span> <span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Eq</span> (<span class=\"highlight__hljs-type___11WfV\">PGReq</span> a)\n<span class=\"highlight__hljs-title___1fl8Q\">deriving</span> <span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Show</span> (<span class=\"highlight__hljs-type___11WfV\">PGReq</span> a)\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Show1</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span> show1 = show\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Hashable</span> (<span class=\"highlight__hljs-type___11WfV\">PGReq</span> <span class=\"highlight__hljs-title___1fl8Q\">a</span>) <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  hashWithSalt s (<span class=\"highlight__hljs-type___11WfV\">GetPerson</span> (<span class=\"highlight__hljs-type___11WfV\">PersonId</span> pid)) = hashWithSalt s (<span class=\"highlight__hljs-number___2gmaH\">0</span>::<span class=\"highlight__hljs-type___11WfV\">Int</span>, pid)\n</code></pre>\n<p>Following the boilerplate we’ll create a <code>StateKey</code> instance. Since this is a simple implementation, we’ll put the connection information in our state so we can create connections later. We’ll also define a function to initialize said state.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">StateKey</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">State</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span> =</span>\n    <span class=\"highlight__hljs-type___11WfV\">PGState</span>\n      { connInfo :: <span class=\"highlight__hljs-type___11WfV\">ConnectInfo</span> }\n\n<span class=\"highlight__hljs-title___1fl8Q\">initHaxlState</span>\n  :: <span class=\"highlight__hljs-type___11WfV\">ConnectInfo</span>\n  -&gt; <span class=\"highlight__hljs-type___11WfV\">IO</span> (<span class=\"highlight__hljs-type___11WfV\">State</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">initHaxlState</span> cInfo = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  return <span class=\"highlight__hljs-type___11WfV\">PGState</span>\n    { connInfo = cInfo }\n</code></pre>\n<p>Haxl needs us to name our DataSource and tell it which function to use for\nfetching data.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">DataSourceName</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  dataSourceName _ = <span class=\"highlight__hljs-string___1SffY\">\"Postgres\"</span>\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">DataSource</span> u <span class=\"highlight__hljs-type___11WfV\">PGReq</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  fetch = pgFetch\n</code></pre>\n<p>Then we can define our asynchronous fetch functions which will process our\n<code>BlockedFetch</code>es. We put a failure on exceptions and pass the data through on a\nsuccess.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">pgFetch</span>\n :: <span class=\"highlight__hljs-type___11WfV\">State</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span>\n -&gt; <span class=\"highlight__hljs-type___11WfV\">Flags</span>\n -&gt; u\n -&gt; [<span class=\"highlight__hljs-type___11WfV\">BlockedFetch</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span>]\n -&gt; <span class=\"highlight__hljs-type___11WfV\">PerformFetch</span>\n<span class=\"highlight__hljs-title___1fl8Q\">pgFetch</span> <span class=\"highlight__hljs-type___11WfV\">PGState</span> {..} _flags _user bfs =\n  <span class=\"highlight__hljs-type___11WfV\">AsyncFetch</span> $ \\inner -&gt; <span class=\"highlight__hljs-keyword___som98\">do</span>\n    asyncs  <span class=\"highlight__hljs-type___11WfV\">BlockedFetch</span> <span class=\"highlight__hljs-type___11WfV\">PGReq</span>\n  -&gt; <span class=\"highlight__hljs-type___11WfV\">IO</span> (<span class=\"highlight__hljs-type___11WfV\">Async</span> ())\n<span class=\"highlight__hljs-title___1fl8Q\">fetchAsync</span> creds (<span class=\"highlight__hljs-type___11WfV\">BlockedFetch</span> req rvar) =\n  async $ <span class=\"highlight__hljs-keyword___som98\">do</span>\n    bracket (connect creds) (close) $ \\conn -&gt; <span class=\"highlight__hljs-keyword___som98\">do</span>\n      e  putFailure rvar (ex :: <span class=\"highlight__hljs-type___11WfV\">SomeException</span>)\n        <span class=\"highlight__hljs-type___11WfV\">Right</span> val -&gt; putSuccess rvar val\n</code></pre>\n<p>Finally, we can define our application logic. In this case our only request type\nis <code>GetPerson</code>, so we need to get a single <code>Person</code> by <code>PersonId</code>. We could also\nwrite more <code>fetchReq</code> patterns if we had more request types.</p>\n<p><code>getPerson</code> is the function we’ll actually call to get a person by id; As seen\nin the intro to this post.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">fetchReq</span>\n  :: <span class=\"highlight__hljs-type___11WfV\">Connection</span>\n  -&gt; <span class=\"highlight__hljs-type___11WfV\">PGReq</span> a\n  -&gt; <span class=\"highlight__hljs-type___11WfV\">IO</span> a\n<span class=\"highlight__hljs-title___1fl8Q\">fetchReq</span> conn (<span class=\"highlight__hljs-type___11WfV\">GetPerson</span> (<span class=\"highlight__hljs-type___11WfV\">PersonId</span> pid)) = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  people  <span class=\"highlight__hljs-type___11WfV\">GenHaxl</span> u (<span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Person</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">getPerson</span> pid = dataFetch (<span class=\"highlight__hljs-type___11WfV\">GetPerson</span> pid)\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.13.node.attributes":{"slug":"a-foray-into-haxl-postgresql-simple","__typename":"BlogPostAttributes","title":"A Foray Into Haxl: PostgreSQL Simple","url":"/2014/7/4/a-foray-into-haxl-postgresql-simple/","excerpt":"I wrote a simple Haxl DataSource and I thought it would be good to share. If you\ndon’t know what Haxl is you can find out more\nhere.","updatedAt":"Jul 4th, 2014","timeToRead":3,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.13":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.13.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.14.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.14.node.attributes","generated":true},"body":"<p>Benchmarks available on <a href=\"https://github.com/ChristopherBiscardi/stm-containers-benchmarks\">GitHub</a> and as <a href=\"http://christopherbiscardi.github.io/stm-containers-benchmarks/\">Github pages</a>.</p>\n<p>Tests were run with ghc 7.8.2 and a 12 core Mac Pro (Trashcan).</p>\n<p>Here’s a fun screenshot of the cpu history for the tests (<a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611512/Screenshot-2014-06-29-11.42.52_woo407.png\">larger size</a>):</p>\n<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611512/Screenshot-2014-06-29-11.42.52_woo407.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/h_300,w_253/v1428611512/Screenshot-2014-06-29-11.42.52_woo407.png\" alt=\"Screenshot 2014-06-29 11.42.52\"></a></p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.14.node.attributes":{"slug":"stm-containers-benchmarks","__typename":"BlogPostAttributes","title":"STM-Containers Benchmarks","url":"/2014/6/29/stm-containers-benchmarks/","excerpt":"Benchmarks available on GitHub and as Github pages.","updatedAt":"Jun 29th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.14":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.14.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.15.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.15.node.attributes","generated":true},"body":"<p>According to <a href=\"http://www.purescript.org/\" title=\"purescript.org\">PureScript.org</a></p>\n<blockquote>\n<p>PureScript is a small strongly, statically typed programming language with\nexpressive types, written in and inspired by Haskell, and compiling to\nJavascript.</p>\n</blockquote>\n<p>It’s fairly easy to get started with the <a href=\"https://github.com/purescript-contrib/grunt-init-purescript\" title=\"grunt\ninit purescript template\">grunt-init-purescript\ntemplate</a></p>\n<h2 id=\"dependencies\">Dependencies</h2>\n<p>We will need\n<a href=\"http://gruntjs.com/\">grunt</a>,<a href=\"https://github.com/gruntjs/grunt-init\">grunt-init</a>\nand <a href=\"http://bower.io/\">bower</a> to work with this PureScript template.\n<a href=\"http://nodejs.org/\" title=\"nodejs\">Node</a> is also a dependency because of this.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>npm install -g grunt grunt-init bower\n</code></pre>\n<p>Then clone the template into a <code>.grunt-init</code> folder using git:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>mkdir ~/.grunt-init\ngit <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/purescript-contrib/grunt-init-purescript.git ~/.grunt-init/purescript\n</code></pre>\n<p>We also need the PureScript compiler, which we can grab with cabal:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>cabal install purescript\n</code></pre>\n<h2 id=\"developing\">Developing</h2>\n<p>We can now install dependencies from npm and bower. There’s a decent amount to be excited about in the output including <code>purescript-quickcheck</code>, <code>either</code> and <code>maybe</code> to name a few.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>npm install\nbower update\n</code></pre>\n<p>Then grunt when we want to build:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>grunt\n</code></pre>\n<h2 id=\"testing\">Testing</h2>\n<p>The template project is more of a library project, where the tests are what we\nwant to run if we cloned the repo. As such, our <code>Main</code> module is in\n<code>tests/Test.purs</code> and can be run using:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>node tmp/index.js\n</code></pre>\n<p>after running <code>grunt</code> to build the project.</p>\n<p>To build an executable (a node.js scraper for example) we can make a few\nchanges.</p>\n<h2 id=\"modifications\">Modifications</h2>\n<p>First, we’ll make some changes to our test file.</p>\n<h4 id=\"tests\">Tests</h4>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>mv tests/Tests.purs tests/Test/Main.purs\n</code></pre>\n<p>and change the module name from <code>Main</code> to <code>Test.Main</code>. Also change the\n<code>Starter.Kit.Example</code> import to <code>Starter.Kit.Main</code>.</p>\n<h4 id=\"js\">JS</h4>\n<p>Place two simple js files in <code>js/</code></p>\n<h6 id=\"jsindexjs\">js/index.js</h6>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>require(<span class=\"highlight__hljs-string___1SffY\">\"Starter.Kit.Main\"</span>).main();\n</code></pre>\n<h6 id=\"jstestjs\">js/test.js</h6>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>require(<span class=\"highlight__hljs-string___1SffY\">\"Test.Main\"</span>).main();\n</code></pre>\n<h4 id=\"starter-kit\">Starter Kit</h4>\n<p>Now we will make a small modification to the Starter Kit file.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>mv src/Starter/Kit/Example.purs src/Starter/Kit/Main.purs\n</code></pre>\n<p>and rename the module to <code>Starter.Kit.Main</code>.</p>\n<h4 id=\"gruntfile\">Gruntfile</h4>\n<p>Finally make some modifications to the Gruntfile and run <code>grunt</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">module</span>.exports = <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">function</span>(<span class=\"hljs-params\">grunt</span>) </span>{\n<span class=\"hljs-meta\">\n  \"use strict\"</span>;\n\n  grunt.initConfig({\n\n    libFiles: [\n      <span class=\"highlight__hljs-string___1SffY\">\"src/**/*.purs\"</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"bower_components/purescript-*/src/**/*.purs\"</span>\n    ],\n\n    clean: [<span class=\"highlight__hljs-string___1SffY\">\"tmp\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"output\"</span>],\n\n    pscMake: {\n      lib: {\n        src: [<span class=\"highlight__hljs-string___1SffY\">\"\"</span>]\n      },\n      tests: {\n        src: [<span class=\"highlight__hljs-string___1SffY\">\"tests/Test/Main.purs\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"\"</span>]\n      }\n    },\n\n    dotPsci: [<span class=\"highlight__hljs-string___1SffY\">\"\"</span>],\n\n    copy: [\n      {\n        expand: <span class=\"highlight__hljs-literal___1V6TY\">true</span>,\n        cwd: <span class=\"highlight__hljs-string___1SffY\">\"output\"</span>,\n        src: [<span class=\"highlight__hljs-string___1SffY\">\"**\"</span>],\n        dest: <span class=\"highlight__hljs-string___1SffY\">\"tmp/node_modules/\"</span>\n      }, {\n        expand: <span class=\"highlight__hljs-literal___1V6TY\">true</span>,\n        cwd: <span class=\"highlight__hljs-string___1SffY\">\"js/\"</span>,\n        src: <span class=\"highlight__hljs-string___1SffY\">'**'</span>,\n        dest: <span class=\"highlight__hljs-string___1SffY\">\"tmp/\"</span>,\n        flatten: <span class=\"highlight__hljs-literal___1V6TY\">true</span>\n      }\n    ],\n\n    execute: {\n      tests: {\n        src: <span class=\"highlight__hljs-string___1SffY\">\"tmp/test.js\"</span>\n      }\n    }\n  });\n\n  grunt.loadNpmTasks(<span class=\"highlight__hljs-string___1SffY\">\"grunt-contrib-copy\"</span>);\n  grunt.loadNpmTasks(<span class=\"highlight__hljs-string___1SffY\">\"grunt-contrib-clean\"</span>);\n  grunt.loadNpmTasks(<span class=\"highlight__hljs-string___1SffY\">\"grunt-execute\"</span>)\n  grunt.loadNpmTasks(<span class=\"highlight__hljs-string___1SffY\">\"grunt-purescript\"</span>);\n\n  grunt.registerTask(<span class=\"highlight__hljs-string___1SffY\">\"test\"</span>, [<span class=\"highlight__hljs-string___1SffY\">\"pscMake:tests\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"copy\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"execute:tests\"</span>]);\n  grunt.registerTask(<span class=\"highlight__hljs-string___1SffY\">\"make\"</span>, [<span class=\"highlight__hljs-string___1SffY\">\"pscMake:lib\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"dotPsci\"</span>]);\n  grunt.registerTask(<span class=\"highlight__hljs-string___1SffY\">\"default\"</span>, [<span class=\"highlight__hljs-string___1SffY\">\"clean\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"make\"</span>, <span class=\"highlight__hljs-string___1SffY\">\"test\"</span>]);\n};\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.15.node.attributes":{"slug":"getting-started-with-purescript","__typename":"BlogPostAttributes","title":"Getting Started with PureScript","url":"/2014/6/22/getting-started-with-purescript/","excerpt":"According to PureScript.org","updatedAt":"Jun 22nd, 2014","timeToRead":2,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.15":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.15.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.16.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.16.node.attributes","generated":true},"body":"<p>When placing a ViewPager inside of a GridView recently I ran into the issue of\nthe ViewPager stealing the GridView Items’ click event. I had lost my click\nevent, but the ViewPager was still scrolling fine.</p>\n<p>With the following GridView:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"php\"><span class=\"hljs-meta\">&lt;?</span>xml version=<span class=\"highlight__hljs-string___1SffY\">\"1.0\"</span> encoding=<span class=\"highlight__hljs-string___1SffY\">\"utf-8\"</span><span class=\"hljs-meta\">?&gt;</span></span>\n<span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">FrameLayout</span>\n    <span class=\"hljs-attr\">xmlns:android</span>=<span class=\"highlight__hljs-string___1SffY\">\"http://schemas.android.com/apk/res/android\"</span>\n    <span class=\"hljs-attr\">android:layout_width</span>=<span class=\"highlight__hljs-string___1SffY\">\"match_parent\"</span>\n    <span class=\"hljs-attr\">android:layout_height</span>=<span class=\"highlight__hljs-string___1SffY\">\"match_parent\"</span>&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">GridView</span>\n        <span class=\"hljs-attr\">android:id</span>=<span class=\"highlight__hljs-string___1SffY\">\"@+id/bar_gridview\"</span>\n        <span class=\"hljs-attr\">android:layout_width</span>=<span class=\"highlight__hljs-string___1SffY\">\"match_parent\"</span>\n        <span class=\"hljs-attr\">android:layout_height</span>=<span class=\"highlight__hljs-string___1SffY\">\"match_parent\"</span>\n        <span class=\"hljs-attr\">android:verticalSpacing</span>=<span class=\"highlight__hljs-string___1SffY\">\"0dp\"</span>\n        <span class=\"hljs-attr\">android:horizontalSpacing</span>=<span class=\"highlight__hljs-string___1SffY\">\"0dp\"</span>\n        <span class=\"hljs-attr\">android:stretchMode</span>=<span class=\"highlight__hljs-string___1SffY\">\"columnWidth\"</span>\n        <span class=\"hljs-attr\">android:numColumns</span>=<span class=\"highlight__hljs-string___1SffY\">\"1\"</span> /&gt;</span>\n<span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">FrameLayout</span>&gt;</span>\n</code></pre>\n<p>and a grid item view with a ViewPager (reduced for simplicity):</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">com.christopherbiscardi.grid.MyGridItemFrame</span> <span class=\"hljs-attr\">xmlns:android</span>=<span class=\"highlight__hljs-string___1SffY\">\"http://schemas.android.com/apk/res/android\"</span>\n    <span class=\"hljs-attr\">android:id</span>=<span class=\"highlight__hljs-string___1SffY\">\"@+id/grid_item_frame\"</span>\n    <span class=\"hljs-attr\">android:layout_width</span>=<span class=\"highlight__hljs-string___1SffY\">\"match_parent\"</span>\n    <span class=\"hljs-attr\">android:layout_height</span>=<span class=\"highlight__hljs-string___1SffY\">\"match_parent\"</span> &gt;</span>\n\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">com.christopherbiscardi.grid.MyViewPager</span>\n        <span class=\"hljs-attr\">android:id</span>=<span class=\"highlight__hljs-string___1SffY\">\"@+id/my_pager\"</span>\n        <span class=\"hljs-attr\">android:layout_width</span>=<span class=\"highlight__hljs-string___1SffY\">\"match_parent\"</span>\n        <span class=\"hljs-attr\">android:layout_height</span>=<span class=\"highlight__hljs-string___1SffY\">\"match_parent\"</span> /&gt;</span>\n\n<span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">com.christopherbiscardi.grid.MyGridItemFrame</span>&gt;</span>\n</code></pre>\n<p>We can intercept the touch event on MyGridItemFrame, which sits between the\nGridView and the ViewPager by extending\n<code>GestureDetector.SimpleOnGestureListener</code> and overriding\n<code>onInterceptTouchEvent</code>. In this case all we care about is handling the tap\n(<code>onSingleTapUp</code>) and we will let the scroll pass through to the ViewPager.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">package</span> com.christopherbiscardi.grid;\n\n<span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">MyGridItemFrame</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">FrameLayout</span> </span>{\n\n\t<span class=\"highlight__hljs-keyword___som98\">final</span> GestureDetector mGestureDetector = <span class=\"highlight__hljs-keyword___som98\">new</span> GestureDetector(<span class=\"highlight__hljs-keyword___som98\">new</span> MyGestureListener());\n\n\t<span class=\"hljs-meta\">@Override</span>\n\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-keyword___som98\">boolean</span> <span class=\"highlight__hljs-title___1fl8Q\">onInterceptTouchEvent</span><span class=\"hljs-params\">(MotionEvent event)</span> </span>{\n\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> mGestureDetector.onTouchEvent(event);\n\t}\n\n\n\t<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">MyGestureListener</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">GestureDetector</span>.<span class=\"highlight__hljs-title___1fl8Q\">SimpleOnGestureListener</span> </span>{\n\n\t\t<span class=\"hljs-meta\">@Override</span>\n\t\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-keyword___som98\">boolean</span> <span class=\"highlight__hljs-title___1fl8Q\">onSingleTapUp</span><span class=\"hljs-params\">(MotionEvent event)</span> </span>{\n\t\t\tToast.makeText(getContext(), <span class=\"highlight__hljs-string___1SffY\">\"clicked Grid Item\"</span>, Toast.LENGTH_SHORT).show();\n\t\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-keyword___som98\">true</span>;\n\t\t}\n\t}\n}\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.16.node.attributes":{"slug":"handling-taps-on-listgrid-items-with-viewpagers-gesture","__typename":"BlogPostAttributes","title":"Handling Taps on List/Grid Items with ViewPagers (GestureDetector)","url":"/2014/4/9/handling-taps-on-listgrid-items-with-viewpagers-gesture/","excerpt":"When placing a ViewPager inside of a GridView recently I ran into the issue of\nthe ViewPager stealing the GridView Items’ click event. I…","updatedAt":"Apr 9th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.16":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.16.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.17.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.17.node.attributes","generated":true},"body":"<p>The github repo for this post is <a href=\"https://github.com/ChristopherBiscardi/snap-postgres-heist\">here</a>.</p>\n<h2 id=\"single-authuser-splice\">Single AuthUser Splice</h2>\n<p>Assuming we have instances and initializations for the Postgres Auth backend and Postgresql-Simple Snaplet, we can do a few things. First, we need to write a Splice for the AuthUser data type. We will only use a couple fields to show how it works.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;haskell&quot; style=&quot;overflow-x:auto&quot;&gt;authUserSplice :: Monad m =&gt;\n                  AuthUser -&gt;\n                  Splices (HeistT n m Template)\nauthUserSplice authUser = do\n  &quot;userLogin&quot; ## I.textSplice (userLogin authUser)\n  &quot;userLoginCount&quot; ## I.textSplice (T.pack $ show $ userLoginCount authUser)\n</code></pre>\n<p>Using <code>##</code>, we are binding the strings <code>&quot;userLogin&quot;</code> and <code>&quot;userLoginCount&quot;</code> to their respective values from the <code>authUser</code> object. <code>userLogin authUser</code> gives us a <code>Text</code> result, so <code>&quot;userLogin&quot;</code> is bound to a text splice. We also bind <code>&quot;userLoginCount&quot;</code> as a text splice by converting the <code>int</code> we get from using <code>userLoginCount</code> on <code>authUser</code>.</p>\n<p>Now that we have our Splice written, let’s write our template.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;html&quot;&gt;&lt;apply template=&quot;base&quot;&gt;\n&lt;h1&gt;&lt;userLogin/&gt;&lt;/h1&gt;\n&lt;p&gt;Number of Times Logged In: &lt;userLoginCount/&gt;&lt;/p&gt;\n&lt;/apply&gt;```\n\nNothing major here. We have used the strings we bound before as tags to display the text from the `authUser` object.\n\nFinally, we can write a Handler to make the database request and render the template using our splice.\n\n</code></pre>\n<p><code class=\"haskell\" style=\"overflow-x:auto\">getFromPostgres :: Handler App (AuthManager App) ()\ngetFromPostgres = do\nresult ```</p>\n<p>Using a simple query to store the data from Postgres in <code>result</code>, we then render using our template (<code>auth_user_splice.tpl</code>) and apply the splice to the data in our result.</p>\n<h2 id=\"list-of-authusers\">List of AuthUsers</h2>\n<p>To display a list of data, the process is very similar.</p>\n<p>We can reuse the <code>authUserSplice</code> we just wrote and map it across the list of data we plan on passing in using <code>mapSplices</code> and <code>runChildrenWith</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;haskell&quot; style=&quot;overflow-x:auto&quot;&gt;authUsersSplice  :: [AuthUser] -&gt; I.Splice AppHandler\nauthUsersSplice = I.mapSplices (I.runChildrenWith . authUserSplice)```\n\nWe will also write a new template to display the information. Included in this is the `authUsers` tag, which we are going to bind in our Handler.\n\n</code></pre>\n<p><code class=\"html\"><apply template=\"base\"></p>\n<dl>\n<authUsers>\n<dt><userLogin/></dt>\n<dd>Number of Times Logged In: <userLoginCount/></dd>\n</authUsers>\n</dl>\n</apply>```\n<p>We can then write our handler as such:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;haskell&quot; style=&quot;overflow-x:auto&quot;&gt;getManyFromPostgres :: Handler App (AuthManager App) ()\ngetManyFromPostgres = do\n        results ```\n\nWe are rendering our new template `auth_users_splice.tpl` with our mapped splices bound to `&quot;authUsers&quot;`. The code inside of `&lt;authUsers&gt;` will be run for each result in our list.\n\n\n## End\n\nThat's it. Feel free to pull the code from [github](https://github.com/ChristopherBiscardi/snap-postgres-heist) and leave any questions you have below.\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.17.node.attributes":{"slug":"snap-postgres-and-heist-displaying-data-from-queries","__typename":"BlogPostAttributes","title":"Snap, Postgres and Heist: Displaying Data from Queries","url":"/2014/4/8/snap-postgres-and-heist-displaying-data-from-queries/","excerpt":"The github repo for this post is here.","updatedAt":"Apr 8th, 2014","timeToRead":2,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.17":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.17.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.18.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.18.node.attributes","generated":true},"body":"<p>In this post we will go over how to set up the sample project for Robolectric,\nrun, test and deploy to a device in a headless vagrant environment.</p>\n<h2 id=\"sample-app\">Sample App</h2>\n<p>Clone the sample app from the <a href=\"https://github.com/robolectric/RobolectricSample\">github\nrepo</a></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>git clone git@github.com:robolectric/RobolectricSample.git\n</code></pre>\n<h2 id=\"vagrantfile\">Vagrantfile</h2>\n<p>Here is our Vagrantfile. We’ll need to add the <code>precise64</code> base box to our\nsystem. also availible as a\n<a href=\"https://gist.github.com/ChristopherBiscardi/9383725\">Gist</a></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>vagrant box add precise64 http://files.vagrantup.com/precise64.box\n</code></pre>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\"># -*- mode: ruby -*-</span>\n<span class=\"highlight__hljs-comment___UYk12\"># vi: set ft=ruby :</span>\n\n<span class=\"highlight__hljs-comment___UYk12\"># Vagrantfile API/syntax version. Don't touch unless you know what you're doing!</span>\nVAGRANTFILE_API_VERSION = <span class=\"highlight__hljs-string___1SffY\">\"2\"</span>\n\nVagrant.configure(VAGRANTFILE_API_VERSION) <span class=\"highlight__hljs-keyword___som98\">do</span> <span class=\"hljs-params\">|config|</span>\n  config.vm.box = <span class=\"highlight__hljs-string___1SffY\">\"precise64\"</span>\n  config.vm.provision <span class=\"highlight__hljs-string___1SffY\">\"shell\"</span>, <span class=\"highlight__hljs-symbol___mdaTG\">path:</span> <span class=\"highlight__hljs-string___1SffY\">\"vagrant-android-build.sh\"</span>\n  config.vm.provider <span class=\"highlight__hljs-symbol___mdaTG\">:virtualbox</span> <span class=\"highlight__hljs-keyword___som98\">do</span> <span class=\"hljs-params\">|vb|</span>\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'modifyvm'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--usb'</span>, <span class=\"highlight__hljs-string___1SffY\">'on'</span>]\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'usbfilter'</span>, <span class=\"highlight__hljs-string___1SffY\">'add'</span>, <span class=\"highlight__hljs-string___1SffY\">'0'</span>, <span class=\"highlight__hljs-string___1SffY\">'--target'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--name'</span>, <span class=\"highlight__hljs-string___1SffY\">'1197123b'</span>, <span class=\"highlight__hljs-string___1SffY\">'--vendorid'</span>, <span class=\"highlight__hljs-string___1SffY\">'0x04e8'</span>]\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'usbfilter'</span>, <span class=\"highlight__hljs-string___1SffY\">'add'</span>, <span class=\"highlight__hljs-string___1SffY\">'0'</span>, <span class=\"highlight__hljs-string___1SffY\">'--target'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--name'</span>, <span class=\"highlight__hljs-string___1SffY\">'android'</span>, <span class=\"highlight__hljs-string___1SffY\">'--vendorid'</span>, <span class=\"highlight__hljs-string___1SffY\">'0x18d1'</span>]\n  <span class=\"highlight__hljs-keyword___som98\">end</span>\n<span class=\"highlight__hljs-keyword___som98\">end</span>\n</code></pre>\n<p>and the Vagrant build script. The build script downloads and installs ADT and\nMaven.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>apt-get update -y\napt-get install openjdk-7-jdk unzip -y\n<span class=\"highlight__hljs-comment___UYk12\"># For maven-plugin</span>\napt-get install lib32z1-dev bison flex lib32ncurses5-dev libx11-dev gperf g++-multilib -y\n<span class=\"highlight__hljs-comment___UYk12\"># Setup Android SDK</span>\nsudo -u vagrant wget http://dl.google.com/android/adt/adt-bundle-linux-x86_64-20131030.zip\nsudo -u vagrant unzip adt-bundle-linux-x86_64-20131030.zip\n<span class=\"highlight__hljs-comment___UYk12\"># Add Android SDK to PATH</span>\nsudo -u vagrant <span class=\"highlight__hljs-built_in___3uuyR\">echo</span> <span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/tools:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span> &gt;&gt; /home/vagrant/.bashrc\nsudo -u vagrant <span class=\"highlight__hljs-built_in___3uuyR\">echo</span> <span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/platform-tools:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span> &gt;&gt; /home/vagrant/.bashrc\n\n<span class=\"highlight__hljs-comment___UYk12\"># Maven</span>\nsudo -u vagrant wget http://download.nextag.com/apache/maven/maven-3/3.2.1/binaries/apache-maven-3.2.1-bin.tar.gz\nsudo -u vagrant tar -xvzf apache-maven-3.2.1-bin.tar.gz\n<span class=\"highlight__hljs-comment___UYk12\"># Add Maven to PATH</span>\nsudo -u vagrant <span class=\"highlight__hljs-built_in___3uuyR\">echo</span> <span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/apache-maven-3.2.1/bin:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span> &gt;&gt; /home/vagrant/.bashrc\n\n<span class=\"highlight__hljs-comment___UYk12\"># Install API 16 (sample project needs it)</span>\n<span class=\"highlight__hljs-comment___UYk12\"># echo \"y\" is a hack to accept the license</span>\nsudo -u vagrant <span class=\"highlight__hljs-built_in___3uuyR\">echo</span> <span class=\"highlight__hljs-string___1SffY\">\"y\"</span> | /home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/tools/android update sdk -t 6 --no-ui -y\n<span class=\"highlight__hljs-comment___UYk12\"># ANDROID_HOME is for Maven</span>\nsudo -u vagrant <span class=\"highlight__hljs-built_in___3uuyR\">echo</span> <span class=\"highlight__hljs-built_in___3uuyR\">export</span> ANDROID_HOME=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/ &gt;&gt; /home/vagrant/.bashrc\n</code></pre>\n<h2 id=\"path-and-android-home\">Path and ANDROID_HOME</h2>\n<p>We need a few thing on our path, all of which are included in our Vagrant build\nscript (Android tools, Android platform-tools, Maven and ANDROID_HOME)</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/tools:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span>\n<span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/platform-tools:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span>\n<span class=\"highlight__hljs-built_in___3uuyR\">export</span> PATH=/home/vagrant/apache-maven-3.2.1/bin:\\<span class=\"highlight__hljs-variable___1-KRy\">$PATH</span>\n<span class=\"highlight__hljs-built_in___3uuyR\">export</span> ANDROID_HOME=/home/vagrant/adt-bundle-linux-x86_64-20131030/sdk/\n</code></pre>\n<h2 id=\"vagrant-up\">Vagrant Up</h2>\n<p>Simply copy the <code>Vagrantfile</code> and <code>vagrant-android-build.sh</code> into the sample\nproject’s root folder. Then <code>cd</code> into that folder and run <code>vagrant up</code> to boot\nthe machine. If you don’t have Vagrant and VirtualBox,\n<a href=\"http://www.vagrantup.com/\">here</a> and <a href=\"https://www.virtualbox.org/\">here</a> are\nthe respective links.</p>\n<p>Note that it may be necessary to run the command to update the Android SDK\nmanually due to the licenses.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>vagrant ssh\nandroid update sdk -t 6 --no-ui -y\n</code></pre>\n<h2 id=\"running-the-tests\">Running the Tests</h2>\n<p>We can run the tests inside the vm using maven:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>vagrant ssh\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> /vagrant\nmvn clean <span class=\"highlight__hljs-built_in___3uuyR\">test</span>\n</code></pre>\n<p>Which will give us output that looks like this:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>Results :\n\nTests run: 87, Failures: 0, Errors: 0, Skipped: 0\n\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time: 28.917 s\n[INFO] Finished at: 2014-03-06T06:19:39+00:00\n[INFO] Final Memory: 23M/57M\n[INFO] ------------------------------------------------------------------------\n</code></pre>\n<p>Run <code>exit</code> to get out of the vm.</p>\n<h2 id=\"connecting-test-devices-to-the-vm\">Connecting Test Devices to the VM</h2>\n<p>With <code>VBoxManage</code> and devices connected, we can allow (all?) of them using the\nfollowing <code>usbfilter</code> in our <code>Vagrantfile</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>config.vm.provider <span class=\"highlight__hljs-symbol___mdaTG\">:virtualbox</span> <span class=\"highlight__hljs-keyword___som98\">do</span> <span class=\"hljs-params\">|vb|</span>\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'modifyvm'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--usb'</span>, <span class=\"highlight__hljs-string___1SffY\">'on'</span>]\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'usbfilter'</span>, <span class=\"highlight__hljs-string___1SffY\">'add'</span>, <span class=\"highlight__hljs-string___1SffY\">'0'</span>, <span class=\"highlight__hljs-string___1SffY\">'--target'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--name'</span>, <span class=\"highlight__hljs-string___1SffY\">'android'</span>, <span class=\"highlight__hljs-string___1SffY\">'--vendorid'</span>, <span class=\"highlight__hljs-string___1SffY\">'0x18d1'</span>]\n  <span class=\"highlight__hljs-keyword___som98\">end</span>\n</code></pre>\n<p>Alternatively, we can list all connected usbhosts and select a specific device\nas such:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>VBoxManage list usbhost\n</code></pre>\n<p>Which gives us a list of these:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>UUID:               6316e123-b702-4155-9703-c2015d014237\nVendorId:           0x18d1 (18D1)\nProductId:          0xd002 (D002)\nRevision:           2.40 (0240)\nPort:               6\nUSB version/speed:  0/2\nManufacturer:       asus\nProduct:            Nexus 7\nSerialNumber:       07d99c71\nAddress:            p=0xd002;v=0x18d1;s=0x000000006321cfbd;l=0x20260000\nCurrent State:      Busy\n</code></pre>\n<p>Find your Android device and use these parameters to change our Vagrantfile:</p>\n<p>SerialNumber -&gt; –name\nVendorId -&gt; –vendorid</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>config.vm.provider <span class=\"highlight__hljs-symbol___mdaTG\">:virtualbox</span> <span class=\"highlight__hljs-keyword___som98\">do</span> <span class=\"hljs-params\">|vb|</span>\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'modifyvm'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--usb'</span>, <span class=\"highlight__hljs-string___1SffY\">'on'</span>]\n    vb.customize [<span class=\"highlight__hljs-string___1SffY\">'usbfilter'</span>, <span class=\"highlight__hljs-string___1SffY\">'add'</span>, <span class=\"highlight__hljs-string___1SffY\">'0'</span>, <span class=\"highlight__hljs-string___1SffY\">'--target'</span>, <span class=\"highlight__hljs-symbol___mdaTG\">:id</span>, <span class=\"highlight__hljs-string___1SffY\">'--name'</span>, <span class=\"highlight__hljs-string___1SffY\">'1197123b'</span>, <span class=\"highlight__hljs-string___1SffY\">'--vendorid'</span>, <span class=\"highlight__hljs-string___1SffY\">'0x04e8'</span>]\n  <span class=\"highlight__hljs-keyword___som98\">end</span>\n</code></pre>\n<p>Remember to <code>vagrant reload</code> after changing network settings in the\n<code>Vagrantfile</code>. Some devices may also need to be unplugged and plugged back in\nfor the VM to see them.</p>\n<h2 id=\"deploying\">Deploying</h2>\n<p>Simply run adb inside the vm to see the connected devices:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>vagrant ssh\nsudo adb devices\n</code></pre>\n<p>If you see an unauthorized message like the one below, it is likely that you\ndidn’t start the adb server as root (which will prevent the RSA authorization\nfrom popping up).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>* daemon not running. starting it now on port 5037 *\n* daemon started successfully *\nList of devices attached\n????????????\tno permissions&lt;/pre&gt;&lt;p&gt;Otherwise we should see a list of devices as below after authorizing the devices when the RSA dialog pops up on each device.&lt;/p&gt;&lt;pre&gt;&lt;code class=<span class=\"highlight__hljs-string___1SffY\">\"&gt;List of devices attached\n07d99c71\tdevice\n2d605528\tdevice\n</span></code></pre>\n<p>We can now install the app on our devices from inside the vm using maven.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">cd</span> /vagrant\nmvn clean install &amp;&amp; mvn android:deploy\n</code></pre>\n<h2 id=\"fin\">Fin</h2>\n<p>That’s it. The app should be installed on your connected devices. It won’t start\nautomatically, but you can navigate to the newly installed <code>Robolectric Sample</code>\napp and start it up.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.18.node.attributes":{"slug":"getting-started-with-robolectric-headless-android-testing-with-vagrant","__typename":"BlogPostAttributes","title":"Getting Started with Robolectric: Headless Android Testing with Vagrant","url":"/2014/3/8/getting-started-with-robolectric-headless-android-testing-with-vagrant/","excerpt":"In this post we will go over how to set up the sample project for Robolectric,\nrun, test and deploy to a device in a headless vagrant…","updatedAt":"Mar 8th, 2014","timeToRead":3,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.18":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.18.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.19.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.19.node.attributes","generated":true},"body":"<p>Today I was trying to extract the minimal imports for a module using <code>ghc -ddump-minimal-imports</code> but I was getting this error on some files:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>error: missing binary operator before token <span class=\"highlight__hljs-string___1SffY\">\"(\"</span>\n<span class=\"highlight__hljs-comment___UYk12\">#if MIN_VERSION_base(4,4,0)</span>\n^\n</code></pre>\n<p>Which is related to the fact that <code>cabal</code> expands <code>MIN_VERSION_base</code> macros when\nrunning <code>cabal build</code>, so we don’t have them when running <code>ghc</code> or <code>ghci</code>.\nLuckily it’s an easy fix.</p>\n<p>Cabal generates a macros file relative to the root of the project at\n<code>dist/build/autogen/cabal_macros.h</code>. We can include this file to gain access to\nthe macros:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>ghc -ddump-minimal-imports -optP-include -optPdist/build/autogen/cabal_macros.h src/Types.hs\n</code></pre>\n<p>Which will now spit out our imports into a file called <code>Types.imports</code> and may\nlook something like this:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">import</span> Blaze.ByteString.Builder\n    ( <span class=\"highlight__hljs-type___11WfV\">Builder</span>, fromLazyByteString, fromByteString )\n<span class=\"highlight__hljs-keyword___som98\">import</span> Blaze.ByteString.Builder.Char.Utf8\n    ( fromText, fromLazyText )\n<span class=\"highlight__hljs-keyword___som98\">import</span> Control.Applicative\n    ( <span class=\"highlight__hljs-type___11WfV\">Applicative</span>((), pure), <span class=\"highlight__hljs-type___11WfV\">Alternative</span>((), empty), () )\n<span class=\"highlight__hljs-keyword___som98\">import</span> Control.Exception.Lifted\n    ( <span class=\"highlight__hljs-type___11WfV\">ErrorCall</span>(..),\n      <span class=\"highlight__hljs-type___11WfV\">Exception</span>,\n      <span class=\"highlight__hljs-type___11WfV\">Handler</span>(..),\n      <span class=\"highlight__hljs-type___11WfV\">SomeException</span>(..),\n      catch,\n      catches,\n      mask,\n      onException,\n      throwIO )\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.19.node.attributes":{"slug":"ghc-ddump-minimal-imports-and-cpp-error-missing-binary-operator-before-token","__typename":"BlogPostAttributes","title":"GHC -ddump-minimal-imports and CPP error: missing binary operator before token \"(\"","url":"/2014/3/5/ghc-ddump-minimal-imports-and-cpp-error-missing-binary-operator-before-token/","excerpt":"Today I was trying to extract the minimal imports for a module using ghc -ddump-minimal-imports but I was getting this error on some files:","updatedAt":"Mar 5th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.19":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.19.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.20.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.20.node.attributes","generated":true},"body":"<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611515/vagrantriak_qhwv7l.gif\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611515/vagrantriak_qhwv7l.gif\" alt=\"vagrantriak\"></a></p>\n<p>In this post we will go over how to set up five Riak nodes, cluster them, setup HAProxy on a sixth machine and run a Haskell environment in a seventh machine. This will allow us to query from our Haskell vm to our HAProxy vm and distribute the queries among a Riak cluster.</p>\n<p>If you haven’t installed Vagrant, do that now:\n<a href=\"http://www.vagrantup.com/\">Vagrant</a></p>\n<p>I used VirtualBox as a backing for Vagrant.\n<a href=\"https://www.virtualbox.org/\">VirtualBox</a></p>\n<h1 id=\"tldr-running-the-code\">tldr: Running the Code</h1>\n<h2 id=\"the-base-box\">The Base Box</h2>\n<p>We will need Ubuntu 13.10 (Saucy Salamander), as this is the base box in our <code>Vagrantfile</code>s.</p>\n<p><code>vagrant box add saucy-amd http://cloud-images.ubuntu.com/vagrant/saucy/current/saucy-server-cloudimg-amd64-vagrant-disk1.box</code></p>\n<h2 id=\"cloning-the-repo\">Cloning the Repo</h2>\n<p>The code is contained in a git repo <a href=\"\">here</a></p>\n<p><code>git clone git@github.com:ChristopherBiscardi/Riak-HAProxy-Haskell-Vagrant.git</code></p>\n<h2 id=\"getting-them-up\">Getting Them Up</h2>\n<p>The simplest way to get everything up and running is:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;bash&quot;&gt;cd riak-haproxy-haskell-vagrant\nvagrant up```\n\nI personally like to bring up my databases first, then proxy, then webserver.\n\n</code></pre>\n<p><code class=\"bash\">cd riak-haproxy-haskell-vagrant\nvagrant up /riak[0-9]/\nvagrant up haproxy\nvagrant up web```</p>\n<p>A gif of running <code>vagrant up haproxy</code> is availible <a href=\"http://www.christopherbiscardi.com/wp-content/uploads/2014/02/vagrantuphaproxy.gif\">here</a></p>\n<h2 id=\"testing\">Testing</h2>\n<p>We can be assured that everything has worked by running:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;bash&quot;&gt;vagrant ssh web\ncurl 192.168.50.3:8098```\n\nWhich is curling the IP of our load balancer. This should return something like this from a Riak node:\n\n</code></pre>\n<code class=\"html\" style=\"overflow-x:auto\">\n<pre><code>&lt;ul&gt;\n&lt;li&gt;&lt;a href=&quot;/types&quot;&gt;riak_kv_wm_bucket_type&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/buckets&quot;&gt;riak_kv_wm_buckets&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/riak&quot;&gt;riak_kv_wm_buckets&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/types&quot;&gt;riak_kv_wm_buckets&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/buckets&quot;&gt;riak_kv_wm_counter&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/types&quot;&gt;riak_kv_wm_crdt&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/buckets&quot;&gt;riak_kv_wm_index&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/types&quot;&gt;riak_kv_wm_index&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/buckets&quot;&gt;riak_kv_wm_keylist&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/types&quot;&gt;riak_kv_wm_keylist&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/buckets&quot;&gt;riak_kv_wm_link_walker&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/riak&quot;&gt;riak_kv_wm_link_walker&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/types&quot;&gt;riak_kv_wm_link_walker&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/mapred&quot;&gt;riak_kv_wm_mapred&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/buckets&quot;&gt;riak_kv_wm_object&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/riak&quot;&gt;riak_kv_wm_object&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/types&quot;&gt;riak_kv_wm_object&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/ping&quot;&gt;riak_kv_wm_ping&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/buckets&quot;&gt;riak_kv_wm_props&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/types&quot;&gt;riak_kv_wm_props&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/stats&quot;&gt;riak_kv_wm_stats&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;/search&quot;&gt;yz_wm_extract&lt;/a&gt;&lt;/li&gt;```\n</code></pre>\n<h2 id=\"whats-going-on\">What’s Going On</h2>\n<p>Our Vagrantfile looks like this:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;ruby&quot; style=&quot;overflow-x:auto&quot;&gt;# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nVAGRANTFILE_API_VERSION = &quot;2&quot;\nNUM_RIAK_NODES = 5\n\nVagrant.configure(VAGRANTFILE_API_VERSION) do |config|\n  config.vm.box = &quot;saucy-amd&quot;\n\n  config.vm.define &quot;web&quot; do |web|\n    web.vm.network &quot;private_network&quot;,\n      ip: &quot;192.168.50.2&quot;, virtualbox__intnet: &quot;riakhaskellnetwork&quot;\n    web.vm.provision &quot;shell&quot;, path: &quot;vagrant-files/haskell-build.sh&quot;\n    web.vm.provider &quot;virtualbox&quot; do |v|\n      v.memory = 1024\n    end\n  end\n\n  config.vm.define &quot;haproxy&quot; do |ha|\n    ha.vm.network &quot;private_network&quot;,\n      ip: &quot;192.168.50.3&quot;, virtualbox__intnet: &quot;riakhaskellnetwork&quot;\n    ha.vm.provision &quot;shell&quot;, path: &quot;vagrant-files/haproxy-build.sh&quot;\n  end\n\n# Base node is 192.168.50.10\n# Subsequent nodes are .11/.12/etc\n  (1..NUM_RIAK_NODES).each do |i|\n    config.vm.define &quot;riak#{i}&quot; do |riakx|\n      riakx.vm.network &quot;private_network&quot;,\n        ip: &quot;192.168.50.#{i+9}&quot;, virtualbox__intnet: &quot;riakhaskellnetwork&quot;\n      riakx.vm.provision &quot;shell&quot;, path: &quot;vagrant-files/riak-build.sh&quot;, args: &quot;192.168.50.#{i+9} 192.168.50.10&quot;\n    end\n  end\nend```\n\nEach of our vm types is defined in a `config.vm.define` block. We have `web`, `haproxy` and some `riak` nodes.\n\n### Global\n\nIn each block we define a `private_network` named `riakhaskellnetwork` and define the IP addresses for each vm. `web` is `x.x.x.2`, `haproxy` is `x.x.x.3` and the `riak` nodes autoincrement from `x.x.x.10`. (riak1 is x.x.x.10, riak2 is x.x.x.11, etc)\n\n### web\n\nOur web vm is provisioned using the shell script located in `vagrant-files/haskell-build.sh`. It’s fairly basic and just installs the `haskell-platform` and updates `cabal`.\n\n</code></pre>\n<p><code class=\"bash\" style=\"overflow-x:auto\">echo &quot;Haskell 7.6.3&quot;\napt-get update\napt-get install build-essential haskell-platform -y\ncabal update\ncabal install cabal-install```</p>\n<p>After <code>vagrant up web</code> we can <code>vagrant ssh web</code> and run <code>ghci</code> to start a Haskell interpreter.</p>\n<h3 id=\"haproxy\">haproxy</h3>\n<p>Our HAProxy vm is a little more interesting. We install <code>haproxy</code>, set the open files limit to &gt; 256000 (in this case 266000) and then we start <code>haproxy</code> with the config file <code>vagrant-files/haproxy.config</code>. Note that there are no startup scripts, so this won’t to be able to withstand <code>vagrant reload</code> without running <code>vagrant provision</code> after it.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;bash&quot; style=&quot;overflow-x:auto&quot;&gt;echo &quot;Building HAProxy&quot;\napt-get update\napt-get install haproxy -y\nulimit -n 266000\nhaproxy -V -f /vagrant/vagrant-files/haproxy.config```\n\nIf we check out `vagrant-files/haproxy.config` we can see a little about what we’re doing with our load balancer:\n\n</code></pre>\n<p><code class=\"config\" style=\"overflow-x:auto\">global\nlog 192.168.50.3     local0\nlog 192.168.50.3     local1 notice\nmaxconn           256000\nchroot            /var/lib/haproxy\nuser              haproxy\ngroup             haproxy\nspread-checks     5\ndaemon\nquiet</p>\n<p>defaults\nlog               global\noption            dontlognull\noption            redispatch\noption            allbackups\nmaxconn           256000\ntimeout connect   5000</p>\n<p>backend riak_rest_backend\nmode               http\nbalance            roundrobin\noption             httpchk GET /ping\noption             httplog\nserver riak1 192.168.50.10:8098 weight 1 maxconn 1024  check\nserver riak2 192.168.50.11:8098 weight 1 maxconn 1024  check\nserver riak3 192.168.50.12:8098 weight 1 maxconn 1024  check\nserver riak4 192.168.50.13:8098 weight 1 maxconn 1024  check\nserver riak5 192.168.50.14:8098 weight 1 maxconn 1024  check</p>\n<p>frontend riak_rest\nbind               192.168.50.3:8098\nmode               http\noption             contstats\ndefault_backend    riak_rest_backend</p>\n<p>backend riak_protocol_buffer_backend\nbalance            leastconn\nmode               tcp\noption             tcpka\noption             srvtcpka\nserver riak1 192.168.50.10:8087 weight 1 maxconn 1024  check\nserver riak2 192.168.50.11:8087 weight 1 maxconn 1024  check\nserver riak3 192.168.50.12:8087 weight 1 maxconn 1024  check\nserver riak4 192.168.50.13:8087 weight 1 maxconn 1024  check\nserver riak5 192.168.50.14:8087 weight 1 maxconn 1024  check</p>\n<p>frontend riak_protocol_buffer\nbind               192.168.50.3:8087\nmode               tcp\noption             tcplog\noption             contstats\nmode               tcp\noption             tcpka\noption             srvtcpka\ndefault_backend    riak_protocol_buffer_backend```</p>\n<p>We are binding to the IP address of our vm, <code>192.168.50.3</code> and we’ve hardcoded the five node Riak cluster into our backends. We have a backend (the Riak nodes) and a frontend (webserver side) for Riak’s HTTP and Protobuf APIs.</p>\n<h3 id=\"riakx\">riakx</h3>\n<p>The Riak nodes are provisioned by <code>vagrant-files/riak-build</code>. We cycle through a list from 1 to <code>NUM_RIAK_NODES</code> (in this case, 5), and create a node for each. We pass two arguments to our shell script for each node. One is the base node IP (always x.x.x.10) and the other is the current node’s IP.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;config&quot; style=&quot;overflow-x:auto&quot;&gt;#!/bin/bash\n# $2 is base riak node IP\n# $1 is current node's IP\necho &quot;Building Riak Vagrant Node&quot;\necho $2\necho $1\nsudo apt-get update\nsudo apt-get install libssl0.9.8 default-jre -y\nwget http://s3.amazonaws.com/downloads.basho.com/riak/2.0/2.0.0pre11/ubuntu/precise/riak_2.0.0pre11-1_amd64.deb\nsudo dpkg -i riak_2.0.0pre11-1_amd64.deb\nsed -i &quot;s/127.0.0.1/$1/g&quot; /etc/riak/riak.conf\nsed -i 's/search = off/search = on/g' /etc/riak/riak.conf\nulimit -n 8192\nriak start\nif [[ &quot;$2&quot; != &quot;$1&quot; ]]\nthen\n  echo &quot;Joining Base Riak Node $2&quot;\n  riak-admin cluster join riak@$2\n  riak-admin cluster plan\n  riak-admin cluster commit\nelse\n  echo &quot;Starting Base Riak Node&quot;\nfi\necho $(riak-admin status | grep ring_members)```\n\n1. We install libssl and a JRE (because we want to run Riak Search)\n2. wget the `amd64.deb` for Riak2.0.0-pre11\n3. install the .deb\n4. Replace 127.0.0.1 with our node’s IP address\n5. Replace `search = off` with `search = on` to turn on Riak Search\n6. Set the file limit to 8192\n7. Start Riak\n8. then, if we have the base node, do nothing\n9. If we have the non-base node, we commit a cluster plan to join with the base node\n10. Finally, echo the result of `riak-admin status | grep ring_members`\n\nNote that, just like the HAProxy vm, the Riak nodes don’t have init scripts and will need a `vagrant provision` after a `vagrant reload`\n\n\n# Future Work\n\nIn the future I might include Riak CS in this configuration. In addition, it would be nice to have some init scripts to make for a more stable cluster. As it stands now, we have a pseudo-production configuration and we can examine the results of doing insane things like randomly `vagrant destroy`ing Riak nodes.\n\nNow that I think about it, a chaos monkey would be a cool addition to this setup.\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.20.node.attributes":{"slug":"riak-haproxy-and-haskell-multimachine-vagrant-on-osx","__typename":"BlogPostAttributes","title":"Riak, HAProxy and Haskell: MultiMachine Vagrant on OSX","url":"/2014/2/12/riak-haproxy-and-haskell-multimachine-vagrant-on-osx/","excerpt":"","updatedAt":"Feb 12th, 2014","timeToRead":5,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.20":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.20.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.21.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.21.node.attributes","generated":true},"body":"<p>In this post we will be using curl to construct a geospatial index using Riak\nSearch 2 (also known as Yokozuna) which is backed by Solr.</p>\n<p>I’ll be using <a href=\"http://docs.basho.com/riak/2.0.0pre11/downloads/\">Riak Pre11</a> for\nthis.</p>\n<p>In <code>etc/riak.conf</code> change <code>search</code> to <code>on</code>:\n(It was on line 411 for me)</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>search = on\n</code></pre>\n<p>Make sure your <code>ulimit</code> is 4096 or greater:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">ulimit</span> -n 4096\n</code></pre>\n<p>Then start Riak. I’m using <code>console</code> myself, but <code>start</code> would also work.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>./bin/riak console\n</code></pre>\n<h2 id=\"creating-a-schema\">Creating a Schema</h2>\n<p>Let’s create a schema so that Solr indexes our data correctly (file available\n<a href=\"https://gist.github.com/ChristopherBiscardi/8876815\">here</a>):</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"php\"><span class=\"hljs-meta\">&lt;?</span>xml version=<span class=\"highlight__hljs-string___1SffY\">\"1.0\"</span> encoding=<span class=\"highlight__hljs-string___1SffY\">\"UTF-8\"</span><span class=\"hljs-meta\">?&gt;</span></span>\n<span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">schema</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"geotest\"</span> <span class=\"hljs-attr\">version</span>=<span class=\"highlight__hljs-string___1SffY\">\"1.5\"</span>&gt;</span>\n  <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">uniqueKey</span>&gt;</span>_yz_id\n  <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fields</span>&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"name\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"string\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"loc\"</span>  <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"location_rpt\"</span>  <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n\n    <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- Begin Yokozuna Fields --&gt;</span>\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">required</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> /&gt;</span>\n\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"text\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"text_ws\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"false\"</span> <span class=\"hljs-attr\">multiValued</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_version_\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"long\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n\n   <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- Entropy Data: Data related to anti-entropy --&gt;</span>\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_ed\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"false\"</span>/&gt;</span>\n\n   <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- Partition Number: Used as a filter query param --&gt;</span>\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_pn\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"false\"</span>/&gt;</span>\n\n   <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- First Partition Number: The first partition in this doc's\n        preflist, used for further filtering on overlapping partitions. --&gt;</span>\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_fpn\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"false\"</span>/&gt;</span>\n\n   <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- If there is a sibling, use vtag to differentiate them --&gt;</span>\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_vtag\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"false\"</span>/&gt;</span>\n\n   <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- Node: The name of the node that this doc was created on. --&gt;</span>\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_node\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"false\"</span>/&gt;</span>\n\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n\n   <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- Riak Bucket: The bucket of the Riak object this doc corresponds to. --&gt;</span>\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n\n   <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- Riak Key: The key of the Riak object this doc corresponds to. --&gt;</span>\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n\n   <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- Node: Stores a flag if this doc is the product of a failed object extration --&gt;</span>\n   <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_err\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"false\"</span>/&gt;</span>\n  <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">fields</span>&gt;</span>\n  <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">types</span>&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"location_rpt\"</span>   <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.SpatialRecursivePrefixTreeFieldType\"</span>\n\t               <span class=\"hljs-attr\">spatialContextFactory</span>=<span class=\"highlight__hljs-string___1SffY\">\"com.spatial4j.core.context.jts.JtsSpatialContextFactory\"</span>\n\t               <span class=\"hljs-attr\">distErrPct</span>=<span class=\"highlight__hljs-string___1SffY\">\"0.025\"</span>\n\t               <span class=\"hljs-attr\">maxDistErr</span>=<span class=\"highlight__hljs-string___1SffY\">\"0.000009\"</span>\n\t               <span class=\"hljs-attr\">units</span>=<span class=\"highlight__hljs-string___1SffY\">\"degrees\"</span>\n\t            /&gt;</span>\n    <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- since fields of this type are by default not stored or indexed,\n         any data added to them will be ignored outright.  --&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldtype</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"ignored\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"false\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"false\"</span> <span class=\"hljs-attr\">multiValued</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.StrField\"</span> /&gt;</span>\n\n    <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- YZ String: Used for non-analyzed fields --&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"_yz_str\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.StrField\"</span> <span class=\"hljs-attr\">sortMissingLast</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"string\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.StrField\"</span> <span class=\"hljs-attr\">sortMissingLast</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"boolean\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.BoolField\"</span> <span class=\"hljs-attr\">sortMissingLast</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"int\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TrieIntField\"</span> <span class=\"hljs-attr\">precisionStep</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"float\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TrieFloatField\"</span> <span class=\"hljs-attr\">precisionStep</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"long\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TrieLongField\"</span> <span class=\"hljs-attr\">precisionStep</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"double\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TrieDoubleField\"</span> <span class=\"hljs-attr\">precisionStep</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-comment___UYk12\">&lt;!--\n     Numeric field types that index each value at various levels of precision\n     to accelerate range queries when the number of values between the range\n     endpoints is large. See the javadoc for NumericRangeQuery for internal\n     implementation details.\n\n     Smaller precisionStep values (specified in bits) will lead to more tokens\n     indexed per value, slightly larger index size, and faster range queries.\n     A precisionStep of 0 disables indexing at different precision levels.\n    --&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"tint\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TrieIntField\"</span> <span class=\"hljs-attr\">precisionStep</span>=<span class=\"highlight__hljs-string___1SffY\">\"8\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"tfloat\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TrieFloatField\"</span> <span class=\"hljs-attr\">precisionStep</span>=<span class=\"highlight__hljs-string___1SffY\">\"8\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"tlong\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TrieLongField\"</span> <span class=\"hljs-attr\">precisionStep</span>=<span class=\"highlight__hljs-string___1SffY\">\"8\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"tdouble\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TrieDoubleField\"</span> <span class=\"hljs-attr\">precisionStep</span>=<span class=\"highlight__hljs-string___1SffY\">\"8\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"date\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TrieDateField\"</span> <span class=\"hljs-attr\">precisionStep</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- A Trie based date field for faster date range queries and date faceting. --&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"tdate\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TrieDateField\"</span> <span class=\"hljs-attr\">precisionStep</span>=<span class=\"highlight__hljs-string___1SffY\">\"6\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"0\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-comment___UYk12\">&lt;!--Binary data type. The data should be sent/retrieved in as Base64 encoded Strings --&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldtype</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"binary\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.BinaryField\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"random\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.RandomSortField\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- A text field that only splits on whitespace for exact matching of words --&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"text_ws\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TextField\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"100\"</span>&gt;</span>\n      <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">analyzer</span>&gt;</span>\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">tokenizer</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.WhitespaceTokenizerFactory\"</span>/&gt;</span>\n      <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">analyzer</span>&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">fieldType</span>&gt;</span>\n    <span class=\"highlight__hljs-comment___UYk12\">&lt;!-- A general text field that has reasonable, generic\n         cross-language defaults: it tokenizes with StandardTokenizer,\n         removes stop words from case-insensitive \"stopwords.txt\"\n         (empty by default), and down cases.  At query time only, it\n         also applies synonyms. --&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"text_general\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.TextField\"</span> <span class=\"hljs-attr\">positionIncrementGap</span>=<span class=\"highlight__hljs-string___1SffY\">\"100\"</span>&gt;</span>\n      <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">analyzer</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"index\"</span>&gt;</span>\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">tokenizer</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.StandardTokenizerFactory\"</span>/&gt;</span>\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">filter</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.StopFilterFactory\"</span> <span class=\"hljs-attr\">ignoreCase</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">words</span>=<span class=\"highlight__hljs-string___1SffY\">\"stopwords.txt\"</span>/&gt;</span>\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">filter</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.LowerCaseFilterFactory\"</span>/&gt;</span>\n      <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">analyzer</span>&gt;</span>\n      <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">analyzer</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"query\"</span>&gt;</span>\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">tokenizer</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.StandardTokenizerFactory\"</span>/&gt;</span>\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">filter</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.StopFilterFactory\"</span> <span class=\"hljs-attr\">ignoreCase</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">words</span>=<span class=\"highlight__hljs-string___1SffY\">\"stopwords.txt\"</span>/&gt;</span>\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">filter</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.SynonymFilterFactory\"</span> <span class=\"hljs-attr\">synonyms</span>=<span class=\"highlight__hljs-string___1SffY\">\"synonyms.txt\"</span> <span class=\"hljs-attr\">ignoreCase</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">expand</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">filter</span> <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.LowerCaseFilterFactory\"</span>/&gt;</span>\n      <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">analyzer</span>&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">fieldType</span>&gt;</span>\n  <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">types</span>&gt;</span>\n<span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">schema</span>&gt;</span>\n</code></pre>\n<p>The important parts here are the schema name being <code>geotest</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">schema</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"geotest\"</span> <span class=\"hljs-attr\">version</span>=<span class=\"highlight__hljs-string___1SffY\">\"1.5\"</span>&gt;</span>\n</code></pre>\n<p>our two fields. <code>name</code> and <code>loc</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"name\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"string\"</span> <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">field</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"loc\"</span>  <span class=\"hljs-attr\">type</span>=<span class=\"highlight__hljs-string___1SffY\">\"location_rpt\"</span>  <span class=\"hljs-attr\">indexed</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span> <span class=\"hljs-attr\">stored</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>/&gt;</span>```\n\nand our fieldType `location_rpt`\n\n```xml\n\t<span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">fieldType</span> <span class=\"hljs-attr\">name</span>=<span class=\"highlight__hljs-string___1SffY\">\"location_rpt\"</span>   <span class=\"hljs-attr\">class</span>=<span class=\"highlight__hljs-string___1SffY\">\"solr.SpatialRecursivePrefixTreeFieldType\"</span>\n\t               <span class=\"hljs-attr\">distErrPct</span>=<span class=\"highlight__hljs-string___1SffY\">\"0.025\"</span>\n\t               <span class=\"hljs-attr\">maxDistErr</span>=<span class=\"highlight__hljs-string___1SffY\">\"0.000009\"</span>\n\t               <span class=\"hljs-attr\">units</span>=<span class=\"highlight__hljs-string___1SffY\">\"degrees\"</span>\n\t            /&gt;</span>\n</code></pre>\n<p>Pretty much everything else is boilerplate so that the Riak Solr integration\nworks.</p>\n<h2 id=\"upload-schema\">Upload Schema</h2>\n<p>We can now upload this schema (I saved the schema above as schema.xml in my\ncurrent directory):</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>curl -i -XPUT http://localhost:8098/search/schema/geotest \\\n  -H <span class=\"highlight__hljs-string___1SffY\">'content-type: application/xml'</span> \\\n  --data-binary @schema.xml\n</code></pre>\n<h2 id=\"create-index\">Create Index</h2>\n<p>…and we create an index named “my_geo_index” which uses the schema (name =\n“geotest”) we just uploaded.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>curl -i -XPUT http://localhost:8098/search/index/my_geo_index \\\n  -H <span class=\"highlight__hljs-string___1SffY\">'content-type: application/json'</span> \\\n  <span class=\"hljs-_\">-d</span> <span class=\"highlight__hljs-string___1SffY\">'{\"schema\":\"geotest\"}'</span>\n</code></pre>\n<p>They should both return 204 responses.</p>\n<h2 id=\"create-bucket-type\">Create Bucket Type</h2>\n<p>Next we’ll create a bucket type named “geo_type” using the <code>riak-admin</code> command.\nOur bucket type won’t have any special properties, it just needs to exist.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>./bin/riak-admin bucket-type create geo_<span class=\"highlight__hljs-built_in___3uuyR\">type</span> <span class=\"highlight__hljs-string___1SffY\">'{\"props\":{}}'</span>\n</code></pre>\n<h2 id=\"activate-bucket-type\">Activate Bucket Type</h2>\n<p>We also need to activate our new bucket type:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>./bin/riak-admin bucket-type activate geo_<span class=\"highlight__hljs-built_in___3uuyR\">type</span>\n</code></pre>\n<h2 id=\"create-bucket\">Create Bucket</h2>\n<p>We will now create a bucket named “stuff” under the <code>geo_type</code> bucket type. In\naddition, this command associates the Solr index <code>my_geo_index</code> with the bucket\n<code>stuff</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>curl -XPUT <span class=\"highlight__hljs-string___1SffY\">'http://localhost:8098/types/geo_type/buckets/stuff/props'</span> \\\n  -H <span class=\"highlight__hljs-string___1SffY\">'content-type: application/json'</span> \\\n  <span class=\"hljs-_\">-d</span> <span class=\"highlight__hljs-string___1SffY\">'{\"props\":{\"search_index\":\"my_geo_index\"}}'</span>\n</code></pre>\n<h2 id=\"indexing-data\">Indexing Data</h2>\n<p>That’s it. Let’s index some data!</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>curl -i -H <span class=\"highlight__hljs-string___1SffY\">'content-type: application/json'</span> -X PUT <span class=\"highlight__hljs-string___1SffY\">'http://localhost:8098/types/geo_type/buckets/stuff/keys/sf'</span> <span class=\"hljs-_\">-d</span> <span class=\"highlight__hljs-string___1SffY\">'{\"name\":\"San Francisco\", \"loc\":\"37.774929,-122.419416\"}'</span>\ncurl -i -H <span class=\"highlight__hljs-string___1SffY\">'content-type: application/json'</span> -X PUT <span class=\"highlight__hljs-string___1SffY\">'http://localhost:8098/types/geo_type/buckets/stuff/keys/sj'</span> <span class=\"hljs-_\">-d</span> <span class=\"highlight__hljs-string___1SffY\">'{\"name\":\"San Jose\", \"loc\":\"37.339386,-121.894955\"}'</span>\ncurl -i -H <span class=\"highlight__hljs-string___1SffY\">'content-type: application/json'</span> -X PUT <span class=\"highlight__hljs-string___1SffY\">'http://localhost:8098/types/geo_type/buckets/stuff/keys/mv'</span> <span class=\"hljs-_\">-d</span> <span class=\"highlight__hljs-string___1SffY\">'{\"name\":\"Mountain View\", \"loc\":\"37.386052,-122.083851\"}'</span>\n</code></pre>\n<h2 id=\"querying\">Querying</h2>\n<p>Now for the fun part. Let’s find all of our data, scored and sorted by distance.\nThe score will return a distance (in degrees). We are querying from a location\nin Palo Alto, California, so we should see fairly small distances to Mountain\nView, San Jose and San Francisco.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>curl <span class=\"highlight__hljs-string___1SffY\">'http://localhost:8098/search/my_geo_index?&amp;fl=*,score&amp;sort=score%20asc&amp;q={!geofilt%20score=distance%20filter=false%20sfield=loc%20pt=37.441883,-122.143019%20d=10}&amp;wt=json'</span>\n</code></pre>\n<p>The query returns the results:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{\n   <span class=\"highlight__hljs-string___1SffY\">\"responseHeader\"</span>:{\n      <span class=\"highlight__hljs-string___1SffY\">\"status\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"QTime\"</span>:<span class=\"highlight__hljs-number___2gmaH\">24</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"params\"</span>:{\n         <span class=\"highlight__hljs-string___1SffY\">\"shards\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"127.0.0.1:8093/solr/my_geo_index\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"sort\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"score asc\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"fl\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"*,score\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"q\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"{!geofilt score=distance filter=false sfield=loc pt=37.441883,-122.143019 d=10}\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"127.0.0.1:8093\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"_yz_pn:64 OR (_yz_pn:61 AND (_yz_fpn:61)) OR _yz_pn:60 OR _yz_pn:57 OR _yz_pn:54 OR _yz_pn:51 OR _yz_pn:48 OR _yz_pn:45 OR _yz_pn:42 OR _yz_pn:39 OR _yz_pn:36 OR _yz_pn:33 OR _yz_pn:30 OR _yz_pn:27 OR _yz_pn:24 OR _yz_pn:21 OR _yz_pn:18 OR _yz_pn:15 OR _yz_pn:12 OR _yz_pn:9 OR _yz_pn:6 OR _yz_pn:3\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"wt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"json\"</span>\n      }\n   },\n   <span class=\"highlight__hljs-string___1SffY\">\"response\"</span>:{\n      <span class=\"highlight__hljs-string___1SffY\">\"numFound\"</span>:<span class=\"highlight__hljs-number___2gmaH\">4</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"start\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"maxScore\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0.39857662</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"docs\"</span>:[\n         {\n            <span class=\"highlight__hljs-string___1SffY\">\"loc\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"37.386052,-122.083851\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"name\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"Mountain View\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"geo_type_stuff_mv_42\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"mv\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"geo_type\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"stuff\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"score\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0.072977245</span>\n         },\n         {\n            <span class=\"highlight__hljs-string___1SffY\">\"loc\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"37.339386,-121.894955\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"name\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"San Jose\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"geo_type_stuff_sj_21\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"sj\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"geo_type\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"stuff\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"score\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0.2221485</span>\n         },\n         {\n            <span class=\"highlight__hljs-string___1SffY\">\"loc\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"37.774929,-122.419416\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"name\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"San Francisco\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"geo_type_stuff_sf_60_MeNonMcIRG8mmdJpk5KfM\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"sf\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"geo_type\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"stuff\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"score\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0.39857662</span>\n         },\n         {\n            <span class=\"highlight__hljs-string___1SffY\">\"loc\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"37.774929,-122.419416\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"name\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"San Francisco\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"geo_type_stuff_sf_60_5n4gT2r1Gt2qlHwfKCwypL\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"sf\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"geo_type\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"stuff\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"score\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0.39857662</span>\n         }\n      ]\n   }\n}\n</code></pre>\n<p>You’ll notice that there are two San Franciscos. This is because I inserted data\ntwice into Riak without using a VClock the second time (While I was writing this\npost), resulting in siblings. This issue is easily resolvable by resolving the\nsiblings as mentioned\n<a href=\"http://docs.basho.com/riak/latest/theory/concepts/Vector-Clocks/\">here</a>.</p>\n<p>Now, we can convert to miles by multiplying the score (which is degrees) by\n<code>69.09341</code>. If we do this for San Jose it would be <code>.2221485 * 69.09341</code>, or\nabout <code>15.34 mi</code>.</p>\n<p>For Kilometers we use <code>111.1951</code>, which gives us about <code>24.7 km</code>.</p>\n<p>Since our query location was from Palo Alto, California, we can see that San\nJose is indeed, approximately that 15 miles away. Our search was successful!</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.21.node.attributes":{"slug":"geospatial-indexing-with-riak-search-2-0-yokozunasolr","__typename":"BlogPostAttributes","title":"GeoSpatial Indexing with Riak Search 2.0 (Yokozuna/Solr)","url":"/2014/2/7/geospatial-indexing-with-riak-search-2-0-yokozunasolr/","excerpt":"In this post we will be using curl to construct a geospatial index using Riak\nSearch 2 (also known as Yokozuna) which is backed by Solr.","updatedAt":"Feb 7th, 2014","timeToRead":7,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.21":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.21.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.22.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.22.node.attributes","generated":true},"body":"<p>In this post we will go over how to accept environmental variables in Haskell.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">import</span> System.Environment\n\n<span class=\"highlight__hljs-title___1fl8Q\">main</span> :: <span class=\"highlight__hljs-type___11WfV\">IO</span> ()\n<span class=\"highlight__hljs-title___1fl8Q\">main</span> = <span class=\"highlight__hljs-keyword___som98\">do</span>\n</code></pre>\n<p>We can compile this if we put it in a file called <code>env.hs</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>ghc env.hs\n</code></pre>\n<p>and run it with an ad-hoc ENV variable:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>myvariable=<span class=\"highlight__hljs-string___1SffY\">\"what\"</span> ./env\n</code></pre>\n<p>Which will print out:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&quot;what&quot;\n</code></pre>\n<p>but this will throw an error if the ENV var doesn’t exist:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>λ ./env\nenv: myvariable: getEnv: does not exist (no environment variable)\n</code></pre>\n<p>To solve that issue we can use <code>lookupEnv</code> with <code>fromMaybe</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">import</span> System.Environment (<span class=\"highlight__hljs-title___1fl8Q\">lookupEnv</span>)\n<span class=\"highlight__hljs-keyword___som98\">import</span> Data.Maybe (<span class=\"highlight__hljs-title___1fl8Q\">fromMaybe</span>)\n\n<span class=\"highlight__hljs-title___1fl8Q\">main</span> :: <span class=\"highlight__hljs-type___11WfV\">IO</span> ()\n<span class=\"highlight__hljs-title___1fl8Q\">main</span> = <span class=\"highlight__hljs-keyword___som98\">do</span>\n</code></pre>\n<p>which will give us a default value when the ENV variable doesn’t exist:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>λ ./env\n<span class=\"highlight__hljs-string___1SffY\">\"mydefaultvalue\"</span>\nλ myvariable=<span class=\"highlight__hljs-string___1SffY\">\"what\"</span> ./env\n<span class=\"highlight__hljs-string___1SffY\">\"what\"</span>\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.22.node.attributes":{"slug":"environment-variables-in-haskell","__typename":"BlogPostAttributes","title":"Environment Variables in Haskell","url":"/2014/2/6/environment-variables-in-haskell/","excerpt":"In this post we will go over how to accept environmental variables in Haskell.","updatedAt":"Feb 6th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.22":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.22.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.23.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.23.node.attributes","generated":true},"body":"<p>So today I tried to write my first fully custom Emacs Lisp code. Here are some things I learned (along with the code for a <code>region-to-gist</code> function).</p>\n<p><a href=\"https://gist.github.com/anonymous/8812412\">Here</a> is my final product, uploaded straight from Emacs.</p>\n<p>The final script looks like this at the bottom of my <code>.emacs</code> file:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;lisp&quot; style=&quot;overflow-x:scroll&quot;&gt;;;; Region to Gist\n(defun region-to-gist ()\n  &quot;Sends region to Gist&quot;\n  (interactive)\n  (if (region-active-p)\n      (gist-req (buffer-substring-no-properties (region-beginning) (region-end))))\n  nil)\n\n(defun gist-test (buf)\n  (message &quot;%S&quot; `(:content ,buf)))\n\n(defun gist-req (buf)\n  (request\n       &quot;https://api.github.com/gists&quot;\n       :type &quot;POST&quot;\n       :data (json-encode `(:description &quot;Created with Christopher Biscardi's region-to-gist&quot;\n                            :public t\n                            :files (:example.el (:content ,buf))))\n       ;; :data &quot;key=value&amp;key2=value2&quot;  ; this is equivalent\n       :parser 'json-read\n       :success (function*\n                 (lambda (&amp;key data &amp;allow-other-keys)\n                   (message &quot;I sent: %S&quot; (assoc-default 'html_url data)))))\n  nil)```\n\nIt is used by setting a mark `C-SPC`, selecting a region (arrow keys work to expand the region) then typing `M-x region-to-gist`. The Function then runs and outputs either an error message (hopefully not) or this to the message buffer:\n\n`&lt;code class=&quot;bash&quot;&gt;I sent: &quot;https://gist.github.com/8812412&quot;`\n\nThe most important part here is the `(interactive)` which allows you to use `M-x region-to-gist` to execute the function. There are a couple different modes you can enable with this.\n\n`region-active-p` basically returns true if there’s a region selection (The `C-SPC` and arrows stuff).\n\n`gist-test` is a function I used to replace the `gist-req` call so I could test whether or not the region was actually being sent and resolve some formatting issues. This function can be wholly deleted with no ramifications.\n\n`buffer-substring-no-properties` returns undecorated strings from your buffers. Use this is you’re trying to handle a string (such as in JSON) and use `buffer-substring` if you’re trying to put something in the kill-ring, etc.\n\nI’m using [request.el](http://tkf.github.io/emacs-request/) to make my request. It tries to use `curl` if available.\n\nThe biggest part of the request code is the `:success` function. In this case we grab the key `html_url` from the [Gist API Response](http://developer.github.com/v3/gists/#create-a-gist)`data`.\n\nThe backtick here:\n\n</code></pre>\n<p><code class=\"haskell\">`(:description “Created with Christopher Biscardi’s region-to-gist”\n:public t\n:files (:example.el (:content ,buf)))```</p>\n<p>means we have to use the <code>,</code> for <code>,buf</code> to get the value of <code>buf</code>.</p>\n<p>Oh, and also, this function should probably be called <code>gist-region</code> as per other region functions. oops.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.23.node.attributes":{"slug":"writing-a-first-emacs-elisp-function","__typename":"BlogPostAttributes","title":"Writing A First Emacs Elisp Function","url":"/2014/2/4/writing-a-first-emacs-elisp-function/","excerpt":"So today I tried to write my first fully custom Emacs Lisp code. Here are some things I learned (along with the code for a region-to-gist…","updatedAt":"Feb 4th, 2014","timeToRead":2,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.23":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.23.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.24.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.24.node.attributes","generated":true},"body":"<p>In this post we will deploy our Snap app to Heroku.</p>\n<p><a href=\"http://www.christopherbiscardi.com/2014/01/07/getting-started-with-snap-and-user-authentication-part-1/\">part 1</a>\n<a href=\"http://www.christopherbiscardi.com/2014/01/10/getting-started-with-snap-and-user-authentication-part-2/\">part 2</a>\n<a href=\"http://www.christopherbiscardi.com/2014/01/11/getting-started-with-snap-and-user-authentication-part-3/\">part 3</a></p>\n<p>First, we need to put a <code>Procfile</code> in the root of our project; Save this as\n<code>Procfile</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>web: cabal run -- -p $PORT\n</code></pre>\n<p>If you’ve been following along and haven’t yet put the code into version\ncontrol, now is the time to do that by running <code>git init</code>, <code>git add</code> and <code>git commit -m &quot;message&quot;</code>.</p>\n<p>This command will create a new Heroku app with a Haskell buildpack. You can find\nmore information on the buildpack\n<a href=\"https://github.com/begriffs/heroku-buildpack-ghc\">here</a></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>heroku create --stack=cedar --buildpack https://github.com/begriffs/heroku-buildpack-ghc.git\n</code></pre>\n<blockquote>\n<p>note: You can now deploy the app to Heroku, but you will get an error about connecting to PostgreSQL</p>\n</blockquote>\n<p>At this point we have two basic choices: We can run PostgreSQL as a Heroku\nextension or we can host PostgreSQL somewhere else. For this example, we’ll\nhosting elsewhere. <code>devel.cfg</code> looks like this:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>host = <span class=\"highlight__hljs-string___1SffY\">\"localhost\"</span>\nport = <span class=\"highlight__hljs-number___2gmaH\">5432</span>\nuser = <span class=\"highlight__hljs-string___1SffY\">\"postgres\"</span>\npass = <span class=\"highlight__hljs-string___1SffY\">\"\"</span>\ndb = <span class=\"highlight__hljs-string___1SffY\">\"testdb\"</span>\n\n<span class=\"highlight__hljs-comment___UYk12\"># Nmuber of distinct connection pools to maintain.  The smallest acceptable</span>\n<span class=\"highlight__hljs-comment___UYk12\"># value is 1.</span>\nnumStripes = <span class=\"highlight__hljs-number___2gmaH\">1</span>\n\n<span class=\"highlight__hljs-comment___UYk12\"># Number of seconds an unused resource is kept open.  The smallest acceptable</span>\n<span class=\"highlight__hljs-comment___UYk12\"># value is 0.5 seconds.</span>\nidleTime = <span class=\"highlight__hljs-number___2gmaH\">5</span>\n\n<span class=\"highlight__hljs-comment___UYk12\"># Maximum number of resources to keep open per stripe.  The smallest</span>\n<span class=\"highlight__hljs-comment___UYk12\"># acceptable value is 1.</span>\nmaxResourcesPerStripe = <span class=\"highlight__hljs-number___2gmaH\">20</span>\n</code></pre>\n<p>The final option is to just host PostgreSQL somewhere other than Heroku and\nmodify the config file to point there.</p>\n<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611521/CBLogo_2014_transparent_swcmig.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/h_300,w_300/v1428611521/CBLogo_2014_transparent_swcmig.png\" alt=\"CBLogo_2014_transparent\"></a></p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.24.node.attributes":{"slug":"deploy-haskells-snap-on-heroku","__typename":"BlogPostAttributes","title":"Deploy Haskell's Snap on Heroku","url":"/2014/2/2/deploy-haskells-snap-on-heroku/","excerpt":"In this post we will deploy our Snap app to Heroku.","updatedAt":"Feb 2nd, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.24":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.24.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.25.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.25.node.attributes","generated":true},"body":"<p>In this post are the beginnings of riak-solr-client.</p>\n<p>First, we need to take a look at the response from Solr/Yokozuna/Riak-Search-2 for a single query. In this case, the database only holds two records and we are doing a query that matches all results (<code>*:*</code>).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{\n   <span class=\"highlight__hljs-string___1SffY\">\"responseHeader\"</span>:{\n      <span class=\"highlight__hljs-string___1SffY\">\"status\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"QTime\"</span>:<span class=\"highlight__hljs-number___2gmaH\">11</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"params\"</span>:{\n         <span class=\"highlight__hljs-string___1SffY\">\"shards\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"127.0.0.1:8093/solr/my_index\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"q\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"*:*\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"127.0.0.1:8093\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"_yz_pn:64 OR (_yz_pn:61 AND (_yz_fpn:61)) OR _yz_pn:60 OR _yz_pn:57 OR _yz_pn:54 OR _yz_pn:51 OR _yz_pn:48 OR _yz_pn:45 OR _yz_pn:42 OR _yz_pn:39 OR _yz_pn:36 OR _yz_pn:33 OR _yz_pn:30 OR _yz_pn:27 OR _yz_pn:24 OR _yz_pn:21 OR _yz_pn:18 OR _yz_pn:15 OR _yz_pn:12 OR _yz_pn:9 OR _yz_pn:6 OR _yz_pn:3\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"wt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"json\"</span>\n      }\n   },\n   <span class=\"highlight__hljs-string___1SffY\">\"response\"</span>:{\n      <span class=\"highlight__hljs-string___1SffY\">\"numFound\"</span>:<span class=\"highlight__hljs-number___2gmaH\">2</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"start\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"maxScore\"</span>:<span class=\"highlight__hljs-number___2gmaH\">1.0</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"docs\"</span>:[\n         {\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"data_my_bucket_name_12\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"name\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"data\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"my_bucket\"</span>\n         },\n         {\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"data_my_bucket_second_15\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"second\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"data\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"my_bucket\"</span>\n         }\n      ]\n   }\n}\n</code></pre>\n<p>As you can see, I’ve decided to retrieve JSON because of my familiarity with\nData.Aeson. There is no set schema for Solr responses, so we’re going to have to\ntest this fairly well to make a generic library that will be updated over time\nas Solr updates.</p>\n<p>With the sample response in mind, we can start to create the datatypes:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">newtype</span> <span class=\"highlight__hljs-type___11WfV\">Params</span> = <span class=\"highlight__hljs-type___11WfV\">Params</span> (<span class=\"highlight__hljs-type___11WfV\">Map</span> <span class=\"highlight__hljs-type___11WfV\">String</span> <span class=\"highlight__hljs-type___11WfV\">String</span>) <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> = <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">status</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">qTime</span>  :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">params</span> :: <span class=\"highlight__hljs-type___11WfV\">Params</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">Docs</span> = <span class=\"highlight__hljs-type___11WfV\">Docs</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_id</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rk</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rt</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rb</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">Results</span> = <span class=\"highlight__hljs-type___11WfV\">Results</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">numFound</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">start</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">maxScore</span> :: <span class=\"highlight__hljs-type___11WfV\">Float</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">docs</span> :: [<span class=\"highlight__hljs-type___11WfV\">Docs</span>]\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> = <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">responseHeader</span> :: <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">response</span> :: <span class=\"highlight__hljs-type___11WfV\">Results</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n</code></pre>\n<p>The most interesting part of this is <code>Params</code>. We’ve defined <code>Params</code> as a\n<code>newtype</code> for a <code>Data.Map</code> because, making an educated guess, the keys for\nparams won’t always be the same. We can reach this conclusion by seeing that one\nof the keys is an IP address (with a port number).</p>\n<p>Another interesting piece of the response is the <code>Docs</code>. Solr seems to return\nthe id in Solr (<code>_yz</code> is presumably for _yokozuna), the Riak Key (<code>_yz_rk</code>), the\nRiak Bucket Type <code>_yz_rt</code> and the Riak Bucket (<code>_yz_rb</code>). This is useful\ninformation because we will need to use riak-haskell-client (or more likely an\nupdated fork for Riak 2.0) to retrieve the actual data.</p>\n<p>We can now write some JSON instances and basic http code to test. Here is the\nfull file:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"hljs-meta\">{-# LANGUAGE OverloadedStrings #-}</span>\n<span class=\"highlight__hljs-keyword___som98\">import</span> Data.Aeson\n<span class=\"highlight__hljs-keyword___som98\">import</span> Data.Map\n<span class=\"highlight__hljs-keyword___som98\">import</span> Control.Applicative\n<span class=\"highlight__hljs-keyword___som98\">import</span> Control.Monad (<span class=\"highlight__hljs-title___1fl8Q\">mzero</span>)\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> Network.HTTP.Conduit <span class=\"highlight__hljs-comment___UYk12\">-- the main module</span>\n\n<span class=\"highlight__hljs-comment___UYk12\">-- The streaming interface uses conduits</span>\n<span class=\"highlight__hljs-keyword___som98\">import</span> Data.Conduit\n<span class=\"highlight__hljs-keyword___som98\">import</span> Data.Conduit.Binary (<span class=\"highlight__hljs-title___1fl8Q\">sinkFile</span>)\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> <span class=\"highlight__hljs-keyword___som98\">qualified</span> Data.ByteString.Lazy.Char8 <span class=\"highlight__hljs-keyword___som98\">as</span> L\n<span class=\"highlight__hljs-keyword___som98\">import</span> Control.Monad.IO.Class (<span class=\"highlight__hljs-title___1fl8Q\">liftIO</span>)\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">newtype</span> <span class=\"highlight__hljs-type___11WfV\">Params</span> = <span class=\"highlight__hljs-type___11WfV\">Params</span> (<span class=\"highlight__hljs-type___11WfV\">Map</span> <span class=\"highlight__hljs-type___11WfV\">String</span> <span class=\"highlight__hljs-type___11WfV\">String</span>) <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> <span class=\"highlight__hljs-type___11WfV\">Params</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseJSON val = <span class=\"highlight__hljs-type___11WfV\">Params</span>  parseJSON val\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> = <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">status</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">qTime</span>  :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">params</span> :: <span class=\"highlight__hljs-type___11WfV\">Params</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseJSON (<span class=\"highlight__hljs-type___11WfV\">Object</span> o) = <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span>  o .: <span class=\"highlight__hljs-string___1SffY\">\"status\"</span>\n                                         o .: <span class=\"highlight__hljs-string___1SffY\">\"QTime\"</span>\n                                         o .: <span class=\"highlight__hljs-string___1SffY\">\"params\"</span>\n  parseJSON _ = mzero\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">Docs</span> = <span class=\"highlight__hljs-type___11WfV\">Docs</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_id</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rk</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rt</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">_yz_rb</span> :: <span class=\"highlight__hljs-type___11WfV\">String</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> <span class=\"highlight__hljs-type___11WfV\">Docs</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseJSON (<span class=\"highlight__hljs-type___11WfV\">Object</span> o) = <span class=\"highlight__hljs-type___11WfV\">Docs</span>  o .: <span class=\"highlight__hljs-string___1SffY\">\"_yz_id\"</span>\n                               o .: <span class=\"highlight__hljs-string___1SffY\">\"_yz_rk\"</span>\n                               o .: <span class=\"highlight__hljs-string___1SffY\">\"_yz_rt\"</span>\n                               o .: <span class=\"highlight__hljs-string___1SffY\">\"_yz_rb\"</span>\n  parseJSON _ = mzero\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">Results</span> = <span class=\"highlight__hljs-type___11WfV\">Results</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">numFound</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">start</span> :: <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">maxScore</span> :: <span class=\"highlight__hljs-type___11WfV\">Float</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">docs</span> :: [<span class=\"highlight__hljs-type___11WfV\">Docs</span>]\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> <span class=\"highlight__hljs-type___11WfV\">Results</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseJSON (<span class=\"highlight__hljs-type___11WfV\">Object</span> o) = <span class=\"highlight__hljs-type___11WfV\">Results</span>  o .: <span class=\"highlight__hljs-string___1SffY\">\"numFound\"</span>\n                                  o .: <span class=\"highlight__hljs-string___1SffY\">\"start\"</span>\n                                  o .: <span class=\"highlight__hljs-string___1SffY\">\"maxScore\"</span>\n                                  o .: <span class=\"highlight__hljs-string___1SffY\">\"docs\"</span>\n  parseJSON _ = mzero\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> = <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> {\n  <span class=\"highlight__hljs-title___1fl8Q\">responseHeader</span> :: <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span>,\n  <span class=\"highlight__hljs-title___1fl8Q\">response</span> :: <span class=\"highlight__hljs-type___11WfV\">Results</span>\n} <span class=\"highlight__hljs-keyword___som98\">deriving</span> (<span class=\"highlight__hljs-type___11WfV\">Show</span>)</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseJSON (<span class=\"highlight__hljs-type___11WfV\">Object</span> o) = <span class=\"highlight__hljs-type___11WfV\">SolrResponse</span>  o .: <span class=\"highlight__hljs-string___1SffY\">\"responseHeader\"</span>\n                                       o .: <span class=\"highlight__hljs-string___1SffY\">\"response\"</span>\n  parseJSON _ = mzero\n\n<span class=\"highlight__hljs-title___1fl8Q\">main</span> :: <span class=\"highlight__hljs-type___11WfV\">IO</span> ()\n<span class=\"highlight__hljs-title___1fl8Q\">main</span> = <span class=\"highlight__hljs-keyword___som98\">do</span>\n</code></pre>\n<p>and running <code>main</code> in ghci gives us:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">Just</span> (<span class=\"highlight__hljs-type___11WfV\">SolrResponse</span> {responseHeader = <span class=\"highlight__hljs-type___11WfV\">ResponseHeader</span> {status = <span class=\"highlight__hljs-number___2gmaH\">0</span>, qTime = <span class=\"highlight__hljs-number___2gmaH\">8</span>, params = <span class=\"highlight__hljs-type___11WfV\">Params</span> (fromList [(<span class=\"highlight__hljs-string___1SffY\">\"127.0.0.1:8093\"</span>,<span class=\"highlight__hljs-string___1SffY\">\"_yz_pn:63 OR (_yz_pn:60 AND (_yz_fpn:60)) OR _yz_pn:59 OR _yz_pn:56 OR _yz_pn:53 OR _yz_pn:50 OR _yz_pn:47 OR _yz_pn:44 OR _yz_pn:41 OR _yz_pn:38 OR _yz_pn:35 OR _yz_pn:32 OR _yz_pn:29 OR _yz_pn:26 OR _yz_pn:23 OR _yz_pn:20 OR _yz_pn:17 OR _yz_pn:14 OR _yz_pn:11 OR _yz_pn:8 OR _yz_pn:5 OR _yz_pn:2\"</span>),(<span class=\"highlight__hljs-string___1SffY\">\"q\"</span>,<span class=\"highlight__hljs-string___1SffY\">\"*:*\"</span>),(<span class=\"highlight__hljs-string___1SffY\">\"shards\"</span>,<span class=\"highlight__hljs-string___1SffY\">\"127.0.0.1:8093/solr/my_index\"</span>),(<span class=\"highlight__hljs-string___1SffY\">\"wt\"</span>,<span class=\"highlight__hljs-string___1SffY\">\"json\"</span>)])}, response = <span class=\"highlight__hljs-type___11WfV\">Results</span> {numFound = <span class=\"highlight__hljs-number___2gmaH\">2</span>, start = <span class=\"highlight__hljs-number___2gmaH\">0</span>, maxScore = <span class=\"highlight__hljs-number___2gmaH\">1.0</span>, docs = [<span class=\"highlight__hljs-type___11WfV\">Docs</span> {_yz_id = <span class=\"highlight__hljs-string___1SffY\">\"data_my_bucket_name_11\"</span>, _yz_rk = <span class=\"highlight__hljs-string___1SffY\">\"name\"</span>, _yz_rt = <span class=\"highlight__hljs-string___1SffY\">\"data\"</span>, _yz_rb = <span class=\"highlight__hljs-string___1SffY\">\"my_bucket\"</span>},<span class=\"highlight__hljs-type___11WfV\">Docs</span> {_yz_id = <span class=\"highlight__hljs-string___1SffY\">\"data_my_bucket_second_14\"</span>, _yz_rk = <span class=\"highlight__hljs-string___1SffY\">\"second\"</span>, _yz_rt = <span class=\"highlight__hljs-string___1SffY\">\"data\"</span>, _yz_rb = <span class=\"highlight__hljs-string___1SffY\">\"my_bucket\"</span>}]}})\n</code></pre>\n<p>Success!</p>\n<p>This is just a small start. Hopefully I’ll be able to build this out a bit more\n(two changes of note will be usage of <code>http-streams</code> and <code>Lens</code>) and write a\nsnaplet that integrates well with <a href=\"https://github.com/ChristopherBiscardi/snaplet-riak-2\">this Riak\nSnaplet</a> in a more\ngeneric fashion.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.25.node.attributes":{"slug":"in-search-of-a-riak-solr-client-for-haskell","__typename":"BlogPostAttributes","title":"In Search of a Riak Solr Client for Haskell","url":"/2014/2/1/in-search-of-a-riak-solr-client-for-haskell/","excerpt":"In this post are the beginnings of riak-solr-client.","updatedAt":"Feb 1st, 2014","timeToRead":5,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.25":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.25.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.26.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.26.node.attributes","generated":true},"body":"<p>In this post we are going to add a ListFragment backed by the RoboSpice data\nfrom the <a href=\"http://www.christopherbiscardi.com/2014/01/27/android-robospice-with-googlehttpclient/\">first\npost</a></p>\n<p>The git repo is\n<a href=\"https://github.com/ChristopherBiscardi/robospice-googlehttpclient-example/tree/8f64ab7d761d095737811018624b0da31b6e4b7b\">here</a>.</p>\n<p>Firstly, we are going to need to bump the sdk version to 11 in\n<code>AndroidManifest.xml</code>. We could use the support version of the Fragment api, but\nin this instance we don’t need to.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">uses-sdk</span>\n        <span class=\"hljs-attr\">android:minSdkVersion</span>=<span class=\"highlight__hljs-string___1SffY\">\"11\"</span>\n        <span class=\"hljs-attr\">android:targetSdkVersion</span>=<span class=\"highlight__hljs-string___1SffY\">\"17\"</span> /&gt;</span>\n</code></pre>\n<p>Then we’ll create a RedditListFragment by extending ListFragment:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">RedditListFragment</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">ListFragment</span> </span>{\n\n    <span class=\"hljs-meta\">@Override</span>\n    <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-keyword___som98\">void</span> <span class=\"highlight__hljs-title___1fl8Q\">onListItemClick</span><span class=\"hljs-params\">(ListView l, View v, <span class=\"highlight__hljs-keyword___som98\">int</span> position, <span class=\"highlight__hljs-keyword___som98\">long</span> id)</span> </span>{\n        Log.e(<span class=\"highlight__hljs-string___1SffY\">\"RedditListingsClick\"</span>,position + <span class=\"highlight__hljs-string___1SffY\">\" \"</span> + id);\n    }\n\n    <span class=\"hljs-meta\">@Override</span>\n    <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> View <span class=\"highlight__hljs-title___1fl8Q\">onCreateView</span><span class=\"hljs-params\">(LayoutInflater inflater, ViewGroup container,\n            Bundle savedInstanceState)</span> </span>{\n        ArrayList&lt;redditchild&gt; redditChildren = <span class=\"highlight__hljs-keyword___som98\">new</span> ArrayList&lt;redditchild&gt;();\n        RedditChildAdapter adapter = <span class=\"highlight__hljs-keyword___som98\">new</span> RedditChildAdapter(inflater.getContext(), redditChildren);\n        setListAdapter(adapter);\n        <span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-keyword___som98\">super</span>.onCreateView(inflater, container, savedInstanceState);\n    }\n}&lt;/redditchild&gt;&lt;/redditchild&gt;\n</code></pre>\n<p>Notably, we have it set to log out the position of taps to LogCat and we set a\nnew adapter (with empty content) for the ListView.</p>\n<h4 id=\"item-reddit-listingxml\">item_reddit_listing.xml</h4>\n<p>We also need an item layout to display our data. We use a simple <code>LinearLayout</code>\nwith vertical alignment and some sensible margins to arrange our three\n<code>TextView</code>s. We set some stylistic effects (color, bold/italics) on our\n<code>TextView</code>s to make the display a little nicer.</p>\n<p>Of note is the <code>android:id</code> fields. We will use these in our adapter to identify\neach <code>TextView</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">LinearLayout</span> <span class=\"hljs-attr\">xmlns:android</span>=<span class=\"highlight__hljs-string___1SffY\">\"http://schemas.android.com/apk/res/android\"</span>\n    <span class=\"hljs-attr\">android:layout_width</span>=<span class=\"highlight__hljs-string___1SffY\">\"fill_parent\"</span>\n    <span class=\"hljs-attr\">android:layout_height</span>=<span class=\"highlight__hljs-string___1SffY\">\"fill_parent\"</span>\n    <span class=\"hljs-attr\">android:background</span>=<span class=\"highlight__hljs-string___1SffY\">\"#EDEDED\"</span>\n    <span class=\"hljs-attr\">android:orientation</span>=<span class=\"highlight__hljs-string___1SffY\">\"vertical\"</span>\n    <span class=\"hljs-attr\">android:paddingBottom</span>=<span class=\"highlight__hljs-string___1SffY\">\"10dp\"</span>\n    <span class=\"hljs-attr\">android:paddingLeft</span>=<span class=\"highlight__hljs-string___1SffY\">\"20dp\"</span>\n    <span class=\"hljs-attr\">android:paddingRight</span>=<span class=\"highlight__hljs-string___1SffY\">\"20dp\"</span>\n    <span class=\"hljs-attr\">android:paddingTop</span>=<span class=\"highlight__hljs-string___1SffY\">\"10dp\"</span> &gt;</span>\n\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">TextView</span>\n        <span class=\"hljs-attr\">android:id</span>=<span class=\"highlight__hljs-string___1SffY\">\"@+id/rTitle\"</span>\n        <span class=\"hljs-attr\">android:layout_width</span>=<span class=\"highlight__hljs-string___1SffY\">\"wrap_content\"</span>\n        <span class=\"hljs-attr\">android:layout_height</span>=<span class=\"highlight__hljs-string___1SffY\">\"wrap_content\"</span>\n        <span class=\"hljs-attr\">android:textColor</span>=<span class=\"highlight__hljs-string___1SffY\">\"#454545\"</span>\n        <span class=\"hljs-attr\">android:textStyle</span>=<span class=\"highlight__hljs-string___1SffY\">\"bold\"</span> /&gt;</span>\n\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">TextView</span>\n        <span class=\"hljs-attr\">android:id</span>=<span class=\"highlight__hljs-string___1SffY\">\"@+id/rAuthor\"</span>\n        <span class=\"hljs-attr\">android:layout_width</span>=<span class=\"highlight__hljs-string___1SffY\">\"wrap_content\"</span>\n        <span class=\"hljs-attr\">android:layout_height</span>=<span class=\"highlight__hljs-string___1SffY\">\"wrap_content\"</span>\n        <span class=\"hljs-attr\">android:textColor</span>=<span class=\"highlight__hljs-string___1SffY\">\"#acacac\"</span>\n        <span class=\"hljs-attr\">android:textStyle</span>=<span class=\"highlight__hljs-string___1SffY\">\"italic\"</span> /&gt;</span>\n\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">TextView</span>\n        <span class=\"hljs-attr\">android:id</span>=<span class=\"highlight__hljs-string___1SffY\">\"@+id/rDomain\"</span>\n        <span class=\"hljs-attr\">android:layout_width</span>=<span class=\"highlight__hljs-string___1SffY\">\"wrap_content\"</span>\n        <span class=\"hljs-attr\">android:layout_height</span>=<span class=\"highlight__hljs-string___1SffY\">\"wrap_content\"</span>\n        <span class=\"hljs-attr\">android:textColor</span>=<span class=\"highlight__hljs-string___1SffY\">\"#acacac\"</span> /&gt;</span>\n\n<span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">LinearLayout</span>&gt;</span>\n</code></pre>\n<h4 id=\"redditchildadapter\">RedditChildAdapter</h4>\n<p>Next we need to extend an adapter to map the data we get from RoboSpice to the\n<code>item_reddit_listing.xml</code> layout.</p>\n<p>Notably, we are using the ViewHolder pattern for performance and using\n<code>child.getData()</code> to get at each <code>RedditListing</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">package</span> com.christopherbiscardi.robospicetest.lists;\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> java.util.ArrayList;\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> com.christopherbiscardi.robospicetest.R;\n<span class=\"highlight__hljs-keyword___som98\">import</span> com.christopherbiscardi.robospicetest.RedditChild;\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> android.content.Context;\n<span class=\"highlight__hljs-keyword___som98\">import</span> android.view.LayoutInflater;\n<span class=\"highlight__hljs-keyword___som98\">import</span> android.view.View;\n<span class=\"highlight__hljs-keyword___som98\">import</span> android.view.ViewGroup;\n<span class=\"highlight__hljs-keyword___som98\">import</span> android.widget.ArrayAdapter;\n<span class=\"highlight__hljs-keyword___som98\">import</span> android.widget.TextView;\n\n<span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">RedditChildAdapter</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">ArrayAdapter</span>&lt;<span class=\"highlight__hljs-title___1fl8Q\">redditchild</span>&gt; </span>{\n    <span class=\"highlight__hljs-keyword___som98\">private</span> <span class=\"highlight__hljs-keyword___som98\">static</span> <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">ViewHolder</span> </span>{\n        TextView title;\n        TextView author;\n        TextView domain;\n    }\n\n    <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-title___1fl8Q\">RedditChildAdapter</span><span class=\"hljs-params\">(Context context, ArrayList&lt;redditchild&gt; redditChildren)</span> </span>{\n        <span class=\"highlight__hljs-keyword___som98\">super</span>(context, R.layout.item_reddit_listing, redditChildren);\n    }\n\n    <span class=\"hljs-meta\">@Override</span>\n    <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> View <span class=\"highlight__hljs-title___1fl8Q\">getView</span><span class=\"hljs-params\">(<span class=\"highlight__hljs-keyword___som98\">int</span> position, View convertView, ViewGroup parent)</span> </span>{\n        <span class=\"highlight__hljs-comment___UYk12\">// Get the data item for this position</span>\n        RedditChild child = getItem(position);\n        <span class=\"highlight__hljs-comment___UYk12\">// Check if an existing view is being reused, otherwise inflate the view</span>\n           ViewHolder viewHolder; <span class=\"highlight__hljs-comment___UYk12\">// view lookup cache stored in tag</span>\n           <span class=\"highlight__hljs-keyword___som98\">if</span> (convertView == <span class=\"highlight__hljs-keyword___som98\">null</span>) {\n              viewHolder = <span class=\"highlight__hljs-keyword___som98\">new</span> ViewHolder();\n              LayoutInflater inflater = LayoutInflater.from(getContext());\n              convertView = inflater.inflate(R.layout.item_reddit_listing, <span class=\"highlight__hljs-keyword___som98\">null</span>);\n              viewHolder.title = (TextView) convertView.findViewById(R.id.rTitle);\n              viewHolder.author = (TextView) convertView.findViewById(R.id.rAuthor);\n              viewHolder.domain = (TextView) convertView.findViewById(R.id.rDomain);\n              convertView.setTag(viewHolder);\n           } <span class=\"highlight__hljs-keyword___som98\">else</span> {\n               viewHolder = (ViewHolder) convertView.getTag();\n           }\n           <span class=\"highlight__hljs-comment___UYk12\">// Populate the data into the template view using the data object</span>\n           viewHolder.title.setText(child.getData().getTitle());\n           viewHolder.author.setText(child.getData().getAuthor());\n           viewHolder.domain.setText(child.getData().getDomain());\n           <span class=\"highlight__hljs-comment___UYk12\">// Return the completed view to render on screen</span>\n           <span class=\"highlight__hljs-keyword___som98\">return</span> convertView;\n    }\n}\n&lt;/redditchild&gt;&lt;/redditchild&gt;\n</code></pre>\n<h4 id=\"mainactivityjava\">MainActivity.java</h4>\n<p>Finally, in <code>MainActivity.java</code>:</p>\n<p>Add a RedditListFragment to the view using FragmentManager:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">protected</span> <span class=\"highlight__hljs-keyword___som98\">void</span> <span class=\"highlight__hljs-title___1fl8Q\">onCreate</span><span class=\"hljs-params\">(Bundle savedInstanceState)</span> </span>{\n    <span class=\"highlight__hljs-keyword___som98\">super</span>.onCreate(savedInstanceState);\n    setContentView(R.layout.activity_main);\n\n    FragmentManager fm = getFragmentManager();\n\n    <span class=\"highlight__hljs-keyword___som98\">if</span> (fm.findFragmentById(android.R.id.content) == <span class=\"highlight__hljs-keyword___som98\">null</span>) {\n        RedditListFragment list = <span class=\"highlight__hljs-keyword___som98\">new</span> RedditListFragment();\n        fm.beginTransaction().add(android.R.id.content, list).commit();\n    }\n    spiceRequestReddit = <span class=\"highlight__hljs-keyword___som98\">new</span> SpiceRequestReddit( <span class=\"highlight__hljs-string___1SffY\">\"Riak\"</span> );\n}\n</code></pre>\n<p>Then in our Request Listener add the data to the ListFragment Adapter:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-keyword___som98\">void</span> <span class=\"highlight__hljs-title___1fl8Q\">onRequestSuccess</span><span class=\"hljs-params\">( <span class=\"highlight__hljs-keyword___som98\">final</span> Reddit result )</span> </span>{\n    Toast.makeText( MainActivity.<span class=\"highlight__hljs-keyword___som98\">this</span>, <span class=\"highlight__hljs-string___1SffY\">\"success\"</span>, Toast.LENGTH_SHORT ).show();\n    Log.e(<span class=\"highlight__hljs-string___1SffY\">\"TEST\"</span>,result.toString());\n    Log.e(<span class=\"highlight__hljs-string___1SffY\">\"TEST\"</span>,result.getData().getChildren().get(<span class=\"highlight__hljs-number___2gmaH\">0</span>).getData().getTitle());\n\n    ListView listView = (ListView) findViewById(android.R.id.list);\n    RedditChildAdapter adapter = (RedditChildAdapter) listView.getAdapter();\n    adapter.clear();\n    adapter.addAll(result.getData().getChildren());\n\n}\n</code></pre>\n<p>At this point we’re good to go. Fire up the app and you should see something\nsimilar to this:</p>\n<figure class=\"wp-caption aligncenter\" id=\"attachment_448\" style=\"width: 187px;\">[![Screenshot of the sample Reddit app](http://res.cloudinary.com/diqzbm8lz/image/upload/h_300,w_188/v1428611518/Screenshot_2014-01-27-16-44-50_njyscb.png)](http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611518/Screenshot_2014-01-27-16-44-50_njyscb.png)<figcaption class=\"wp-caption-text\">Screenshot of the sample Reddit app</figcaption></figure>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.26.node.attributes":{"slug":"android-listfragment-populated-by-robospice","__typename":"BlogPostAttributes","title":"Android ListFragment Populated by RoboSpice","url":"/2014/1/28/android-listfragment-populated-by-robospice/","excerpt":"In this post we are going to add a ListFragment backed by the RoboSpice data\nfrom the first\npost","updatedAt":"Jan 28th, 2014","timeToRead":4,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.26":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.26.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.27.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.27.node.attributes","generated":true},"body":"<p>In this post we will examine an example app in which we make a RoboSpice request\nusing GoogleHttpClient.</p>\n<p>The github repo is\n<a href=\"https://github.com/ChristopherBiscardi/robospice-googlehttpclient-example\">here</a>.</p>\n<h2 id=\"dependencies\">Dependencies</h2>\n<p>First, we need to grab the RoboSpice dependency JARs from the <code>repository</code> repo.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>git <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/octo-online/robospice/tree/repository\n</code></pre>\n<p>Inside of\n<a href=\"https://github.com/octo-online/robospice/tree/repository/dependencies/1.4.11/robospice-google-http-client\">1.4.11/robospice-google-http-client</a>\nare the JARs we need to include in the project. If you are using Eclipse copy\nthe JARs into your <code>libs/</code> folder and add them to the build path in <code>Project -&gt; Properties -&gt; Libraries</code> by clicking <code>Add JARs</code>. You may also need to click the\n<code>Order and Export</code> tab, check their boxes and move the included JARs to the top.</p>\n<p>We will also need one JAR from the Google-Http-Lib\n<a href=\"https://code.google.com/p/google-http-java-client/wiki/Setup#Download_Library_with_Dependencies\">source</a>.\nIt is <code>google-http-client-1.17.0</code>. Again, if using Eclipse, add it to your\nproject in the same way.</p>\n<h2 id=\"classes\">Classes</h2>\n<p>We are going to create a few files:</p>\n<ul>\n<li><a href=\"#spice-base\">BaseSpiceActivity.java</a></li>\n<li><a href=\"#spice-reddit\">Reddit*.java</a></li>\n<li><a href=\"#spice-request-reddit\">SpiceRequestReddit.java</a></li>\n</ul>\n<h4 id=\"basespiceactivity\">BaseSpiceActivity</h4>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">import</span> com.octo.android.robospice.JacksonGoogleHttpClientSpiceService;\n<span class=\"highlight__hljs-keyword___som98\">import</span> com.octo.android.robospice.SpiceManager;\n\n<span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">BaseSpiceActivity</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">Activity</span> </span>{\n\t<span class=\"highlight__hljs-keyword___som98\">private</span> SpiceManager spiceManager = <span class=\"highlight__hljs-keyword___som98\">new</span> SpiceManager(JacksonGoogleHttpClientSpiceService.class);\n\n\t<span class=\"hljs-meta\">@Override</span>\n\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">protected</span> <span class=\"highlight__hljs-keyword___som98\">void</span> <span class=\"highlight__hljs-title___1fl8Q\">onStart</span><span class=\"hljs-params\">()</span> </span>{\n\t\tspiceManager.start(<span class=\"highlight__hljs-keyword___som98\">this</span>);\n\t\t<span class=\"highlight__hljs-keyword___som98\">super</span>.onStart();\n\t}\n\n\t<span class=\"hljs-meta\">@Override</span>\n\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">protected</span> <span class=\"highlight__hljs-keyword___som98\">void</span> <span class=\"highlight__hljs-title___1fl8Q\">onStop</span><span class=\"hljs-params\">()</span> </span>{\n\t\tspiceManager.shouldStop();\n\t\t<span class=\"highlight__hljs-keyword___som98\">super</span>.onStop();\n\t}\n\n\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">protected</span> SpiceManager <span class=\"highlight__hljs-title___1fl8Q\">getSpiceManager</span><span class=\"hljs-params\">()</span> </span>{\n\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> spiceManager;\n\t}\n\n}\n</code></pre>\n<p>The big thing we’re doing in this file is creating an instance of <code>SpiceManager</code>\nthat will be accessible in the activities that inherit from this base class\n(like our <code>MainActivity.java</code> will).</p>\n<p>We then start <code>spiceManager</code> in <code>onStart()</code> and stop it in <code>onStop</code>. This will\nensure that our activities have a <code>SpiceManager</code> accessible when they start and\nclean up after themselves when they stop.</p>\n<p>The final piece is a getter function (<code>getSpiceManager()</code>) so that we have easy\naccess to the <code>spiceManager</code> in our activities.</p>\n<h4 id=\"redditjava\">Reddit*.java</h4>\n<p>We will be getting our data from Reddit, so we first need to examine the\nresponses we’re going to get. I’ve chosen a subreddit where all the posts are\nvery similar (/r/Riak). Here is a sample API response:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{\n   <span class=\"highlight__hljs-string___1SffY\">\"kind\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"Listing\"</span>,\n   <span class=\"highlight__hljs-string___1SffY\">\"data\"</span>:{\n      <span class=\"highlight__hljs-string___1SffY\">\"modhash\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"3mxugaulcd1f8b500be09\"</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"children\"</span>:[\n         {\n            <span class=\"highlight__hljs-string___1SffY\">\"kind\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"t3\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"data\"</span>:{\n               <span class=\"highlight__hljs-string___1SffY\">\"domain\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"github.com\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"banned_by\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"media_embed\"</span>:{\n\n               },\n               <span class=\"highlight__hljs-string___1SffY\">\"subreddit\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"Riak\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"selftext_html\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"selftext\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"likes\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"secure_media\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"link_flair_text\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"id\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"19v60r\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"secure_media_embed\"</span>:{\n\n               },\n               <span class=\"highlight__hljs-string___1SffY\">\"clicked\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">false</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"stickied\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">false</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"author\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"BonzoESC\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"media\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"score\"</span>:<span class=\"highlight__hljs-number___2gmaH\">1</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"approved_by\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"over_18\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">false</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"hidden\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">false</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"thumbnail\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"subreddit_id\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"t5_2s3vw\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"edited\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">false</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"link_flair_css_class\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"author_flair_css_class\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"downs\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"saved\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">false</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"is_self\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">false</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"permalink\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"/r/Riak..riak/\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"name\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"t3_19v60r\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"created\"</span>:<span class=\"highlight__hljs-number___2gmaH\">1362687827.0</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"url\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"https://github.com/basho/riak_dt\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"author_flair_text\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"title\"</span>:<span class=\"highlight__hljs-string___1SffY\">\"riak_dt: CRDT for Riak\"</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"created_utc\"</span>:<span class=\"highlight__hljs-number___2gmaH\">1362687827.0</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"ups\"</span>:<span class=\"highlight__hljs-number___2gmaH\">1</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"num_comments\"</span>:<span class=\"highlight__hljs-number___2gmaH\">0</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"visited\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">false</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"num_reports\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n               <span class=\"highlight__hljs-string___1SffY\">\"distinguished\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>\n            }\n         }\n      ],\n      <span class=\"highlight__hljs-string___1SffY\">\"after\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"before\"</span>:<span class=\"highlight__hljs-literal___1V6TY\">null</span>\n   }\n}\n</code></pre>\n<p>We will create a few classes to model the data. The first being <code>Reddit.java</code>.</p>\n<p>In <code>Reddit.java</code> we include the keys <code>kind</code> and <code>data</code> using <code>@Key</code>\ndeclarations. Then we declare their types.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">package</span> com.christopherbiscardi.robospicetest;\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> com.google.api.client.util.Key;\n\n<span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">Reddit</span> </span>{\n\t<span class=\"hljs-meta\">@Key</span>\n\t<span class=\"highlight__hljs-keyword___som98\">private</span> String kind;\n\t<span class=\"hljs-meta\">@Key</span>\n\t<span class=\"highlight__hljs-keyword___som98\">private</span> RedditData data;\n\n\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-title___1fl8Q\">Reddit</span><span class=\"hljs-params\">()</span> </span>{\n\t}\n</code></pre>\n<p>Then define some basic getters for when we are dealing with our request’s\nresponse.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>  <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> String <span class=\"highlight__hljs-title___1fl8Q\">getKind</span><span class=\"hljs-params\">()</span> </span>{\n\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-keyword___som98\">this</span>.kind;\n\t}\n\n\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> RedditData <span class=\"highlight__hljs-title___1fl8Q\">getData</span><span class=\"hljs-params\">()</span> </span>{\n\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-keyword___som98\">this</span>.data;\n\t}\n</code></pre>\n<p>and override some utility functions:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>\t<span class=\"hljs-meta\">@Override</span>\n\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-keyword___som98\">int</span> <span class=\"highlight__hljs-title___1fl8Q\">hashCode</span><span class=\"hljs-params\">()</span> </span>{\n\t\t<span class=\"highlight__hljs-keyword___som98\">final</span> <span class=\"highlight__hljs-keyword___som98\">int</span> prime = <span class=\"highlight__hljs-number___2gmaH\">31</span>;\n\t\t<span class=\"highlight__hljs-keyword___som98\">int</span> result = <span class=\"highlight__hljs-number___2gmaH\">1</span>;\n\t\tresult = prime * result + ( kind == <span class=\"highlight__hljs-keyword___som98\">null</span> ? <span class=\"highlight__hljs-number___2gmaH\">0</span> : kind.hashCode() ) + ( data == <span class=\"highlight__hljs-keyword___som98\">null</span> ? <span class=\"highlight__hljs-number___2gmaH\">0</span> : data.hashCode() );\n\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> result;\n\t}\n\n\t<span class=\"hljs-meta\">@Override</span>\n\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-keyword___som98\">boolean</span> <span class=\"highlight__hljs-title___1fl8Q\">equals</span><span class=\"hljs-params\">( Object obj )</span> </span>{\n\t\t<span class=\"highlight__hljs-keyword___som98\">if</span> ( <span class=\"highlight__hljs-keyword___som98\">this</span> == obj ) {\n\t\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-keyword___som98\">true</span>;\n\t\t}\n\t\t<span class=\"highlight__hljs-keyword___som98\">if</span> ( obj == <span class=\"highlight__hljs-keyword___som98\">null</span> ) {\n\t\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-keyword___som98\">false</span>;\n\t\t}\n\t\t<span class=\"highlight__hljs-keyword___som98\">if</span> ( getClass() != obj.getClass() ) {\n\t\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-keyword___som98\">false</span>;\n\t\t}\n\t\tReddit other = (Reddit) obj;\n\t\t<span class=\"highlight__hljs-keyword___som98\">if</span> ( kind == <span class=\"highlight__hljs-keyword___som98\">null</span> ) {\n\t\t\t<span class=\"highlight__hljs-keyword___som98\">if</span> ( other.kind != <span class=\"highlight__hljs-keyword___som98\">null</span> ) {\n\t\t\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-keyword___som98\">false</span>;\n\t\t\t}\n\t\t} <span class=\"highlight__hljs-keyword___som98\">else</span> <span class=\"highlight__hljs-keyword___som98\">if</span> ( !kind.equals( other.kind ) ) {\n\t\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-keyword___som98\">false</span>;\n\t\t}\n\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-keyword___som98\">true</span>;\n\t}\n\n\t<span class=\"hljs-meta\">@Override</span>\n\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> String <span class=\"highlight__hljs-title___1fl8Q\">toString</span><span class=\"hljs-params\">()</span> </span>{\n\t\t<span class=\"highlight__hljs-keyword___som98\">return</span> <span class=\"highlight__hljs-string___1SffY\">\"Reddit [kind=\"</span> + kind + <span class=\"highlight__hljs-string___1SffY\">\" \"</span> + data + <span class=\"highlight__hljs-string___1SffY\">\"]\"</span>;\n\t}\n}\n</code></pre>\n<p>The model files will all follow this same format: @Key definitions, getters,\nutilities.</p>\n<p>Our final model (<code>RedditListing.java</code>) is where we are getting the content we\ncare about. We don’t have to include <code>@Key</code> for every key in our JSON response,\nso we’ll just grab the ones we care about:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>\t<span class=\"hljs-meta\">@Key</span>\n\t<span class=\"highlight__hljs-keyword___som98\">private</span> String domain;\n    <span class=\"hljs-meta\">@Key</span>\n\t<span class=\"highlight__hljs-keyword___som98\">private</span> String author;\n    <span class=\"hljs-meta\">@Key</span>\n\t<span class=\"highlight__hljs-keyword___som98\">private</span> String permalink;\n    <span class=\"hljs-meta\">@Key</span>\n\t<span class=\"highlight__hljs-keyword___som98\">private</span> String title;\n</code></pre>\n<h4 id=\"spicerequestredditjava\">SpiceRequestReddit.java</h4>\n<p>To finish off our classes, we’ll create a SpiceRequest that takes a string (our\nsubreddit) and returns a <code>Reddit</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">package</span> com.christopherbiscardi.robospicetest;\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> java.io.IOException;\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> roboguice.util.temp.Ln;\n\n<span class=\"highlight__hljs-keyword___som98\">import</span> com.google.api.client.http.GenericUrl;\n<span class=\"highlight__hljs-keyword___som98\">import</span> com.google.api.client.http.HttpRequest;\n<span class=\"highlight__hljs-keyword___som98\">import</span> com.google.api.client.json.jackson.JacksonFactory;\n<span class=\"highlight__hljs-keyword___som98\">import</span> com.octo.android.robospice.request.googlehttpclient.GoogleHttpClientSpiceRequest;\n\n<span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">SpiceRequestReddit</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">GoogleHttpClientSpiceRequest</span>&lt;<span class=\"highlight__hljs-title___1fl8Q\">reddit</span>&gt; </span>{\n\t<span class=\"highlight__hljs-keyword___som98\">private</span> String baseUrl;\n\n    <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-title___1fl8Q\">SpiceRequestReddit</span><span class=\"hljs-params\">( String subreddit )</span> </span>{\n        <span class=\"highlight__hljs-keyword___som98\">super</span>( Reddit.class );\n        <span class=\"highlight__hljs-keyword___som98\">this</span>.baseUrl = String.format( <span class=\"highlight__hljs-string___1SffY\">\"http://www.reddit.com/r/%s.json\"</span>, subreddit );\n    }\n\n    <span class=\"hljs-meta\">@Override</span>\n    <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> Reddit <span class=\"highlight__hljs-title___1fl8Q\">loadDataFromNetwork</span><span class=\"hljs-params\">()</span> <span class=\"highlight__hljs-keyword___som98\">throws</span> IOException </span>{\n        Ln.d( <span class=\"highlight__hljs-string___1SffY\">\"Call web service \"</span> + baseUrl );\n        HttpRequest request = getHttpRequestFactory()<span class=\"highlight__hljs-comment___UYk12\">//</span>\n                .buildGetRequest( <span class=\"highlight__hljs-keyword___som98\">new</span> GenericUrl( baseUrl ) );\n        request.setParser( <span class=\"highlight__hljs-keyword___som98\">new</span> JacksonFactory().createJsonObjectParser() );\n        <span class=\"highlight__hljs-keyword___som98\">return</span> request.execute().parseAs( getResultType() );\n    }\n}&lt;/reddit&gt;\n</code></pre>\n<h2 id=\"calling-the-api\">Calling the API</h2>\n<p>In <code>MainActivity.java</code> we need to add some code to execute the request:</p>\n<p>We need to extend our <code>MainActivity</code> from <code>BaseSpiceActivity</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">MainActivity</span> <span class=\"highlight__hljs-keyword___som98\">extends</span> <span class=\"highlight__hljs-title___1fl8Q\">BaseSpiceActivity</span> </span>{\n</code></pre>\n<p>Add a new <code>SpiceRequestReddit</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>java\nprivate SpiceRequestReddit spiceRequestReddit;\n</code></pre>\n<p>Instantiate it with the Riak subreddit;</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>spiceRequestReddit = <span class=\"highlight__hljs-keyword___som98\">new</span> SpiceRequestReddit( <span class=\"highlight__hljs-string___1SffY\">\"Riak\"</span> );\n</code></pre>\n<p>and implement our ResultHandler class:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-keyword___som98\">final</span> <span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">RedditSpiceRequestListener</span> <span class=\"highlight__hljs-keyword___som98\">implements</span> <span class=\"highlight__hljs-title___1fl8Q\">RequestListener</span> </span>{\n\n\t\t<span class=\"hljs-meta\">@Override</span>\n\t\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-keyword___som98\">void</span> <span class=\"highlight__hljs-title___1fl8Q\">onRequestFailure</span><span class=\"hljs-params\">( SpiceException spiceException )</span> </span>{\n\t\t\tToast.makeText( MainActivity.<span class=\"highlight__hljs-keyword___som98\">this</span>, <span class=\"highlight__hljs-string___1SffY\">\"failure\"</span>, Toast.LENGTH_SHORT ).show();\n\t\t}\n\n\t\t<span class=\"hljs-meta\">@Override</span>\n\t\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">public</span> <span class=\"highlight__hljs-keyword___som98\">void</span> <span class=\"highlight__hljs-title___1fl8Q\">onRequestSuccess</span><span class=\"hljs-params\">( <span class=\"highlight__hljs-keyword___som98\">final</span> Reddit result )</span> </span>{\n\t\t\tToast.makeText( MainActivity.<span class=\"highlight__hljs-keyword___som98\">this</span>, <span class=\"highlight__hljs-string___1SffY\">\"success\"</span>, Toast.LENGTH_SHORT ).show();\n\t\t\tLog.e(<span class=\"highlight__hljs-string___1SffY\">\"TEST\"</span>,result.getData().toString());\n\t\t\tLog.e(<span class=\"highlight__hljs-string___1SffY\">\"TEST\"</span>,result.getData().getChildren().get(<span class=\"highlight__hljs-number___2gmaH\">0</span>).getData().getTitle());\n\t\t}\n\t}\n</code></pre>\n<p>We’ve just implemented a simple log to view the data, but we could have added it\nto an ArrayAdapter and displayed it in a ListView.</p>\n<p>Finally, we override the <code>onStart()</code> method to actually make the request.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>  <span class=\"hljs-meta\">@Override</span>\n\t<span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">protected</span> <span class=\"highlight__hljs-keyword___som98\">void</span> <span class=\"highlight__hljs-title___1fl8Q\">onStart</span><span class=\"hljs-params\">()</span> </span>{\n\t\t<span class=\"highlight__hljs-keyword___som98\">super</span>.onStart();\n\n\t\tsetProgressBarIndeterminate( <span class=\"highlight__hljs-keyword___som98\">false</span> );\n\t\tsetProgressBarVisibility( <span class=\"highlight__hljs-keyword___som98\">true</span> );\n\n\t\tgetSpiceManager().execute( spiceRequestReddit, <span class=\"highlight__hljs-string___1SffY\">\"json\"</span>, DurationInMillis.ONE_MINUTE, <span class=\"highlight__hljs-keyword___som98\">new</span> RedditSpiceRequestListener() );\n\t}\n</code></pre>\n<h2 id=\"androidmanifestxml\">AndroidManifest.xml</h2>\n<p>Now that’s all the code we need to write, but we still need to register our\nservice and permissions in <code>AndroidManifest.xml</code>. Notice we’ve added three\n<code>uses-permission</code> nodes and a <code>service</code> node.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"php\"><span class=\"hljs-meta\">&lt;?</span>xml version=<span class=\"highlight__hljs-string___1SffY\">\"1.0\"</span> encoding=<span class=\"highlight__hljs-string___1SffY\">\"utf-8\"</span><span class=\"hljs-meta\">?&gt;</span></span>\n<span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">manifest</span> <span class=\"hljs-attr\">xmlns:android</span>=<span class=\"highlight__hljs-string___1SffY\">\"http://schemas.android.com/apk/res/android\"</span>\n    <span class=\"hljs-attr\">package</span>=<span class=\"highlight__hljs-string___1SffY\">\"com.christopherbiscardi.robospicetest\"</span>\n    <span class=\"hljs-attr\">android:versionCode</span>=<span class=\"highlight__hljs-string___1SffY\">\"1\"</span>\n    <span class=\"hljs-attr\">android:versionName</span>=<span class=\"highlight__hljs-string___1SffY\">\"1.0\"</span> &gt;</span>\n\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">uses-sdk</span>\n        <span class=\"hljs-attr\">android:minSdkVersion</span>=<span class=\"highlight__hljs-string___1SffY\">\"8\"</span>\n        <span class=\"hljs-attr\">android:targetSdkVersion</span>=<span class=\"highlight__hljs-string___1SffY\">\"17\"</span> /&gt;</span>\n\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">uses-permission</span> <span class=\"hljs-attr\">android:name</span>=<span class=\"highlight__hljs-string___1SffY\">\"android.permission.INTERNET\"</span> /&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">uses-permission</span> <span class=\"hljs-attr\">android:name</span>=<span class=\"highlight__hljs-string___1SffY\">\"android.permission.ACCESS_NETWORK_STATE\"</span> /&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">uses-permission</span> <span class=\"hljs-attr\">android:name</span>=<span class=\"highlight__hljs-string___1SffY\">\"android.permission.ACCESS_WIFI_STATE\"</span> /&gt;</span>\n\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">application</span>\n        <span class=\"hljs-attr\">android:allowBackup</span>=<span class=\"highlight__hljs-string___1SffY\">\"true\"</span>\n        <span class=\"hljs-attr\">android:icon</span>=<span class=\"highlight__hljs-string___1SffY\">\"@drawable/ic_launcher\"</span>\n        <span class=\"hljs-attr\">android:label</span>=<span class=\"highlight__hljs-string___1SffY\">\"@string/app_name\"</span>\n        <span class=\"hljs-attr\">android:theme</span>=<span class=\"highlight__hljs-string___1SffY\">\"@style/AppTheme\"</span> &gt;</span>\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">activity</span>\n            <span class=\"hljs-attr\">android:name</span>=<span class=\"highlight__hljs-string___1SffY\">\"com.christopherbiscardi.robospicetest.MainActivity\"</span>\n            <span class=\"hljs-attr\">android:label</span>=<span class=\"highlight__hljs-string___1SffY\">\"@string/app_name\"</span> &gt;</span>\n            <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">intent-filter</span>&gt;</span>\n                <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">action</span> <span class=\"hljs-attr\">android:name</span>=<span class=\"highlight__hljs-string___1SffY\">\"android.intent.action.MAIN\"</span> /&gt;</span>\n\n                <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">category</span> <span class=\"hljs-attr\">android:name</span>=<span class=\"highlight__hljs-string___1SffY\">\"android.intent.category.LAUNCHER\"</span> /&gt;</span>\n            <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">intent-filter</span>&gt;</span>\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">activity</span>&gt;</span>\n\n        <span class=\"highlight__hljs-tag___2Bb-l\">&lt;<span class=\"hljs-name\">service</span>\n            <span class=\"hljs-attr\">android:name</span>=<span class=\"highlight__hljs-string___1SffY\">\"com.octo.android.robospice.JacksonGoogleHttpClientSpiceService\"</span>\n            <span class=\"hljs-attr\">android:exported</span>=<span class=\"highlight__hljs-string___1SffY\">\"false\"</span> /&gt;</span>\n    <span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">application</span>&gt;</span>\n\n<span class=\"highlight__hljs-tag___2Bb-l\">&lt;/<span class=\"hljs-name\">manifest</span>&gt;</span>\n</code></pre>\n<h2 id=\"fin\">Fin</h2>\n<p>Now we can run the app and see the result (success or failure) pop up as a Toast\nas well as viewing the actual data in LogCat.</p>\n<p>Check out the github repository\n<a href=\"https://github.com/ChristopherBiscardi/robospice-googlehttpclient-example\">here</a></p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.27.node.attributes":{"slug":"android-robospice-with-googlehttpclient","__typename":"BlogPostAttributes","title":"Android RoboSpice with GoogleHttpClient","url":"/2014/1/27/android-robospice-with-googlehttpclient/","excerpt":"In this post we will examine an example app in which we make a RoboSpice request\nusing GoogleHttpClient.","updatedAt":"Jan 27th, 2014","timeToRead":7,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.27":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.27.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.28.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.28.node.attributes","generated":true},"body":"<p>In this post we will enable Drakma HTTP support in the Android/MOCL example\ncode. I have forked the repo <a href=\"https://github.com/ChristopherBiscardi/mocl-example-lisp-contacts-android\">on\nGithub</a>\nfor posterity. The first post is\n<a href=\"http://www.christopherbiscardi.com/2014/01/10/common-lisp-on-android-running-the-mocl-android-example/\">here</a>\nand it will get you set up with the Android/MOCL example without Drakma.</p>\n<p>First we must download dependencies.</p>\n<p><a href=\"http://weitz.de/drakma/#install\">Drakma</a>\n<a href=\"http://common-lisp.net/projects/usocket/releases/\">USocket</a>\n<a href=\"http://weitz.de/flexi-streams/\">Flexi-Streams</a>\n<a href=\"http://weitz.de/chunga/\">Chunga</a>\n<a href=\"http://www.cliki.net/cl-base64\">CL-BASE64</a>\n<a href=\"http://www.cliki.net/puri\">Puri</a></p>\n<p>My libs are located in mocl/systems. So I that’s where I place the folders of\ncode, then link the .asd files. The instructions may change slightly with\ndifferent versions of libs.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">cd</span> mocl/systems\nln <span class=\"hljs-_\">-s</span> drakma-1.3.7/drakma.asd drakma.asd\nln <span class=\"hljs-_\">-s</span> usocket-0.6.1/usocket.asd usocket.asd\ngit <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/edicl/cl-ppcre.git\nln <span class=\"hljs-_\">-s</span> cl-ppcre/cl-ppcre.asd cl-ppcre.asd\n</code></pre>\n<p>Note that <code>cl-ppcre-unicode.asd</code> also exists. Also of note is the version of\n<code>trivial-gray-streams</code> in use here. As of this writing the current version is\ncausing issues and the version presented below should be used.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>ln <span class=\"hljs-_\">-s</span> flexi-streams-1.0.12/flexi-streams.asd flexi-streams.asd\ngit <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://git.gitorious.org/trivial-gray-streams/wukix-trivial-gray-streams.git\nln <span class=\"hljs-_\">-s</span> wukix-trivial-gray-streams/trivial-gray-streams.asd trivial-gray-streams.asd\nln <span class=\"hljs-_\">-s</span> chunga-1.1.5/chunga.asd chunga.asd\nln <span class=\"hljs-_\">-s</span> cl-base64-3.3.3/cl-base64.asd cl-base64.asd\nln <span class=\"hljs-_\">-s</span> puri-1.5.5/puri.asd puri.asd\n</code></pre>\n<p>So after doing the linking dance we can uncomment the Drakma code in app.lisp (5\nlines):</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>(<span class=\"hljs-name\">pushnew</span> <span class=\"highlight__hljs-symbol___mdaTG\">:drakma-no-ssl</span> *features*)\n   (<span class=\"hljs-name\">require</span> <span class=\"highlight__hljs-symbol___mdaTG\">:drakma</span>)\n</code></pre>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>(<span class=\"hljs-name\">declaim</span> (<span class=\"hljs-name\">call-in</span> net-test))\n(<span class=\"hljs-name\">defun</span> net-test ()\n  (<span class=\"hljs-name\">print</span> (<span class=\"hljs-name\">drakma</span><span class=\"highlight__hljs-symbol___mdaTG\">:http-request</span> <span class=\"highlight__hljs-string___1SffY\">\"http://wukix.com\"</span>)))\n</code></pre>\n<p>but we have to change out <code>http://wukix.com</code> because as of this writing wukix\nhas changed their site to redirect to https, and drakma can’t use ssl yet. In my\ncase I changed it to <code>http://www.cliki.net/</code> because it currently accepts over\nhttp.</p>\n<p>and add <code>net_test</code> to our <code>MainActivity.java</code>. In this case we just log out the\nresult</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>CL.cl_init();\n<span class=\"highlight__hljs-keyword___som98\">try</span> {\n    String dataDir = getDataDir();\n    CL.set_temp_dir(dataDir);\n    CL.set_doc_dir(dataDir);\n    CL.set_font_path(getAssetPath(<span class=\"highlight__hljs-string___1SffY\">\"DejaVuSans.ttf\"</span>));\n    CL.load_contacts();\n} <span class=\"highlight__hljs-keyword___som98\">catch</span> (Exception e) {\n    <span class=\"highlight__hljs-comment___UYk12\">// TODO Auto-generated catch block</span>\n    e.printStackTrace();\n}\n\nLog.e(<span class=\"highlight__hljs-string___1SffY\">\"CL\"</span>,CL.net_test());\n</code></pre>\n<p>and run:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">cd</span> mocl-example-lisp-contacts-android\nmocl --android LispContacts app.lisp\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> LispContacts/jni\nndk-build\n</code></pre>\n<p>Then simply debug the project in ADK and watch the logcat output. The result\nshould show up as an error, since we used <code>Log.e(&quot;&quot;,&quot;&quot;)</code>, with a tag of CL.</p>\n<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611521/CBLogo_2014_transparent_swcmig.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/h_300,w_300/v1428611521/CBLogo_2014_transparent_swcmig.png\" alt=\"CBLogo_2014_transparent\"></a></p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.28.node.attributes":{"slug":"mocl-for-android-part-2-drakma","__typename":"BlogPostAttributes","title":"MOCL for Android Part 2: Drakma","url":"/2014/1/16/mocl-for-android-part-2-drakma/","excerpt":"In this post we will enable Drakma HTTP support in the Android/MOCL example\ncode. I have forked the repo on\nGithub\nfor posterity. The first…","updatedAt":"Jan 16th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.28":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.28.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.29.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.29.node.attributes","generated":true},"body":"<p>In this post we’ll go through the process to create a basic Clojure/Compojure/libnoir scaffolding project and deploying it to Heroku.</p>\n<p>First, make sure you’ve installed the prereqs:\n<a href=\"http://leiningen.org/\">Leiningen</a> &gt;= v2.0\n<a href=\"https://toolbelt.heroku.com/\">Heroku Toolbelt</a></p>\n<p>and here’s the <a href=\"https://github.com/ChristopherBiscardi/clojure-compojure-libnoir\">GitHub</a> if that’s your style.</p>\n<p>After installing leiningen, run:</p>\n<p><code>lein new compojure scaffold-app</code></p>\n<p>to scaffold a new project. Then cd into the project and run <code>lein ring server</code> to install dependencies and run the app.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;bash&quot;&gt;cd scaffold-app\nlein ring server```\n\nWe can kill the server with `C-c`. We will need a `Procfile` to deploy to Heroku and it will look like this:\n\n`web: java $JVM_OPTS -cp target/scaffolding-app.jar clojure.main -m scaffold-app.handler $PORT`\n\nBe sure to save that as `Procfile`. This says we will have a “web” dyno type, which is a special type on heroku that is allowed to receive web traffic.\n\nWe need a `:main` namespace in our app so that `lein run` knows how to run the app.\n\nInside of `project.clj` add `:main` and a dependency on `lib-noir`, from which we will use a jetty adapter. We also want to add `min-lein-version` so that heroku uses lein 2.0 and add a section for our `:uberjar-name`. This will help us out with some startup-timing issues we could encounter otherwise.\n\n</code></pre>\n<p><code class=\"clojure\">(defproject scaffold-app “0.1.0-SNAPSHOT”\n:description “FIXME: write description”\n:url “<a href=\"http://example.com/FIXME\">http://example.com/FIXME</a>”\n:dependencies [[org.clojure/clojure “1.5.1”]\n[lib-noir “0.7.9”]\n[compojure “1.1.6”]]\n:main scaffold-app.handler\n:min-lein-version “2.0.0”\n:uberjar-name “scaffolding-app.jar”\n:plugins [[lein-ring “0.8.10”]]\n:ring {:handler scaffold-app.handler/app}\n:profiles\n{:dev {:dependencies [[javax.servlet/servlet-api “2.5”]\n[ring-mock “0.1.5”]]}})```</p>\n<p>In <code>src/scaffold_app/handler.clj</code> add <code>ring.adapter.jetty</code> to <code>:use</code> and bracket</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;clojure&quot;&gt;(:use [compojure.core]\n      [ring.adapter.jetty :as ring])```\n\nand `-main` to the body where the port will be given to us from Heroku:\n\n</code></pre>\n<p><code class=\"clojure\">(defn -main [port]\n(run-jetty (handler/site app-routes) {:port (read-string port) :join? false}))```</p>\n<p>At this point you should be able to run <code>lein run 8080</code> to start an instance of the app on port 8080. If this works, you are ready to deploy to Heroku.</p>\n<p>Assuming you have git, a Heroku account and the Toolbelt (mentioned at the top of the post) installed we can deploy to heroku in this fashion: (Remember to change “scaffolding-clojure” to something else. There is already an app with that name that exists on heroku.)</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;bash&quot;&gt;git init\nheroku apps:create scaffolding-clojure```\n\nheroku’s `apps:create` adds a “heroku” remote to git.\n\n</code></pre>\n<p><code class=\"bash\">git add Procfile .gitignore <a href=\"http://README.md\">README.md</a> project.clj src/ test/\ngit commit -m 'first commit’\ngit push -u heroku master```</p>\n<p>We can open our app with <code>heroku open</code> or watch it run with <code>heroku logs --tail</code></p>\n<p>In the next post we’ll dive into lib-noir a bit to investigate potential applications (such as JSON APIs).</p>\n<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611521/CBLogo_2014_transparent_swcmig.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/h_300,w_300/v1428611521/CBLogo_2014_transparent_swcmig.png\" alt=\"CBLogo_2014_transparent\"></a></p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.29.node.attributes":{"slug":"scaffolding-a-clojurecompojure-webapp-for-heroku","__typename":"BlogPostAttributes","title":"Scaffolding a Clojure/Compojure Webapp for Heroku","url":"/2014/1/15/scaffolding-a-clojurecompojure-webapp-for-heroku/","excerpt":"In this post we’ll go through the process to create a basic Clojure/Compojure/libnoir scaffolding project and deploying it to Heroku.","updatedAt":"Jan 15th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.29":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.29.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.30.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.30.node.attributes","generated":true},"body":"<p>In this post we will be replacing the JSON file (for user authentication) with a\nPostgres database.</p>\n<p><a href=\"https://github.com/ChristopherBiscardi/Getting-Started-with-Snap-and-User-Authentication/commit/72a77abac5d46554e659ddeef0a1abf7074a5c6f\">Git Diff and Repo</a>\n<a href=\"http://www.christopherbiscardi.com/2014/01/07/getting-started-with-snap-and-user-authentication-part-1/\">part 1</a>\n<a href=\"http://www.christopherbiscardi.com/2014/01/10/getting-started-with-snap-and-user-authentication-part-2/\">part 2</a></p>\n<p>In <code>abc.cabal</code> add <code>snaplet-postgresql-simple</code> to <code>Build-depends</code>:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">Build</span>-depends:\n    bytestring                &gt;= <span class=\"highlight__hljs-number___2gmaH\">0.9</span><span class=\"highlight__hljs-number___2gmaH\">.1</span>   &amp;&amp; = <span class=\"highlight__hljs-number___2gmaH\">0.12</span>    &amp;&amp; = <span class=\"highlight__hljs-number___2gmaH\">0.2</span><span class=\"highlight__hljs-number___2gmaH\">.1</span>   &amp;&amp; = <span class=\"highlight__hljs-number___2gmaH\">2</span>       &amp;&amp; = <span class=\"highlight__hljs-number___2gmaH\">0.11</span>    &amp;&amp; = <span class=\"highlight__hljs-number___2gmaH\">0.9</span>     &amp;&amp; = <span class=\"highlight__hljs-number___2gmaH\">0.9</span>     &amp;&amp; = <span class=\"highlight__hljs-number___2gmaH\">0.9</span>     &amp;&amp; = <span class=\"highlight__hljs-number___2gmaH\">0.11</span>    &amp;&amp; = <span class=\"highlight__hljs-number___2gmaH\">1.1</span>     &amp;&amp; = <span class=\"highlight__hljs-number___2gmaH\">0.1</span>,\n    snaplet-postgresql-simple == <span class=\"highlight__hljs-number___2gmaH\">0.4</span><span class=\"highlight__hljs-number___2gmaH\">.1</span>```\n\n<span class=\"highlight__hljs-type___11WfV\">Then</span>, <span class=\"highlight__hljs-type___11WfV\">In</span> `src/<span class=\"highlight__hljs-type___11WfV\">Site</span>.hs` we’re going to add the following imports:\n\n```haskell\n<span class=\"highlight__hljs-keyword___som98\">import</span> Snap.Snaplet.PostgresqlSimple\n<span class=\"highlight__hljs-keyword___som98\">import</span> Snap.Snaplet.Auth.Backends.PostgresqlSimple\n</code></pre>\n<p>add this line to initialize the database in our Application Initialization code\nbelow session and about auth:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>d\n</code></pre>\n<p>and replace this line:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>initJsonFileAuthManager defAuthSettings sess &quot;users.json&quot;\n</code></pre>\n<p>with this line, which does the dirty work of using Postgres instead of a JSON\nfile.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>initPostgresAuth sess d\n</code></pre>\n<p>We’ll also add the initialized database snaplet to our returned App:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>return $ App h s d a\n</code></pre>\n<p>We’re almost done, but first we’ll need to add <code>_db</code> to our App definition in\n<code>src/Application.hs</code>:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">App</span> = <span class=\"highlight__hljs-type___11WfV\">App</span></span>\n    { _heist :: <span class=\"highlight__hljs-type___11WfV\">Snaplet</span> (<span class=\"highlight__hljs-type___11WfV\">Heist</span> <span class=\"highlight__hljs-type___11WfV\">App</span>)\n    , _sess :: <span class=\"highlight__hljs-type___11WfV\">Snaplet</span> <span class=\"highlight__hljs-type___11WfV\">SessionManager</span>\n    , _db :: <span class=\"highlight__hljs-type___11WfV\">Snaplet</span> <span class=\"highlight__hljs-type___11WfV\">Postgres</span>\n    , _auth :: <span class=\"highlight__hljs-type___11WfV\">Snaplet</span> (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> <span class=\"highlight__hljs-type___11WfV\">App</span>)\n    }\n</code></pre>\n<p>and don’t forget the import for postgres in the same file.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>import Snap.Snaplet.PostgresqlSimple\n</code></pre>\n<p>We are now using Postgres as a database for our authentication! <code>cabal install</code>\nand run <code>abc</code> to make sure it works. You may need to run the following in\n<code>psql</code>:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>CREATE ROLE postgres LOGIN;\nCREATE DATABASE testdb;\n</code></pre>\n<p>also of note is that the git repo has bumped the version of abc to <code>0.2</code></p>\n<p><a href=\"http://www.christopherbiscardi.com/2014/01/07/getting-started-with-snap-and-user-authentication-part-1/\">Part 1 - Beginnings</a>\n<a href=\"http://www.christopherbiscardi.com/2014/01/10/getting-started-with-snap-and-user-authentication-part-2/\">Part 2 - Auth</a></p>\n<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611521/CBLogo_2014_transparent_swcmig.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/h_300,w_300/v1428611521/CBLogo_2014_transparent_swcmig.png\" alt=\"CBLogo_2014_transparent\"></a></p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.30.node.attributes":{"slug":"getting-started-with-snap-and-user-authentication-part-3","__typename":"BlogPostAttributes","title":"Getting Started With Snap (and User Authentication): Part 3","url":"/2014/1/11/getting-started-with-snap-and-user-authentication-part-3/","excerpt":"In this post we will be replacing the JSON file (for user authentication) with a\nPostgres database.","updatedAt":"Jan 11th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.30":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.30.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.31.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.31.node.attributes","generated":true},"body":"<p>Prereqs: Install ADK, Android NDK, and mocl.</p>\n<p>git clone the sample app somewhere:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>git <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/Wukix/mocl-example-lisp-contacts-android.git\n</code></pre>\n<p>Import the cloned app into Android Development’s version of Eclipse. Note: at\nthis time there are may or may not be issues with creating a new project in ADK\ndue to Gradle not supporting the NDK.</p>\n<p>My third party library install location is <code>mocl/systems</code>.</p>\n<p>Install Common Lisp dependencies there:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>$ <span class=\"highlight__hljs-built_in___3uuyR\">cd</span> mocl/systems\n$ git <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/xach/vectometry.git\n$ ln <span class=\"hljs-_\">-s</span> vectometry/vectometry.asd vectometry.asd\n$ git <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/xach/geometry.git\n$ ln <span class=\"hljs-_\">-s</span> geometry/geometry.asd geometry.asd\n$ git <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/Wukix/vecto.git\n$ ln <span class=\"hljs-_\">-s</span> vecto/vecto.asd vecto.asd\n$ git <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/xach/zpb-ttf.git\n$ ln <span class=\"hljs-_\">-s</span> zpb-ttf/zpb-ttf.asd zpb-ttf.asd\n$ git <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/xach/zpng.git\n$ ln <span class=\"hljs-_\">-s</span> zpng/zpng.asd zpng.asd\n$ git <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/xach/salza2.git\n$ ln <span class=\"hljs-_\">-s</span> salza2/salza2.asd salza2.asd\n$ git <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/fjolliton/cl-vectors.git\n$ ln <span class=\"hljs-_\">-s</span> cl-vectors/cl-vectors.asd cl-vectors.asd\n$ ln <span class=\"hljs-_\">-s</span> cl-vectors/cl-paths.asd cl-paths.asd\n$ ln <span class=\"hljs-_\">-s</span> cl-vectors/cl-aa.asd cl-aa.asd```\n\nOnce everything is installed/linked go to the imported project and run:\n\n```bash\nmocl --android LispContacts app.lisp\n</code></pre>\n<p>Make sure you have the Android 17 sdk, because that’s what’s used in the example\nproject.</p>\n<p>After all of that, <code>cd LispContacts/jni</code></p>\n<p>then run: <code>ndk-build</code></p>\n<p>At this point the code has compiled and you’re good to go. You may have to close\nADK and reopen it to get ADK to see the mocl files. I might do another post on\nthe code in the example… Give me a comment if that’s something you’re interested\nin.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.31.node.attributes":{"slug":"common-lisp-on-android-running-the-mocl-android-example","__typename":"BlogPostAttributes","title":"Common Lisp on Android: Running the MOCL Android Example","url":"/2014/1/10/common-lisp-on-android-running-the-mocl-android-example/","excerpt":"Prereqs: Install ADK, Android NDK, and mocl.","updatedAt":"Jan 10th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.31":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.31.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.32.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.32.node.attributes","generated":true},"body":"<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611521/CBLogo_2014_transparent_swcmig.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/h_300,w_300/v1428611521/CBLogo_2014_transparent_swcmig.png\" alt=\"CBLogo_2014_transparent\"></a></p>\n<p><a href=\"https://github.com/ChristopherBiscardi/Getting-Started-with-Snap-and-User-Authentication\">Git Repo</a>\n<a href=\"http://www.christopherbiscardi.com/2014/01/07/getting-started-with-snap-and-user-authentication-part-1/\">part 1</a></p>\n<p>The file structure now looks like this:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>  - abc.cabal\n  - log/\n     - access.log\n     - error.log\n  - snaplets/\n     - heist/\n        - templates/\n           - _login.tpl\n           - _new_user.tpl\n           - base.tpl\n           - index.tpl\n           - login.tpl\n           - new_user.tpl\n           - userform.tpl\n  - src/\n     - Application.hs\n     - Main.hs\n     - Site.hs\n  - static/\n     - screen.css\n</code></pre>\n<p><code>abc.cabal</code> includes our dependencies and build information. This file is read\nwhen we run <code>cabal install</code></p>\n<p><code>log</code> includes two files that log out what browsers <code>access</code> the site and what\n<code>error</code>s occur.</p>\n<p><code>snaplets</code> is where our snaplets store their files. In this case we only have\n<code>heist</code> there, which contains a <code>templates</code> folder that includes the templates\nwe use to render the site.</p>\n<p><code>static</code> includes a simple stylesheet that is served when we visit the site.</p>\n<p><code>src</code> is the folder we’re currently concerned with. It includes three files:</p>\n<h5 id=\"mainhs\">Main.hs</h5>\n<p>This file contains some boilerplate for dynamic recompilation of a snap site.\nWe’ll be leaving this file alone.</p>\n<h5 id=\"applicationhs\">Application.hs</h5>\n<p>Here we define our App datatype with the snaplets we will be using.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">App</span> = <span class=\"highlight__hljs-type___11WfV\">App</span></span>\n    { _heist :: <span class=\"highlight__hljs-type___11WfV\">Snaplet</span> (<span class=\"highlight__hljs-type___11WfV\">Heist</span> <span class=\"highlight__hljs-type___11WfV\">App</span>)\n    , _sess :: <span class=\"highlight__hljs-type___11WfV\">Snaplet</span> <span class=\"highlight__hljs-type___11WfV\">SessionManager</span>\n    , _auth :: <span class=\"highlight__hljs-type___11WfV\">Snaplet</span> (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> <span class=\"highlight__hljs-type___11WfV\">App</span>)\n    }\n</code></pre>\n<p>In this case we are using <code>heist</code>, <code>sessions</code> and <code>authentication</code>.</p>\n<p>Then we make a call to <code>makeLenses</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>makeLenses ''App\n</code></pre>\n<p><code>makeLenses</code> does some things under the hood like creating getters/setters and\nchanging the names for the snaplets in our app to remove the underscore. This\nmeans that <code>_auth</code> will be referred to as <code>auth</code> in the rest of our app,\nincluding in <code>src/Site.hs</code>.</p>\n<p>We then define an instance for the Heist Snaplet so we don’t have to use <code>with heist</code> every time we want to render a template (More about this later).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">HasHeist</span> <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n    heistLens = subSnaplet heist\n</code></pre>\n<p>and finally we declare a type alias so that we can use <code>AppHandler</code> instead of\nthe longer <code>Handler App App</code> in the type signatures for our routes.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>type AppHandler = Handler App App\n</code></pre>\n<h5 id=\"sitehs\">Site.hs</h5>\n<p>This is where the meat of our site lives. The routing code, handlers and\ninitialization for the entire app.</p>\n<p>The first route is <code>&quot;/login&quot;</code> which uses <code>handleLoginSubmit</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>(&quot;/login&quot;,    with auth handleLoginSubmit)\n</code></pre>\n<p><code>with auth</code> lets us work in the auth Snaplet for <code>handleLoginSubmit</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">handleLoginSubmit</span> :: <span class=\"highlight__hljs-type___11WfV\">Handler</span> <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> <span class=\"highlight__hljs-type___11WfV\">App</span>) ()\n<span class=\"highlight__hljs-title___1fl8Q\">handleLoginSubmit</span> =\n    loginUser <span class=\"highlight__hljs-string___1SffY\">\"login\"</span> <span class=\"highlight__hljs-string___1SffY\">\"password\"</span> <span class=\"highlight__hljs-type___11WfV\">Nothing</span>\n              (_ -&gt; handleLogin err) (redirect <span class=\"highlight__hljs-string___1SffY\">\"/\"</span>)\n  <span class=\"highlight__hljs-keyword___som98\">where</span>\n    err = <span class=\"highlight__hljs-type___11WfV\">Just</span> <span class=\"highlight__hljs-string___1SffY\">\"Unknown user or password\"</span>\n</code></pre>\n<p>Since we’re working in the auth Snaplet our type signature for the handler has\nthe type <code>Handler App (AuthManager App) ()</code>, which is slightly different from\nthe type we aliased in <code>Application.hs</code>.</p>\n<p><code>loginUser</code> is a function from the auth snaplet. It takes the <code>username</code> field\nand the <code>password</code> field from a form submission, a “remember” field, a failure\nfunction and a success function, in that order. The type signature looks like\nthis:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">loginUser</span>\n  :: <span class=\"highlight__hljs-type___11WfV\">ByteString</span> <span class=\"highlight__hljs-comment___UYk12\">-- name of username field</span>\n     -&gt; <span class=\"highlight__hljs-type___11WfV\">ByteString</span> <span class=\"highlight__hljs-comment___UYk12\">-- name of password field</span>\n     -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">ByteString</span> <span class=\"highlight__hljs-comment___UYk12\">-- name of remember field (`Nothing` means there isn't one)</span>\n     -&gt; (<span class=\"highlight__hljs-type___11WfV\">AuthFailure</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">Handler</span> b (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> b) ()) <span class=\"highlight__hljs-comment___UYk12\">-- failure function</span>\n     -&gt; <span class=\"highlight__hljs-type___11WfV\">Handler</span> b (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> b) () <span class=\"highlight__hljs-comment___UYk12\">-- success function</span>\n     -&gt; <span class=\"highlight__hljs-type___11WfV\">Handler</span> b (<span class=\"highlight__hljs-type___11WfV\">AuthManager</span> b) () <span class=\"highlight__hljs-comment___UYk12\">-- return value is a handler</span>\n</code></pre>\n<p>So going back to <code>handleLoginSubmit</code> we use:\n<code>&quot;login&quot;</code> as the username field\n<code>&quot;password&quot;</code> as the password field\n<code>Nothing</code> as the remember field\n<code>_ -&gt; handleLogin err</code> as our error function\nand <code>redirect &quot;/&quot;</code> as our success function.</p>\n<p><code>err</code> is defined as <code>Just &quot;Unknown user or password&quot;</code> which matches up with the\ntype from <code>handleLogin</code>.</p>\n<p>The <code>handleLogin</code> code will be covered in a Heist tutorial at another time, but\nsuffice it to say that <code>handleLogin</code> is rendering the login form with the error\nthat we’ve supplied it (which is “Unknown user or password”).</p>\n<p>Our <code>&quot;/logout&quot;</code> route is pretty simple. Just call the snaplet-auth supplied\nfunction <code>logout</code> and redirect to <code>&quot;/&quot;</code></p>\n<p><code>&quot;/new_user&quot;</code> does a similar thing, except it displays the empty form on <code>GET</code>\nrequest and handles a form submit on <code>POST</code>.</p>\n<p>Next we’ll replace the backend, currently a json file, with postgres.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.32.node.attributes":{"slug":"getting-started-with-snap-and-user-authentication-part-2","__typename":"BlogPostAttributes","title":"Getting Started With Snap (and User Authentication): Part 2","url":"/2014/1/9/getting-started-with-snap-and-user-authentication-part-2/","excerpt":"","updatedAt":"Jan 10th, 2014","timeToRead":3,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.32":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.32.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.33.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.33.node.attributes","generated":true},"body":"<p><a href=\"http://res.cloudinary.com/diqzbm8lz/image/upload/v1428611521/CBLogo_2014_transparent_swcmig.png\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/h_300,w_300/v1428611521/CBLogo_2014_transparent_swcmig.png\" alt=\"CBLogo_2014_transparent\"></a>\nThe github repo for this code is at <a href=\"https://github.com/ChristopherBiscardi/Snap-Databased-within-Auth-Snaplet-Example\">here</a>.</p>\n<p>tldr; use this instance:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;haskell&quot;&gt;instance HasPostgres (Handler App (AuthManager App)) where\n    getPostgresState = withTop pg get\n</code></pre>\n<p>The app we’re using was built by running <code>snap init</code> and adding the following code:</p>\n<h5 id=\"srcapplicationhs\">src/Application.hs</h5>\n<p>In <code>src/Application.hs</code> we’ve added the following imports:</p>\n<p><code>import Snap.Snaplet.PostgresqlSimple</code></p>\n<p>and the following definition to our <code>App</code> datatype:</p>\n<p><code>,_pg :: Snaplet Postgres</code></p>\n<h5 id=\"srcsitehs\">src/Site.hs</h5>\n<p>In <code>src/Site.hs</code> we’ve added the following language extensions:</p>\n<p><code>{-# LANGUAGE FlexibleInstances #-}</code></p>\n<p>Imports:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;haskell&quot;&gt;-- for &quot;get&quot;\nimport Control.Monad.State.Class\n-- for &quot;liftIO&quot;\nimport           Control.Monad.IO.Class\n--for &quot;writeJSON&quot;\nimport           Snap.Extras.JSON\n-- for Non Snaplet-Auth related database queries\nimport           Snap.Snaplet.PostgresqlSimple\n-- for Snaplet-Auth backed\nimport           Snap.Snaplet.Auth.Backends.PostgresqlSimple```\n\nInstances:\n\n</code></pre>\n<p><code class=\"haskell\">instance HasPostgres (Handler b App) where\ngetPostgresState = with pg get</p>\n<p>instance HasPostgres (Handler App (AuthManager App)) where\ngetPostgresState = withTop pg get</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>\nand Snaplet Init code:\n\n`&lt;code class=&quot;haskell&quot;&gt;p `\n\n\n## What's Going On\n\nWe've also defined a convenience function `needsAuth` to restrict our `&quot;/postgres&quot;` route to only logged in users.\n\n</code></pre>\n<p><code class=\"haskell\">needsAuth :: Handler App (AuthManager App) () -&gt; Handler App App ()\nneedsAuth x = with auth $ requireUser auth (redirect “/”) x</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>\n`getFromPostgres` does the dirty work for us by querying a table that was created as part of the Snaplet-Auth backend. It will return a list of all users.\n\n</code></pre>\n<p><code class=\"haskell\">getFromPostgres :: Handler App (AuthManager App) ()\ngetFromPostgres = do\n–get the results\nresults ```</p>\n<p><code>&quot;/postgres&quot;</code> is the url to hit to check to see if it’s working.</p>\n<p><code>, (&quot;/postgres&quot;, needsAuth getFromPostgres)</code></p>\n<h2 id=\"the-instance\">The Instance</h2>\n<p>What’s really doing the heavy lifting of using the postgres snaplet inside of the auth snaplet’s route is this instance:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;haskell&quot;&gt;instance HasPostgres (Handler App (AuthManager App)) where\n    getPostgresState = withTop pg get\n</code></pre>\n<p>The important difference from the instance above it is <code>withTop</code> which can be found <a href=\"http://hackage.haskell.org/package/snap-0.6.0.2/docs/Snap-Snaplet.html\">here</a>.</p>\n<p>From the docs:</p>\n<blockquote>\n<p>– | Like ‘with’ but doesn’t impose the requirement that the action\n– being run be a descendant of the current snaplet.</p>\n</blockquote>\n<p>Essentially, the auth snaplet doesn’t know anything about the postgres snaplet as we’ve instantiated it (it doesn’t keep around a reference from the Backend module), so we have to ask the parent context (using <code>withTop</code>).</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.33.node.attributes":{"slug":"using-databases-inside-of-snaplet-auth-restricted-routes","__typename":"BlogPostAttributes","title":"Using Databases inside of Snaplet Auth Restricted Routes","url":"/2014/1/9/using-databases-inside-of-snaplet-auth-restricted-routes/","excerpt":"The github repo for this code is at here.","updatedAt":"Jan 9th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.33":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.33.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.34.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.34.node.attributes","generated":true},"body":"<p>I decided to take stock of the books that are sitting on my bookshelf for 2014.\nHere is that list.</p>\n<p>Starting with some (of my) classics. These are books that I read in the\nmiddle/high school time period in my life.</p>\n<h4 id=\"basic-technical-mathematics-with-calculus\"><a href=\"http://www.amazon.com/Basic-Technical-Mathematics-Calculus-Edition/dp/0133116530?tag=christophe067-20\">Basic Technical Mathematics with Calculus</a></h4>\n<p>(note: my version is the second edition. It looks like they’re up to the tenth)</p>\n<p>This was a book that let me explore math on my own. It goes from trig functions\nthrough linear equations, logarithms, determinants and matrices, derivatives,\nintegration, series expansion and differential equations. A little beyond what\nmy AP Calc class ended up taking us through. I would suggest it if you have an\ninterest in Mathematics and Calculus at an advanced high school level.</p>\n<h4 id=\"texas-instruments-ti-83-manual\">Texas Instruments TI-83+ Manual</h4>\n<p>I read this cover to cover one day. It led through the days of BASIC on a\ncalculator in Math class, where I would program equation solvers and games.</p>\n<h2 id=\"distributed-systems\">Distributed Systems</h2>\n<h4 id=\"distributed-systems-concepts-and-design\">Distributed Systems Concepts and Design</h4>\n<p>The purchase of this book was driven by my interest in Erlang and Riak Core. I\nwas hoping that this would give me some good information on distributed systems\nbut it’s a bit of a slog to parse the wordiness of the book. Preferable would be\nto surf the repos of various open source projects. The table of contents,\nhowever, is useful in pointing you to on the path to those projects.</p>\n<h4 id=\"parallel-and-concurrent-programming-in-haskell\"><a href=\"http://www.amazon.com/Parallel-Concurrent-Programming-Haskell-Multithreaded/dp/1449335942/?tag=christophe067-20\">Parallel and Concurrent Programming in Haskell</a></h4>\n<p>A solid book that takes you through parallelism and concurrency in Haskell with\nplenty of code to work with. Concepts covered include Data Parallel Programing,\nGPU programming, MVars, Software Transactional Memory and finally\ndistributed-process, which is an attempt to create a sort of Erlang-as-a-package\nfor Haskell.</p>\n<h2 id=\"databases\">Databases</h2>\n<h4 id=\"readings-in-database-systems\"><a href=\"http://www.amazon.com/Readings-Database-Systems-Joseph-Hellerstein/dp/0262693143?tag=christophe067-20\">Readings in Database Systems</a></h4>\n<p>Databases are not my specialty, so I use this book as some casual reading. It is\na collection of academic papers relating to databases.</p>\n<h2 id=\"lisp-lambda-calculus-and-functional-programming\">Lisp, Lambda Calculus and Functional Programming</h2>\n<h4 id=\"an-introduction-to-functional-programming-through-lambda-calculus\"><a href=\"http://www.amazon.com/Introduction-Functional-Programming-Calculus-Mathematics/dp/0486478831?tag=christophe067-20\">An Introduction to Functional Programming Through Lambda Calculus</a></h4>\n<p>This is a fun book that take you through the lambda calculus with a functional\nslant. Includes some comparisons with Lisp and Scheme later in the book.</p>\n<h4 id=\"pearls-of-functional-algorithm-design\"><a href=\"http://www.amazon.com/Pearls-Functional-Algorithm-Design-Richard/dp/0521513383?tag=christophe067-20\">Pearls of Functional Algorithm Design</a></h4>\n<p>A nice look at functional algorithms with plenty of Haskell code. I quite enjoy\nthis book when I’m in an algorithmic mood.</p>\n<h4 id=\"common-lisp\"><a href=\"http://www.cs.cmu.edu/~dst/LispBook/\">Common Lisp</a></h4>\n<p>Widely recognized as a great introduction to the Common Lisp language. I don’t\nwrite as much Lisp as I would like to, but having mocl around for\nexperimentation sure helps.</p>\n<h4 id=\"let-over-lambda\"><a href=\"http://letoverlambda.com/\">Let Over Lambda</a></h4>\n<p>Let Over Lambda is billed as a book about macros, in other words a book to move\nyou from intermediate lisper to professional. I’d like to spend a little more\ntime with Common Lisp over the next year and Let Over Lambda will be one of the\nbooks I use to do that.</p>\n<h2 id=\"training\">Training</h2>\n<p>For those that don’t know, I train for Volleyball and High Jump. Having played\nDivision 1 Volleyball in college I still enjoy training and competing at a high\nlevel. These books help me move towards my athletic goals.</p>\n<h4 id=\"weightlifting-programming-a-winning-coachs-guide\"><a href=\"http://www.amazon.com/Weightlifting-Programming-Winning-Coachs-Guide/dp/0980011159?tag=christophe067-20\">Weightlifting Programming: A Winning Coach’s Guide</a></h4>\n<p>This is a book by a well respected coach in the weightlifting community. Since I\nuse Olympic lifts in my training this will help me program my lifting workouts\nfor greater effect.</p>\n<h4 id=\"overcoming-gravity\"><a href=\"http://www.amazon.com/Overcoming-Gravity-Systematic-Gymnastics-Bodyweight/dp/1467933120?tag=christophe067-20\">Overcoming Gravity</a></h4>\n<p>I’m not a huge fan of doing bench press, bicep curls, etc. So I got this book\nabout training gymnastics movements to supplement my Olympic lifting, especially\nmy upper body which I don’t need excess hypertrophy on.</p>\n<h4 id=\"abs-on-the-ball-a-pilates-approach-to-building-superb-abdominals\"><a href=\"http://www.amazon.com/Abs-Ball-Approach-Building-Abdominals/dp/089281098X?tag=christophe067-20\">Abs on the Ball: A Pilates Approach to Building Superb Abdominals</a></h4>\n<p>In the past I’ve found Pilates on exercise balls to be a great way to improve\ncore strength and stability. Colleen Craig’s books have been on my shelf for\nawhile and I often take exercises from them. Core strength will help me in my\nlifts, gymnastics training and controlling my body in the air while jumping for\nHigh Jump and Volleyball.</p>\n<h4 id=\"becoming-a-supple-leopard-the-ultimate-guide-to-resolving-pain-preventing-injury-and-optimizing-athletic-performance\"><a href=\"http://www.amazon.com/Becoming-Supple-Leopard-Preventing-Performance/dp/1936608588?tag=christophe067-20\">Becoming a Supple Leopard: The Ultimate Guide to Resolving Pain, Preventing Injury, and Optimizing Athletic Performance</a></h4>\n<p>This is a book I use for preventative maintenance of joints and muscles. I went\nto an arthritis specialist in college who told me that my joints were\nhypermobile, which means that I can do things like dislocate my shoulder or\nthose weird thumb/finger tricks you may have seen people do, all over my body.\nPreventative maintenance is therefore particularly important in my mind.</p>\n<h2 id=\"other\">Other</h2>\n<p>The final book on my shelf for 2014 is Sartre’s L’existentialisme est un\nhumanisme in the original French.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.34.node.attributes":{"slug":"books-on-my-bookshelf-for-2014","__typename":"BlogPostAttributes","title":"Books on My Bookshelf for 2014","url":"/2014/1/7/books-on-my-bookshelf-for-2014/","excerpt":"I decided to take stock of the books that are sitting on my bookshelf for 2014.\nHere is that list.","updatedAt":"Jan 8th, 2014","timeToRead":3,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.34":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.34.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.35.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.35.node.attributes","generated":true},"body":"<p><a href=\"http://www.christopherbiscardi.com/2014/01/10/getting-started-with-snap-and-user-authentication-part-2/\">Part 2</a></p>\n<p>Before we get started, there is a quickstart on the snap-framework site\n<a href=\"http://snapframework.com/docs/quickstart\">here</a> that goes into the <code>barebones</code>\nscaffold project a bit. This course will go a little more in depth into the\n<code>default</code> project, exploring user authentication.</p>\n<p>I use <a href=\"https://github.com/Paczesiowa/hsenv\">hsenv</a> to create separate Haskell\nenvironments, but that is not a requirement and beginners may be more\ncomfortable installing the <a href=\"http://www.haskell.org/platform/\">Haskell Platform</a></p>\n<p>If you wish to use hsenv, you can run this on newer versions:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>hsenv --ghc=7.6.3\n</code></pre>\n<p>or download the package for ghc-7.6.3\n<a href=\"http://www.haskell.org/ghc/download_ghc_7_6_3\">here</a> and run this:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>hsenv --ghc=/path/to/downloaded/ghc-7.6.3-x86_64-apple-darwin.tar.bz2\n</code></pre>\n<p>From here on out the process is the same if you’re using hsenv or not. Create a\nnew directory named “abc” and enter it. This will also function as the name of\nour project and executable.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>mkdir abc\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> abc\n</code></pre>\n<p>It’s good to update the package list when starting a new project:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>cabal update\ncabal install cabal-install\n</code></pre>\n<p>After updating and installing the new version of cabal-instal we can install\nsnap:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>cabal install snap\n</code></pre>\n<p>At this point we will have the <code>snap</code> CLI and can run init to scaffold a default\nproject. After scaffolding, we then run <code>cabal install</code> to compile the binary\nand <code>abc</code> to run the project. <code>abc</code> will also take a port as such: <code>abc -p 8000</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>snap init\ncabal install\nabc -p 8000\n</code></pre>\n<p>Our app, abc, should now be running. Navigate to <code>localhost:8000</code> (or the port\nyou specified) in your browser to take a look.</p>\n<p>In the next post we’ll take a look at the code we generated and take a brief\noverview of what it does.</p>\n<p><a href=\"http://www.christopherbiscardi.com/2014/01/10/getting-started-with-snap-and-user-authentication-part-2/\">Part 2 – Auth</a></p>\n<p><a href=\"http://www.christopherbiscardi.com/2014/01/11/getting-started-with-snap-and-user-authentication-part-3/\">Part 3 – Postgres Backed Auth</a></p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.35.node.attributes":{"slug":"getting-started-with-snap-and-user-authentication-part-1","__typename":"BlogPostAttributes","title":"Getting Started With Snap (and User Authentication): Part 1","url":"/2014/1/6/getting-started-with-snap-and-user-authentication-part-1/","excerpt":"Part 2","updatedAt":"Jan 7th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.35":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.35.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.36.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.36.node.attributes","generated":true},"body":"<p>I was writing a quick script today and came across a nice use case for .apply to\nmerge nested arrays into a single array. So I figured I’d share it.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>    <span class=\"highlight__hljs-comment___UYk12\">//If we have nested arrays of depth = 1:</span>\n    <span class=\"highlight__hljs-keyword___som98\">var</span> arr = [[<span class=\"highlight__hljs-number___2gmaH\">1</span>,<span class=\"highlight__hljs-number___2gmaH\">2</span>,<span class=\"highlight__hljs-number___2gmaH\">3</span>],[<span class=\"highlight__hljs-number___2gmaH\">4</span>,<span class=\"highlight__hljs-number___2gmaH\">5</span>],<span class=\"highlight__hljs-number___2gmaH\">6</span>];\n    <span class=\"highlight__hljs-comment___UYk12\">//we can flatten it by using concat and apply</span>\n    <span class=\"highlight__hljs-keyword___som98\">var</span> flat_arr = [].concat.apply([],arr);\n    <span class=\"highlight__hljs-comment___UYk12\">//and check the value</span>\n    <span class=\"highlight__hljs-built_in___3uuyR\">console</span>.log(flat_arr);\n    <span class=\"highlight__hljs-comment___UYk12\">//logs [1,2,3,4,5,6]</span>\n</code></pre>\n<p>If you need a recursive (ie: infinitely nested) array flattened, check out the\nsource for Underscore’s <a href=\"http://underscorejs.org/#flatten\">flatten()</a> function,\nwhich uses concat.apply for shallow arrays.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.36.node.attributes":{"slug":"flattening-nested-arrays-in-javascript","__typename":"BlogPostAttributes","title":"Flattening Nested Arrays in JavaScript","url":"/2014/1/5/flattening-nested-arrays-in-javascript/","excerpt":"I was writing a quick script today and came across a nice use case for .apply to\nmerge nested arrays into a single array. So I figured I’d…","updatedAt":"Jan 6th, 2014","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.36":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.36.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.37.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.37.node.attributes","generated":true},"body":"<p>Here is a description of how I installed Montage (<a href=\"https://github.com/bumptech/montage\">https://github.com/bumptech/montage</a>) with GHC 7.6.1</p>\n<p>First clone these repos (the relevant commit I used is listed below each clone command)</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>mkdir montage_deps\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> montage_deps\n\ngit <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> git <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> git@github.com:wmoss/StatsWeb.git\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> StatsWeb\ngit checkout d65376e37b315897226e37946faa35e1b1a328f5\ncabal install\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> ..\n\ngit <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/bumptech/riak-haskell-client.git\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> riak-haskell-client\ngit checkout 1a773db41681c895021206a742f889a20daf5875\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> protobuf &amp;&amp; cabal install\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> .. &amp;&amp; cabal install\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> ..\n\ngit <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/bumptech/pool.git\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> pool\ngit checkout b72a259dc375cce4a8208eedc58d8252b3c44201\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> ..\n</code></pre>\n<p>Next I installed some C dependencies using homebrew (<a href=\"http://brew.sh/\">http://brew.sh/</a>):</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>brew install libev redo libsodium\n</code></pre>\n<p>Grab the nitro C code from <a href=\"http://gonitro.io/\">http://gonitro.io/</a>\nI used v0.2.0</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">cd</span> folder_with_nitro_code\nredo\nsudo redo install\n</code></pre>\n<p>We are now ready to install Montage</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">cd</span> montage_deps\ngit <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> https://github.com/bumptech/montage.git\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> montage\ngit checkout 8ac5d81328b29ddf547673f158a1185b40ceec85\ncabal install\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.37.node.attributes":{"slug":"installing-montage-a-riak-sibling-resolution-library-written-in-haskell-on-osx","__typename":"BlogPostAttributes","title":"Installing Montage: A Riak sibling resolution library written in Haskell, on OSX","url":"/2013/7/25/installing-montage-a-riak-sibling-resolution-library-written-in-haskell-on-osx/","excerpt":"Here is a description of how I installed Montage (https://github.com/bumptech/montage) with GHC 7.6.1","updatedAt":"Jul 26th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.37":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.37.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.38.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.38.node.attributes","generated":true},"body":"<p>For Vagrant, if you see this error after <code>vagrant up</code>-ing the box.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;bash&quot;&gt;Failed to connect to VM via SSH. Please verify the VM successfully booted\nby looking at the VirtualBox GUI.```\n\nThere are three things I did to fix it.\n\n1) Enable the :gui option and run `sudo /etc/init.d/networking restart` on the box\n 2) Run `sudo dhclient` on the box\n 3) Change the IP Address in your Vagrantfile\n\nThen rebuild your box.\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.38.node.attributes":{"slug":"vagrant-can-not-ssh-into-the-box","__typename":"BlogPostAttributes","title":"Vagrant Can Not SSH Into the Box","url":"/2013/7/12/vagrant-can-not-ssh-into-the-box/","excerpt":"For Vagrant, if you see this error after vagrant up-ing the box.","updatedAt":"Jul 12th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.38":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.38.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.39.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.39.node.attributes","generated":true},"body":"<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>brew update\nbrew install ivy\ngit <span class=\"highlight__hljs-built_in___3uuyR\">clone</span> -b rz-yokozuna-2 git://github.com/basho/riak.git\n<span class=\"highlight__hljs-built_in___3uuyR\">cd</span> riak\nmake yz-setup\n</code></pre>\n<p>It’s important to have Ivy installed before <code>make yz-setup</code> or the priv/solr.jar\nwon’t be built. The build script only checks for the containing folder, not the\nbuilt .jar so you’ll have to either re-clone the git repo or remove the entire\nsolr folder after installing Ivy.</p>\n<p>Full instructions here: <a href=\"https://github.com/rzezeski/yokozuna\">https://github.com/rzezeski/yokozuna</a></p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.39.node.attributes":{"slug":"installing-yokozuna-on-osx-lion-with-homebrew","__typename":"BlogPostAttributes","title":"Installing Yokozuna on OSX Lion with Homebrew","url":"/2013/2/26/installing-yokozuna-on-osx-lion-with-homebrew/","excerpt":"It’s important to have Ivy installed before make yz-setup or the priv/solr.jar\nwon’t be built. The build script only checks for the…","updatedAt":"Feb 26th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.39":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.39.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.40.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.40.node.attributes","generated":true},"body":"<p>If you want to deploy a Clojure/Compojure application you’re going to need a couple hints.</p>\n<p>First, in project.clj you’re going to need to add an item to :dependencies and :main.</p>\n<p>I have some extra dependencies such as hiccup that aren’t strictly necessary. The ring/ring-jetty-adapter is most important.</p>\n<p>under :main write the name of the module that has your (defroutes), we’re going to add a -main function to the same file.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-symbol___mdaTG\">:dependencies</span> [[org.clojure/clojure <span class=\"highlight__hljs-string___1SffY\">\"1.4.0\"</span>]\n              [compojure <span class=\"highlight__hljs-string___1SffY\">\"1.1.5\"</span>]\n              [ring/ring-jetty-adapter <span class=\"highlight__hljs-string___1SffY\">\"1.2.0-beta1\"</span>]\n              [hiccup <span class=\"highlight__hljs-string___1SffY\">\"1.0.2\"</span>]]\n<span class=\"highlight__hljs-symbol___mdaTG\">:main</span> projectname.handler\n</code></pre>\n<p>Now in projectname.handler add :gen-class and ring.adapter.jetty to (use).</p>\n<p>Lower in the same file, include a new function called -main.\nThis is the function java will call to start the server.</p>\n<p>In this case my defroutes was named app-routes so that’s what goes after\nrun-jetty.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>(<span class=\"hljs-name\"><span class=\"hljs-builtin-name\">ns</span></span> projectname.handler\n (<span class=\"highlight__hljs-symbol___mdaTG\">:gen-class</span>)\n (<span class=\"highlight__hljs-symbol___mdaTG\">:use</span> [compojure.core]\n       [ring.adapter.jetty]\n       [hiccup.core]))\n\n(<span class=\"hljs-name\">defroutes</span> app-routes\n           (<span class=\"hljs-name\">GET</span> <span class=\"highlight__hljs-string___1SffY\">\"/\"</span> [] g/show-home)\n           (<span class=\"hljs-name\">route/resources</span> <span class=\"highlight__hljs-string___1SffY\">\"/\"</span>)\n           (<span class=\"hljs-name\">route/not-found</span> <span class=\"highlight__hljs-string___1SffY\">\"Not Found\"</span>))\n\n(<span class=\"hljs-name\"><span class=\"hljs-builtin-name\">defn</span></span> -main [&amp; args]\n (<span class=\"hljs-name\">run-jetty</span> (<span class=\"hljs-name\">handler/site</span> app-routes) {<span class=\"highlight__hljs-symbol___mdaTG\">:port</span> <span class=\"highlight__hljs-number___2gmaH\">5000</span>}))\n</code></pre>\n<p>That’s it. You should be able to</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>lein compile\nlein uberjar\njava -jar target/whatever-STANDALONE.jar\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.40.node.attributes":{"slug":"clojure-compojure-jetty-integration","__typename":"BlogPostAttributes","title":"Clojure Compojure Jetty Integration","url":"/2013/2/17/clojure-compojure-jetty-integration/","excerpt":"If you want to deploy a Clojure/Compojure application you’re going to need a couple hints.","updatedAt":"Feb 18th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.40":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.40.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.41.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.41.node.attributes","generated":true},"body":"<p>I think <a href=\"http://learnyouahaskell.com/starting-out#im-a-list-comprehension\">list\ncomprehensions</a>\nare my favorite reason to pull out Haskell.</p>\n<p>For example: I was recently asked this:</p>\n<p>You have a row of 100 school lockers. For each number from 1 to 100 walk down\nthe line of lockers starting at the beginning, and switch the state of every nth\nlocker. All of the lockers start closed.</p>\n<p>For example:\nwe start off at 1 and switch all the lockers to open. (1,2,3,4,5,…)\nwe then go to 2 and switch all of the lockers evenly divisible by 2. (2,4,6,8…)\nfor 3 we flip every 3rd locker (3,6,9,12,…)\n4 is every 4th locker. (4,8,12,16,…)\netc.</p>\n<h4 id=\"answer-below-this-line\">Answer Below This Line</h4>\n<p>In Haskell this is easily accomplished using a list comprehension.</p>\n<p>We can observe through trial (ie: actually flipping every locker) that the\nlockers are flipped by their factors. (ie: 6 is flipped by 1,2,3,and 6), so\nwe’ll write a quick comprehension to give us the factors of a number:</p>\n<p>In this example, we get the factors of 6</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>[x | x\n</code></pre>\n<p>links:\n<a href=\"http://learnyouahaskell.com/starting-out#texas-ranges\">[1…6]</a>\n<a href=\"http://en.wikipedia.org/wiki/Modulo_operation\">modulo</a>\n<a href=\"http://zvon.org/other/haskell/Outputprelude/mod_f.html\">mod</a>\n<a href=\"http://www.haskell.org/haskellwiki/Infix_operator\"><code>infix</code></a></p>\n<p>Essentially you can read the above code as</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">Give</span> me x <span class=\"highlight__hljs-keyword___som98\">where</span> x is [<span class=\"highlight__hljs-number___2gmaH\">1</span>,<span class=\"highlight__hljs-number___2gmaH\">2</span>,<span class=\"highlight__hljs-number___2gmaH\">3</span>,<span class=\"highlight__hljs-number___2gmaH\">4</span>,<span class=\"highlight__hljs-number___2gmaH\">5</span>,<span class=\"highlight__hljs-number___2gmaH\">6</span>] and <span class=\"highlight__hljs-number___2gmaH\">6</span> is evenly divisible by x\n</code></pre>\n<p>and breaking it down:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">Give</span> me x\n[x\n\n<span class=\"highlight__hljs-title___1fl8Q\">where</span>\n|\n\n<span class=\"highlight__hljs-title___1fl8Q\">x</span>\n\n<span class=\"highlight__hljs-title___1fl8Q\">is</span>\n</code></pre>\n<p>We can then realize that if you flip something an even number of times, nothing\nchanges. This means we’re looking for the number with an odd number of factors\nbecause we want the lockers that are open at the end.</p>\n<p>The code to determine an open locker will look like this, where factors is the\ncode we just wrote.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">length</span> factors `mod` <span class=\"highlight__hljs-number___2gmaH\">2</span> == <span class=\"highlight__hljs-number___2gmaH\">1</span>\n</code></pre>\n<p>If we stick that in a list comprehension for all numbers [1…100] we have\neffectively filtered out all of the open lockers.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>[n | n\n</code></pre>\n<p>But wait! There’s more! For the low low price of $19.95 we can realize there’s a\npattern in the results. The pattern happens to be perfect squares. This is\nbecause perfect squares are the only numbers with an odd number of factors!</p>\n<p>for example:\n9’s factors are 1,3 and 9.\nWhile 8’s factors are 1,2,4 and 8</p>\n<p>We can now write a far more efficient list comprehension.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>[x*x | x &lt;- [<span class=\"highlight__hljs-number___2gmaH\">1.</span><span class=\"highlight__hljs-number___2gmaH\">.10</span>]]\n</code></pre>\n<p>Which can be read as:\ngive me x*x where x is [1,2,3,4,5,6,7,8,9,10]</p>\n<p>We can also expand this into an function using an infinite list, just in case we\nwant to calculate how many lockers are open if we have 50081 lockers.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">let</span> lockers = [x*x | x\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.41.node.attributes":{"slug":"quick-tip-haskell-list-comprehensions","__typename":"BlogPostAttributes","title":"Quick Tip: Haskell List Comprehensions","url":"/2013/2/8/quick-tip-haskell-list-comprehensions/","excerpt":"I think list\ncomprehensions\nare my favorite reason to pull out Haskell.","updatedAt":"Feb 8th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.41":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.41.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.42.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.42.node.attributes","generated":true},"body":"<p>Say we have the following function:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;javascript&quot;&gt;\nfunction increaseBy(x){\n  return function(y){\n    return x + y;\n  }\n}\n</code></pre>\n<p>We can use this function to create new, higher order functions that increase a number by a certain value.</p>\n<p>for example:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;javascript&quot;&gt;\nvar incByThree = increaseBy(3);\n</code></pre>\n<p>gives us a function we can then use later in our code as such:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;javascript&quot;&gt;\nincByThree(4);\n//returns 7\n\nincByThree(5);\n//returns 8\n</code></pre>\n<p>We can also create multiple higher-order functions and have each of them use a different x value;</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;javascript&quot;&gt;\nvar incByThree = increaseBy(3);\nvar incByFour = increaseBy(4);\n\nincByThree(6);\n//returns 9\nincbyFour(6);\n//returns 10\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.42.node.attributes":{"slug":"quick-tip-javascript-partially-applied-functions","__typename":"BlogPostAttributes","title":"Quick Tip: JavaScript Partially Applied Functions","url":"/2013/2/8/quick-tip-javascript-partially-applied-functions/","excerpt":"Say we have the following function:","updatedAt":"Feb 8th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.42":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.42.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.43.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.43.node.attributes","generated":true},"body":"<h2 id=\"prerequisites\">Prerequisites</h2>\n<dl><dt>[Rebar](https://github.com/basho/rebar)</dt><dd>To build the project</dd></dl>\n##  Relevant Files\n<dl><dt>Project on Github</dt><dd>[https://github.com/ChristopherBiscardi/Riak-Core-Consistent-Hash-Routing-Example](https://github.com/ChristopherBiscardi/Riak-Core-Consistent-Hash-Routing-Example)</dd><dt>[chapp.erl](https://github.com/ChristopherBiscardi/Riak-Core-Consistent-Hash-Routing-Example/blob/master/a    pps/chapp/src/chapp.erl)</dt><dd>Holds the different routing code</dd><dt>[chapp_vnode.erl](https://github.com/ChristopherBiscardi/Riak-Core-Consistent-Hash-Routing-Example/blob/master/apps/chapp/src    /chapp_vnode.erl)</dt><dd>The ping function on the vnodes. This function is the same on every vnode, the difference is which vnode is processing the request.</dd></dl>\n<h2 id=\"the-code\">The Code</h2>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">%% @doc Pings a random vnode</span>\n<span class=\"hljs-function\"><span class=\"highlight__hljs-title___1fl8Q\">ping</span><span class=\"hljs-params\">()</span> -&gt;</span>\n    DocIdx = riak_core_util:chash_key({&gt;, term_to_binary(now())}),\n    PrefList = riak_core_apl:get_primary_apl(DocIdx, <span class=\"highlight__hljs-number___2gmaH\">1</span>, chapp),\n    [{IndexNode, _Type}] = PrefList,\n    riak_core_vnode_master:sync_spawn_command(IndexNode, ping, chapp_vnode_master).\n</code></pre>\n<p>The first function, shown above, pings a random (random enough for our purposes)\nvnode and returns the partition identifier. The code we’re interested in is in\nthe first line of the function – specifically the chash_key() function.</p>\n<p>The\n<a href=\"https://github.com/basho/riak_core/blob/master/src/riak_core_util.erl#L187-192\">chash_key</a>\nfunction takes a two-tuple and returns a binary identifier we can use to get a\nPrefList. Much of the terminology in the Riak Core source refers to Riak KV. In\nthis case, the variables are named Bucket and Key in the chash_key function.</p>\n<p>Each function in\n[chapp.erl](<a href=\"https://github.com/ChristopherBiscardi/Riak-Core-Consistent-Hash-Routing-Example/blob/master/a\">https://github.com/ChristopherBiscardi/Riak-Core-Consistent-Hash-Routing-Example/blob/master/a</a>\npps/chapp/src/chapp.erl) has different tuples which affect which vnode gets\ncalled.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">% ping()</span>\n{&gt;, term_to_binary(now())}\n\n<span class=\"highlight__hljs-comment___UYk12\">% pingsame()</span>\n{&gt;, &gt;}\n\n<span class=\"highlight__hljs-comment___UYk12\">% pinginput(X)</span>\n{&gt;, term_to_binary(X)}\n</code></pre>\n<p>so if we build the project.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-built_in___3uuyR\">cd</span> path/to/project\nmake rel\n</code></pre>\n<p>and run the console</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>./rel/chapp/bin/chapp console\n</code></pre>\n<p>we can then execute the various ping() functions as such:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>chapp:ping().\n</code></pre>\n<p>which gives us a tuple that contains <code>pong</code> and the partition id that processed\nthe request.</p>\n<p>We can see the results from running the ping() function a couple times below.\nNotice that each time we run ping(), a different partition handles the call.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{pong,<span class=\"highlight__hljs-number___2gmaH\">1004782375664995756265033322492444576013453623296</span>}\n{pong,<span class=\"highlight__hljs-number___2gmaH\">1050454301831586472458898473514828420377701515264</span>}\n{pong,<span class=\"highlight__hljs-number___2gmaH\">1027618338748291114361965898003636498195577569280</span>}\n{pong,<span class=\"highlight__hljs-number___2gmaH\">1118962191081472546749696200048404186924073353216</span>}\n</code></pre>\n<p>Looking at the next function <code>pingsame</code> which we call as such:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>chapp:pingsame().\n</code></pre>\n<p>we can see that by calling this function multiple times, we get the same\npartition handling the call, because the hash of the tuple is always the same.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{pong,<span class=\"highlight__hljs-number___2gmaH\">936274486415109681974235595958868809467081785344</span>}\n{pong,<span class=\"highlight__hljs-number___2gmaH\">936274486415109681974235595958868809467081785344</span>}\n{pong,<span class=\"highlight__hljs-number___2gmaH\">936274486415109681974235595958868809467081785344</span>}\n{pong,<span class=\"highlight__hljs-number___2gmaH\">936274486415109681974235595958868809467081785344</span>}\n</code></pre>\n<p>The pinginput function allows us to take a more interactive look at where our\nrequests go. pinginput uses the input we give it as the second element in the\nchash_key function tuple.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>chapp:pinginput(someinput).\n</code></pre>\n<p>we can see that by calling this function multiple times with the same input, the\nsame vnode processes the request.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>chapp:pinginput(someinput).\n{pong,<span class=\"highlight__hljs-number___2gmaH\">959110449498405040071168171470060731649205731328</span>}\nchapp:pinginput(someinput).\n{pong,<span class=\"highlight__hljs-number___2gmaH\">959110449498405040071168171470060731649205731328</span>}\nchapp:pinginput(someinput).\n{pong,<span class=\"highlight__hljs-number___2gmaH\">959110449498405040071168171470060731649205731328</span>}\n</code></pre>\n<p>We can also see that by calling pinginput with a different input results in a\ndifferent vnode handling the request.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>chapp:pinginput(otherinput).\n{pong,<span class=\"highlight__hljs-number___2gmaH\">342539446249430371453988632667878832731859189760</span>}\nchapp:pinginput(otherinput).\n{pong,<span class=\"highlight__hljs-number___2gmaH\">342539446249430371453988632667878832731859189760</span>}\nchapp:pinginput(otherinput).\n{pong,<span class=\"highlight__hljs-number___2gmaH\">342539446249430371453988632667878832731859189760</span>}\n</code></pre>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.43.node.attributes":{"slug":"consistant-hash-routing-in-riak-core","__typename":"BlogPostAttributes","title":"Consistant Hash Routing in Riak Core","url":"/2013/1/16/consistant-hash-routing-in-riak-core/","excerpt":"The first function, shown above, pings a random (random enough for our purposes)\nvnode and returns the partition identifier. The code we’re…","updatedAt":"Jan 16th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.43":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.43.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.44.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.44.node.attributes","generated":true},"body":"<p>As seen in the <a href=\"http://www.christopherbiscardi.com/2013/01/13/riak-core-quickstart/\">quickstart post</a>; the default Riak Core template gives you a <code>myapp:ping().</code> method.\nI named my application spades, so my files are named <code>spades.erl</code> and <code>spades_vnode.erl</code> with the function being called as <code>spades:ping().</code></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;erlang&quot;&gt;\n%% File: spades.erl\n%% @doc Pings a random vnode to make sure communication is functional\nping() -&gt;\n  DocIdx = riak_core_util:chash_key({&lt;&lt;&quot;ping&quot;&gt;&gt;, term_to_binary(now())}),\n  PrefList = riak_core_apl:get_primary_apl(DocIdx, 1, spades),\n  [{IndexNode, _Type}] = PrefList,\n  riak_core_vnode_master:sync_spawn_command(IndexNode, ping, spades_vnode_master).\n</code></pre>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;erlang&quot;&gt;\n%% File: spades_vnode.erl\n%% Sample command: respond to a ping\nhandle_command(ping, _Sender, State) -&gt;\n  {reply, {pong, State#state.partition}, State};\n</code></pre>\n<p>All commands we execute as <code>myapp:command().</code> (such as <code>spades:ping().</code>) route through the myapp.erl functions.</p>\n<p>In this case, when we call <code>spades:ping().</code> the ping(). function in spades.erl is what gets called.</p>\n<p>Let’s take a look at the first line of code.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;erlang&quot;&gt;\n    DocIdx = riak_core_util:chash_key({&lt;&lt;&quot;ping&quot;&gt;&gt;, term_to_binary(now())}),\n</code></pre>\n<p>DocIdx is short for Document Index. This appears to be a holdover from before Riak Core was separated from Riak KV.\nWe are using the Consistent Hash (chash) function from the riak_core_util module.\nBy hashing on the “ping” and the current time, we achieve an acceptable level of randomness to distribute our request to a random vnode.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&lt;code class=&quot;erlang&quot;&gt;\n  PrefList = riak_core_apl:get_primary_apl(DocIdx, 1, spades),\n</code></pre>\n<p>We then create a PreferenceList (PrefList) by using the hash we just created, an N value and a module name.</p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.44.node.attributes":{"slug":"riak-core-myappping","__typename":"BlogPostAttributes","title":"Riak Core: myapp:ping().","url":"/2013/1/13/riak-core-myappping/","excerpt":"As seen in the quickstart post; the default Riak Core template gives you a myapp:ping(). method.\nI named my application spades, so my files…","updatedAt":"Jan 13th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.44":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.44.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.45.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.45.node.attributes","generated":true},"body":"<p>First Retrieve the Rebar Templates and put them in ~/.rebar/templates</p>\n<div><div class=\"syntaxhighlighter  bash\" id=\"highlighter_831319\"><div class=\"toolbar\"><span>[?](#)</span></div><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\">`<code class=\"bash plain\"><a href=\"http://git-scm.com/book\">git</a><a href=\"http://git-scm.com/book/en/Git-Basics-Getting-a-Git-Repository\">clone</a><a href=\"https://github.com/rzezeski/rebar_riak_core\">git://github.com/rzezeski/rebar_riak_core.git</a>`</div><div class=\"line number2 index1 alt1\">`<code class=\"bash functions\"><a href=\"http://unixhelp.ed.ac.uk/CGI/man-cgi?mkdir\">mkdir</a>``<code class=\"bash plain\"><a href=\"http://unixhelp.ed.ac.uk/CGI/man-cgi?mkdir\">-p</a> ~/.rebar``<code class=\"bash plain\">/templates`</div><div class=\"line number3 index2 alt2\">`<code class=\"bash functions\"><a href=\"http://unixhelp.ed.ac.uk/CGI/man-cgi?cp\">cp</a>``<code class=\"bash plain\">rebar_riak_core/* ~/.rebar``<code class=\"bash plain\">/templates`</div></div></td></tr></tbody></table></div></div>You’ll also need [Rebar](https://github.com/basho/rebar) and [Erlang](). I used [homebrew](http://mxcl.github.com/homebrew/) to get them:\n<p>[bash]\nbrew install erlang rebar\n[/bash]</p>\n<p>Now that you’re set up, you can create a new multinode app from the templates.\nReplace myapp with whatever you want to call your new app in the following command:</p>\n<div><div class=\"syntaxhighlighter  bash\" id=\"highlighter_654785\"><div class=\"toolbar\"><span>[?](#)</span></div><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\">`<code class=\"bash functions\">cd``<code class=\"bash plain\">~``<code class=\"bash plain\">/where/I/want/my/app`</div><div class=\"line number2 index1 alt1\">`<code class=\"bash plain\"><a href=\"https://github.com/basho/rebar\">rebar create</a> template=riak_core_multinode appid=myapp nodeid=myapp`</div></div></td></tr></tbody></table></div></div>You can now `make` and run the code.\n [bash]\n make rel\n ./rel/myapp/bin/myapp console\n [/bash]\n<p>If all goes well you should be sitting in a console for your app.\nRun\n[erlang]\nmyapp:ping().\n[/erlang]\nto ping a random vnode.</p>\n<h5 id=\"links\">Links</h5>\n<ul>\n<li><a href=\"https://github.com/rzezeski/try-try-try/tree/master/2011/riak-core-first-multinode\">try try try</a>\nPost that goes into more detail about the process.</li>\n<li><a href=\"\">Ping</a>\nA Future Post detailing the <code>myapp:ping().</code> method.</li>\n</ul>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.45.node.attributes":{"slug":"riak-core-quickstart","__typename":"BlogPostAttributes","title":"Riak Core: Quickstart","url":"/2013/1/13/riak-core-quickstart/","excerpt":"First Retrieve the Rebar Templates and put them in ~/.rebar/templates","updatedAt":"Jan 13th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.45":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.45.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.46.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.46.node.attributes","generated":true},"body":"<p>Some of the current Riak Core resources available are:</p>\n<ul>\n<li><a href=\"https://github.com/rzezeski/try-try-try/tree/master/2011\">try try try:</a> A blog written by Ryan Zezeski. It includes a few posts on Riak Core and one on Riak Search.</li>\n<li><a href=\"https://github.com/websterclay/rebar_riak_core/network\">Rebar Templates</a> These are some rebar templates for Riak Core. rzezeski’s branch is used in the blogs above and some of the others add examples for coverage.</li>\n<li><a href=\"http://basho.com/blog/technical/2011/04/12/Where-To-Start-With-Riak-Core/\">Basho</a> Basho has an introductory post that includes some talks, slides and links.</li>\n<li><a href=\"http://vimeo.com/53910999\">Riak Pipe</a> Bryan Fink’s talk from Ricon 2012</li>\n<li><a href=\"http://vimeo.com/54266574\">Yokozuna</a> Ryan Zezeski’s talk about integration between Riak Core and Solr</li>\n<li><a href=\"http://basho.com/blog/technical/2010/07/30/introducing-riak-core/\">Introducing Riak Core</a> Another Basho post with some useful information on the files included in Riak Core</li>\n</ul>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.46.node.attributes":{"slug":"riak-core-up-and-running","__typename":"BlogPostAttributes","title":"Riak Core: Up and Running","url":"/2013/1/12/riak-core-up-and-running/","excerpt":"Some of the current Riak Core resources available are:","updatedAt":"Jan 13th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.46":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.46.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.47.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.47.node.attributes","generated":true},"body":"<p>To generate a unique identifier, Riak Core exposes:</p>\n<div><div class=\"syntaxhighlighter  erlang\" id=\"highlighter_676059\"><div class=\"toolbar\"><span>[?](#)</span></div><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\">`<code class=\"erlang functions\">riak_core_util:unique_id_62``<code class=\"erlang plain\">()`</div></div></td></tr></tbody></table></div></div>Which returns a string that looks like this:\n<p>[erlang]NWX8ZV4Zn4pfZDh51viJtpyya9v[/erlang]</p>\n<p>The full function can be seen below:</p>\n<div><div class=\"syntaxhighlighter  erlang\" id=\"highlighter_202233\"><div class=\"toolbar\"><span>[?](#)</span></div><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div><div class=\"line number5 index4 alt2\">5</div><div class=\"line number6 index5 alt1\">6</div><div class=\"line number7 index6 alt2\">7</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\">`<code class=\"erlang comments\">%% @spec unique_id_62() -> string()`</div><div class=\"line number2 index1 alt1\">`<code class=\"erlang comments\">%% @doc Create a random identifying integer, returning its string`</div><div class=\"line number3 index2 alt2\">`<code class=\"erlang comments\">%%      representation in base 62.`</div><div class=\"line number4 index3 alt1\">`<code class=\"erlang plain\">unique_id_62() ->`</div><div class=\"line number5 index4 alt2\">`<code class=\"erlang spaces\">    ``<code class=\"erlang constants\">Rand``<code class=\"erlang plain\">= ``<code class=\"erlang functions\"><a href=\"http://erlang.org/doc/man/crypto.html#sha-1\">crypto:sha</a>``<code class=\"erlang plain\">(<a href=\"http://erlang.org/doc/man/erlang.html#term_to_binary-1\">term_to_binary</a>({<a href=\"http://erlang.org/doc/man/erlang.html#make_ref-0\">make_ref()</a>, ``<code class=\"erlang functions\"><a href=\"http://www.erlang.org/doc/man/os.html#timestamp-0\">os:timestamp</a>``<code class=\"erlang plain\">()})),`</div><div class=\"line number6 index5 alt1\">`<code class=\"erlang spaces\">    ``<code class=\"erlang plain\"><a href=\"http://learnyousomeerlang.com/starting-out-for-real#bit-syntax\"><<I:160/integer>></a> = ``<code class=\"erlang constants\">Rand``<code class=\"erlang plain\">,`</div><div class=\"line number7 index6 alt2\">`<code class=\"erlang spaces\">    ``<code class=\"erlang plain\"><a href=\"http://erlang.org/doc/man/erlang.html#integer_to_list-2\">integer_to_list(I, 62).</a>`</div></div></td></tr></tbody></table></div></div>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.47.node.attributes":{"slug":"riak-core-unique-identifiers","__typename":"BlogPostAttributes","title":"Riak Core: Unique Identifiers","url":"/2013/1/12/riak-core-unique-identifiers/","excerpt":"To generate a unique identifier, Riak Core exposes:","updatedAt":"Jan 12th, 2013","timeToRead":1,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.47":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.47.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.48.node":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.48.node.attributes","generated":true},"body":"<p>Recently I was asked to build a CRUD app.</p>\n<p>The task was open to using any tech I wanted on the backend, so my first thought was a distributed service in Erlang with a WebMachine interface. This would satisfy the REST requirements for the location service, which we could access via an application server for web.</p>\n<p>However, the preferred method for this task was described to be Python/Flask, So we’ll use that.</p>\n<p>Since sessions are not technically RESTful, they cannot be included in a user authentication scheme. Client side on mobile devices is a different story, with iOS using keychain for security and Android advocating OAuth-type approaches. As it happens, the task language doesn’t include the concept of users, just locations, so we’ll skip authentication to make it REST-Compliant (note: REST doesn’t have a spec.)</p>\n<p>Attributes of a favorite location object include:</p>\n<ul>\n<li>id</li>\n<li>lat</li>\n<li>lng</li>\n<li>address (e.g. 800 Market Street, San Francisco, CA 94114)</li>\n<li>name (e.g. Work)</li>\n</ul>\n<p>This could easily fit in a SQL database, but since we’re using Geolocation and I happen to know that MongoDB’s Geo facilities would allow us to query based on distance from our current position, we’ll use Mongo. Alternatively, we could have also used ElasticSearch/Solr/Lucene but Mongo will serve our purposes just fine.</p>\n<p>We will be deploying on Heroku to use the free ssl support and addons. In reality Heroku is a test platform due to being hosted on EC2 US East only. We will also be skipping the CDN (CloudFront/S3/etc) as the total users here will be under 5.</p>\n<p>I’ve never used Flask before, so this will take a little longer than normal. If I was going for turnaround time, I might have used node.js and express or RESTify because I’m stronger with JS/node.</p>\n<p>To connect to the Mongo Instance on Heroku || localhost:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>  <span class=\"highlight__hljs-keyword___som98\">import</span> pymongo\n\n  <span class=\"highlight__hljs-comment___UYk12\"># Get MongoDB URL if on Heroku, else use localhost</span>\n  MONGO_URL = os.environ.get(<span class=\"highlight__hljs-string___1SffY\">'MONGOHQ_URL'</span>)\n\n   <span class=\"highlight__hljs-keyword___som98\">if</span> MONGO_URL:\n       <span class=\"highlight__hljs-comment___UYk12\"># Get a connection</span>\n       conn = pymongo.Connection(MONGO_URL)\n\n       <span class=\"highlight__hljs-comment___UYk12\"># Get the database</span>\n       db = conn[urlparse(MONGO_URL).path[<span class=\"highlight__hljs-number___2gmaH\">1</span>:]]\n   <span class=\"highlight__hljs-keyword___som98\">else</span>:\n       <span class=\"highlight__hljs-comment___UYk12\"># Not on an app with the MongoHQ add-on, do some localhost action</span>\n       conn = pymongo.Connection(<span class=\"highlight__hljs-string___1SffY\">'localhost'</span>, <span class=\"highlight__hljs-number___2gmaH\">27017</span>)\n       db = conn[<span class=\"highlight__hljs-string___1SffY\">'test'</span>]\n  <span class=\"highlight__hljs-comment___UYk12\"># locations Collection</span>\n  locationsC = db.locations\n</code></pre>\n<p>And set up some content negotiation formatters:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\"># Content Negotiation Formatters</span>\n\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">JSONFormatter</span><span class=\"hljs-params\">(Formatter)</span>:</span>\n    format = <span class=\"highlight__hljs-string___1SffY\">'json'</span>\n    mimetypes = [<span class=\"highlight__hljs-string___1SffY\">'application/json'</span>]\n\n    <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">def</span> <span class=\"highlight__hljs-title___1fl8Q\">render</span><span class=\"hljs-params\">(self, obj)</span>:</span>\n        <span class=\"highlight__hljs-keyword___som98\">return</span> json.dumps(obj)\n\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-title___1fl8Q\">HTMLFormatter</span><span class=\"hljs-params\">(Formatter)</span>:</span>\n    format = <span class=\"highlight__hljs-string___1SffY\">'json'</span>\n    mimetypes = [<span class=\"highlight__hljs-string___1SffY\">'text/html'</span>]\n\n    <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">def</span> <span class=\"highlight__hljs-title___1fl8Q\">configure</span><span class=\"hljs-params\">(self, template)</span>:</span>\n        self.template = template\n\n    <span class=\"hljs-function\"><span class=\"highlight__hljs-keyword___som98\">def</span> <span class=\"highlight__hljs-title___1fl8Q\">render</span><span class=\"hljs-params\">(self, obj)</span>:</span>\n        <span class=\"highlight__hljs-keyword___som98\">return</span> render_template(self.template, **obj)\n</code></pre>\n<p>Having got some server basics out of the way I started on the structure of the home page. There isn’t a defined business purpose here, so I chose to make the design based around creating new locations.</p>\n<p><a href=\"http://www.christopherbiscardi.com/2012/12/06/a-python-flask-crud/screen-shot-2013-01-18-at-8-31-37-am/\"><img src=\"http://res.cloudinary.com/diqzbm8lz/image/upload/h_174,w_300/v1428611529/Screen-shot-2013-01-18-at-8.31.37-AM_vtxjto.png\" alt=\"Python Crud App Homepage\"></a></p>\n","__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":50}).edges.48.node.attributes":{"slug":"a-python-flask-crud","__typename":"BlogPostAttributes","title":"A Python Flask CRUD","url":"/2012/12/6/a-python-flask-crud/","excerpt":"Recently I was asked to build a CRUD app.","updatedAt":"Dec 6th, 2012","timeToRead":2,"headerImage":null},"$ROOT_QUERY.root.posts({\"first\":50}).edges.48":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50}).edges.48.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root":{"posts({\"first\":50})":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":50})","generated":true},"__typename":"Query"},"ROOT_QUERY":{"root":{"type":"id","id":"$ROOT_QUERY.root","generated":true}}}}};</script><script src="/js/client.js" charset="UTF-8"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-46878058-1', 'auto');
          ga('send', 'pageview');</script></body></html>